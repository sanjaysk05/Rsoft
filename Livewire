<?php

namespace App\Http\Livewire;
use Illuminate\Support\Facades\Log;
require_once base_path().'/vendor/autoload.php';
include_once base_path().'/vendor/PHPExcel/PHPExcel/Classes/PHPExcel.php';
use Livewire\Component;
use App\Http\Model\Modules\Rsoftcrm;
use App\Http\Model\Module;
use DB;
use mPDF;
use Auth;
use stdClass;
 use Session;
use Livewire\WithFileUploads;
use App\Http\Model\Modules\User;
use App\Http\Model\ModuleFieldTypes;
use App\Http\Model\ListViewFilter;
use App\Http\Model\Modules\Library\Attachment;
use App\Http\Model\SignGenerator;
use App\Http\FilterHelpers;
use App\Http\Model\Modules\ModuleRecords;
use App\Http\Model\QuickCreate;
use App\Http\Model\ModuleFields;
use App\Http\Model\Modules\Setting\Profile2AssignedUser;
use PDF;
use PHPExcel;
use PHPExcel_IOFactory;
use PHPExcel_Style_Fill;
use PHPExcel_Style_Border;
use PHPExcel_Style_Font;
use Carbon\Carbon;
use DOMDocument;
use App\Http\Model\Modules\Library\FormulaCalculation; 
use DateTime;

class AdvancedReport extends Component  
{
    public $moduleseach;
    public $reportcontent = '';
    public $sidetabval = '';
    public $sharecontent = '';
     public $Schdulecontent = '';
    public $sidebarmenulist = '';
    public $reportName;
    public $moduleType;
    public $primarymodule;
    public $subModules = [];
    public $description;
    public $savemode;
    public $report_id;
    public $rename_report_id;
    public $rename_reportname = '';
    public $deletereportid;
    public $module;
    public $module_id;
    public $headermenu='';
    public $createreport='';
    public $share_type;
    public $share_width_user;
    public $publicvisible;
    public $privatevisible;
    public $share_widthusers;
    public $share_widthroles;
    public $share_permission;
    public $colname;
    public $fieldid;
    public $fieldtype;
    public $selectedOperator;
    public $selectedValue;
    public $filter_id;
    public $sortedIDs;
    public $pagemode;
    public $togglereport_id;
    public $togglereportmode;
    public $moduleSelect;
    public $perPage = 20;
    public $page = 0;
    public $allreportslist = [];
    public $searchValue;
    public $column_name;
    public $sortmode;
    public $filtermode;
    public $addreports=0;
    public $searchQuery;
    public $preimgquery;
    public $searchfieldid;
    public $searchcondtion;
    public $searchfieldvalue;
    public $searchfieldtype;
    public $searchcolname;
    public $previewcolumnname;
    public $previewsorting;
    public $previewperPage = 20;
    public $previewpage = 0;
    public $previewreportslist = [];
    public $addpreviewreports;
    public $presearchmode;
    public $misreportname;
    public $misreportids;
    public $picklistValues = [];
    public $isEditingPopup = false;
    public $currentTrackingId = null;
    public $popupIsOpen = false;
    public $filterData = [];
    public $currentReportId;
    public $misCurrentReportId;
    public $oldMisCurrentReportId;
    public $tabmode;

     protected $listeners = ['AdvancedReportSave','loadTableContent','DeleteReport','handleItemDropped','removeReportItem','SharedReportSave','SharedReportDelete','SaveFilter','DeleteFilter','SaveLogic','SaveCalculationType','UpdateReportListOrder','BuilderUpdateOrder','ExpandSave','SaveSchdule','InactiveSchduleStatus','DeleteSchdule','UpdateSchduleListOrder','SaveShare','UpdateShareListOrder','SaveTableStyle','loadMoreReports','PreviewFilterSearch','ExportReport','loadMorePreviewRecords','resetTableStylePopup','triggerCloseSchedule','SaveCommentsType','SaveFormula','fetchFormulaDetails','DeleteFormula','SaveChartconfigure','DeleteChartconfigure','AdvancedMISReportSave','MISDeleteReport','fetchCurrentReportId','fetchSortedFields','fetchGroupByArrays','changeRecord','updateGroupBy','updateSortFields','checkPicklistFieldUsage','checkExistingPicklistTracking','fetchPicklistTrackingDetails',  'deletePicklistTracking', 'fetchPicklistTrackingResults', 'updatePicklistTrackingOnRename','savePicklistTracking','updatePicklistTracking','ExpandSaveUserPreference','clearStoredFilters','resetAllFilterData','loadMISPreview','reloadPreview','getDefaultTablestyle','misCurrentReportId','misreport','MisScroll'];
    //RenameReport
   public function render()
    {
        $module = new \stdClass();
        $module->picklist_data = [];

        if (isset($_REQUEST['record'])) {
            $this->report_id = $_REQUEST['record'];
        }

        if (isset($_REQUEST['tabmode'])) {
            $this->sidetabval = $_REQUEST['tabmode'];
            $moduleData = DB::table('rsoft_modules')->where('name', $this->sidetabval)->first();
            if ($moduleData) {
                $this->module_id = $moduleData->id;
                $this->sidetabval = $moduleData->label;
                $this->module = $moduleData->name;
            }
            if ($_REQUEST['tabmode'] == 'preview') {
                $this->pagemode = 'preview';
            }
            if ($_REQUEST['tabmode'] == 'MISPreview') {
                $this->pagemode = 'MISPreview';
            }
        }

        if (empty($this->module_id) && !empty($this->report_id)) {
            $advancedreport = DB::table('rsoft_advanced_report')->where('report_id', $this->report_id)->first();
            if ($advancedreport) {
                $this->module_id = $advancedreport->primarymodule;
                $this->module = DB::table('rsoft_modules')->where('id', $this->module_id)->value('name') ?? 'Not found';
            } else {
                $this->module_id = 0;
            }
        }

        $this->module_id = $this->module_id ?? 0;
        $module->reportdetails = DB::table('rsoft_advanced_report')->where('report_id', $this->report_id)->get();
        $module->picklistTrackings = DB::table('rsoft_advanced_report_picklisttracking')
            ->where('report_id', $this->report_id)
            ->where('module_id', $this->module_id)
            ->get();

        $roleid = Auth::user()->users_roles;
        $profileid = DB::table('rsoft_role2profile')->where('roleid', $roleid)->value('permissionprofileid');
        $module->allmodules = DB::table('rsoft_modules')
            ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
            ->whereNotIn('rsoft_modules.name', ['Comments', 'Updates', 'Reports', 'Imports', 'Exports', 'RecycleBin', 'Users', 'Advanced_report', 'Notifications', 'Pdf_makers', 'Ivr_providers', 'Emails', 'Email_Templates', 'SMS_Templates', 'Sms_notifiers', 'Calendars', 'Whatsapp_template'])
            ->where('rsoft_modules.status', 0)
            ->where('rsoft_profile2tab.profileid', $profileid)
            ->where('rsoft_profile2tab.permission', 1)
            ->orderBy('rsoft_modules.orderseqance')
            ->get();

        $module->relatedmodules = DB::table('rsoft_fieldmodulerel')
            ->join('rsoft_modules', 'rsoft_fieldmodulerel.relmodule', '=', 'rsoft_modules.name')
            ->where('rsoft_fieldmodulerel.module', 'Leads')
            ->get();

        $module->rolepermission = DB::table('rsoft_assigneduserpermissions')
            ->where('roleid', $roleid)
            ->get();

        $module->report_id = $this->report_id;
        $module->module_id = $this->module_id;
        $module->pagemode = $this->pagemode;
        $module->allmodulepermissions = $this->getUSerProfilePermissions();
        $module->picklist_fields = $this->module_id ? $this->getPicklistFields($this->module_id) : [];

        if ($this->module_id && $module->picklist_fields) {
            foreach ($module->picklist_fields as $picklist_field) {
                $values = $this->getPicklistValues($picklist_field['field_id'], $picklist_field['field_type'], $picklist_field['colname'], $picklist_field['module_name']);
                $module->picklist_data[$picklist_field['colname']] = ['label' => $picklist_field['label'], 'values' => $values];
                $this->picklistValues[$picklist_field['colname']] = $values;
            }
        }

        if ($this->picklistValues) {
            $this->emit('picklistValuesFetched', $this->picklistValues);
        }

    
        $module->filterData = $this->filterData;
        $module->searchQuery = $this->searchQuery;
        $module->searchfieldid = $this->searchfieldid;
        $module->searchfieldtype = $this->searchfieldtype;
        $module->searchcondtion = $this->searchcondtion;
        $module->searchfieldvalue = $this->searchfieldvalue;
        $module->searchcolname = $this->searchcolname;

        $this->loadTableContent($this->sidetabval, $this->module_id, $this->report_id, $module, '');
        $this->emit('select2Updated');
        $report = DB::table('rsoft_advanced_report')->where('report_id', $this->report_id)->first();
        $isEditPermitted = false;
        if ($report) 
            {
            $isEditPermitted = ($report->smownerid == Auth::id());
        }
        return view('Livewire.AdvancedReport.AdvancedReport',['Module'=>$module,'isEditPermitted'=>$isEditPermitted]);
    }

   
   public function AdvancedReportSave($report_id, $savemode, $reportName, $moduleType, $primarymodule, $submodules, $description, $datahandling, $piclistorder, $report_type)
    {
        $totalReports = DB::table('rsoft_advanced_report')->count() + 1;
        $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');

        $formData = [
            'report_name' => trim($reportName),
            'report_type' => $report_type,
            'description' => $description,
            'data_handling' => $datahandling,
            'smcreatorid' => Auth::user()->id,
            'smownerid' => Auth::user()->id,
            'createdtime' => $datetime,
            'picklist_order' => $piclistorder ? 1 : 0,
            'primarymodule' => $primarymodule,
            'report_moduletype' => $moduleType,
            'submodules' => json_encode($submodules),
            'report_seq' => $totalReports,
        ];

        if ($savemode == 'duplicate') {
            $reportdata = DB::table('rsoft_advanced_report')->where('report_id', $report_id)->first();
            if ($reportdata) {
                $formData['primarymodule'] = $reportdata->primarymodule;
                $formData['report_moduletype'] = $reportdata->report_moduletype;
                $formData['submodules'] = $reportdata->submodules;
                $formData['report_type'] = $reportdata->report_type;
                $formData['expand_detail_rows'] = $reportdata->expand_detail_rows;
                $formData['expand_group_count'] = $reportdata->expand_group_count;
                $formData['expand_sub_total'] = $reportdata->expand_sub_total;
                $formData['expand_grand_total'] = $reportdata->expand_grand_total;
                $formData['group_sort'] = $reportdata->group_sort; // Copy group_sort
            }

            $new_reportid = DB::table('rsoft_advanced_report')->insertGetId($formData);

            $tables = [
                'rsoft_advanced_report_columns',
                'rsoft_advanced_report_groupbycolumns',
                'rsoft_advanced_report_groupbyrows',
                'rsoft_advanced_report_aggregatecolumns',
                'rsoft_advanced_report_tablestyle',
                'rsoft_advanced_report_filter',
                'rsoft_advanced_report_sharing',
                'rsoft_advanced_report_formula',
                'rsoft_advanced_report_chartconfigure'
            ];

            foreach ($tables as $table) {
                $reportData = DB::table($table)->where('report_id', $report_id)->get();
                if ($reportData->count()) {
                    $reportDataArray = $reportData->toArray();
                    foreach ($reportDataArray as $key => $record) {
                        $record = (array) $record;
                        unset($record['report_id']);
                        unset($record['columns_id']);
                        unset($record['groupbycolumns_id']);
                        unset($record['groupbyrows_id']);
                        unset($record['aggregatecolumns_id']);
                        unset($record['filter_id']);
                        unset($record['tablestyle_id']);
                        unset($record['share_id']);
                        unset($record['schedule_id']);
                        unset($record['formula_id']);
                        unset($record['chart_id']);
                        $record['report_id'] = $new_reportid;
                        $reportDataArray[$key] = $record;
                    }
                    DB::table($table)->insert($reportDataArray);
                }
            }

            $this->report_id = $new_reportid;
            $this->loadTableContent($this->sidetabval, $primarymodule, $new_reportid);
        } elseif ($savemode == 'renamereport') {
            $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
            $formData = [
                'report_name' => trim($reportName),
                'description' => $description,
                'data_handling' => $datahandling,
                'modifiedby' => Auth::user()->id,
                'modifiedtime' => $datetime,
                'picklist_order' => $piclistorder,
            ];

            DB::table('rsoft_advanced_report')->where('report_id', $report_id)->update($formData);

            $this->page = 0;
            $this->perPage = 20;
            $this->allreportslist = [];
            $this->loadTableContent($this->sidetabval, $primarymodule, $report_id);
        } else {
        $formData = [
            'report_name' => trim($reportName),
            'report_type' => $report_type,
            'report_moduletype' => $moduleType,
            'primarymodule' => $primarymodule,
            'submodules' => implode(',', $submodules),
            'description' => $description,
            'data_handling' => $datahandling,
            'smcreatorid' => Auth::user()->id,
            'smownerid' => Auth::user()->id,
            'createdtime' => $datetime,
            'report_seq' => $totalReports,
            'picklist_order' => $piclistorder,
             'group_sort' => json_encode([]),
        ];

        $new_reportid = DB::table('rsoft_advanced_report')->insertGetId($formData);

        $tablestyle = [];
        $tablestyle['report_id'] = $new_reportid;
        $tablestyle['table_header_color'] = '#000000';
        $tablestyle['table_header_font'] = "Arial";
        $tablestyle['table_header_size'] = 14;
        $tablestyle['table_header_cell_color'] = '#ebf4ff';
        $tablestyle['table_footer_color'] = '#000000';
        $tablestyle['table_footer_font'] = "Arial";
        $tablestyle['table_footer_size'] = 14;
        $tablestyle['table_footer_cell_color'] = '#cfe4ff';
        $tablestyle['table_label_color'] = '#000000';
        $tablestyle['table_label_font'] = "Arial";
        $tablestyle['table_label_size'] = 13;
        $tablestyle['table_label_cell_color'] = '';
        $tablestyle['table_odd_row_color'] = '#ffffff';
        $tablestyle['table_even_row_color'] = '#ffffff';
        $tablestyle['table_border_color'] = '#000000';
        $tablestyle['table_border_design'] = 'All Borders';
        $tablestyle['table_header_b'] = 1;
        $tablestyle['table_footer_b'] = 1;
        DB::table('rsoft_advanced_report_tablestyle')->insertGetId($tablestyle);

        $Chartconfigure = [];
        $Chartconfigure['report_id'] = $new_reportid;
        $Chartconfigure['module_id'] = $primarymodule;
        $Chartconfigure['chart_title'] = '';
        $Chartconfigure['chart_type'] = 'BarVerticalChart';
        $Chartconfigure['x_axis_colname'] = '';
        $Chartconfigure['y_axis_colname'] = '';
        $Chartconfigure['calculation_colname'] = '';
        $Chartconfigure['chart_tooltip'] = '';
        $Chartconfigure['calculation'] = 'COUNT';
        $Chartconfigure['chart_title_fontcolor'] = '#000000';
        $Chartconfigure['chart_title_fontfamily'] = "Arial";
        $Chartconfigure['chart_title_fontsize'] = 14;
        $Chartconfigure['x_axis_fontfamily'] = "Arial";
        $Chartconfigure['x_axis_fontsize'] = "14";
        $Chartconfigure['x_axis_fontcolor'] = "#000000";
        $Chartconfigure['y_axis_fontfamily'] = "Arial";
        $Chartconfigure['y_axis_fontsize'] = "14";
        $Chartconfigure['y_axis_fontcolor'] = "#000000";
        $Chartconfigure['target_value'] = '';
        DB::table('rsoft_advanced_report_chartconfigure')->insertGetId($Chartconfigure);

        $this->report_id = $new_reportid;
        $editmode = ($report_type == 'Chart') ? 'ChartReport' : 'EditReport';
        $this->emit('ReportSaved', $new_reportid,$editmode);
        $this->sidetabval=$editmode;
        $this->loadTableContent($editmode, $primarymodule, $new_reportid);
       
    }
    $this->emit('hideModal');
}

    public function UpdateReportListOrder($sortedIDs,$modevals="")
    {   
        $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
        foreach ($sortedIDs as $index => $report_id) {
            if ($modevals == 'MISReports') {
            DB::table('rsoft_advanced_report') ->where('primarymodule', $report_id)->where('report_moduletype', 'MISReport') ->update([ 'report_seq' => $index + 1,'modifiedtime' => $datetime,'modifiedby' => Auth::user()->id ]);
            } else {
            DB::table('rsoft_advanced_report')->where('report_id', $report_id) ->where('report_moduletype', '!=', 'MISReport')->update(['report_seq' => $index + 1,'modifiedtime' => $datetime,'modifiedby' => Auth::user()->id ]);
            }
        }

        $this->page=0;
        $this->perPage=20;
        $this->allreportslist=[];
    }
    public function ExpandSave($report_id,$expand_detail_rows,$expand_group_count,$expand_sub_total,$expand_grand_total,$expand_tabular_chart){
    $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
    $isOwner = DB::table('rsoft_users')
        ->where('id', Auth::user()->id)
        ->value('admin'); 

    if ($isOwner == 1) {

                if($this->pagemode  === 'MISPreview'){
                    DB::table('mis_report_table')->where('report_id',$this->misCurrentReportId)->where('id',$this->currentReportId)->update(['mis_active'=>1,'mis_expand_detail_rows'=>$expand_detail_rows,'mis_expand_group_count'=>$expand_group_count,'mis_expand_sub_total'=>$expand_sub_total,'mis_expand_grand_total'=>$expand_grand_total]);
                }
                else{
                DB::table('rsoft_advanced_report')->where('report_id',$report_id)->update(['expand_detail_rows'=>$expand_detail_rows,'expand_group_count'=>$expand_group_count,'expand_sub_total'=>$expand_sub_total,'expand_grand_total'=>$expand_grand_total,'expand_tabular_chart'=>$expand_tabular_chart]);
                }
        // $this->UpdateModifiedInfo($report_id);

    } else {
        DB::table('rsoft_advanced_report_user_preferences')->updateOrInsert(
            [
                'report_id' => $report_id,
                'user_id'   => Auth::user()->id,
            ],
            [
                'expand_detail_rows'  => $expand_detail_rows,
                'expand_group_count'  => $expand_group_count,
                'expand_sub_total'    => $expand_sub_total,
                'expand_grand_total'  => $expand_grand_total,
                'expand_tabular_chart'=> $expand_tabular_chart,
                'updated_at'          => $datetime,
            ]
        );
    }
}
public function ExpandSaveUserPreference($report_id, $expand_detail_rows, $expand_group_count, $expand_sub_total, $expand_grand_total, $expand_tabular_chart)
{
    $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
    $userId = Auth::id();

    $effectiveReportId = ($this->pagemode === 'MISPreview' && !empty($this->currentReportId))? $this->currentReportId: $report_id;

    $reportCreatorId = DB::table('rsoft_advanced_report')
        ->where('report_id', $effectiveReportId)
        ->value('smcreatorid');
    if ($reportCreatorId == $userId) {
        if($this->pagemode  === 'MISPreview'){
            DB::table('mis_report_table')->where('report_id',$this->misCurrentReportId)->where('id',$this->currentReportId)->update(['mis_active'=>1,'mis_expand_detail_rows'=>$expand_detail_rows,'mis_expand_group_count'=>$expand_group_count,'mis_expand_sub_total'=>$expand_sub_total,'mis_expand_grand_total'=>$expand_grand_total]);
        }
        else{
        DB::table('rsoft_advanced_report')
            ->where('report_id', $report_id)
            ->update([
                'expand_detail_rows'   => $expand_detail_rows,
                'expand_group_count'   => $expand_group_count,
                'expand_sub_total'     => $expand_sub_total,
                'expand_grand_total'   => $expand_grand_total,
                'expand_tabular_chart' => $expand_tabular_chart
            ]);
        }
    } else {
       
    DB::table('rsoft_advanced_report_user_preferences')->updateOrInsert(
        [
            'report_id' => $report_id,
            'user_id'   => $userId,
        ],
        [
            'expand_detail_rows'  => $expand_detail_rows,
            'expand_group_count'  => $expand_group_count,
            'expand_sub_total'    => $expand_sub_total,
            'expand_grand_total'  => $expand_grand_total,
            'expand_tabular_chart'=> $expand_tabular_chart,
            'updated_at'          => $datetime,
        ]
    );
    }
}




    public function SharedReportSave()
    {
        $share_type='public';
        if($this->privatevisible=='private'){
            $share_type='private';
        }
        $share_width='users';
        if($this->share_widthroles=='roles'){
            $share_width=$this->share_widthroles;
        }

        $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
        if( $share_type=='public'){
            $formData = [
                'report_id' => $this->report_id,
                'share_type' => $share_type,
                'share_width' => Null,
                'share_width_user' => Null,
                'share_width_role' => Null,
                'share_permission' => $this->share_permission,
                'share_createdtime' =>$datetime ,
                'share_createdby' =>Auth::user()->id,
                'share_modifiedtime' =>$datetime ,
                 'share_modifiedby' =>Auth::user()->id,
            ];
        }else{
            $formData = [
                'report_id' => $this->report_id,
                'share_type' =>  $share_type,
                'share_width' => $share_width,
                'share_width_user' => Null,
                'share_width_role' =>Null,
                'share_permission' => $this->share_permission,
                'share_createdtime' =>$datetime ,
                'share_createdby' =>Auth::user()->id,
                'share_modifiedtime' =>$datetime ,
                'share_modifiedby' =>Auth::user()->id,
                
            ];
        }

        
         dd( $formData);
        // $this->UpdateModifiedInfo($report_id);
        //$shareid = DB::table('rsoft_advanced_report_sharing')->insertGetId($formData);
       
    }


    public function SaveFilter($filter_id,$report_id,$fieldid,$colname,$fieldtype,$selectedOperator,$selectedValue,$timeformat,$dateformat)
    {
       
        $FilterHelpers = (new FilterHelpers())->filteremptyvaluecon();
        $dateValueCondition = (new FilterHelpers())->dateValueCondition();
        //$dateformat = (new User())->getCurrentUserDateFormat();
        $block2ConValueparms = [];
        $block2emptyConValue = (new FilterHelpers)->block2emptyValueCondition($block2ConValueparms);

        // $timeformat = 'H:i:s';
        // if ((new User())->getCurrentUserTimeFormat() == '12 hours') {
        //     $timeformat = 'h:i:s A';
        // }
        $dateandtimeformat = $dateformat.' '.$timeformat;
        
        if(is_array($selectedValue) && in_array($fieldtype,[3,9,13,14,15,29,30,31,21,23])){
            $selectedValue=implode('#',$selectedValue);
        }elseif(in_array($fieldtype,[16,17,19]) && $selectedValue !=''){
            $withoutDateValues = ['less_than_days_ago', 'more_than_days_ago', 'in_less_than', 'in_more_than', 'daysago', 'days_later','less_than_hours_before','less_than_hours_later','more_than_hours_before','more_than_hours_later'];

            // $timeformat = 'H:i:s';
            // if (Auth::user()->users_timeformat == '12 hours') {
            //     $timeformat = 'h:i:s A';
            // }
           // $dateformat = Auth::user()->users_dateformat;
            $dateandtimeformat = $dateformat.' '.$timeformat;
            if(trim($selectedValue)){
                if (in_array($selectedOperator, $block2emptyConValue)) {
                    $selectedValue = trim($selectedValue);
                } else {
                    if (in_array($selectedOperator, $withoutDateValues)) {
                        $selectedValue = trim($selectedValue);
                    } elseif ($selectedOperator == 'between') {
                        $dates = explode(',', trim($selectedValue));
                        $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateandtimeformat,'Y-m-d H:i:s'); 
                        $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateandtimeformat,'Y-m-d H:i:s');
                        $selectedValue = $fullFormat1.','.$fullFormat2;
                    } elseif (in_array($selectedOperator, $dateValueCondition) ) {
                        $dates = explode(',', trim($selectedValue));
                        $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateformat,'Y-m-d');
                        $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateformat,'Y-m-d');
                        $selectedValue = $fullFormat1.','.$fullFormat2;
                    } elseif (array_key_exists($selectedOperator, $FilterHelpers)) {
                        $selectedValue = (new User())->convertToUtc(trim($selectedValue),$dateformat,'Y-m-d H:i:s');
                    } else {
                        $fullFormat = (new User())->convertToUtc(trim($selectedValue),$dateandtimeformat,'Y-m-d H:i:s');
                        $selectedValue = $fullFormat;
                    }
                }
            }
        }elseif ($fieldtype == 7) {
            $withoutDateValues = ['less_than_days_ago', 'more_than_days_ago', 'in_less_than', 'in_more_than', 'daysago', 'days_later','less_than_hours_before','less_than_hours_later','more_than_hours_before','more_than_hours_later'];
            //$dateandtimeformat = Auth::user()->users_dateformat;
            $dateandtimeformat = $dateformat;
            if(trim($selectedValue)){
                if (in_array($selectedOperator, $block2emptyConValue)) {
                    $selectedValue = trim($selectedValue);
                } else {
                    if (in_array($selectedOperator, $withoutDateValues)) {
                        $selectedValue =  trim($selectedValue);
                    } elseif ($selectedOperator == 'between') {
                        $dates = explode(',', trim($selectedValue));
                        $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateandtimeformat,'Y-m-d');
                        $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateandtimeformat,'Y-m-d');
                        $selectedValue = $fullFormat1.','.$fullFormat2;
                    } elseif (in_array($selectedOperator, $dateValueCondition) ) {
                        $dates = explode(',', trim($selectedValue));
                        $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateandtimeformat,'Y-m-d');
                        $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateandtimeformat,'Y-m-d');
                        $selectedValue = $fullFormat1.','.$fullFormat2;
                    } elseif (array_key_exists($selectedOperator, $FilterHelpers)) {
                        $selectedValue = (new User())->convertToUtc(trim($selectedValue),$dateandtimeformat,'Y-m-d');
                    } else {
                        $fullFormat = (new User())->convertToUtc(trim($selectedValue),$dateandtimeformat,'Y-m-d');
                        $selectedValue = $fullFormat;
                    }
                }
            }
            
        } elseif ($fieldtype == 20) {
            if(trim($selectedValue)){
                // $timeformat = 'H:i:s';
                // if (Auth::user()->users_timeformat == '12 hours') {
                //     $timeformat = 'h:i:s A';
                // }
                $fullFormat = (new User())->convertToUtc(trim($selectedValue),$timeformat,'H:i:s');
                $selectedValue = $fullFormat;
            }
        }
       
        if($filter_id==''){
            $formData = [
                'report_id' => $report_id,
                'coloumn_name' => $colname,
                'fieldid' => $fieldid,
                'field_type' => $fieldtype,
                'operator' => $selectedOperator,
                'value' =>$selectedValue,
                'logic' =>'AND',
            ];
            DB::table('rsoft_advanced_report_filter')->insertGetId($formData);
        }else{
            $formData = [
                'report_id' => $report_id,
                'coloumn_name' => $colname,
                'fieldid' => $fieldid,
                'field_type' => $fieldtype,
                'operator' => $selectedOperator,
                'value' =>$selectedValue,
            ];
            DB::table('rsoft_advanced_report_filter')->where('filter_id',$filter_id)->update($formData);
        }
        $this->UpdateModifiedInfo($report_id);
        $this->emit('hideModal');
    }
    public function DeleteFilter($filter_id,$report_id)
    {
        DB::table('rsoft_advanced_report_filter')->where('filter_id',$filter_id)->delete();
        $this->UpdateModifiedInfo($report_id);
    }
    public function SaveLogic($report_id,$logic)
    {   
        
        $logic=explode(' ',trim($logic));
        $finalarray = [];
        for ($i = 0; $i < count($logic); $i += 2) {
            if (isset($logic[$i]) && isset($logic[$i + 1])) {
                $finalarray[$logic[$i]] = $logic[$i + 1];
            }
        }
       
        if(count($finalarray)){
            $filters = DB::table('rsoft_advanced_report_filter')
            ->where('report_id',$report_id)->where('fieldid','!=','')
            ->orderBy('filter_id', 'asc')
            ->get();
            foreach ($filters as $index => $filter) {
                if($index==0){
                    $logic = $finalarray[($index+1)];
                    DB::table('rsoft_advanced_report_filter')
                        ->where('filter_id', $filter->filter_id)
                        ->update(['logic' =>'AND']);
                }else{
                    $logic = $finalarray[$index];
                    DB::table('rsoft_advanced_report_filter')
                        ->where('filter_id', $filter->filter_id)
                        ->update(['logic' => $logic]);
                }
                
            }
        }
        $this->UpdateModifiedInfo($report_id);
    }

   public function SaveSchdule($schdule_id, $report_id, $module_id, $schedulename, $reportformat, $frequency, $schduletime, $weeklydays, $monthlyradio, $monthdate, $userstimezone, $deliverymethod, $scheduleSendToContactsJson, $scheduletemplate, $crmradio, $crmcontacts, $cnt_message, $scheduleSendToEmailsJson, $subject_email, $email_des,$rsoft_whatsapp = 0) {
        // Verify user has permission to the report
        $report = DB::table('rsoft_advanced_report')
            ->where('report_id', $report_id)
            ->where(function ($query) {
                $query->where('smownerid', Auth::user()->id)
                      ->orWhereExists(function ($subQuery) {
                          $subQuery->select(DB::raw(1))
                                   ->from('rsoft_advanced_report_sharing')
                                   ->whereColumn('rsoft_advanced_report_sharing.report_id', 'rsoft_advanced_report.report_id')
                                   ->where('share_width_user', Auth::user()->id)
                                   ->where('share_permission', '<>', 4);
                      });
            })
            ->first();
    
        if (!$report) {
            throw new \Exception('Unauthorized access to report for scheduling');
        }
    
        // If updating, verify the user owns the schedule
        if (!empty($schdule_id)) {
            $schedule = DB::table('rsoft_advanced_report_schedule')
                ->where('schedule_id', $schdule_id)
                ->where('schedule_createdby', Auth::user()->id)
                ->first();
            
            if (!$schedule) {
                throw new \Exception('Unauthorized access to update this schedule');
            }
        }
    
        $request['scheduleTime'] = $schduletime;
        $request['frequency'] = $frequency;
        $request['weeklydays'] = $weeklydays;
        $request['monthlyradio'] = $monthlyradio;
        $request['monthdate'] = $monthdate;
        $executetime = $this->getExecutionTime($request);
        $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
        $timeformat = (new User())->getCurrentUserTimeFormat() == '12 hours' ? 'h:i:s A' : 'H:i:s';
        $schduletime = (new User())->convertToUtc(trim($schduletime), $timeformat, 'H:i:s');
        // Prepare form data for insertion/updating
        if ($deliverymethod == 'Email') {
            $scheduletemplate = '';
            $cnt_message = '';
        } else {
            $subject_email = '';
            $email_des = '';
        }
    
        $formData = [
            'report_id' => $report_id,
            'module_id' => $module_id,
            'schedule_name' => $schedulename,
            'schedule_report_format' => $reportformat,
            'schedule_frequency' => $frequency,
            'schedule_days' => $weeklydays,
            'schedule_sendtocontacts' => $scheduleSendToContactsJson,
            'schedule_sendtoemails' => $scheduleSendToEmailsJson,
            'schedule_monthlyradio' => $monthlyradio,
            'schedule_monthdate' => $monthdate,
            'schedule_time' => $schduletime,
            'schedule_timezone' => $userstimezone,
            'schedule_deliverymethod' => $deliverymethod,
            'schedule_template' => $scheduletemplate,
            'schedule_crmcontactstatus' => $crmradio,
            'schedule_crmcontacts' => $crmcontacts,
            'schedule_messagecontant' => $cnt_message,
            'schedule_emailsubject' => $subject_email,
            'schedule_emaildescription' => $email_des,
            'schedule_executiontime' => $executetime,
            'schedule_retrycount' => 0,
            'rsoft_email'   => isset($request['rsoft_email']) ? (int)$request['rsoft_email'] : 0,
            'rsoft_whatsapp' => $rsoft_whatsapp,

        ];
    
        if (empty($schdule_id)) {
            $formData1 = [
                'schedule_createdtime' => $datetime,
                'schedule_createdby' => Auth::user()->id,
            ];
            $formData = array_merge($formData, $formData1);
            DB::table('rsoft_advanced_report_schedule')->insert($formData);
        } else {
            $formData1 = [
                'schedule_modifiedtime' => $datetime,
                'schedule_modifiedby' => Auth::user()->id,
            ];
            $formData = array_merge($formData, $formData1);
            DB::table('rsoft_advanced_report_schedule')->where('schedule_id', $schdule_id)->update($formData);
        }
        $this->UpdateModifiedInfo($report_id);
    }

    

    
    public function InactiveSchduleStatus($inactiveid, $activeStatus, $mode,$report_id){
        $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
        if($mode=='allschdule'){
            DB::table('rsoft_advanced_report_schedule')->where('report_id',$inactiveid)->update(['schedule_status'=>$activeStatus,'schedule_modifiedtime'=> $datetime,'schedule_modifiedby'=>Auth::user()->id]);
        }elseif($mode =="Misreport"){
           DB::table('rsoft_advanced_report_schedule')->where('report_id',$report_id)->update(['schedule_status'=>$activeStatus,'schedule_modifiedtime'=> $datetime,'schedule_modifiedby'=>Auth::user()->id]);
        }else{
            DB::table('rsoft_advanced_report_schedule')->where('schedule_id',$inactiveid)->update(['schedule_status'=>$activeStatus,'schedule_modifiedtime'=> $datetime,'schedule_modifiedby'=>Auth::user()->id]);
        }
        $this->togglereport_id=$report_id;
        $this->togglereportmode=$mode;
    }
    public function DeleteSchdule($deleteid,$report_id,$mode=''){
        if($mode=='allschdule'){
            DB::table('rsoft_advanced_report_schedule')->where('report_id',$deleteid)->delete();
        }else{
            DB::table('rsoft_advanced_report_schedule')->where('schedule_id',$deleteid)->delete();
        }
        $this->togglereport_id=$report_id;
        $this->togglereportmode=$mode;
    }

     public function UpdateSchduleListOrder($sortedIDs){

        $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
        foreach ($sortedIDs as $index => $report_id) {
            DB::table('rsoft_advanced_report_schedule')->where('report_id', $report_id)->update(['schedule_seq' => $index + 1,'schedule_modifiedtime'=> $datetime,'schedule_modifiedby'=>Auth::user()->id]);
        }
    }

    public function SaveShare($share_id,$report_id,$module_id,$share_type,$share_permission,$userPermissions,$modes="")
    {

        $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
        $formDatas =[];
        

        if (($share_type == 'public' && empty($share_permission)) || 
            ($share_type == 'private' && empty($userPermissions))) {
        
            DB::table('rsoft_advanced_report_sharing')->where('report_id', $report_id)->delete();
            $this->UpdateModifiedInfo($report_id);
            $this->emit('hideModal');
            return;
        }
        
        $shareseqdata = DB::table('rsoft_advanced_report_sharing')->where('report_id', $report_id)->where('share_seq', '!=', '')->limit(1)->pluck('share_seq');
        $shareseq=1;
        $modifiedtime=Null;
        $userid=Null;
        if ($shareseqdata->isNotEmpty()) {
            $shareseq=$shareseqdata[0];
            $modifiedtime=$datetime;
            $userid=Auth::user()->id;
        }else{
            $shareseqdata = DB::table('rsoft_advanced_report_sharing')->orderBy('share_seq', 'desc')->limit(1)->pluck('share_seq');
            if ($shareseqdata->isNotEmpty()) {
             $shareseq=$shareseqdata[0];
            }
        }
       
        if($share_type=='public'){
            if($share_permission != 4 && !empty($share_permission)) {
                $formDatas = [
                    'report_id' => $report_id,
                    'module_id' => $module_id,
                    'share_type' => $share_type,
                    'share_width' => 'users',
                    'share_width_user' => 0,
                    'share_permission' =>$share_permission,
                    'share_createdtime' =>$datetime ,
                    'share_createdby' =>Auth::user()->id,
                    'share_seq' =>$shareseq,
                    'share_modifiedtime' =>$modifiedtime ,
                    'share_modifiedby' =>$userid,
                    'share_report_type' =>$modes,
                ];
            }
        }else{
            foreach($userPermissions as $key => $value) {
                if($value['permission'] != 4 && !empty($value['permission'])) {
                    $formData = [
                        'report_id' => $report_id,
                        'module_id' => $module_id,
                        'share_type' => $share_type,
                        'share_width' => $value['mode'],
                        'share_width_user' => $key,
                        'share_permission' => $value['permission'],
                        'share_createdtime' => $datetime,
                        'share_createdby' => Auth::user()->id,
                        'share_seq' =>$shareseq,
                        'share_modifiedtime' =>$modifiedtime ,
                        'share_modifiedby' =>$userid,
                        'share_report_type' =>$modes,
                    ];
                    $formDatas[] = $formData;
                }
            }
        }

        DB::table('rsoft_advanced_report_sharing')->where('report_id', $report_id)->delete();
       // if($share_id==''){
    
        if (!empty($formDatas)) {
         DB::table('rsoft_advanced_report_sharing')->insert($formDatas);
        // }else{
        //     DB::table('rsoft_advanced_report_sharing')->where('share_id',$share_id)->update($formDatas);
        // }
        }  
        $this->UpdateModifiedInfo($report_id);
        $this->emit('hideModal');
    }

    public function SaveTableStyle($report_id,$TableStyle){
        DB::table('rsoft_advanced_report_tablestyle')->where('report_id',$report_id)->update($TableStyle);
        $this->UpdateModifiedInfo($report_id);
        $this->emit('hideModal');
    }
    
    public function resetTableStylePopup($report_id){
        $tablestyle=[];
        $tablestyle['table_header_color']='#000000';
        $tablestyle['table_header_font']="Arial";
        $tablestyle['table_header_size']=14;
        $tablestyle['table_header_cell_color']='#ebf4ff';
        $tablestyle['table_footer_color']='#000000';
        $tablestyle['table_footer_font']="Arial";
        $tablestyle['table_footer_size']=14;
        $tablestyle['table_footer_cell_color']='#cfe4ff';
        $tablestyle['table_label_color']='#000000';
        $tablestyle['table_label_font']="Arial";
        $tablestyle['table_label_size']=13;
        $tablestyle['table_label_cell_color']='';
        $tablestyle['table_odd_row_color']='#ffffff';
        $tablestyle['table_even_row_color']='#ffffff';
        $tablestyle['table_border_color']='#000000';
        $tablestyle['table_border_design']='All Borders';
        $tablestyle['table_header_b'] = 1;
        $tablestyle['table_header_u'] = 0;
        $tablestyle['table_header_i'] = 0;
        $tablestyle['table_footer_b'] = 1;
        $tablestyle['table_footer_u'] = 0;
        $tablestyle['table_footer_i'] = 0;
        DB::table('rsoft_advanced_report_tablestyle')->where('report_id',$report_id)->update($tablestyle);

    }
    public function PreviewFilterSearch($value, $report_id, $module_id, $fieldid, $colname = null, $fieldtype = null, $condtion = null, $fieldvalue = null)
{
    if (is_array($fieldid)) {
        $filterData = $fieldid;
        $query = '';
        $preimgquery = '';
        $logic = ' AND '; 
        $individualQueries = [];

        foreach ($filterData as &$filter) {
            if (empty($filter['fieldid']) || empty($filter['condition'])) {
                continue;
            }
            
            $singleFieldid = $filter['fieldid'];
            $singleColname = $filter['colname'] ?? '';
            $singleFieldtype = $filter['fieldtype'] ?? '';
            $singleCondition = $filter['condition'];
            $singleFieldvalue = $filter['fieldvalue'] ?? '';

            if (in_array($singleFieldtype, [3, 9, 29, 30, 31, 21, 23])) {
                if (!empty($singleFieldvalue) && strpos($singleFieldvalue, ',') !== false) {
                    $singleFieldvalue = str_replace(',', '#', $singleFieldvalue);
                    $filter['fieldvalue'] = $singleFieldvalue;
                }
            }
        }
        unset($filter);
        
        foreach ($filterData as $filter) {
            if (empty($filter['fieldid']) || empty($filter['condition'])) {
                continue;
            }
            
            $singleFieldid = $filter['fieldid'];
            $singleColname = $filter['colname'] ?? '';
            $singleFieldtype = $filter['fieldtype'] ?? '';
            $singleCondition = $filter['condition'];
            $singleFieldvalue = $filter['fieldvalue'] ?? '';

            $fieldData = DB::select("SELECT field_type,name_db,name FROM rsoft_module_fields INNER JOIN rsoft_modules ON rsoft_modules.id  = rsoft_module_fields.module  WHERE colname='".$singleColname."' AND rsoft_module_fields.id='".$singleFieldid."' AND active=1"); 
            
            if(count($fieldData)){
                $FilterHelpers = (new FilterHelpers())->filteremptyvaluecon();
                $dateValueCondition = (new FilterHelpers())->dateValueCondition();
                $dateformat = (new User())->getCurrentUserDateFormat();
                $timeformat = 'H:i:s';
                if ((new User())->getCurrentUserTimeFormat() == '12 hours') {
                    $timeformat = 'h:i:s A';
                }
                $dateandtimeformat = $dateformat.' '.$timeformat;
                
                if(in_array($singleFieldtype,[16,17,19]) && $singleFieldvalue !=''){
                    $withoutDateValues = ['less_than_days_ago', 'more_than_days_ago', 'in_less_than', 'in_more_than', 'daysago', 'days_later','less_than_hours_before','less_than_hours_later','more_than_hours_before','more_than_hours_later'];

                    $timeformat = 'H:i:s';
                    if (Auth::user()->users_timeformat == '12 hours') {
                        $timeformat = 'h:i:s A';
                    }
                    $dateformat = Auth::user()->users_dateformat;
                    $dateandtimeformat = $dateformat.' '.$timeformat;
                    if(trim($singleFieldvalue)){
                        if (in_array($singleCondition, $withoutDateValues)) {
                            $singleFieldvalue = trim($singleFieldvalue);
                        } elseif ($singleCondition == 'between') {
                            $dates = explode(',', trim($singleFieldvalue));
                            $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateandtimeformat,'Y-m-d H:i:s'); 
                            $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateandtimeformat,'Y-m-d H:i:s');
                            $singleFieldvalue = $fullFormat1.','.$fullFormat2;
                        } elseif (in_array($singleCondition, $dateValueCondition) ) {
                            $dates = explode(',', trim($singleFieldvalue));
                            $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateformat,'Y-m-d');
                            $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateformat,'Y-m-d');
                            $singleFieldvalue = $fullFormat1.','.$fullFormat2;
                        } elseif (array_key_exists($singleCondition, $FilterHelpers)) {
                            $singleFieldvalue = (new User())->convertToUtc(trim($singleFieldvalue),$dateformat,'Y-m-d H:i:s');
                        } else {
                            $fullFormat = (new User())->convertToUtc(trim($singleFieldvalue),$dateandtimeformat,'Y-m-d H:i:s');
                            $singleFieldvalue = $fullFormat;
                        }
                    }
                }elseif ($singleFieldtype == 7) {
                    $withoutDateValues = ['less_than_days_ago', 'more_than_days_ago', 'in_less_than', 'in_more_than', 'daysago', 'days_later','less_than_hours_before','less_than_hours_later','more_than_hours_before','more_than_hours_later'];
                    $dateandtimeformat = Auth::user()->users_dateformat;
                    if(trim($singleFieldvalue)){
                        if (in_array($singleCondition, $withoutDateValues)) {
                            $singleFieldvalue =  trim($singleFieldvalue);
                        } elseif ($singleCondition == 'between') {
                            $dates = explode(',', trim($singleFieldvalue));
                            $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateandtimeformat,'Y-m-d');
                            $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateandtimeformat,'Y-m-d');
                            $singleFieldvalue = $fullFormat1.','.$fullFormat2;
                        } elseif (in_array($singleCondition, $dateValueCondition) ) {
                            $dates = explode(',', trim($singleFieldvalue));
                            $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateandtimeformat,'Y-m-d');
                            $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateandtimeformat,'Y-m-d');
                            $singleFieldvalue = $fullFormat1.','.$fullFormat2;
                        } elseif (array_key_exists($singleCondition, $FilterHelpers)) {
                            $singleFieldvalue = (new User())->convertToUtc(trim($singleFieldvalue),$dateandtimeformat,'Y-m-d');
                        } else {
                            $fullFormat = (new User())->convertToUtc(trim($singleFieldvalue),$dateandtimeformat,'Y-m-d');
                            $singleFieldvalue = $fullFormat;
                        }
                    }
                    
                } elseif ($singleFieldtype == 20) {
                    if(trim($singleFieldvalue)){
                        $timeformat = 'H:i:s';
                        if (Auth::user()->users_timeformat == '12 hours') {
                            $timeformat = 'h:i:s A';
                        }
                        $fullFormat = (new User())->convertToUtc(trim($singleFieldvalue),$timeformat,'H:i:s');
                        $singleFieldvalue = $fullFormat;
                    }
                }

                $signgeneratorarray = [];
                $signgeneratorarray['columnname'] = $singleColname;

                if ($singleFieldtype == 13 || $singleFieldtype == 14 || ($singleFieldtype == 15 && $singleColname == 'smownerid') || $singleFieldtype == 16 || $singleFieldtype == 17) {
                    $signgeneratorarray['columnname'] = 'rsoft_crmentity_'.trim($fieldData[0]->name_db).'.'.$singleColname;
                    $signgeneratorarray['fieldname'] = 'rsoft_user_'.trim($fieldData[0]->name_db).'_'.$singleColname;
                }

                $signgeneratorarray['comparator'] = $singleCondition;
                $signgeneratorarray['value'] = $singleFieldvalue;
                $signgeneratorarray['fieldtype'] = $singleFieldtype;
                $signgeneratorarray['modulename'] = $fieldData[0]->name;
                $condition_signwithvalue = (new SignGenerator())->Gettingfilterconditionsign($signgeneratorarray);

                if ($condition_signwithvalue['return_flag'] == 1 && ! empty($condition_signwithvalue['return_condition'])) {
                    $individualQueries[] = "(".$condition_signwithvalue['return_condition'].')';
                }

                if($singleFieldtype == 12) {
                    $sql = "SELECT *  FROM rsoft_advanced_report_filter  WHERE  fieldid='".$singleFieldid."' AND rsoft_advanced_report_filter.report_id ='".$report_id."'";
                    $Records = DB::select($sql);
                    if(count($Records)==0){
                        $tablename_db=$fieldData[0]->name_db;
                        $preimgquery .= " LEFT JOIN  rsoft_attachments as  rsoft_attachments_$singleColname   ON FIND_IN_SET(rsoft_attachments_$singleColname.attachments_id,$tablename_db.$singleColname) > 0 ";
                    }
                }
            }
        }

        if (!empty($individualQueries)) {
            $query = implode($logic, $individualQueries);
        }

        $this->filterData = $filterData;
        $this->searchQuery = $query;
        $this->preimgquery = $preimgquery;
        
        if (!empty($filterData)) {
            $firstFilter = $filterData[0];
            $this->searchfieldid = $firstFilter['fieldid'];
            $this->searchfieldtype = $firstFilter['fieldtype'] ?? '';
            $this->searchcondtion = $firstFilter['condition'];
            $this->searchfieldvalue = $firstFilter['fieldvalue'] ?? '';
            $this->searchcolname = $firstFilter['colname'] ?? '';
        }
        
        if($value !='previewexport'){
            if($value =='preview'){
                $this->previewpage=0;
                $this->previewreportslist=[];
            }elseif($value =='clearpreview'){
                $this->previewpage=0;
                $this->previewreportslist=[];
                $this->searchQuery= '';
                $this->filterData = []; 
                $this->searchfieldid='';
                $this->searchfieldtype='';
                $this->searchcondtion='';
                $this->searchfieldvalue='';
                $this->searchcolname='';
            }

            if ($this->tabmode === 'MISPreview') {
                $this->loadTableContent('MISPreview', $module_id, $this->misCurrentReportId);
            }
            else{
            $this->loadTableContent('preview',$module_id,$report_id);
            }
        }
        return; 
    }

        $query='';
        $preimgquery='';
        $fieldData = DB::select("SELECT field_type,name_db,name FROM rsoft_module_fields INNER JOIN rsoft_modules ON rsoft_modules.id  = rsoft_module_fields.module  WHERE colname='".$colname."' AND rsoft_module_fields.id='".$fieldid."' AND active=1"); 
        if(count($fieldData)){

            $FilterHelpers = (new FilterHelpers())->filteremptyvaluecon();
            $dateValueCondition = (new FilterHelpers())->dateValueCondition();
            $dateformat = (new User())->getCurrentUserDateFormat();
            $timeformat = 'H:i:s';
            if ((new User())->getCurrentUserTimeFormat() == '12 hours') {
                $timeformat = 'h:i:s A';
            }
            $dateandtimeformat = $dateformat.' '.$timeformat;
            
            if(in_array($fieldtype,[16,17,19]) && $fieldvalue !=''){
                $withoutDateValues = ['less_than_days_ago', 'more_than_days_ago', 'in_less_than', 'in_more_than', 'daysago', 'days_later','less_than_hours_before','less_than_hours_later','more_than_hours_before','more_than_hours_later'];

                $timeformat = 'H:i:s';
                if (Auth::user()->users_timeformat == '12 hours') {
                    $timeformat = 'h:i:s A';
                }
                $dateformat = Auth::user()->users_dateformat;
                $dateandtimeformat = $dateformat.' '.$timeformat;
                if(trim($fieldvalue)){
                    if (in_array($condtion, $withoutDateValues)) {
                        $fieldvalue = trim($fieldvalue);
                    } elseif ($condtion == 'between') {
                        $dates = explode(',', trim($fieldvalue));
                        $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateandtimeformat,'Y-m-d H:i:s'); 
                        $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateandtimeformat,'Y-m-d H:i:s');
                        $fieldvalue = $fullFormat1.','.$fullFormat2;
                    } elseif (in_array($condtion, $dateValueCondition) ) {
                        $dates = explode(',', trim($fieldvalue));
                        $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateformat,'Y-m-d');
                        $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateformat,'Y-m-d');
                        $fieldvalue = $fullFormat1.','.$fullFormat2;
                    } elseif (array_key_exists($condtion, $FilterHelpers)) {
                        $fieldvalue = (new User())->convertToUtc(trim($fieldvalue),$dateformat,'Y-m-d H:i:s');
                    } else {
                        $fullFormat = (new User())->convertToUtc(trim($fieldvalue),$dateandtimeformat,'Y-m-d H:i:s');
                        $fieldvalue = $fullFormat;
                    }
                }
            }elseif ($fieldtype == 7) {
                $withoutDateValues = ['less_than_days_ago', 'more_than_days_ago', 'in_less_than', 'in_more_than', 'daysago', 'days_later','less_than_hours_before','less_than_hours_later','more_than_hours_before','more_than_hours_later'];
                $dateandtimeformat = Auth::user()->users_dateformat;
                if(trim($fieldvalue)){
                    if (in_array($condtion, $withoutDateValues)) {
                        $fieldvalue =  trim($fieldvalue);
                    } elseif ($condtion == 'between') {
                        $dates = explode(',', trim($fieldvalue));
                        $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateandtimeformat,'Y-m-d');
                        $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateandtimeformat,'Y-m-d');
                        $fieldvalue = $fullFormat1.','.$fullFormat2;
                    } elseif (in_array($condtion, $dateValueCondition) ) {
                        $dates = explode(',', trim($fieldvalue));
                        $fullFormat1 = (new User())->convertToUtc(trim($dates[0]),$dateandtimeformat,'Y-m-d');
                        $fullFormat2 = (new User())->convertToUtc(trim($dates[1]),$dateandtimeformat,'Y-m-d');
                        $fieldvalue = $fullFormat1.','.$fullFormat2;
                    } elseif (array_key_exists($condtion, $FilterHelpers)) {
                        $fieldvalue = (new User())->convertToUtc(trim($fieldvalue),$dateandtimeformat,'Y-m-d');
                    } else {
                        $fullFormat = (new User())->convertToUtc(trim($fieldvalue),$dateandtimeformat,'Y-m-d');
                        $fieldvalue = $fullFormat;
                    }
                }
                
            } elseif ($fieldtype == 20) {
                if(trim($fieldvalue)){
                    $timeformat = 'H:i:s';
                    if (Auth::user()->users_timeformat == '12 hours') {
                        $timeformat = 'h:i:s A';
                    }
                    $fullFormat = (new User())->convertToUtc(trim($fieldvalue),$timeformat,'H:i:s');
                    $fieldvalue = $fullFormat;
                }
            }

            $logic = ' ';
            $signgeneratorarray = [];
            $signgeneratorarray['columnname'] = $colname;

            if ($fieldtype == 13 || $fieldtype == 14 || ($fieldtype == 15 && $colname == 'smownerid') || $fieldtype == 16 || $fieldtype == 17) {
                $signgeneratorarray['columnname'] = 'rsoft_crmentity_'.trim($fieldData[0]->name_db).'.'.$colname;
                $signgeneratorarray['fieldname'] = 'rsoft_user_'.trim($fieldData[0]->name_db).'_'.$colname;
            }elseif($fieldtype == 3 || $fieldtype == 9 || $fieldtype == 29 || $fieldtype == 30 || $fieldtype == 31 || $fieldtype == 21 || $fieldtype == 23 ){
                $fieldvalue=str_replace(',','#',$fieldvalue);
            }

            $signgeneratorarray['comparator'] = $condtion;
            $signgeneratorarray['value'] = $fieldvalue;
            $signgeneratorarray['fieldtype'] = $fieldtype;
            $signgeneratorarray['modulename'] = $fieldData[0]->name;
            $condition_signwithvalue = (new SignGenerator())->Gettingfilterconditionsign($signgeneratorarray);

            if ($condition_signwithvalue['return_flag'] == 1 && ! empty($condition_signwithvalue['return_condition'])) {
                $query.=$logic." (".$condition_signwithvalue['return_condition'].')';
            }
            $query = '('.$query.') ';
            if($fieldtype == 12) {
                $sql = "SELECT *  FROM rsoft_advanced_report_filter  WHERE  fieldid='".$fieldid."' AND rsoft_advanced_report_filter.report_id ='".$report_id."'";
                $Records = DB::select($sql);
                if(count($Records)==0){
                    $tablename_db=$fieldData[0]->name_db;
                    $preimgquery .= " LEFT JOIN  rsoft_attachments as  rsoft_attachments_$colname   ON FIND_IN_SET(rsoft_attachments_$colname.attachments_id,$tablename_db.$colname) > 0 ";
                }
            }
        }

        $this->searchQuery= $query;
        $this->preimgquery= $preimgquery;
        $this->searchfieldid=$fieldid;
        $this->searchfieldtype=$fieldtype;
        $this->searchcondtion=$condtion;
        $this->searchfieldvalue=$fieldvalue;
        $this->searchcolname=$colname;
        if($value !='previewexport'){
            if($value =='preview'){
                $this->previewpage=0;
                $this->previewreportslist=[];
            }elseif($value =='clearpreview'){
                $this->previewpage=0;
                $this->previewreportslist=[];
                $this->searchQuery= '';
                $this->searchfieldid='';
                $this->searchfieldtype='';
                $this->searchcondtion='';
                $this->searchfieldvalue='';
                $this->searchcolname='';
            }
             if ($this->tabmode === 'MISPreview') {
                $this->loadTableContent('MISPreview', $module_id, $this->misCurrentReportId);
            }
            else{
            $this->loadTableContent('preview',$module_id,$report_id);
            }
        }
    }

    public function loadMoreReports($filtermode,$value,$searchValue='',$column_name='',$sortmode='',$module_id='',$allreportslist='')
    {
        if($searchValue !=''){
            if($filtermode=='search' || $filtermode=='sort'){
                $this->page=0;
                $this->perPage=20;
                $this->allreportslist=[];
            }else{
                $this->page++;
                 $this->allreportslist=json_decode($allreportslist, true);
            }
        }else{
            if($filtermode=='sort'){
                $this->page=0;
                $this->perPage=20;
                $this->allreportslist=[];
            }elseif($searchValue =='' && $filtermode=='search'){
                $this->allreportslist=[];
                $this->page=0;
                $this->perPage=20;
            }else{
               $this->page++;
                $this->allreportslist=json_decode($allreportslist, true);
            }
        }
        $this->column_name=$column_name;
        $this->sortmode=($sortmode==='DESC') ? 'DESC' : 'ASC';
        $this->filtermode=$filtermode;
        $this->searchValue=trim($searchValue);
        $this->addreports=1;
        $this->loadTableContent($value,$module_id);
        $this->emit('reportsAppended');
    }

public function loadMorePreviewRecords($searchmode,$report_id,$module_id,$previewsorting,$previewcolumnname,$fieldid='',$colname='',$fieldtype='',$condition='',$previewreportarray,$fieldvalue='')
{   
    $this->previewsorting=$previewsorting;
    $this->previewcolumnname=$previewcolumnname;
    $this->previewperPage=20;
    if($searchmode=='sorting'){
        $this->previewpage=0;
        $this->previewreportslist=[];
        
        // FIX: Check if we have stored filter data and use it
        if (!empty($this->filterData) && is_array($this->filterData) && count($this->filterData) > 0) {
            $this->PreviewFilterSearch('previewscroll',$report_id,$module_id,$this->filterData);
        } else {
            $this->PreviewFilterSearch('previewscroll',$report_id,$module_id,$fieldid,$colname,$fieldtype,$condition,$fieldvalue);
        }
    }else{
        $this->previewpage++;
        $this->previewreportslist=json_decode($previewreportarray, true);
        $this->PreviewFilterSearch('previewscroll',$report_id,$module_id,$fieldid,$colname,$fieldtype,$condition,$fieldvalue);
    }
 
    $this->addpreviewreports=1;
    $this->presearchmode=$searchmode;
    if ($this->tabmode === 'MISPreview') {
         $this->loadTableContent('MISPreview', $module_id, $this->misCurrentReportId);
    } else {
        $this->loadTableContent('preview', $module_id, $report_id);
    }
}
    
    public function loadTableContent($value,$module_id='',$report_id='',$originalModule = null,$listtab='',$currentReportId=''){

        $module= new \stdClass();
        if (is_object($originalModule) && property_exists($originalModule, 'picklist_data')) {
            $module->picklist_data = $originalModule->picklist_data;
        } elseif (is_array($originalModule) && array_key_exists('picklist_data', $originalModule)) {
            $module->picklist_data = $originalModule['picklist_data'];
        } else {
            $module->picklist_data = [];
        }          
        if(trim($value)==''){
            $value = $this->sidetabval;
        }
        $previewvalue=$this->sidetabval;
        $this->sidetabval=$value;
        $this->module_id=$module_id;
        $this->report_id=$report_id;
        $module->sidetabval=$value;
        $module->report_id=$report_id;
        $module->module_id=$module_id;
        $module->modulelabel=$value;
        $module->primarymodulefields=[];
        $module->selectedmodulefields=[];
        $module->reportcolumns=[];
        $module->groupbycolumns=[];
        $module->groupbyrows=[];
        $module->aggregatecolumns=[];
        $module->report_filter=[];
        $module->reportdetails=[];
        $module->mobiledata=[];
        $module->submodulesdata=[];
        $module->report_sharing=[];
        $this->pagemode= $module->sidetabval;
        $module->AllUsers = (new User())->GettingAllUsers();
        $module->ThemeColor=$this->getThemeColor();
        if($value != 'Scheduled Reports' && $value != 'MISReports'){
            $this->togglereport_id='';
            $this->togglereportmode='';
        }
        if($listtab =='listtab'){
            $this->allreportslist=[];
            $this->sortmode='ASC';
            $this->filtermode='';
            $this->page=0;
            $this->perPage=20;
            $this->addreports=0;
            $this->searchValue='';
        }
        $roleid = Auth::user()->users_roles;
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $roleid)->first()->permissionprofileid;
        $module->allmodulepermissions=$this->getUSerProfilePermissions();
      
        if ($value == 'All Reports') {
                    $module->module_id='';
            $module->reportmodulelist=$this->getReportModuleList($profileid);
            $allreports= $this->getAllReports();
            $module->allreports= $allreports['allreports'];
            $module->totalCount= $allreports['totalCount'];
            $module->currenttotalcount=($this->page+1)*$this->perPage;
           
            $module->sortmode= $this->sortmode;  
            $module->report_column_name= $this->column_name;
   
             if (count($this->allreportslist)) {
                if ($this->searchValue != '' && $this->filtermode == 'search') {
                    $this->allreportslist = [];
                } elseif ($this->filtermode == 'sort' || $listtab == 'listtab') {
                    $this->allreportslist = [];
                } else {
                    $module->allreports = array_unique(
                        array_merge($this->allreportslist, $module->allreports),
                        SORT_REGULAR
                    );
                }
               
            }

            $module->allreports = $module->allreports;
            $module->searchValue=$this->searchValue;
            $this->searchfieldid='';
            $this->searchfieldtype='';
            $this->searchcondtion='';
            $this->searchfieldvalue='';
            $this->searchcolname='';
            $this->searchQuery='';
            $this->preimgquery='';
            $this->previewpage=0;
            $this->previewreportslist=[];

            $module->profilepermissions=$this->getUSerProfilePermissions('Advanced_report');
            $this->createreport = view('Module.AdvancedReport.ListViewHeader',['Module'=>$module,'mode'=>'allreport'])->render();
            $this->headermenu = view('Module.AdvancedReport.HeaderMenu',['Module'=>$module,'mode'=>'modulelist'])->render();
            $this->sidebarmenulist = view('Module.AdvancedReport.SidebarMenuList',['Module'=>$module,'mode'=>'modulelist'])->render();
            if(count($module->allreports)){
                $this->reportcontent = view('Module.AdvancedReport.ReportListView',['Module'=>$module])->render();
            }else{
                $this->reportcontent = view('Module.AdvancedReport.NoData')->render();
            }
        }elseif ($value == 'Scheduled Reports') {
            $module->schduledmodulelist=$this->getSchduleListRecord();
            $module->totalschdulecount = count($module->schduledmodulelist);
            $module->reportmodulelist=$this->getReportModuleList($profileid);
            $module->userstimezone=DB::table('users_timezone')->orderBy('seq')->get();
            $alltimezone=[];
            foreach($module->userstimezone as $timezone){
                $alltimezone[$timezone->id]=$timezone->picklistvalue;
            }
            $module->alltimezone= $alltimezone;
            $module->togglereport_id= $this->togglereport_id;
            $module->togglereportmode= $this->togglereportmode;
            $this->searchValue='';
            $this->createreport = view('Module.AdvancedReport.ListViewHeader',['Module'=>$module,'mode'=>'schedule'])->render();
            $this->headermenu = view('Module.AdvancedReport.HeaderMenu',['Module'=>$module,'mode'=>'modulelist'])->render();
            $this->sidebarmenulist = view('Module.AdvancedReport.SidebarMenuList',['Module'=>$module,'mode'=>'modulelist'])->render();
            if(count($module->schduledmodulelist)){
                $this->reportcontent = view('Module.AdvancedReport.SchduleListView', ['Module' => $module])->render();
            }else{
                $this->reportcontent = view('Module.AdvancedReport.NoData')->render();
            }
        }elseif ($value == 'Shared Reports') {
            $module->sharemodulelist = $this->getShareListRecord();
            $module->totalsharecount =count($module->sharemodulelist);
            $this->searchValue='';
            $module->reportmodulelist=$this->getReportModuleList($profileid);
            $module->allroles = DB::table('rsoft_role')
            ->join('rsoft_users', 'rsoft_role.roleid', '=', 'rsoft_users.users_roles')
            ->where('rsoft_role.roleid', '!=', 1)
            ->whereNotNull('rsoft_users.users_roles')
            ->select('rsoft_role.rolename', 'rsoft_role.roleid')
            ->distinct()
            ->orderBy('rsoft_role.depth')
            ->pluck('rolename', 'roleid');            
            $this->createreport = view('Module.AdvancedReport.ListViewHeader',['Module'=>$module,'mode'=>'share'])->render();
            $this->headermenu = view('Module.AdvancedReport.HeaderMenu',['Module'=>$module,'mode'=>'modulelist'])->render();
            $this->sidebarmenulist = view('Module.AdvancedReport.SidebarMenuList',['Module'=>$module,'mode'=>'modulelist'])->render();
            if(count($module->sharemodulelist)){
                $this->reportcontent = view('Module.AdvancedReport.ShareListView', ['Module' => $module])->render();
            }else{
                $this->reportcontent = view('Module.AdvancedReport.NoData')->render();
            }
        
        }elseif($value === 'MISReports'){
            $module->module_id='';

           
            $this->page = 0;
            $this->perPage = 20;
            $this->allreportslist = [];
            $this->addreports = 0;
            $this->searchValue = '';

            $module->reportmodulelist=$this->getReportModuleList($profileid);
            $allreports= $this->getMISReports();
            $module->allreports= $allreports['allreports'];
            $module->totalCount= $allreports['totalCount'];
            $module->togglereport_id= $this->togglereport_id;
            $module->togglereportmode= $this->togglereportmode;           
             // $module->schduledmodulelist=$this->MisSchduleListRecord();
            $module->userstimezone=DB::table('users_timezone')->orderBy('seq')->get();
            $alltimezone=[];
            foreach($module->userstimezone as $timezone){
                $alltimezone[$timezone->id]=$timezone->picklistvalue;
            }
            $module->alltimezone= $alltimezone;
            $module->searchValue=$this->searchValue;
            $this->allreportslist=$module->allreports;
            $module->profilepermissions=$this->getUSerProfilePermissions('Advanced_report');
            $this->createreport = view('Module.AdvancedReport.MisListviewHeader',['Module'=>$module,'mode'=>'MISReports'])->render();
            $this->headermenu = view('Module.AdvancedReport.HeaderMenu',['Module'=>$module,'mode'=>'modulelist'])->render();
            $this->sidebarmenulist = view('Module.AdvancedReport.SidebarMenuList',['Module'=>$module,'mode'=>'modulelist'])->render();
              if(count($module->allreports)){
                $this->reportcontent = view('Module.AdvancedReport.MisListview',['Module'=>$module])->render();
            }else{
                $this->reportcontent = view('Module.AdvancedReport.MisReportNodata')->render();
            }
        }elseif ($value == 'EditReport' || $value == 'Fields Reports' || $value == 'Filters Reports' || $value == 'ChartReport') {
            if($report_id !=''){
                $reportdetails=DB::table('rsoft_advanced_report')->where('report_id',$report_id)->join('rsoft_modules','rsoft_advanced_report.primarymodule','=','rsoft_modules.id')->get();
                $module->reportdetails=$reportdetails;
        $preferences = DB::table('rsoft_advanced_report_user_preferences')
            ->where('report_id', $report_id)
            ->where('user_id', Auth::user()->id)
            ->first();

        if ($preferences && $module->reportdetails->isNotEmpty()) {
            $report = $module->reportdetails[0]; 
            $report->expand_detail_rows   = $preferences->expand_detail_rows;
            $report->expand_group_count   = $preferences->expand_group_count;
            $report->expand_sub_total     = $preferences->expand_sub_total;
            $report->expand_grand_total   = $preferences->expand_grand_total;
            $report->expand_tabular_chart = $preferences->expand_tabular_chart;
        }
                if($reportdetails[0]->submodules !=''){
                    $submodules=explode(',',$reportdetails[0]->submodules);
                    $module->submodulesdata=DB::table('rsoft_modules')->whereIn('id',$submodules)->where('status',0)->get();
                }
                $module->primarymodule=$reportdetails[0]->primarymodule;
                if($module_id==''){
                    $module_id=$reportdetails[0]->primarymodule;
                }
                $this->searchValue='';
                if($value == 'Filters Reports'){
                    $module_id=$module->primarymodule;
                }

                $module->report_filter = $this->getReportFilters($report_id, $reportdetails);

                $module->commentcheck=DB::table('rsoft_relatedlists')->where('rsoft_relatedlists.tabid',$module_id)->join('rsoft_profile2tab','rsoft_relatedlists.related_tabid','=','rsoft_profile2tab.tabid')->where('profileid',$profileid)->where('rsoft_profile2tab.permission',1)->where('rsoft_relatedlists.presence', 0)->where('related_tabid',2)->get();
               
              
                $module->primarymodulefields=DB::table('rsoft_module_fields')
                ->join('rsoft_module_field_types', 'rsoft_module_fields.field_type', '=', 'rsoft_module_field_types.id')
                ->join('rsoft_block', 'rsoft_module_fields.blockid', '=', 'rsoft_block.blockid')
                ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
                ->where('rsoft_profile2field.profileid', $profileid)
                ->where('rsoft_module_fields.active', 1)
                ->where('rsoft_module_fields.module', $module_id)
                ->when($reportdetails[0]->report_type == 'Chart', function ($query) {
                    $query->whereIn('rsoft_module_fields.field_type', [9, 13, 14, 15, 29, 30, 31]);
                })
                ->whereNotIn('rsoft_block.blocktype', ['Inventory','Table'])
                ->select('rsoft_module_field_types.field_type_icon as field_type_icon', 'rsoft_module_fields.*','rsoft_profile2field.visible')// Select with alias for id
                 ->distinct() 
                ->get();
            $primarymoduleslabel=DB::table('rsoft_modules')->where('id',$module_id)->get();
            if (empty($primarymoduleslabel)) {
                $primarymodulefields = [];
            } else {
                $primarymodulefields[$primarymoduleslabel[0]->label] = $module->primarymodulefields;
            }
            if($value == 'Filters Reports'){
                $submodulefields=[];
                if($reportdetails[0]->report_moduletype=='Multiple' && !empty($reportdetails[0]->submodules)){
                    $submodule=explode(',',$reportdetails[0]->submodules);
                    if(count( $submodule)){
                        foreach( $submodule as $key =>$val){
                            $submoduleslabel=DB::table('rsoft_modules')->where('id',$val)->get();
                            if(count( $submoduleslabel)){
                                $submodule=DB::table('rsoft_module_fields')
                                    ->join('rsoft_module_field_types', 'rsoft_module_fields.field_type', '=', 'rsoft_module_field_types.id')
                                    ->join('rsoft_block', 'rsoft_module_fields.blockid', '=', 'rsoft_block.blockid')
                                    ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
                                    ->where('rsoft_profile2field.profileid', $profileid)
                                    ->where('rsoft_module_fields.active', 1)
                                    ->when($reportdetails[0]->report_type == 'Chart', function ($query) {
                                        $query->whereIn('rsoft_module_fields.field_type', [9, 13, 14, 15, 29, 30, 31]);
                                    })
                                    ->where('rsoft_module_fields.module', $val)
                                    ->whereNotIn('rsoft_block.blocktype', ['Inventory','Table'])
                                    ->select('rsoft_module_field_types.field_type_icon as field_type_icon', 'rsoft_module_fields.*','rsoft_profile2field.visible') // Select with alias for id
                                    ->get();
                                    $submodulefields[$submoduleslabel[0]->label]= $submodule;
                                }
                            }
                            
                        }              
                    }
                    $module->selectedmodulefields=array_merge($primarymodulefields,$submodulefields);


                    $module->Getallfields_valuebase = (new ModuleFields())->GetFieldsforfiltercondition_base_valuesForWorkflow($module_id);
                    //dd($module->Getallfields_valuebase);
                }
                $module->sidetabval=$reportdetails[0]->report_name;
                $module->modulelabel=$reportdetails[0]->label;

            if($previewvalue == 'ChartReport' || $value == 'ChartReport' || $reportdetails[0]->report_type=='Chart'){
                $module->chartdata=$this->getChartReportResult($report_id,$reportdetails,'builder');
                $this->emit('updateChart',  $module->chartdata);
                if($reportdetails[0]->expand_tabular_chart==1){
                    $reportall=$this->getDetailReportResult($report_id,$reportdetails,'builder');
                    $module->reportresult=$reportall['reportall']['reportresult'];
                    $module->reportfields=$reportall['reportall']['reportfields'];
                    $module->reportcolumns=$reportall['reportall']['reportcolumns'];
                    $module->groupbycolumns=$reportall['reportall']['groupbycolumns'];
                    $module->groupbyrows=$reportall['reportall']['groupbyrows'];
                    $module->aggregatecolumns=$reportall['reportall']['aggregatecolumns']; 
                    $module->coloumnfieldtypes=$reportall['reportall']['coloumnfieldtypes'];
                    $module->reportarray=$reportall['reportarray1'];
                    $module->aggrateValues=$reportall['aggrateValues'];
                    $module->Totalaggregatecolumn=$reportall['reportall']['Totalaggregatecolumn'];
                    $filteredGroupByRows = collect($module->groupbyrows ?? [])->map(function ($row) use ($reportdetails) {
                        $label = $row->label;
                        $fieldData = DB::table('rsoft_module_fields')
                            ->where('id', $row->groupbyrows_fieldid)
                            ->select('colname', 'id', 'module')
                            ->first();
                        if ($fieldData) {
                            if ($row->module != $reportdetails[0]->primarymodule) {
                                $label .= ' - (' . $row->modulelabel . ')';
                            }
                            return [
                                'value' => $row->groupbyrows_fieldid,
                                'label' => $label,
                                'field_id' => $row->groupbyrows_fieldid,
                                'fieldname' => $fieldData->colname ?? $row->label,
                                'column_id' => $fieldData->module ?? $row->groupbyrows_fieldid,
                                'field_type' => $row->field_type
                            ];
                        }
                        return null;
                    })->filter()->values()->toArray();
                    $filteredGroupByColumns = collect($module->groupbycolumns ?? [])->map(function ($column) use ($reportdetails) {
                        $label = $column->label;
                        $fieldData = DB::table('rsoft_module_fields')
                            ->where('id', $column->groupbycolumns_fieldid)
                            ->select('colname', 'id', 'module')
                            ->first();
                        if ($fieldData) {
                            if ($column->module != $reportdetails[0]->primarymodule) {
                                $label .= ' - (' . $column->modulelabel . ')';
                            }
                            return [
                                'value' => $column->groupbycolumns_fieldid,
                                'label' => $label,
                                'field_id' => $column->groupbycolumns_fieldid,
                                'fieldname' => $fieldData->colname ?? $column->label,
                                'column_id' => $fieldData->module ?? $column->groupbycolumns_fieldid,
                                'field_type' => $column->field_type
                            ];
                        }
                        return null;
                    })->filter()->values()->toArray();
                    $this->emit('updateGroupByArrays', [
                        'groupByRows' => $filteredGroupByRows,
                        'groupByColumns' => $filteredGroupByColumns,
                    ]);
                }
            }else{
                if($reportdetails[0]->expand_tabular_chart==1){
                    $module->chartdata=$this->getChartReportResult($report_id,$reportdetails,'builder');
                    $this->emit('updateChart',  $module->chartdata);
                }
                $reportall=$this->getDetailReportResult($report_id,$reportdetails,'builder');
                $module->reportresult=$reportall['reportall']['reportresult'];
                $module->reportfields=$reportall['reportall']['reportfields'];
                $module->reportcolumns=$reportall['reportall']['reportcolumns'];
                $module->groupbycolumns=$reportall['reportall']['groupbycolumns'];
                $module->groupbyrows=$reportall['reportall']['groupbyrows'];
                $module->aggregatecolumns=$reportall['reportall']['aggregatecolumns']; 
                $module->coloumnfieldtypes=$reportall['reportall']['coloumnfieldtypes'];
                $module->reportarray=$reportall['reportarray1'];
                $module->aggrateValues=$reportall['aggrateValues'];
                $module->Totalaggregatecolumn=$reportall['reportall']['Totalaggregatecolumn'];
                $filteredGroupByRows = collect($module->groupbyrows ?? [])->map(function ($row) use ($reportdetails) {
                    $label = $row->label;
                    $fieldData = DB::table('rsoft_module_fields')
                        ->where('id', $row->groupbyrows_fieldid)
                        ->select('colname', 'id', 'module')
                        ->first();
                    if ($fieldData) {
                        if ($row->module != $reportdetails[0]->primarymodule) {
                            $label .= ' - (' . $row->modulelabel . ')';
                        }
                        return [
                            'value' => $row->groupbyrows_fieldid,
                            'label' => $label,
                            'field_id' => $row->groupbyrows_fieldid,
                            'fieldname' => $fieldData->colname ?? $row->label,
                            'column_id' => $fieldData->module ?? $row->groupbyrows_fieldid,
                            'field_type' => $row->field_type
                        ];
                    }
                    return null;
                })->filter()->values()->toArray();
                $filteredGroupByColumns = collect($module->groupbycolumns ?? [])->map(function ($column) use ($reportdetails) {
                    $label = $column->label;
                    $fieldData = DB::table('rsoft_module_fields')
                        ->where('id', $column->groupbycolumns_fieldid)
                        ->select('colname', 'id', 'module')
                        ->first();
                    if ($fieldData) {
                        if ($column->module != $reportdetails[0]->primarymodule) {
                            $label .= ' - (' . $column->modulelabel . ')';
                        }
                        return [
                            'value' => $column->groupbycolumns_fieldid,
                            'label' => $label,
                            'field_id' => $column->groupbycolumns_fieldid,
                            'fieldname' => $fieldData->colname ?? $column->label,
                            'column_id' => $fieldData->module ?? $column->groupbycolumns_fieldid,
                            'field_type' => $column->field_type
                        ];
                    }
                    return null;
                })->filter()->values()->toArray();
                $this->emit('updateGroupByArrays', [
                    'groupByRows' => $filteredGroupByRows,
                    'groupByColumns' => $filteredGroupByColumns,
                ]);
            }
        
            $tablestyle=DB::table('rsoft_advanced_report_tablestyle')->where('report_id',$report_id)->get();
            $module->tablefontfamily=['Arial','Helvetica','Times New Roman','Verdana','Tahoma','Calibri','Roboto','Open Sans','Lato','Georgia'];
            $module->tablestyledata=$tablestyle;
            $module->tablestyle=$this->getTablestyle($tablestyle);


               $module->formulas = DB::table('rsoft_advanced_report_formula')->where('report_id',$report_id)->select('formula_id', 'formula_label') ->get();
                $module->picklistTrackings = DB::table('rsoft_advanced_report_picklisttracking')
                ->where('report_id', $report_id)
                ->where('module_id', $module_id)
                ->get();
    
                
                $module->Allcustomefiltercondforfieldstypes = (new ListViewFilter())->GetAllcustomefiltercondforfieldstypes();

                $module->filteremptyvaluecon = (new FilterHelpers())->filteremptyvaluecon();
                if($this->moduleSelect !=''){
                   $module->moduleSelect =$this->moduleSelect;
                }else{
                  $module->moduleSelect =$module->module_id;
                }
                $this->searchfieldid='';
                $this->searchfieldtype='';
                $this->searchcondtion='';
                $this->searchfieldvalue='';
                $this->searchcolname='';
                $this->preimgquery='';
                $this->searchQuery='';
                $this->previewpage=0;
                $this->previewreportslist=[];
            }
            $this->createreport = view('Module.AdvancedReport.ListViewHeader',['Module'=>$module,'mode'=>'hide'])->render();
            $this->headermenu = view('Module.AdvancedReport.HeaderMenu',['Module'=>$module,'mode'=>'fieldlist'])->render();
            $tabvalue ='fieldlist';
            if($value == 'Filters Reports'){
                $tabvalue ='filterlist';
            }
            if($previewvalue == 'ChartReport' || $reportdetails[0]->report_type=='Chart'){
              $value='ChartReport';
            }
            $this->sidebarmenulist = view('Module.AdvancedReport.SidebarMenuList',['Module'=>$module,'mode'=> $tabvalue,'tappage'=>$value ])->render();
            $this->reportcontent = view('Module.AdvancedReport.ReportBuilderView', ['Module' => $module,'mode'=>$value])->render(); 
        }elseif ($value === 'preview'){  
            $module->RecordPermission=$this->getRecordPermission($report_id,$module_id);
            $this->pagemode='preview';
            if($report_id !=''){
                //$this->InitializeValueClear();
                $reportdetails=DB::table('rsoft_advanced_report')->where('report_id',$report_id)->join('rsoft_modules','rsoft_advanced_report.primarymodule','=','rsoft_modules.id')->get();
                $module->reportdetails=$reportdetails;
        $preferences = DB::table('rsoft_advanced_report_user_preferences')
            ->where('report_id', $report_id)
            ->where('user_id', Auth::user()->id)
            ->first();

        if ($preferences && $module->reportdetails->isNotEmpty()) {
            $report = $module->reportdetails[0];
            $report->expand_detail_rows   = $preferences->expand_detail_rows;
            $report->expand_group_count   = $preferences->expand_group_count;
            $report->expand_sub_total     = $preferences->expand_sub_total;
            $report->expand_grand_total   = $preferences->expand_grand_total;
            $report->expand_tabular_chart = $preferences->expand_tabular_chart;
        }
                if($reportdetails[0]->submodules !=''){
                    $submodules=explode(',',$reportdetails[0]->submodules);
                    $module->submodulesdata=DB::table('rsoft_modules')->whereIn('id',$submodules)->where('status',0)->get();
                }
                $this->searchValue='';
                $module->primarymodulefields=DB::table('rsoft_module_fields')
                ->join('rsoft_module_field_types', 'rsoft_module_fields.field_type', '=', 'rsoft_module_field_types.id')
                ->join('rsoft_block', 'rsoft_module_fields.blockid', '=', 'rsoft_block.blockid')
                ->where('rsoft_module_fields.active', 1)
                ->where('rsoft_module_fields.module', $reportdetails[0]->primarymodule)
                ->whereNotIn('rsoft_block.blocktype', ['Inventory','Table'])
                ->select('rsoft_module_field_types.field_type_icon as field_type_icon', 'rsoft_module_fields.*') // Select with alias for id
                ->get();
                $primarymoduleslabel=DB::table('rsoft_modules')->where('id',$reportdetails[0]->primarymodule)->get();
                $primarymodulefields[$primarymoduleslabel[0]->label]= $module->primarymodulefields;
                
                $submodulefields=[];
                if($reportdetails[0]->report_moduletype=='Multiple'){
                    $submodule=explode(',',$reportdetails[0]->submodules);
                    if(count( $submodule)){
                        foreach( $submodule as $key =>$val){
                            $submoduleslabel=DB::table('rsoft_modules')->where('id',$val)->get();
                            if(count( $submoduleslabel)){
                                $submodule=DB::table('rsoft_module_fields')
                                ->join('rsoft_module_field_types', 'rsoft_module_fields.field_type', '=', 'rsoft_module_field_types.id')
                                ->join('rsoft_block', 'rsoft_module_fields.blockid', '=', 'rsoft_block.blockid')
                                ->where('rsoft_module_fields.active', 1)
                                ->where('rsoft_module_fields.module', $val)
                                ->whereNotIn('rsoft_block.blocktype', ['Inventory','Table'])
                                ->select('rsoft_module_field_types.field_type_icon as field_type_icon', 'rsoft_module_fields.*') // Select with alias for id
                                ->get();
                                $submodulefields[$submoduleslabel[0]->label]= $submodule;
                            }
                        }
                        
                    }              
                }
              
                $module->selectedmodulefields=array_merge($primarymodulefields,$submodulefields);
                $module->Getallfields_valuebase = (new ModuleFields())->GetFieldsforfiltercondition_base_valuesForWorkflow($module_id);


                $module->previewsorting= $this->previewsorting;
                $module->previewcolumnname=$this->previewcolumnname;
                if($module->previewsorting=='ASC'){
                    $module->previewsorting= 'DESC';
                }else if($module->previewsorting=='DESC'){
                    $module->previewsorting= 'ASC';
                }else{
                    $module->previewsorting= 'ASC';
                }
                
                $module->sidetabval=$reportdetails[0]->report_name;
                $module->modulelabel=$reportdetails[0]->label;

                if($value == 'ChartReport' || $reportdetails[0]->report_type=='Chart'){
                    $module->chartdata=$this->getChartReportResult($report_id,$reportdetails,'preview');
                    $this->emit('updateChart',  $module->chartdata);
                    if($reportdetails[0]->expand_tabular_chart==1){
                        $reportall=$this->getDetailReportResult($report_id,$reportdetails,'preview');
                        $module->totalRecords=$reportall['reportall']['totalRecords'];
                        $module->reportresult=$reportall['reportall']['reportresult'];
                        $module->reportfields=$reportall['reportall']['reportfields'];
                        $module->reportcolumns=$reportall['reportall']['reportcolumns'];
                        $module->groupbycolumns=$reportall['reportall']['groupbycolumns'];
                        $module->groupbyrows=$reportall['reportall']['groupbyrows'];
                        $module->aggregatecolumns=$reportall['reportall']['aggregatecolumns'];
                        $module->coloumnfieldtypes=$reportall['reportall']['coloumnfieldtypes'];
                        $module->reportarray=$reportall['reportarray1'];
                        $module->aggrateValues=$reportall['aggrateValues'];
                        $module->Totalaggregatecolumn=$reportall['reportall']['Totalaggregatecolumn'];
                    
                         if (count($this->previewreportslist)) {
                            $mergedArray = [];
                            foreach ($module->reportarray as $key => $values) {
                                if (isset($this->previewreportslist[$key])) {
                                    $mergedArray[$key] = array_merge($this->previewreportslist[$key],$values);
                                } else {
                                    $mergedArray[$key] = $values;
                                }
                            }
                            $module->reportarray= $mergedArray;
                        }
                        $module->reportarray = $module->reportarray;
                        $module->currenttotalcount=($this->previewpage+1)*$this->previewperPage;
                    }
                }else{
                    if($reportdetails[0]->expand_tabular_chart==1){
                        $module->chartdata=$this->getChartReportResult($report_id,$reportdetails,'preview');
                        $this->emit('updateChart',  $module->chartdata);
                    }
                    $reportall=$this->getDetailReportResult($report_id,$reportdetails,'preview');
                    $module->totalRecords=$reportall['reportall']['totalRecords'];
                    $module->reportresult=$reportall['reportall']['reportresult'];
                    $module->reportfields=$reportall['reportall']['reportfields'];
                    $module->reportcolumns=$reportall['reportall']['reportcolumns'];
                    $module->groupbycolumns=$reportall['reportall']['groupbycolumns'];
                    $module->groupbyrows=$reportall['reportall']['groupbyrows'];
                    $module->aggregatecolumns=$reportall['reportall']['aggregatecolumns'];
                    $module->coloumnfieldtypes=$reportall['reportall']['coloumnfieldtypes'];
                    $module->reportarray=$reportall['reportarray1'];
                    $module->aggrateValues=$reportall['aggrateValues'];
                    $module->Totalaggregatecolumn=$reportall['reportall']['Totalaggregatecolumn'];

                    if (count($this->previewreportslist)) {
                        $mergedArray = [];
                        foreach ($module->reportarray as $key => $values) {
                            if (isset($this->previewreportslist[$key])) {
                                $mergedArray[$key] = array_merge($this->previewreportslist[$key],$values);
                            } else {
                                $mergedArray[$key] = $values;
                            }
                        }
                        $module->reportarray= $mergedArray;
                    }
                    $module->reportarray = $module->reportarray;
                    $module->currenttotalcount=($this->previewpage+1)*$this->previewperPage;
                }
                // Fetch and emit sortedFields
                $report = DB::table('rsoft_advanced_report')
                    ->where('report_id', $report_id)
                    ->first();
                $sortedFields = json_decode($report->group_sort, true) ?: [];
                // $this->emit('sortFieldsUpdated', $sortedFields);

                // Fetch and emit groupByRows and groupByColumns
                $filteredGroupByRows = collect($module->groupbyrows ?? [])->map(function ($row) use ($reportdetails) {
                    $label = $row->label;
                    $fieldData = DB::table('rsoft_module_fields')
                        ->where('id', $row->groupbyrows_fieldid)
                        ->select('colname', 'id', 'module')
                        ->first();
                    if ($fieldData) {
                        if ($row->module != $reportdetails[0]->primarymodule) {
                            $label .= ' - (' . $row->modulelabel . ')';
                        }
                        return [
                            'value' => $row->groupbyrows_fieldid,
                            'label' => $label,
                            'field_id' => $row->groupbyrows_fieldid,
                            'fieldname' => $fieldData->colname ?? $label,
                            'column_id' => $fieldData->module ?? $row->groupbyrows_fieldid,
                            'field_type' => $row->field_type
                        ];
                    }
                    return null;
                })->filter()->values()->toArray();

                $filteredGroupByColumns = collect($module->groupbycolumns ?? [])->map(function ($column) use ($reportdetails) {
                    $label = $column->label;
                    $fieldData = DB::table('rsoft_module_fields')
                        ->where('id', $column->groupbycolumns_fieldid)
                        ->select('colname', 'id', 'module')
                        ->first();
                    if ($fieldData) {
                        if ($column->module != $reportdetails[0]->primarymodule) {
                            $label .= ' - (' . $column->modulelabel . ')';
                        }
                        return [
                            'value' => $column->groupbycolumns_fieldid,
                            'label' => $label,
                            'field_id' => $column->groupbycolumns_fieldid,
                            'fieldname' => $fieldData->colname ?? $label,
                            'column_id' => $fieldData->module ?? $column->groupbycolumns_fieldid,
                            'field_type' => $column->field_type
                        ];
                    }
                    return null;
                })->filter()->values()->toArray();

                $this->emit('updateGroupByArrays', [
                    'groupByRows' => $filteredGroupByRows,
                    'groupByColumns' => $filteredGroupByColumns,
                ]);

                $tablestyle=DB::table('rsoft_advanced_report_tablestyle')->where('report_id',$report_id)->get();
                $module->tablestyle=$this->getTablestyle($tablestyle);
            }
            $module->Allcustomefiltercondforfieldstypes = (new ListViewFilter())->GetAllcustomefiltercondforfieldstypes();
            $module->allpicklistvalues = (new ModuleFields())->Getallpicklistvalues('id');
            $module->allCity = (new ModuleFieldTypes())->getAllCity();
            $module->allState = (new ModuleFieldTypes())->getAllState();
            $module->allCountry = (new ModuleFieldTypes())->getAllCountry();
            $module->nameprefix=DB::table('rsoft_namefield_prefix')->pluck('prefix_value');
	    	$module->phoneprefix=DB::table('rsoft_phonenumber_prefix')->pluck('prefix_value');
            $module->Assignedtousers = (new Profile2AssignedUser())->GettingAssignedUser();
            $module->Filteremptyconditionarray= (new FilterHelpers())->filteremptyvaluecon();
            $groupedByRole = [];
            foreach ($module->Assignedtousers['assignusers'] as $user) {
                $role = $user['rolename'];
                if (!isset($groupedByRole[$role])) {
                    $groupedByRole[$role] = [];
                }
                $groupedByRole[$role][] = $user;
            }
            $module->RoleBasedUsers = $groupedByRole;
            $module->searchfieldid=$this->searchfieldid;
            $module->searchfieldtype=$this->searchfieldtype;
            $module->searchcondtion=$this->searchcondtion;
            $module->searchfieldvalue=$this->searchfieldvalue;
            $module->searchcolname=$this->searchcolname;
            $module->report_filter = $this->getReportFilters($report_id, $reportdetails);
            $this->headermenu = view('Module.AdvancedReport.HeaderMenu', ['Module' => $module, 'mode' => 'previewlist'])->render();   
            $this->reportcontent = view('Module.AdvancedReport.PreviewResultView', ['Module' => $module,'mode'=>$value])->render();
         }elseif ($value === 'MISPreview') {
            $this->pagemode = 'MISPreview';
            $module->pagemode = 'MISPreview';
            if (function_exists('session')) {
                try {
                    session(['advanced_report_pagemode' => 'MISPreview']);
                } catch (\Throwable $e) {}
            }
            $configurationeditor=DB::table('rsoft_configurationeditor')->get();
            $exportlimit=$configurationeditor[0]->maximum_export_limit;
            $module->exportlimit=$exportlimit;
            $module->report_id = $report_id;
            $misreportdetails = DB::table('rsoft_advanced_report')->where('report_id', $report_id)->first();
            if (!$misreportdetails) { return; }
            $primaryModule = DB::table('rsoft_modules')->where('id', $misreportdetails->primarymodule)->first();
            $module->primaryModule = $primaryModule;
            $module->misreportdetails = $misreportdetails;
            $reportIds = array_filter(array_map('trim', explode(',', $misreportdetails->primarymodule ?? '')));
            $module->includeReports = !empty($reportIds)? DB::table('rsoft_advanced_report')->whereIn('report_id', $reportIds)->get(): collect();
            $misPreviewData = [];
            $groupByEmitted = false;
            if (empty($this->currentReportId) && $module->includeReports->isNotEmpty()) {
                $this->currentReportId = $module->includeReports->first()->report_id;
            }
            if (empty($this->currentReportId)) {
                $this->currentReportId = $report_id;
            }
            $module->misCurrentReportId = $this->misCurrentReportId;
            if ($this->oldMisCurrentReportId !== $this->misCurrentReportId) {
                $this->currentReportId = $module->includeReports->first()->report_id ??'';
            }
            $this->oldMisCurrentReportId = $this->misCurrentReportId;
            $currentreport = $this->currentReportId;
            $module->currentreport = $currentreport;
            
            foreach ($module->includeReports as $report) {
                $reportData = DB::table('rsoft_advanced_report')
                    ->where('rsoft_advanced_report.report_id', $report->report_id)
                    ->join('rsoft_modules', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_modules.id')
                    ->select('rsoft_advanced_report.*', 'rsoft_modules.name', 'rsoft_modules.name_db',
                            'rsoft_modules.moduletype', 'rsoft_modules.id as module_id')
                    ->get();
                if ($reportData instanceof \Illuminate\Support\Collection && $reportData->isEmpty()) {
                    $single = DB::table('rsoft_advanced_report')
                        ->where('rsoft_advanced_report.report_id', $report->report_id)
                        ->join('rsoft_modules', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_modules.id')
                        ->select('rsoft_advanced_report.*', 'rsoft_modules.name', 'rsoft_modules.name_db',
                                'rsoft_modules.moduletype', 'rsoft_modules.id as module_id')
                        ->first();
        
                    if ($single) {
                        $reportData = collect([$single]);
                    }
                }
                if ($reportData instanceof \Illuminate\Support\Collection && $reportData->count()) {
                    $result = $this->getDetailReportResult($report->report_id, $reportData, 'preview');
                    $inner  = $result['reportall']['reportall'] ?? ($result['reportall'] ?? []);
                    $module->totalRecords=$result ['reportall']['totalRecords'];
                    // dd($module->totalRecords);
                    $groupbyrowsSource = $inner['groupbyrows'] ?? [];
                    $filteredGroupByRows = collect($groupbyrowsSource)
                        ->map(function ($row) use ($reportData) {
                            $label       = is_array($row) ? ($row['label'] ?? '') : ($row->label ?? '');
                            $fieldId     = is_array($row) ? ($row['groupbyrows_fieldid'] ?? null) : ($row->groupbyrows_fieldid ?? null);
                            $rowModule   = is_array($row) ? ($row['module'] ?? null) : ($row->module ?? null);
                            $moduleLabel = is_array($row) ? ($row['modulelabel'] ?? '') : ($row->modulelabel ?? '');
                            $fieldType   = is_array($row) ? ($row['field_type'] ?? null) : ($row->field_type ?? null);
                            if (!$fieldId) { return null; }
                            $fieldData = DB::table('rsoft_module_fields')
                                ->where('id', $fieldId)
                                ->select('colname', 'id', 'module')
                                ->first();
                            if (!$fieldData) { return null; }
                            if ($rowModule != ($reportData[0]->primarymodule ?? null)) {
                                $label .= ' - (' . $moduleLabel . ')';
                            }
                            return [
                                'value'      => $fieldId,
                                'label'      => $label,
                                'field_id'   => $fieldId,
                                'fieldname'  => $fieldData->colname ?? $label,
                                'column_id'  => $fieldData->module ?? $fieldId,
                                'field_type' => $fieldType,
                            ];
                        })
                        ->filter()
                        ->values()
                        ->toArray();
                    $groupbycolumnsSource = $inner['groupbycolumns'] ?? [];
                    $filteredGroupByColumns = collect($groupbycolumnsSource)
                        ->map(function ($column) use ($reportData) {
                            $label       = is_array($column) ? ($column['label'] ?? '') : ($column->label ?? '');
                            $fieldId     = is_array($column) ? ($column['groupbycolumns_fieldid'] ?? null) : ($column->groupbycolumns_fieldid ?? null);
                            $colModule   = is_array($column) ? ($column['module'] ?? null) : ($column->module ?? null);
                            $moduleLabel = is_array($column) ? ($column['modulelabel'] ?? '') : ($column->modulelabel ?? '');
                            $fieldType   = is_array($column) ? ($column['field_type'] ?? null) : ($column->field_type ?? null);
                            if (!$fieldId) { return null; }
                            $fieldData = DB::table('rsoft_module_fields')
                                ->where('id', $fieldId)
                                ->select('colname', 'id', 'module')
                                ->first();
                            if (!$fieldData) { return null; }
                            if ($colModule != ($reportData[0]->primarymodule ?? null)) {
                                $label .= ' - (' . $moduleLabel . ')';
                            }
                            return [
                                'value'      => $fieldId,
                                'label'      => $label,
                                'field_id'   => $fieldId,
                                'fieldname'  => $fieldData->colname ?? $label,
                                'column_id'  => $fieldData->module ?? $fieldId,
                                'field_type' => $fieldType,
                            ];
                        })
                        ->filter()
                        ->values()
                        ->toArray();
                    if  (!$groupByEmitted && $report->report_id == $currentreport) {
                        $this->emit('updateGroupByArrays', [
                            'groupByRows'    => $filteredGroupByRows,
                            'groupByColumns' => $filteredGroupByColumns,
                        ]);
                        $groupByEmitted = true;
                    }
                    $misreport = DB::table('mis_report_table')->where('report_id',$this->misCurrentReportId)->where('id', $report->report_id)->first();
                    // Store the report data
                    $misPreviewData[$report->report_id] = [
                        'report_name'            => $report->report_name,
                        'report_data'            => $result,
                        'reportall'              => $result['reportall'] ?? [],
                        'reportarray1'           => $result['reportarray1'] ?? [],
                        'sortedFields' => json_decode((empty($misreport->mis_group_sort))? ($report->group_sort): $misreport->mis_group_sort,true),
                        'totalRecords'           => $inner['totalRecords'] ?? 0,
                        'reportresult'           => $inner['reportresult'] ?? [],
                        'reportfields'           => $inner['reportfields'] ?? [],
                        'reportcolumns'          => $inner['reportcolumns'] ?? [],
                        'groupbycolumns'         => $inner['groupbycolumns'] ?? [],
                        'groupbyrows'            => $inner['groupbyrows'] ?? [],
                        'aggregatecolumns'       => $inner['aggregatecolumns'] ?? [],
                        'coloumnfieldtypes'      => $inner['coloumnfieldtypes'] ?? [],
                        'reportarray'            => $result['reportarray1'] ?? [],
                        'aggrateValues'          => $result['aggrateValues'] ?? [],
                        'Totalaggregatecolumn'   => $inner['Totalaggregatecolumn'] ?? null,
                    ];
                }
            }
            
            $module->reportdetails = DB::table('rsoft_advanced_report')->where('report_id', $report_id)->select('description')->get();
            $module->misPreviewData = $misPreviewData;
            // Get the main report's tablestyle for the parent module
            $tablestyleRecords = DB::table('rsoft_advanced_report_tablestyle')->where('report_id', $report_id)->get();
            $module->tablestyle = $tablestyleRecords->isNotEmpty() ? $this->getTablestyle($tablestyleRecords) : $this->getDefaultTablestyle();
        
            // Now set up each sub-report with its own tablestyle
           // In the foreach loop where you create sub-modules, add this:
foreach ($module->misPreviewData as $rid => $rData) {
    $subModule = new \stdClass();
    $subModule->AllUsers = $module->AllUsers ?? [];
    
    // Get tablestyle for THIS specific report
    $reportTablestyleRecords = DB::table('rsoft_advanced_report_tablestyle')->where('report_id', $rid)->get();
    
    // Get tablestyle data - it returns an ARRAY, not an object
    if ($reportTablestyleRecords->isNotEmpty()) {
        $tablestyleData = $this->getTablestyle($reportTablestyleRecords);
    } else {
        $tablestyleData = $this->getDefaultTablestyle();
    }
    $module->previewsorting= $this->previewsorting;
    $module->previewcolumnname=$this->previewcolumnname;
        if($module->previewsorting=='ASC'){
            $module->previewsorting= 'DESC';
        }else if($module->previewsorting=='DESC'){
            $module->previewsorting= 'ASC';
        }else{
            $module->previewsorting= 'ASC';
        }
    // Store as array (since getTablestyle returns array)
    $subModule->tablestyle = $tablestyleData;
    
    $subModule->Allcustomefiltercondforfieldstypes = $module->Allcustomefiltercondforfieldstypes ?? [];
    $subModule->allpicklistvalues = $module->allpicklistvalues ?? [];
    $subModule->allCity = $module->allCity ?? [];
    $subModule->allState = $module->allState ?? [];
    $subModule->allCountry = $module->allCountry ?? [];
    $subModule->nameprefix = $module->nameprefix ?? [];
    $subModule->phoneprefix = $module->phoneprefix ?? [];
    $subModule->Assignedtousers = $module->Assignedtousers ?? [];
    $subModule->Filteremptyconditionarray = $module->Filteremptyconditionarray ?? [];
    $subModule->RoleBasedUsers = $module->RoleBasedUsers ?? [];
    
    $reportall_payload = $rData['reportall'] ?? ($rData['report_data']['reportall']['reportall'] ?? $rData['report_data']['reportall'] ?? []);
    $subModule->reportresult = $reportall_payload['reportresult'] ?? ($rData['reportresult'] ?? []);
    $subModule->totalRecords = $reportall_payload['totalRecords'] ?? ($rData['totalRecords'] ?? 0);
    $subModule->reportfields = $reportall_payload['reportfields'] ?? ($rData['reportfields'] ?? []);
    $subModule->reportcolumns = $reportall_payload['reportcolumns'] ?? ($rData['reportcolumns'] ?? []);
    $subModule->groupbycolumns = $reportall_payload['groupbycolumns'] ?? ($rData['groupbycolumns'] ?? []);
    $subModule->groupbyrows = $reportall_payload['groupbyrows'] ?? ($rData['groupbyrows'] ?? []);
    $subModule->aggregatecolumns = $reportall_payload['aggregatecolumns'] ?? ($rData['aggregatecolumns'] ?? []);
    $subModule->coloumnfieldtypes = $reportall_payload['coloumnfieldtypes'] ?? ($rData['coloumnfieldtypes'] ?? []);
    $subModule->reportarray = $rData['reportarray'] ?? ($rData['reportarray1'] ?? []);
    $subModule->aggrateValues = $rData['aggrateValues'] ?? ($rData['report_data']['aggrateValues'] ?? []);
    $subModule->Totalaggregatecolumn = $reportall_payload['Totalaggregatecolumn'] ?? ($rData['Totalaggregatecolumn'] ?? null);
    $subModule->report_id = $rid;
    
    $misReportDetail = DB::table('rsoft_advanced_report')->where('report_id', $rid)->first();
    $subModule->reportdetails = $misReportDetail ? collect([$misReportDetail]) : collect();
    
    // Set module_id
    if ($misReportDetail && $misReportDetail->primarymodule) {
        $subModule->module_id = $misReportDetail->primarymodule;
        $subModule->primarymodule = $misReportDetail->primarymodule;
    } else {
        $firstField = DB::table('rsoft_module_fields')
            ->where('module', $subModule->report_id)
            ->first();
        if ($firstField) {
            $subModule->module_id = $firstField->module;
            $subModule->primarymodule = $firstField->module;
        } else {
            $subModule->module_id = null;
            $subModule->primarymodule = null;
        }
    }
    
    // Extract tablestyle properties using ARRAY access (since getTablestyle returns array)
    $tablestyleArray = $subModule->tablestyle;
    
    // Set properties with defaults
    $subModule->tableClass = isset($tablestyleArray['tstyle']) ? $tablestyleArray['tstyle'] : 'no-borders';
    $subModule->borderColor = isset($tablestyleArray['tborder_color']) ? $tablestyleArray['tborder_color'] : '#cccccc';
    $subModule->headerStyle = isset($tablestyleArray['hstyle']) ? $tablestyleArray['hstyle'] : '';
    $subModule->bodyStyle = isset($tablestyleArray['bstyle']) ? $tablestyleArray['bstyle'] : '';
    $subModule->footerStyle = isset($tablestyleArray['fstyle']) ? $tablestyleArray['fstyle'] : '';
    $subModule->oddRowColor = isset($tablestyleArray['oddrowcolor']) ? $tablestyleArray['oddrowcolor'] : '#ffffff';
    $subModule->evenRowColor = isset($tablestyleArray['evenrowcolor']) ? $tablestyleArray['evenrowcolor'] : '#f9f9f9';
    $subModule->footerBgColor = isset($tablestyleArray['footer_bg_color']) ? $tablestyleArray['footer_bg_color'] : '#f3f4f6';
    
    // Add footer_bg_color to tablestyle array if not present
    if (!isset($tablestyleArray['footer_bg_color'])) {
        $subModule->tablestyle['footer_bg_color'] = $subModule->footerBgColor;
    }
    
    // Debug logging
    if (app()->environment('local')) {
        \Log::info("Report {$rid} tablestyle properties:", [
            'tableClass' => $subModule->tableClass,
            'oddRowColor' => $subModule->oddRowColor,
            'evenRowColor' => $subModule->evenRowColor,
            'borderColor' => $subModule->borderColor,
            'tablestyle_type' => gettype($subModule->tablestyle),
            'is_array' => is_array($subModule->tablestyle)
        ]);
    }
    
    $module->misPreviewData[$rid]['Module'] = $subModule;
}
            $module->currenttotalcount=($this->previewpage+1)*$this->previewperPage;
            $module->searchfieldid = $this->searchfieldid;
            $module->searchfieldtype = $this->searchfieldtype;
            $module->searchcondtion = $this->searchcondtion;
            $module->searchfieldvalue = $this->searchfieldvalue;
            $module->searchcolname = $this->searchcolname;
            $module->report_filter = $this->getReportFilters($report_id, $misreportdetails);
            
            $this->headermenu = view('Module.AdvancedReport.HeaderMenu', ['Module' => $module,'mode' => 'previewlist'])->render();
            $this->reportcontent = view('Module.AdvancedReport.MISPreviewResultView', ['Module' => $module,'mode' => $value])->render();
            $this->dispatchBrowserEvent('mis-preview-loaded', ['report_id' => $currentreport]);
        }
         else {
          //  dd($module_id);
            $allreports= $this->getAllReports($module_id);
            $module->allreports= $allreports['allreports'];
            $module->totalCount= $allreports['totalCount'];
            $module->currenttotalcount=($this->page+1)*$this->perPage;  
            $module->sortmode= $this->sortmode;   
            $module->report_column_name= $this->column_name;
            if($module->sortmode=='ASC'){
                $module->sortmode= 'DESC';
            }else if($module->sortmode=='DESC'){
                $module->sortmode= 'ASC';
            }else{
                $module->sortmode= 'ASC';
            }
             if (count($this->allreportslist)) {
                if ($this->searchValue != '' && $this->filtermode == 'search') {
                    $this->allreportslist = [];
                } elseif ($this->filtermode == 'sort' || $listtab == 'listtab') {
                    $this->allreportslist = [];
                } else {
                    $module->allreports = array_merge($this->allreportslist, $module->allreports);
                }
               
            }
            $module->allreports = $module->allreports;
            $module->searchValue=$this->searchValue;
            $module->reportmodulelist=$this->getReportModuleList($profileid);
            $module->profilepermissions=$this->getUSerProfilePermissions('Advanced_report');
            $this->createreport = view('Module.AdvancedReport.ListViewHeader', ['Module' => $module, 'mode' => 'moduletab'])->render();
            $this->headermenu = view('Module.AdvancedReport.HeaderMenu',['Module'=>$module,'mode'=>'modulelist'])->render();
            $this->sidebarmenulist = view('Module.AdvancedReport.SidebarMenuList',['Module'=>$module,'mode'=>'modulelist'])->render();
            if(count($module->allreports)){
                $this->reportcontent = view('Module.AdvancedReport.ReportListView',['Module'=>$module])->render();
            }else{
                $this->reportcontent = view('Module.AdvancedReport.NoData')->render();
            }
        }
        $this->emit('select2Updated');
    }

    public function getReportModuleList($profileid){
        $userid = Auth::user()->id;
        $roleid = Auth::user()->user_roles;
        //$reportmodulelist=DB::table('rsoft_advanced_report')->join('rsoft_modules','rsoft_advanced_report.primarymodule','=','rsoft_modules.id')->join('rsoft_profile2tab','rsoft_advanced_report.primarymodule','=','rsoft_profile2tab.tabid')->where('rsoft_modules.status',0)->where('profileid',$profileid)->where('rsoft_profile2tab.permission',1)->groupBy('primarymodule')->orderBy('report_seq')->get();

        $reportmodulelist = DB::table('rsoft_advanced_report')
        // Join with rsoft_modules and filter by status
        ->join('rsoft_modules', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_modules.id')
        ->where('rsoft_modules.status', 0) // Ensure module status is active
        
        // Join with other tables
        ->join('rsoft_profile2tab', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_profile2tab.tabid')
        ->leftJoin('rsoft_advanced_report_sharing', 'rsoft_advanced_report.report_id', '=', 'rsoft_advanced_report_sharing.report_id')
        // Filter by profile ID and permission
        ->where('rsoft_profile2tab.profileid', $profileid)
        ->where('rsoft_profile2tab.permission', 1)
        ->where('rsoft_advanced_report.report_moduletype', '!=', 'MISReport')

        // Apply user-based permission filtering
        ->when($userid != '1', function($query) use ($userid, $roleid) {
            $query->where(function($query) use ($userid, $roleid) {
                $query->where('rsoft_advanced_report.smcreatorid', $userid)
                    ->orWhere('rsoft_advanced_report_sharing.share_type', 'public')
                    ->orWhereIn('rsoft_advanced_report_sharing.share_width_user', [$userid, $roleid]);
            });
        })
        ->groupBy('primarymodule')
        // Order by sequence and fetch results
        ->orderBy('rsoft_advanced_report.report_seq')
        ->get();
        return  $reportmodulelist;
    }
    

    public function InitializeValueClear(){
        $this->moduleSelect='';
        $this->searchValue ='';
    }

   public function getAllReports($module_id = '')
{  
    $userid = Auth::user()->id;
    $roleid = Auth::user()->users_roles;
        $page=$this->page;
       
    $perPage = $this->perPage;
   
    $offset = $page * $perPage;
        $searchvalue=$this->searchValue;
        $column_name=$this->column_name;
        $sortmode=$this->sortmode;
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $roleid)->first()->permissionprofileid;
        $baseQuery = DB::table('rsoft_advanced_report')
        // Joining rsoft_modules table with a check on primary module and ensuring status is 0
        ->join('rsoft_modules', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_modules.id')
        ->where('rsoft_modules.status', 0) // Apply this condition right after the join

        // Joining other necessary tables
        ->join('rsoft_profile2tab', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_profile2tab.tabid')
        ->leftJoin('rsoft_advanced_report_sharing', 'rsoft_advanced_report.report_id', '=', 'rsoft_advanced_report_sharing.report_id')
        ->leftJoin('rsoft_users as rsoft_users_smcreatorid', 'rsoft_users_smcreatorid.id', '=', 'rsoft_advanced_report.smcreatorid')
        ->leftJoin('rsoft_users as rsoft_users_modifiedby', 'rsoft_users_modifiedby.id', '=', 'rsoft_advanced_report.modifiedby')

        // Applying filters on profile ID and permission
        ->where('profileid', $profileid)
        ->where('permission', 1)

        // Conditionally applying user-based permissions
        ->when($userid != '1', function($query) use ($userid, $roleid) {
            $query->where(function($query) use ($userid, $roleid) {
                $query->where('smcreatorid', $userid)
                    ->orWhere('share_type', 'public')
                    ->orWhereIn('share_width_user', [$userid, $roleid]);
            });
        })

        // Conditionally applying module filter
        ->when(!empty($module_id), function($query) use ($module_id) {
            return $query->where('primarymodule', $module_id);
        })

        // Applying search filter if search value is provided
        ->when(!empty($searchvalue), function($query) use ($searchvalue) {
            $escapedSearchValue = str_replace(['\\', '%', '_'], ['\\\\', '\%', '\_'], $searchvalue);
            return $query->where(function($query) use ($escapedSearchValue) {
                $query->where('report_name', 'like', '%' . $escapedSearchValue . '%')
                    ->orWhere('description', 'like', '%' . $escapedSearchValue . '%')
                    ->orWhere('rsoft_modules.label', 'like', '%' . $escapedSearchValue . '%')
                    ->orWhere('rsoft_users_smcreatorid.users_firstname', 'like', '%' . $escapedSearchValue . '%')
                    ->orWhere('rsoft_users_smcreatorid.users_lastname', 'like', '%' . $escapedSearchValue . '%')
                    ->orWhere('rsoft_users_modifiedby.users_firstname', 'like', '%' . $escapedSearchValue . '%')
                    ->orWhere('rsoft_users_modifiedby.users_lastname', 'like', '%' . $escapedSearchValue . '%')
                    ->orWhere(DB::raw("CONCAT(rsoft_users_smcreatorid.users_firstname, ' ', rsoft_users_smcreatorid.users_lastname)"), 'like', '%' . $escapedSearchValue . '%')
                    ->orWhere(DB::raw("CONCAT(rsoft_users_modifiedby.users_firstname, ' ', rsoft_users_modifiedby.users_lastname)"), 'like', '%' . $escapedSearchValue . '%');
            });
        });

        // Calculating the total count of grouped results
        $totalCount = (clone $baseQuery)->where('rsoft_advanced_report.report_moduletype', '!=', 'MISReport')->groupBy('rsoft_advanced_report.report_id')->get()->count();

        // Fetching the reports with pagination and ordering
        $reports = $baseQuery
        ->select(
            'rsoft_advanced_report.*',
            'rsoft_modules.*',
            'rsoft_advanced_report_sharing.*',
            'rsoft_advanced_report.report_id as report_id'
        )
        ->where('rsoft_advanced_report.report_moduletype', '!=', 'MISReport')
        ->groupBy('rsoft_advanced_report.report_id')
        
        // Applying default or custom sorting
        ->when(empty($column_name), function($query) {
            return $query->orderBy('report_seq', 'ASC');
        })
         ->when(!empty($column_name), function($query) use ($column_name, $sortmode) {
            if ($column_name === 'primarymodule') {
                return $query->orderBy('rsoft_modules.label', $sortmode);
            }elseif($column_name == 'smcreatorid' || $column_name == 'modifiedby'){
                $userTable = 'rsoft_users_'. $column_name;
                $query->orderBy(DB::raw("CONCAT($userTable.users_firstname, ' ', $userTable.users_lastname)"), $sortmode);

            }
            return $query->orderBy($column_name, $sortmode);
        })
        ->limit($perPage)
        ->offset($offset)
        ->get();

        $reports=json_decode(json_encode($reports),true);
       
        return [
            'totalCount' => $totalCount,
            'allreports' => $reports,
        ];
    }
    

    public function getRecordPermission($report_id,$module_id){
        $userid = Auth::user()->id;
        $roleid = Auth::user()->users_roles;
        $reportsper = DB::table('rsoft_advanced_report_sharing')
            ->select(
                'rsoft_advanced_report.smcreatorid', 
                'rsoft_advanced_report_sharing.*', 
            )
            ->join('rsoft_modules', 'rsoft_advanced_report_sharing.module_id', '=', 'rsoft_modules.id')
            ->Join('rsoft_advanced_report', 'rsoft_advanced_report_sharing.report_id', '=', 'rsoft_advanced_report.report_id')->where('rsoft_advanced_report_sharing.report_id', $report_id)->where('rsoft_advanced_report_sharing.module_id', $module_id)->WhereIn('share_width_user', [$userid, $roleid]) ->groupBy('rsoft_advanced_report_sharing.report_id')->get();   
            $sharepermission=1;
            $advanced=DB::table('rsoft_advanced_report')->where('report_id',$report_id)->get();
            if( $userid==$advanced[0]->smcreatorid){
                $sharepermission=3;
            }
        if(count($reportsper)){
            if($reportsper[0]->smcreatorid== $userid){
                $sharepermission=3;
            }else{
                $sharepermission=$reportsper[0]->share_permission;
            }
        }
        return $sharepermission;
    }



    public function getReportReultRecord($report_id,$reportdetails,$viewmode,$downloadmode=''){
        $response=[];
        $reportresult =[];
        $coloumnfieldtypes =[];
        $reportfields =[];
        $columns_coloumn_name=[];
        //$userid=Auth::user()->id;
        $userid=(new user())->getCurrentUserId();
        $searchQuery=$this->searchQuery;
      
       $response['totalRecords']='';
       $previewgtotalresult=[];
        $this->previewcolumnname = request()->get('previewcolumnname', $this->previewcolumnname);
        $this->previewsorting = request()->get('previewsorting', $this->previewsorting);
        $roleid = (new user())->getCurrentUserRoleId();
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $roleid)->get()[0]->permissionprofileid;

        $reportcolumn = DB::table('rsoft_advanced_report_columns')
        ->join('rsoft_module_fields', 'rsoft_advanced_report_columns.columns_fieldid', '=', 'rsoft_module_fields.id')
        ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
        ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
        ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
        ->where('rsoft_profile2field.profileid', $profileid)
        ->when($viewmode != 'SendMail', function($query) {
            $query->where('rsoft_profile2tab.permission', 1);
        })
        ->where('rsoft_profile2tab.profileid', $profileid)
        ->where('rsoft_advanced_report_columns.report_id', $report_id)
        ->where('rsoft_module_fields.active', 1)
        ->where('rsoft_modules.status', 0)
        ->where('rsoft_advanced_report_columns.columns_isformula','!=',1)
        ->orderBy('rsoft_advanced_report_columns.columns_seq')
        ->select(
            'rsoft_advanced_report_columns.*',
            'rsoft_module_fields.*',
            'rsoft_modules.label as modulelabel',
            'rsoft_profile2field.visible'
        )->get();

        $groupbycolumn = DB::table('rsoft_advanced_report_groupbycolumns')
        ->join('rsoft_module_fields', 'rsoft_advanced_report_groupbycolumns.groupbycolumns_fieldid', '=', 'rsoft_module_fields.id')
        ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
        ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
        ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
        ->where('rsoft_profile2field.profileid', $profileid)
        ->when($viewmode != 'SendMail', function($query) {
            $query->where('rsoft_profile2tab.permission', 1);
        })
        ->where('rsoft_profile2tab.profileid',$profileid)
        ->where('report_id', $report_id)
        ->where('rsoft_module_fields.active', 1)
        ->where('rsoft_modules.status', 0)
        ->orderBy('groupbycolumns_seq')
        ->select(
            'rsoft_advanced_report_groupbycolumns.*',
            'rsoft_module_fields.*',
            'rsoft_modules.label as modulelabel',
             'rsoft_modules.name_db',
            'rsoft_profile2field.visible'
        )
        ->groupby('rsoft_advanced_report_groupbycolumns.groupbycolumns_id')
        ->get();

        $groupbyrow = DB::table('rsoft_advanced_report_groupbyrows')
        ->join('rsoft_module_fields', 'rsoft_advanced_report_groupbyrows.groupbyrows_fieldid', '=', 'rsoft_module_fields.id')
        ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
        ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
        ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
        ->where('rsoft_profile2field.profileid', $profileid)
        ->when($viewmode != 'SendMail', function($query) {
            $query->where('rsoft_profile2tab.permission', 1);
        })
        ->where('rsoft_profile2tab.profileid',$profileid)
        ->where('report_id', $report_id)
        ->where('rsoft_module_fields.active', 1)
        ->where('rsoft_modules.status', 0)
        ->orderBy('groupbyrows_seq')
        ->select(
            'rsoft_advanced_report_groupbyrows.*',
            'rsoft_module_fields.*',
            'rsoft_modules.label as modulelabel',
             'rsoft_modules.name_db',
            'rsoft_profile2field.visible'
        )
        ->groupby('rsoft_advanced_report_groupbyrows.groupbyrows_id')
        ->get();

        $Totalaggregatecolumn = DB::table('rsoft_advanced_report_aggregatecolumns')
        ->join('rsoft_module_fields', 'rsoft_advanced_report_aggregatecolumns.aggregatecolumns_fieldid', '=', 'rsoft_module_fields.id')
        ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
        ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
        ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
        ->where('rsoft_profile2field.profileid', $profileid)
        ->when($viewmode != 'SendMail', function($query) {
            $query->where('rsoft_profile2tab.permission', 1);
        })
        ->where('rsoft_profile2tab.profileid',$profileid)
        ->where('report_id', $report_id)
        ->where('rsoft_module_fields.active', 1)
        ->where('rsoft_modules.status', 0)
        ->orderBy('aggregatecolumns_seq')
        ->select(
            'rsoft_advanced_report_aggregatecolumns.*',
            'rsoft_module_fields.*',
            'rsoft_modules.label as modulelabel',
             'rsoft_modules.name_db',
            'rsoft_profile2field.visible'
        )
        ->groupby('rsoft_advanced_report_aggregatecolumns.aggregatecolumns_id')
        ->get();

        $reportcolumns=[];
        foreach($reportcolumn as $key =>$val){
            $count = DB::table('rsoft_fieldmodulerel')->join('rsoft_module_fields', 'rsoft_fieldmodulerel.fieldid', '=', 'rsoft_module_fields.id')->where('rsoft_fieldmodulerel.module',$reportdetails[0]->name)->where('relmodule',$val->columns_modulename)->where('rsoft_module_fields.active',1)->get();
            if(count($count) || $reportdetails[0]->name==$val->columns_modulename){
                $reportcolumns[$key]=$val;
            }elseif($val->columns_isformula == 1){
                $reportcolumns[$key]=$val;
            }
        }  
        $reportcolumns = collect($reportcolumns);

        $formulacolumn = DB::table('rsoft_advanced_report_formula')
        ->join('rsoft_advanced_report_columns',  'rsoft_advanced_report_formula.formula_id', '=','rsoft_advanced_report_columns.columns_fieldid')
        ->leftjoin('rsoft_field_formula', 'rsoft_advanced_report_formula.formula_functionid', '=', 'rsoft_field_formula.functionid')
        ->orderBy('rsoft_advanced_report_columns.columns_seq')
        ->where('rsoft_advanced_report_columns.report_id',$report_id)
        ->select(
            'rsoft_advanced_report_columns.*',
            'rsoft_advanced_report_formula.*',
            'rsoft_field_formula.*'
        )
        ->get();
        $formulacolumns=[];
        if(count($formulacolumn)){
            foreach($formulacolumn as $key =>$val){
                $formulacolumns[$key]=$val;
            }  
        }
        $reportcolumns = $reportcolumns->merge($formulacolumns);

        $commentscolumn = new \stdClass();
        $commentscolumn = collect();
        $commentcheck=DB::table('rsoft_relatedlists')->where('rsoft_relatedlists.tabid',$reportdetails[0]->primarymodule)->join('rsoft_profile2tab','rsoft_relatedlists.related_tabid','=','rsoft_profile2tab.tabid')->where('profileid',$profileid)->where('rsoft_profile2tab.permission',1)->where('rsoft_relatedlists.presence', 0)->where('related_tabid',2)->get();
        if(count( $commentcheck)){
            $commentscolumn = DB::table('rsoft_advanced_report_columns')->where('columns_coloumn_name','Comments')->where('report_id',$report_id)
            ->orderBy('columns_seq')
            ->get();
            $reportcolumns = $reportcolumns->merge($commentscolumn);
        }
 
        $groupbycolumns=[];
        foreach($groupbycolumn as $key =>$val){
            $count = DB::table('rsoft_fieldmodulerel')->join('rsoft_module_fields', 'rsoft_fieldmodulerel.fieldid', '=', 'rsoft_module_fields.id')->where('rsoft_fieldmodulerel.module',$reportdetails[0]->name)->where('relmodule',$val->groupbycolumns_modulename)->where('rsoft_module_fields.active',1)->get();
            if(count($count) || $reportdetails[0]->name==$val->groupbycolumns_modulename){
                $groupbycolumns[$key]=$val;
            }
        } 
        $groupbyrows=[];
        foreach($groupbyrow as $key =>$val){
            $count = DB::table('rsoft_fieldmodulerel')->join('rsoft_module_fields', 'rsoft_fieldmodulerel.fieldid', '=', 'rsoft_module_fields.id')->where('rsoft_fieldmodulerel.module',$reportdetails[0]->name)->where('relmodule',$val->groupbyrows_modulename)->where('rsoft_module_fields.active',1)->get();
            if(count($count) || $reportdetails[0]->name==$val->groupbyrows_modulename){
                $groupbyrows[$key]=$val;
            }
        }
        $misReport = DB::table('mis_report_table')->where('report_id', $this->misCurrentReportId)->where('id', $this->currentReportId)->first();
        $expandDetail =($this->pagemode === 'MISPreview'&& isset($misReport->mis_active)&& (int) $misReport->mis_active === 1)
                                        ? ($misReport->mis_expand_detail_rows ?? 0)
                                        : ($reportdetails[0]->expand_detail_rows ?? 0);
        if((count($groupbyrows)==0 || $expandDetail == 1 || $downloadmode =='DetailReport') && $downloadmode !='GroupReport'){  
            $aggregatecolumn = DB::table('rsoft_advanced_report_aggregatecolumns')
            ->join('rsoft_module_fields', 'rsoft_advanced_report_aggregatecolumns.aggregatecolumns_fieldid', '=', 'rsoft_module_fields.id')
            ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
            ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
            ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
            ->where('rsoft_profile2field.profileid', $profileid)
            ->when($viewmode != 'SendMail', function($query) {
                $query->where('rsoft_profile2tab.permission', 1);
            })
            ->where('rsoft_profile2tab.profileid',$profileid)
            ->where('report_id', $report_id)
            ->where('rsoft_module_fields.active', 1)
            ->where('rsoft_modules.status', 0)
            ->where('aggregatecolumns_calculation_type','!=','')
             ->where('aggregatecolumns_calculation_type','!=','picklist_tracking')
            ->orderBy('aggregatecolumns_seq')
            ->select(
                'rsoft_advanced_report_aggregatecolumns.*',
                'rsoft_module_fields.*',
                'rsoft_modules.label as modulelabel',
                'rsoft_modules.name_db',
                'rsoft_profile2field.visible'
            )
            ->groupby('rsoft_advanced_report_aggregatecolumns.aggregatecolumns_id')
            ->get();
        }else{
            $aggregatecolumn = DB::table('rsoft_advanced_report_aggregatecolumns')
            ->join('rsoft_module_fields', 'rsoft_advanced_report_aggregatecolumns.aggregatecolumns_fieldid', '=', 'rsoft_module_fields.id')
            ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
            ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
            ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
            ->where('rsoft_profile2field.profileid', $profileid)
            ->when($viewmode != 'SendMail', function($query) {
                $query->where('rsoft_profile2tab.permission', 1);
            })
            ->where('rsoft_profile2tab.profileid',$profileid)
            ->where('report_id', $report_id)
            ->where('rsoft_module_fields.active', 1)
            ->where('rsoft_modules.status', 0)
            ->where('aggregatecolumns_calculation_type','!=','')
            ->orderBy('aggregatecolumns_seq')
            ->select(
                'rsoft_advanced_report_aggregatecolumns.*',
                'rsoft_module_fields.*',
                'rsoft_modules.label as modulelabel',
                'rsoft_modules.name_db',
                'rsoft_profile2field.visible'
            )
            ->groupby('rsoft_advanced_report_aggregatecolumns.aggregatecolumns_id')
            ->get();
        }
        
        $aggregatecolumns=[];
        $picklist_tracking_count=0;
        $agg_picklist_tracking_count=0;
        foreach($aggregatecolumn as $key =>$val){
            $count = DB::table('rsoft_fieldmodulerel')->join('rsoft_module_fields', 'rsoft_fieldmodulerel.fieldid', '=', 'rsoft_module_fields.id')->where('rsoft_fieldmodulerel.module',$reportdetails[0]->name)->where('relmodule',$val->aggregatecolumns_modulename)->where('rsoft_module_fields.active',1)->get();
            if(count($count) || $reportdetails[0]->name==$val->aggregatecolumns_modulename){
                $aggregatecolumns[$key]=$val;
                if($val->aggregatecolumns_calculation_type=='picklist_tracking'){
                    $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$val->picklist_tracking_id)->where('field_id','!=',0)->get();
                    if(count($trackingdetails)){
                        $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                        foreach($picklist_data as $picklistval){
                             $picklist_tracking_count++;
                        }
                    }
                }else{
                    $agg_picklist_tracking_count++;
                }
            }
        } 
        if($picklist_tracking_count !=0){
            $picklist_tracking_count= $picklist_tracking_count-$agg_picklist_tracking_count;
        }
   
        $sql = "SELECT *  FROM rsoft_advanced_report_filter LEFT JOIN rsoft_module_fields ON rsoft_module_fields.id = rsoft_advanced_report_filter.fieldid LEFT JOIN rsoft_modules ON rsoft_modules.id = rsoft_module_fields.module WHERE  rsoft_advanced_report_filter.report_id ='".$report_id."'";
        $Records = DB::select($sql);
        $imgquery='';
        if(count($Records)){
            $imgfieldid=[];
            foreach ($Records as $imgval){
                if($imgval->field_type==12 && !in_array($imgval->fieldid,$imgfieldid)){
                    $imgquery .= " LEFT JOIN  rsoft_attachments as  rsoft_attachments_$imgval->coloumn_name   ON FIND_IN_SET(rsoft_attachments_$imgval->coloumn_name.attachments_id, $imgval->name_db.$imgval->coloumn_name) > 0 ";
                    array_push($imgfieldid,$imgval->fieldid);
                }
            }
        }
       
        $tablename=$reportdetails[0]->name_db;
        $filterquery=$this->getFilterConditions($report_id,$reportdetails);
       //dd($filterquery);
        $configurationeditor=DB::table('rsoft_configurationeditor')->get();
        $exportlimit=$configurationeditor[0]->maximum_export_limit;
        // $mainusertablenamesmownerid  = 'rsoft_user_'.$tablename.'_smownerid';
        // $mainusertablenamesmcreatorid = 'rsoft_user_'.$tablename.'_smcreatorid';
        // $mainusertablenamemodifiedby = 'rsoft_user_'.$tablename.'_modifiedby';
        // $maintablename='rsoft_crmentity_'.$tablename;
        // $maintableuserquery = ' LEFT JOIN rsoft_users as '.$mainusertablenamesmownerid.' ON '.$maintablename.'.smownerid = '.$mainusertablenamesmownerid.'.id LEFT JOIN rsoft_users as '.$mainusertablenamesmcreatorid.' ON '.$maintablename.'.smcreatorid = '.$mainusertablenamesmcreatorid.'.id  LEFT JOIN rsoft_users as '.$mainusertablenamemodifiedby.' ON '.$maintablename.'.modifiedby ='.$mainusertablenamemodifiedby.'.id';
        
        $crmentitytablename='rsoft_crmentity_'.$tablename;
        $RecordsAccess=[];
        if($reportdetails[0]->data_handling==3){
            $RecordsAccess = (new User())->getRecordsAccessQuery($reportdetails[0]->name,$tablename);
        }
        $misReport = DB::table('mis_report_table')->where('report_id', $this->misCurrentReportId)->where('id', $this->currentReportId)->first();
        $expandDetail =($this->pagemode === 'MISPreview'&& isset($misReport->mis_active)&& (int) $misReport->mis_active === 1)
                                        ? ($misReport->mis_expand_detail_rows ?? 0)
                                        : ($reportdetails[0]->expand_detail_rows ?? 0);
        if((count($groupbyrows)==0 || $expandDetail == 1 || $downloadmode =='DetailReport') && $downloadmode !='GroupReport'){ 
           $reportcol=json_decode(json_encode($reportcolumns),true);
            $coloumn_name=array_column($reportcol,'columns_coloumn_name');
            foreach ($reportcolumns as $index => $col) {
                if($col->columns_coloumn_name!='comments' && $col->columns_isformula !=1){
                    $columns_coloumn_name []= $col->columns_coloumn_name . ' AS `' . $col->columns_coloumn_name.'`';
                }elseif($col->columns_coloumn_name!='comments'){
                    preg_match_all('/\$(.*?)\$/', $col->formula_value, $matches);
                    if(count($matches[1])){
                        foreach($matches[1] as $key =>$value){
                            $explodeval=explode('.',$value);
                            if(count($explodeval)==1){
                                $count = DB::table('rsoft_module_fields')->where('rsoft_module_fields.colname',$value)->where('rsoft_module_fields.active',1)->get();
                                if(count($count)){
                                    if($reportdetails[0]->id != $count[0]->module ){
                                        $relmodule = DB::table('rsoft_modules')->where('id',$count[0]->module)->get();
                                        $rcount = DB::table('rsoft_fieldmodulerel')->where('module',$reportdetails[0]->name)->where('relmodule',$relmodule[0]->name)->get();
                                        if(count($rcount)){
                                            $columns_coloumn_name []= $value. ' AS `' . $value.'`';
                                        }
                                    }else{
                                        $columns_coloumn_name []= $value. ' AS `' . $value.'`';
                                    }
                                }
                            }else{
                                $columns_coloumn_name []= $value. ' AS `' . $value.'`';
                            }
                        }
                    }
                }
            }
            $coloumnfieldtypes=array_column($reportcol,'columns_coloumn_fieldtype','columns_coloumn_name');
            $aggregatecol=json_decode(json_encode($aggregatecolumns),true);
           
 
            $response['commentscolumn']=$commentscolumn;
            $reportfields=array_merge($reportcol,$aggregatecol);
           
            foreach($aggregatecol as $key =>$val){
                $cname='aggregate|#|' . $val['aggregatecolumns_calculation_type'] . '|#|'.$val['aggregatecolumns_coloumn_name'];
                    $columns_coloumn_name[] =  $val['aggregatecolumns_coloumn_name'].' as ` '.$cname.'`';
                $coloumnfieldtypes[$val['aggregatecolumns_calculation_type'] . '_'.$val['aggregatecolumns_coloumn_name']]=$val['aggregatecolumns_fieldtype'];
            }
           
            $implodecolum=$tablename.'.id';
            if(count($columns_coloumn_name)){
                $implodecolum .=',';
            }
            $implodecolum.=implode(',',$columns_coloumn_name);
           
           
            $reportresult = DB::table($tablename)
                ->join('rsoft_crmentity as ' . $crmentitytablename, $tablename . '.id', '=', $crmentitytablename . '.crmid')
                ->leftJoin('rsoft_users as rsoft_user_'.$tablename.'_smownerid', $crmentitytablename . '.smownerid', '=', 'rsoft_user_'.$tablename.'_smownerid.id')
                ->leftJoin('rsoft_users as rsoft_user_'.$tablename.'_smcreatorid', $crmentitytablename . '.smcreatorid', '=', 'rsoft_user_'.$tablename.'_smcreatorid.id')
                ->leftJoin('rsoft_users as rsoft_user_'.$tablename.'_modifiedby', $crmentitytablename . '.modifiedby', '=', 'rsoft_user_'.$tablename.'_modifiedby.id');

                $relatedmodule = DB::table('rsoft_fieldmodulerel')
                ->join('rsoft_modules', 'rsoft_fieldmodulerel.relmodule', '=', 'rsoft_modules.name')
                ->where('rsoft_fieldmodulerel.module', $reportdetails[0]->name)
                ->where('relmodule', '!=', $reportdetails[0]->name)
                ->when($reportdetails[0]->moduletype == 'Inventory', function($query) {
                    $query->where('relmodule', '!=', 'Products');
                })
                ->get();
                if (!empty($relatedmodule)) {
                    foreach ($relatedmodule as $relatedtable) {
                        $relcrmentitytablename = 'rsoft_crmentity_' . $relatedtable->name_db;
                        $fieldData = DB::table('rsoft_module_fields')
                            ->where('id', $relatedtable->fieldid)
                            ->pluck('colname');
                        if ($fieldData->isNotEmpty()) {
                            $reportresult->leftJoin($relatedtable->name_db, $reportdetails[0]->name_db . '.' . $fieldData[0], '=', $relatedtable->name_db . '.id')
                                ->leftJoin('rsoft_crmentity as ' . $relcrmentitytablename, $relatedtable->name_db . '.id', '=', $relcrmentitytablename . '.crmid')
                                ->leftJoin('rsoft_users as rsoft_user_'.$relatedtable->name_db.'_smownerid', $relcrmentitytablename . '.smownerid', '=', 'rsoft_user_'.$relatedtable->name_db.'_smownerid.id')
                                ->leftJoin('rsoft_users as rsoft_user_'.$relatedtable->name_db.'_smcreatorid', $relcrmentitytablename . '.smcreatorid', '=', 'rsoft_user_'.$relatedtable->name_db.'_smcreatorid.id')
                                ->leftJoin('rsoft_users as rsoft_user_'.$relatedtable->name_db.'_modifiedby', $relcrmentitytablename . '.modifiedby', '=', 'rsoft_user_'.$relatedtable->name_db.'_modifiedby.id');
                        }
                    }
                }
            //}

            if (!empty($imgquery)) {
                preg_match('/LEFT JOIN (.+) ON (.+)/i', $imgquery, $matches);
                $joinTable = $matches[1] ?? null;
                $joinCondition = $matches[2] ?? null;
                
                if ($joinTable && $joinCondition) {
                    $reportresult->leftJoin(DB::raw($joinTable), function($join) use ($joinCondition) {
                        $join->on(DB::raw($joinCondition), '>', DB::raw('0'));
                    });
                }
            }
          
            if(!empty( $this->preimgquery)){
                preg_match('/LEFT JOIN (.+) ON (.+)/i', $this->preimgquery, $matches);
                $joinTable = $matches[1] ?? null;
                $joinCondition = $matches[2] ?? null;
                
                if ($joinTable && $joinCondition) {
                    $reportresult->leftJoin(DB::raw($joinTable), function($join) use ($joinCondition) {
                        $join->on(DB::raw($joinCondition), '>', DB::raw('0'));
                    });
                }
            }
           
           
            $reportresult->where($crmentitytablename . '.deleted', '=', 0);
            if (!empty($filterquery)) {
                $reportresult->whereRaw($filterquery);
            }
            if ($userid != 1) {
                $reportresult->where($crmentitytablename . '.smownerid', '!=', 1);
            }

            if ($reportdetails[0]->data_handling == 2) {
                $reportresult->where($crmentitytablename . '.smownerid', '=', $userid);
            }
            if ($reportdetails[0]->data_handling == 3 && !empty($RecordsAccess['sharingrecordusers'])) {
                $sharingcondition = substr($RecordsAccess['sharingrecordusers'], 4);
                $reportresult->whereRaw($sharingcondition);
            }

            if (($viewmode == 'preview' || $viewmode == 'export') && !empty($searchQuery)) {
                $reportresult->whereRaw($searchQuery);
            }

            $allowedOrderColumns = [];
            // collect real selectable aliases
            foreach ($columns_coloumn_name as $col) {
                if (preg_match('/\s+AS\s+`(.+)`/i', $col, $m)) {
                    $allowedOrderColumns[] = trim($m[1]);
                } else {
                    $allowedOrderColumns[] = trim($col);
                }
            }

            $reportresult->select(DB::raw($implodecolum)); 
            if (($viewmode == 'export' || $viewmode == 'preview') &&!empty($this->previewcolumnname) &&!empty($this->previewsorting)) {
                if (in_array($this->previewcolumnname, $allowedOrderColumns)) {
                    $sm=explode('.',$this->previewcolumnname);
                    if (isset($sm[1]) && in_array($sm[1], ['smownerid', 'smcreatorid', 'modifiedby'])) {
                        $userTable = 'rsoft_user_' . $tablename . '_' . $sm[1];
                        $reportresult->orderBy(DB::raw("CASE WHEN $userTable.users_firstname IS NULL OR $userTable.users_firstname = ''
                                            THEN $userTable.users_lastname
                                            ELSE CONCAT($userTable.users_firstname, ' ', $userTable.users_lastname)END"),$this->previewsorting);
                    } else {
                        $reportresult->orderBy($this->previewcolumnname, $this->previewsorting);
                    }
                } elseif (!empty($reportdetails[0]->name_db)) {
                    $reportresult->orderBy($reportdetails[0]->name_db . '.id', 'DESC');
                }
                $previewgtotalresult = $reportresult->get();
                $response['totalRecords']=count($previewgtotalresult);

            }else{
                if (!empty($this->previewcolumnname) && !empty($this->previewsorting)) {
                    $validColumns = array_column($reportcolumns->toArray(), 'columns_coloumn_name');
                    $validGroupByRows = array_column($groupbyrows, 'groupbyrows_coloumn_name');
                    $validGroupByColumns = array_column($groupbycolumns, 'groupbycolumns_coloumn_name');
                    $allValidFields = array_merge($validColumns, $validGroupByRows, $validGroupByColumns);
                    // Check if the field is active
                    $isActiveField = DB::table('rsoft_module_fields')
                        ->where('colname', $this->previewcolumnname)
                        ->where('active', 1)
                        ->exists();
                    if (in_array($this->previewcolumnname, $allValidFields) && $isActiveField) {
                        $sm = explode('.', $this->previewcolumnname);
                        if (isset($sm[1]) && in_array($sm[1], ['smownerid', 'smcreatorid', 'modifiedby'])) {
                            $userTable = 'rsoft_user_' . $tablename . '_' . $sm[1];
                            $reportresult->orderBy(DB::raw("CASE WHEN $userTable.users_firstname IS NULL OR $userTable.users_firstname = ''
                                            THEN $userTable.users_lastname
                                            ELSE CONCAT($userTable.users_firstname, ' ', $userTable.users_lastname)END"),$this->previewsorting);
                        } else {
                            // Use the preview column name directly for ordering    
                        $reportresult->orderBy($this->previewcolumnname, $this->previewsorting);
                        }
                    } else {
                        $reportresult->orderBy($reportdetails[0]->name_db . '.id', 'DESC');
                    }
                } elseif (!empty($reportdetails[0]->name_db)) {
                    $reportresult->orderBy($reportdetails[0]->name_db . '.id', 'DESC');
                }
            }
            $reportresult->when(!empty($viewmode), function ($query) use ($viewmode, $exportlimit) {
                if ($viewmode == 'builder') {
                    return $query->limit(25);
                } elseif ($viewmode == 'export' || $viewmode == 'SendMail') {
                    return $query->limit($exportlimit);
                } else {
                    return $query->limit($this->previewperPage)->offset($this->previewpage * $this->previewperPage);
                }
            });
                
            $reportresult = $reportresult->get();
            //dd($reportresult);
            $response['reportresult']=$reportresult;
            $response['reportMode']='DetailReport';
        }else{
            $leadstatusArray = [];
            $leadstatusArray['body'] = [];
            $TotalRecordCount=0;
            if(count($groupbyrows) || count($groupbycolumns)){
                 if($agg_picklist_tracking_count==0){
                        $picklist_tracking_count=$picklist_tracking_count-1;
                }else{
                    $picklist_tracking_count=$picklist_tracking_count+$agg_picklist_tracking_count-1;
                }
                if($reportdetails[0]->expand_group_count==0){
                    $leadstatusArray['aggregatecolumns'] =count($aggregatecolumns)+$picklist_tracking_count;
                }else{
                    $leadstatusArray['aggregatecolumns'] =count($aggregatecolumns)+1+$picklist_tracking_count;
                }
             
                $leadstatusArray['countgroupbyrow'] =count($groupbyrows);
                $leadstatusArray['countgroupbycol'] =count($groupbycolumns);
                $leadstatusArray['labelgroupbycol']='';
                $leadstatusArray['labelgroupbyrow']=[];
                $GroupbyLabelArray=[];
                $GroupbyArray=[];
                $selectval='';
                $grval='';
                $gcval='';
                $gcvalgroup='';
                $groupByColumns = [];

               
                $timeformatcheck=(new User())->getCurrentUserTimeFormat();
                $timeformat =" H:i:s";
                if($timeformatcheck=='12 hours') $timeformat = "h:i:s A";      
                $dateformat=(new User())->getCurrentUserDateFormat();
              
                if(count($groupbycolumns)){
                    if($groupbycolumns[0]->column_type =='picklist_tracking'){
                       $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$groupbycolumns[0]->picklist_tracking_id)->where('field_id','!=',0)->get();
                       $colname_db=$reportdetails[0]->name_db.'.id';
                        if(count($trackingdetails)){                          
                            $leadstatusArray['labelgroupbycol'] =$trackingdetails[0]->tracking_name;
                            $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                            foreach($picklist_data as $picklistval){
                                $formula=$picklistval->formula;
                                if( $formula=='avg_time'){
                                    $formula='Avg Time';
                                }elseif( $formula=='percentage'){
                                    $formula='Percentage';
                                }elseif( $formula=='sum'){
                                    $formula='Sum';
                                }else{
                                        $formula='Count';
                                }
                                $clabel =$formula.' of '.$picklistval->from_value.' to '.$picklistval->to_value;
                                $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                $GroupbyLabelArray[] = $clabel;
                                $GroupbyArray[] = $column;
                             
                                $grval .= "GROUP_CONCAT({$reportdetails[0]->name_db}.id) AS $column". ',';
                                $groupByColumns[] ="COALESCE(NULLIF($colname_db, ''), '')";
                                
                            }
                            $leadstatusArray['aggregatecolumns']=$leadstatusArray['aggregatecolumns']+$agg_picklist_tracking_count;
                        }
                    }else{  
                        if($reportdetails[0]->primarymodule != $groupbycolumns[0]->groupbycolumns_moduleid){
                            $leadstatusArray['labelgroupbycol'] = $groupbycolumns[0]->label.' - ('.$groupbycolumns[0]->modulelabel.')' ;
                        }else{
                            $leadstatusArray['labelgroupbycol'] =$groupbycolumns[0]->label;
                        }
                        if(in_array($groupbycolumns[0]->groupbycolumns_fieldtype,[13,14,15,16,17])){
                            $gcval=$groupbycolumns[0]->groupbycolumns_coloumn_name;
                            $gcvalgroup=$groupbycolumns[0]->groupbycolumns_coloumn_name;
                        }else{
                            $gcval =$groupbycolumns[0]->name_db . "." .$groupbycolumns[0]->groupbycolumns_coloumn_name;
                            $gcvalgroup = "COALESCE(NULLIF(" . $groupbycolumns[0]->name_db . "." .$groupbycolumns[0]->groupbycolumns_coloumn_name . ", ''), '')";
                        }

                        $crmentitytablename='rsoft_crmentity_'.$reportdetails[0]->name_db;


                        $statuses = DB::table($reportdetails[0]->name_db)
                            ->join('rsoft_crmentity as ' . $crmentitytablename, $reportdetails[0]->name_db . '.id', '=', $crmentitytablename . '.crmid')
                            ->leftJoin('rsoft_users as rsoft_user_'.$tablename.'_smownerid', $crmentitytablename . '.smownerid', '=', 'rsoft_user_'.$tablename.'_smownerid.id')
                            ->leftJoin('rsoft_users as rsoft_user_'.$tablename.'_smcreatorid', $crmentitytablename . '.smcreatorid', '=', 'rsoft_user_'.$tablename.'_smcreatorid.id')
                            ->leftJoin('rsoft_users as rsoft_user_'.$tablename.'_modifiedby', $crmentitytablename . '.modifiedby', '=', 'rsoft_user_'.$tablename.'_modifiedby.id');

                            $relatedmodule = DB::table('rsoft_fieldmodulerel')
                            ->join('rsoft_modules', 'rsoft_fieldmodulerel.relmodule', '=', 'rsoft_modules.name')
                            ->where('rsoft_fieldmodulerel.module', $reportdetails[0]->name)
                            ->where('relmodule', '!=', $reportdetails[0]->name)
                            ->when($reportdetails[0]->moduletype == 'Inventory', function($query) {
                                $query->where('relmodule', '!=', 'Products');
                            })
                            ->get();
                            if (!empty($relatedmodule)) {
                                foreach ($relatedmodule as $relatedtable) {
                                    $relcrmentitytablename = 'rsoft_crmentity_' . $relatedtable->name_db;
                                    $fieldData = DB::table('rsoft_module_fields')
                                        ->where('id', $relatedtable->fieldid)
                                        ->pluck('colname');
                                    if ($fieldData->isNotEmpty()) {
                                        $statuses->leftJoin($relatedtable->name_db, $reportdetails[0]->name_db . '.' . $fieldData[0], '=', $relatedtable->name_db . '.id')
                                        ->leftJoin('rsoft_crmentity as ' . $relcrmentitytablename, $relatedtable->name_db . '.id', '=', $relcrmentitytablename . '.crmid')
                                        ->leftJoin('rsoft_users as rsoft_user_'.$relatedtable->name_db.'_smownerid', $relcrmentitytablename . '.smownerid', '=', 'rsoft_user_'.$relatedtable->name_db.'_smownerid.id')
                                        ->leftJoin('rsoft_users as rsoft_user_'.$relatedtable->name_db.'_smcreatorid', $relcrmentitytablename . '.smcreatorid', '=', 'rsoft_user_'.$relatedtable->name_db.'_smcreatorid.id')
                                        ->leftJoin('rsoft_users as rsoft_user_'.$relatedtable->name_db.'_modifiedby', $relcrmentitytablename . '.modifiedby', '=', 'rsoft_user_'.$relatedtable->name_db.'_modifiedby.id');
                                    }
                                }
                            }

                            if (!empty($imgquery)) {
                                preg_match('/LEFT JOIN (.+) ON (.+)/i', $imgquery, $matches);
                                $joinTable = $matches[1] ?? null;
                                $joinCondition = $matches[2] ?? null;
        
                                if ($joinTable && $joinCondition) {
                                    $statuses->leftJoin(DB::raw($joinTable), function($join) use ($joinCondition) {
                                        $join->on(DB::raw($joinCondition), '>', DB::raw('0'));
                                    });
                                }
                            }
                            
                            if(!empty( $this->preimgquery)){
                                preg_match('/LEFT JOIN (.+) ON (.+)/i', $this->preimgquery, $matches);
                                $joinTable = $matches[1] ?? null;
                                $joinCondition = $matches[2] ?? null;
                                
                                if ($joinTable && $joinCondition) {
                                    $statuses->leftJoin(DB::raw($joinTable), function($join) use ($joinCondition) {
                                        $join->on(DB::raw($joinCondition), '>', DB::raw('0'));
                                    });
                                }
                            }

                        $groupbyColumnName = $groupbycolumns[0]->groupbycolumns_coloumn_name;

                        $groupbyftype=$groupbycolumns[0]->groupbycolumns_fieldtype;
                        if(in_array($groupbyftype,[16,17,19,20,7])){
                            $statuses->selectRaw(
                                'CASE WHEN ' . $groupbyColumnName . ' IS NULL THEN "Empty" ELSE ' . $groupbyColumnName . ' END as groupbycol'
                            );
                        }else{
                            $statuses->selectRaw(
                                'CASE WHEN ' . $groupbyColumnName . ' IS NULL OR ' . $groupbyColumnName . ' = "" THEN "Empty" ELSE ' . $groupbyColumnName . ' END as groupbycol'
                            );
                        }
                        $statuses->when(true, function ($query) use ($crmentitytablename) {
                            $query->where($crmentitytablename . '.deleted', '=', 0);
                        })->when(!empty($filterquery), function ($query) use ($filterquery) {
                            $query->whereRaw($filterquery);
                        });
                        $statuses->groupBy('groupbycol');
                        $orderby = '';
                    $misreport = DB::table('mis_report_table')->where('report_id', $this->misCurrentReportId)->where('id', $this->currentReportId)->first();
                    $groupSortValue =($this->pagemode === 'MISPreview' && !empty($misreport->mis_group_sort))? ($misreport->mis_group_sort): ($reportdetails[0]->group_sort ?? '');
                    if($groupSortValue){
                        $group_sort=json_decode($groupSortValue); 
                        $orderClauses = [];
                        $validGroupByColumnIds = array_column($groupbycolumns, 'groupbycolumns_fieldid');
                        foreach( $group_sort as $sortcol){
                            if($sortcol->type=='Column' && in_array($sortcol->field_id, $validGroupByColumnIds)){
                                $sortfield = DB::table('rsoft_module_fields')->where('active',1)->where('id',$sortcol->field_id)->get();
                                if ($sortfield->isNotEmpty()) {
                                    $sortftype=$sortfield[0]->field_type;
                                $sortcolname=$sortfield[0]->colname;
                        if (in_array($sortftype, [13,14,15])) {
                                    $userTable = 'rsoft_user_' . $tablename . '_' . $sortcolname;
                                    $orderClauses[] = "CONCAT($userTable.users_firstname, ' ', $userTable.users_lastname) $sortcol->order";
                                } elseif (in_array($sortftype, [16,17])) {
                                    $crmentityTable = 'rsoft_crmentity_' . $tablename;
                                    $colname = $sortfield->isNotEmpty() && isset($sortfield[0]->colname) ? $sortfield[0]->colname : 'created_time'; // Fallback to 'created_time'
                                    $orderClauses[] = "$crmentityTable.$colname $sortcol->order";
                                } else {
                                    $colname = $sortfield->isNotEmpty() && isset($sortfield[0]->colname) ? $sortfield[0]->colname : 'id'; // Fallback to 'id'
                                    $orderClauses[] = "$colname $sortcol->order";
                                    }
                                }
                            }
                        }
                        if (!empty($orderClauses)) {
                            $orderby = implode(', ', $orderClauses);
                            $statuses->orderByRaw($orderby);
                        } else {
                            $statuses->orderBy($reportdetails[0]->name_db . '.id', 'DESC');
                        }
                    } else {
                        $statuses->orderBy($reportdetails[0]->name_db . '.id', 'DESC');


                    }
                        $statuses = $statuses->get()->toArray();
                        if ($reportdetails[0]->picklist_order == 1) {
                            if (in_array($groupbyftype, [9, 21, 23, 29, 30, 31])) {

                                $tnme=$groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $vcolname='picklistvalue';
                                $ordercolname='seq';
                                if($groupbyftype==21){
                                    $tnme='rsoft_phonenumber_prefix';
                                    $vcolname='prefix_value';
                                    $ordercolname='id';
                                }else if($groupbyftype==23){
                                    $tnme='rsoft_namefield_prefix';
                                    $vcolname='prefix_value';
                                    $ordercolname='id';
                                }else if($groupbyftype==29){
                                    $tnme='rsoft_city';
                                }else if($groupbyftype==30){
                                    $tnme='rsoft_state';
                                }else if($groupbyftype==31){
                                    $tnme='rsoft_country';
                                }
                                $orderrow = DB::table($tnme)->orderBy($ordercolname, 'DESC')->pluck($ordercolname)->first()+1;
                            }
                        }

                        foreach ($statuses as $row) {
                            $groupbycolval=$row->groupbycol;
                            $addstatus=1;
                            if($groupbycolval !='Empty'){
                                if(in_array($groupbyftype,[16,17,19])){
                                    $datetime=$dateformat.' '.$timeformat;
                                    $groupbycolval =(new User())->convertUserTimeZone($groupbycolval,$datetime,'Y-m-d H:i:s');
                                }elseif($groupbyftype==20){
                                    $groupbycolval = (new User())->convertUserTimeZone(trim($groupbycolval),$timeformat, 'H:i:s');
                                }elseif($groupbyftype==7){
                                    $groupbycolval  = (new User())->convertUserTimeZone($groupbycolval,$dateformat,'Y-m-d'); 
                                }elseif($groupbyftype==6){
                                    $groupbycolval  =$this->getUserFormatValues($groupbyftype,$groupbycolval);
                                }elseif($groupbyftype==25){
                                    $groupbycolval  =$this->getUserFormatValues($groupbyftype,$groupbycolval);  
                                }elseif($groupbyftype==11){
                                    $groupbycolval  =$this->getUserFormatValues($groupbyftype,$groupbycolval,$groupbycolval,$groupbyColumnName); 
                                }elseif($groupbyftype==12 || $groupbyftype==3){
                                    $groupbycolval  =$this->getUserFormatValues($groupbyftype,$groupbycolval); 
                                }elseif(in_array($groupbyftype,[13,14,15])){
                                    $userid=(new user())->getCurrentUserId();
                                    $groupbycolval  =$groupbycolval; 
                                    if( $userid==1 && $groupbycolval==1){
                                        $addstatus=1;
                                    }elseif($userid !=1 && $groupbycolval==1){
                                        $addstatus=0;
                                        
                                    }
                                
                                }
                            // $groupbycolval  =$this->getUserFormatValues($groupbyftype,$groupbycolval);
                                
                            }
                        if($addstatus==1){
                                if ($reportdetails[0]->picklist_order == 1) {
                                    if (in_array($groupbyftype, [9, 21, 23, 29, 30, 31])) {

                                        $tnme=$groupbycolumns[0]->groupbycolumns_coloumn_name;
                                        $vcolname='picklistvalue';
                                        $ordercolname='seq';
                                        if($groupbyftype==21){
                                            $tnme='rsoft_phonenumber_prefix';
                                            $vcolname='prefix_value';
                                            $ordercolname='id';
                                        }else if($groupbyftype==23){
                                            $tnme='rsoft_namefield_prefix';
                                            $vcolname='prefix_value';
                                            $ordercolname='id';
                                        }else if($groupbyftype==29){
                                            $tnme='rsoft_city';
                                        }else if($groupbyftype==30){
                                            $tnme='rsoft_state';
                                        }else if($groupbyftype==31){
                                            $tnme='rsoft_country';
                                        }
                                        $orderMapping = DB::table($tnme)
                                        ->where($vcolname,$groupbycolval )
                                        ->pluck($ordercolname)
                                        ->toArray();
                                        if (isset($orderMapping[0])) {
                                            $GroupbyLabelArray[$orderMapping[0]] = $groupbycolval;
                                            $GroupbyArray[$orderMapping[0]] = $groupbycolval;
                                        }else{
                                            $GroupbyLabelArray[$orderrow] = $groupbycolval;
                                            $GroupbyArray[$orderrow] = $groupbycolval;
                                            $orderrow++;
                                        }
                                        foreach ($aggregatecolumns as $val) {
                                            if (isset($orderMapping[0])) {
                                                $orderseq= $orderMapping[0];
                                            }else{
                                                $orderseq= $orderrow;
                                                $orderrow++;
                                            }
                                            if($val->aggregatecolumns_calculation_type=='picklist_tracking'){
                                                $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$val->picklist_tracking_id)->where('field_id','!=',0)->get();
                                                if(count($trackingdetails)){
                                                    $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                                    foreach($picklist_data as $picklistval){
                                                        $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                                           $GroupbyArray[$orderseq.''.$groupbycolval.'_'. $column]=$groupbycolval.'_'. $column;
                                                    }
                                                } 
                                            }else{
                                                $GroupbyArray[$orderseq.''.$groupbycolval.'_'.$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name]=$groupbycolval.'_'.$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                                            }
                                        }
                                    }else if ($reportdetails[0]->picklist_order == 1  &&  in_array($groupbyftype, [13, 14, 15])) {
                                        $GroupbyLabelArray[$groupbycolval] = $groupbycolval;
                                        $GroupbyArray[$groupbycolval] = $groupbycolval;
                                        
                                        foreach ($aggregatecolumns as $val) {
                                            if($val->aggregatecolumns_calculation_type=='picklist_tracking'){
                                                $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$val->picklist_tracking_id)->where('field_id','!=',0)->get();
                                                if(count($trackingdetails)){
                                                    $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                                    foreach($picklist_data as $picklistval){
                                                        $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                                        $GroupbyArray[$groupbycolval.'_'.$column]=$groupbycolval.'_'.$column;
                                                    }
                                                } 
                                            }else{
                                                $GroupbyArray[$groupbycolval.'_'.$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name]=$groupbycolval.'_'. $val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                                            }
                                        }

                                    }
                                    else if ($reportdetails[0]->picklist_order == 1 && !in_array($groupbyftype, [9, 21, 23, 29, 30, 31, 13, 14, 15])) {
                                        // Handle non-picklist fields
                                        static $nonPicklistOrder = 0;
                                        $nonPicklistOrder++;
                                        $GroupbyLabelArray[$nonPicklistOrder] = $groupbycolval;
                                        $GroupbyArray[$nonPicklistOrder] = $groupbycolval;
                                        foreach ($aggregatecolumns as $val) {
                                            if ($val->aggregatecolumns_calculation_type == 'picklist_tracking') {
                                                $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id', $val->picklist_tracking_id)->where('field_id','!=',0)->get();
                                                if (count($trackingdetails)) {
                                                    $picklist_data = json_decode($trackingdetails[0]->picklist_data);
                                                    foreach ($picklist_data as $picklistval) {
                                                        $column = 'picklisttracking_' . $trackingdetails[0]->colname . '_' . $picklistval->formula . '_' . str_replace(' ', '_', $picklistval->from_value) . '_' . str_replace(' ', '_', $picklistval->to_value);
                                                        $GroupbyArray[$nonPicklistOrder . '_' . $column] = $groupbycolval . '_' . $column;
                                                    }
                                                }
                                            } else {
                                                $GroupbyArray[$nonPicklistOrder . '_' . $val->aggregatecolumns_calculation_type . '_' . $val->aggregatecolumns_coloumn_name] = $groupbycolval . '_' . $val->aggregatecolumns_calculation_type . '_' . $val->aggregatecolumns_coloumn_name;
                                            }
                                        }
                                    }
                                }else{
                                    $GroupbyLabelArray[] = $groupbycolval;
                                    $GroupbyArray[] = $groupbycolval;

                                    foreach ($aggregatecolumns as $val) {
                                        if($val->aggregatecolumns_calculation_type=='picklist_tracking'){
                                            $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$val->picklist_tracking_id)->where('field_id','!=',0)->get();
                                            if(count($trackingdetails)){
                                                $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                                foreach($picklist_data as $picklistval){
                                                    $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                                    $GroupbyArray[]= $groupbycolval . '_' .$column;
                                                }
                                            } 
                                        }else{
                                            $GroupbyArray[]=$groupbycolval.'_'.$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                                        }
                                    }
                                   
                                }                                       
                                

                        }
                        
                        }
                    }
                }
   
                if ($reportdetails[0]->picklist_order == 1 && count($groupbycolumns)) {
                        ksort($GroupbyLabelArray);        
                        uksort($GroupbyArray, function($a, $b) {
                        preg_match('/^(\d+)/', $a, $aMatches);
                        preg_match('/^(\d+)/', $b, $bMatches);

                        $aNum = isset($aMatches[1]) ? (int)$aMatches[1] : PHP_INT_MAX;
                        $bNum = isset($bMatches[1]) ? (int)$bMatches[1] : PHP_INT_MAX;

                        return $aNum <=> $bNum;
                    });
                }
               
                $leadstatusArray['groupbycol'] = $GroupbyLabelArray;
                $leadstatusArray['groupbyaggrecol'] = $GroupbyArray;
                if(count($groupbyrows)){
                    foreach($groupbyrows as $value){
                        if($reportdetails[0]->primarymodule != $value->groupbyrows_moduleid){
                            $leadstatusArray['labelgroupbyrow'][] = $value->label.' - ('.$value->modulelabel.')' ;
                        }else{
                            $leadstatusArray['labelgroupbyrow'][] = $value->label;
                        }
                        if(in_array($value->groupbyrows_fieldtype,[13,14,15,16,17])){
                            $columnName = $value->groupbyrows_coloumn_name;
                            $colname=explode('.',$value->groupbyrows_coloumn_name)[1];
                        }else{
                            $columnName = $value->name_db . '.' . $value->groupbyrows_coloumn_name;
                            $colname=$value->groupbyrows_coloumn_name;
                        }
                        if($value->groupbyrows_fieldtype==16 || $value->groupbyrows_fieldtype == 17 || $value->groupbyrows_fieldtype == 19 || $value->groupbyrows_fieldtype == 25 || $value->groupbyrows_fieldtype == 7){
                            $grval .= "$columnName AS $colname" . ',';
                            $groupByColumns[] = "$columnName";
                        }else{

                            $grval .= "COALESCE(NULLIF($columnName , ''), '') AS $colname ". ',';
                            $groupByColumns[] ="COALESCE(NULLIF($columnName, ''), '')";
                        }
                    }
                    $misReport = DB::table('mis_report_table')->where('report_id', $this->misCurrentReportId)->where('id', $this->currentReportId)->first();
                    $expandDetail =($this->pagemode === 'MISPreview'&& isset($misReport->mis_active)&& (int) $misReport->mis_active === 1)
                                        ? ($misReport->mis_expand_group_count ?? 0)
                                        : ($reportdetails[0]->expand_group_count ?? 0);
                    if($expandDetail==1){
                        $leadstatusArray['labelgroupbyrow'][] ='Group Count';

                    }
                    if(count($aggregatecolumns)){
                        foreach($aggregatecolumns as $key =>$val){
                            //$cname=$val->aggregatecolumns_calculation_type . ' of '.$val->label
                            $clabel=$val->aggregatecolumns_calculation_type . ' of '.$val->label;;
                            if($val->aggregatecolumns_calculation_type=='picklist_tracking'){
                                $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$val->picklist_tracking_id)->where('field_id','!=',0)->get();
                                if(count($trackingdetails)){
                                    $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                        foreach ($picklist_data as &$entry) {
                                            foreach ($entry as $key => $value) {
                                                if (is_string($value)) {
                                                    $clean = str_replace(
                                                        ["\xC2\xA0", "\u{00A0}", "&nbsp;"],
                                                        ' ',
                                                        $value
                                                    );
                                                    $clean = preg_replace('/\s+/', ' ', $clean);
                                                    $entry->$key = trim($clean);
                                                }
                                            }
                                        }
                                        unset($entry);
                                        $filtered = array_filter($picklist_data, function($entry) {
                                            return ($entry->from_value ?? '') !== ($entry->to_value ?? '');
                                        });
        
                                        $filtered = array_values($filtered);
                                        DB::table('rsoft_advanced_report_picklisttracking')
                                            ->where('tracking_id', $val->picklist_tracking_id)
                                            ->update([
                                                'picklist_data' => json_encode($filtered),
                                                'updated_at'    => now()
                                            ]);
                                        $picklist_data = $filtered;
 
                                    foreach($picklist_data as $picklistval){
                                         $formula=$picklistval->formula;
                                        if( $formula=='avg_time'){
                                            $formula='Avg Time';
                                        }elseif( $formula=='percentage'){
                                             $formula='Percentage';
                                        }elseif( $formula=='sum'){
                                            $formula='Sum';
                                        }else{
                                             $formula='Count';
                                        }
                                         if(in_array($trackingdetails[0]->fieldtype,[13,14,15])){
                                                $from_value = DB::table('rsoft_users')->where('id',$picklistval->from_value)->get();
                                                $to_value = DB::table('rsoft_users')->where('id',$picklistval->to_value)->get();
                                                if(count($from_value)){
                                                   $fromusername=$from_value[0]->users_firstname.' '. $from_value[0]->users_lastname;
                                                   if(trim($fromusername)==''){
                                                        $fromusername=$from_value[0]->id;
                                                   }
                                                }
                                                if(count($to_value)!=''){
                                                   $tousername=$to_value[0]->users_firstname.' '. $to_value[0]->users_lastname;
                                                   if(trim($tousername)==''){
                                                        $tousername=$to_value[0]->id;
                                                   }
                                                }
                                                $clabel =$formula.' of '.$fromusername.' to '.$tousername;
                                            }else{
                                                $clabel =$formula.' of '.$picklistval->from_value.' to '.$picklistval->to_value;
                                            }
                                        if($reportdetails[0]->primarymodule != $val->aggregatecolumns_moduleid){
                                            $leadstatusArray['labelgroupbyrow'][] = $clabel.' - ('.$val->modulelabel.')' ;
                                        }else{
                                            $leadstatusArray['labelgroupbyrow'][] =$clabel;
                                        }
                                    }
                                }
                            }else{
                                
                                if($val->aggregatecolumns_calculation_type=='Column_Percentage'){
                                    $clabel ='Column Percentage of '.$val->label;
                                }elseif($val->aggregatecolumns_calculation_type=='Row_Percentage'){
                                    $clabel ='Row Percentage of '.$val->label;
                                }elseif($val->aggregatecolumns_calculation_type=='DistinctCount'){
                                    $clabel ='Distinct Count of '.$val->label;
                                }elseif($val->aggregatecolumns_calculation_type=='StdDev'){
                                    $clabel ='Sample StdDev of '.$val->label;
                                }elseif($val->aggregatecolumns_calculation_type=='Var'){
                                    $clabel ='Sample Variance of '.$val->label;
                                }elseif($val->aggregatecolumns_calculation_type=='Sumhourcal'){
                                    $clabel ='Sum (HH:MM: SS) of '.$val->label;
                                }
                                 if($reportdetails[0]->primarymodule != $val->aggregatecolumns_moduleid){
                                    $leadstatusArray['labelgroupbyrow'][] = $clabel.' - ('.$val->modulelabel.')' ;
                                }else{
                                    $leadstatusArray['labelgroupbyrow'][] =$clabel;
                                }
                            }
                        }
                    }
                    foreach($leadstatusArray['groupbycol'] as $value1){
                        $misReport = DB::table('mis_report_table')->where('report_id', $this->misCurrentReportId)->where('id', $this->currentReportId)->first();
                        $expandDetail =($this->pagemode === 'MISPreview'&& isset($misReport->mis_active)&& (int) $misReport->mis_active === 1)
                                        ? ($misReport->mis_expand_group_count?? 0)
                                        : ($reportdetails[0]->expand_group_count ?? 0);
                        if($expandDetail==1){
                        $leadstatusArray['labelgroupbyrow'][] ='Group Count';
                        }
                        if(count($aggregatecolumns)){
                            foreach($aggregatecolumns as $key =>$val){
                                $clabel=$val->aggregatecolumns_calculation_type . ' of '.$val->label;
                                if($val->aggregatecolumns_calculation_type=='picklist_tracking'){
                                    $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$val->picklist_tracking_id)->where('field_id','!=',0)->get();
                                    if(count($trackingdetails)){
                                        $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                        foreach($picklist_data as $picklistval){
                                            $formula=$picklistval->formula;
                                            if( $formula=='avg_time'){
                                                $formula='Avg Time';
                                            }elseif($formula=='percentage'){
                                                $formula='Percentage';
                                            }elseif( $formula=='sum'){
                                                $formula='Sum';
                                            }else{
                                                 $formula='Count';
                                            }
                                            if(in_array($trackingdetails[0]->fieldtype,[13,14,15])){
                                                $from_value = DB::table('rsoft_users')->where('id',$picklistval->from_value)->get();
                                                $to_value = DB::table('rsoft_users')->where('id',$picklistval->to_value)->get();
                                                if(count($from_value)){
                                                   $fromusername=$from_value[0]->users_firstname.' '. $from_value[0]->users_lastname;
                                                   if(trim($fromusername)==''){
                                                        $fromusername=$from_value[0]->id;
                                                   }
                                                }
                                                if(count($to_value)){
                                                   $tousername=$to_value[0]->users_firstname.' '. $to_value[0]->users_lastname;
                                                   if(trim($tousername)==''){
                                                        $tousername=$to_value[0]->id;
                                                   }
                                                }
                                                $clabel =$formula.' of '.$fromusername.' to '.$tousername;
                                            }else{
                                                $clabel =$formula.' of '.$picklistval->from_value.' to '.$picklistval->to_value;
                                            }
                                            
                                             if($reportdetails[0]->primarymodule != $val->aggregatecolumns_moduleid){
                                                $leadstatusArray['labelgroupbyrow'][] = $clabel.' - ('.$val->modulelabel.')' ;
                                            }else{
                                                $leadstatusArray['labelgroupbyrow'][] =$clabel;
                                            }
                                        }
                                    }
                                }else{
                                    if($val->aggregatecolumns_calculation_type=='Column_Percentage'){
                                        $clabel ='Column Percentage of '.$val->label;
                                    }elseif($val->aggregatecolumns_calculation_type=='Row_Percentage'){
                                        $clabel ='Row Percentage of '.$val->label;
                                    }elseif($val->aggregatecolumns_calculation_type=='DistinctCount'){
                                        $clabel ='Distinct Count of '.$val->label;
                                    }elseif($val->aggregatecolumns_calculation_type=='StdDev'){
                                        $clabel ='Sample StdDev of '.$val->label;
                                    }elseif($val->aggregatecolumns_calculation_type=='Var'){
                                        $clabel ='Sample Variance of '.$val->label;
                                    }elseif($val->aggregatecolumns_calculation_type=='Sumhourcal'){
                                        $clabel ='Sum (HH:MM: SS) of '.$val->label;
                                    }
                                    if($reportdetails[0]->primarymodule != $val->aggregatecolumns_moduleid){
                                        $leadstatusArray['labelgroupbyrow'][] = $clabel.' - ('.$val->modulelabel.')' ;
                                    }else{
                                        $leadstatusArray['labelgroupbyrow'][] =$clabel;
                                    }
                                }
                            }
                        }
                    }
                }
        
                $selectval = rtrim($grval, ',');
                if($gcval!=''){
                    $selectval .=',' . $gcval;
                    $groupByColumns[] = $gcvalgroup;
                }
                $groupByColumns=implode(',',$groupByColumns);
               // dd($selectval);
                $selectStatements = [
                    DB::raw($selectval),
                    DB::raw('COUNT(*) as count'),
                ];
                foreach ($aggregatecolumns as $val) {
                   
                    if (in_array($val->aggregatecolumns_fieldtype, [9, 12, 13, 14, 15, 16, 17, 29, 30, 31])) {
                        $column = $val->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $val->aggregatecolumns_coloumn_name);
                       if ($val->aggregatecolumns_fieldtype == 16 || $val->aggregatecolumns_fieldtype == 17) {
                            $datamergecol = "$val->aggregatecolumns_calculation_type($val->aggregatecolumns_coloumn_name) AS $column";
                        } else {
                            $datamergecol = "$val->aggregatecolumns_calculation_type(COALESCE(NULLIF($val->aggregatecolumns_coloumn_name, ''), '')) AS $column";
                        }
                    }else{
                        $column=$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                        $coloumn_name=$val->aggregatecolumns_calculation_type.'('.$val->aggregatecolumns_coloumn_name.')';
                        if ($val->aggregatecolumns_fieldtype == 19 || $val->aggregatecolumns_fieldtype == 25 || $val->aggregatecolumns_fieldtype == 7) {
                            $datamergecol = "$val->aggregatecolumns_calculation_type($val->aggregatecolumns_coloumn_name) AS $column";
                        }else{
                            $datamergecol="$val->aggregatecolumns_calculation_type(COALESCE(NULLIF($val->aggregatecolumns_coloumn_name, ''), '')) AS $column";
                        }
                       
                    }
                
                    if($val->aggregatecolumns_calculation_type=='Column_Percentage' || $val->aggregatecolumns_calculation_type=='Row_Percentage'){
                        if($val->aggregatecolumns_fieldtype==24 || $val->aggregatecolumns_fieldtype ==25){
                           $selectStatements[] =DB::raw("SUM($val->aggregatecolumns_coloumn_name) as $column");
                        }else{
                            if ($val->aggregatecolumns_fieldtype == 16 || $val->aggregatecolumns_fieldtype == 17 || $val->aggregatecolumns_fieldtype == 19 || $val->aggregatecolumns_fieldtype == 7) {
                                $selectStatements[] = DB::raw("COUNT($val->aggregatecolumns_coloumn_name, '')  AS $column");
                            }else{
                                $selectStatements[] = DB::raw("COUNT(COALESCE($val->aggregatecolumns_coloumn_name, ''))  AS $column");
                            }
                        }
                    }elseif($val->aggregatecolumns_calculation_type=='Var'){
                        $selectStatements[] = DB::raw("VARIANCE($val->aggregatecolumns_coloumn_name) as $column");
                    }elseif($val->aggregatecolumns_calculation_type=='DistinctCount'){
                        if ($val->aggregatecolumns_fieldtype == 16 || $val->aggregatecolumns_fieldtype == 17 || $val->aggregatecolumns_fieldtype == 19 || $val->aggregatecolumns_fieldtype == 7 || $val->aggregatecolumns_fieldtype == 25) {
                            $selectStatements[] = DB::raw(" COUNT(DISTINCT $val->aggregatecolumns_coloumn_name) as $column");
                        }else{
                            $selectStatements[] = DB::raw("COUNT(DISTINCT COALESCE(NULLIF($val->aggregatecolumns_coloumn_name, ''), '')) as $column");
                        }
                    }elseif($val->aggregatecolumns_calculation_type == 'Mode' || $val->aggregatecolumns_calculation_type == 'Median') {
                        $table = $reportdetails[0]->name_db;
                        $columnn = $val->aggregatecolumns_coloumn_name;
                        
                        $conditions = "rsoft_crmentity.deleted = 0 AND created_time BETWEEN '2024-10-24 18:30:00' AND '2024-10-25 18:29:59'";
                                            $modeQuery = "
                            (SELECT $columnn AS mode_value
                            FROM $table inner join rsoft_crmentity on $table.id=rsoft_crmentity.crmid
                            WHERE $conditions
                            GROUP BY $columnn
                            ORDER BY COUNT($columnn) DESC
                            LIMIT 1) AS $column
                        ";
                    
                        // Add the mode query to the select statements
                        $selectStatements[] = DB::raw($modeQuery);
                    }elseif ($val->aggregatecolumns_calculation_type == 'Median') {
                        $table = $reportdetails[0]->name_db; // Dynamic table name
                        $columnn = $val->aggregatecolumns_coloumn_name; // Dynamic column name
                        $conditions = "deleted = 0 AND created_time BETWEEN '2024-10-24 18:30:00' AND '2024-10-25 18:29:59'"; // Dynamic conditions
                        
                        // Query to calculate the median
                        $medianQuery = "
                            (SELECT AVG(middle_values.$columnn) AS $column
                             FROM (
                                 SELECT $columnn
                                 FROM $table
                                 WHERE $conditions
                                 ORDER BY $columnn
                                 LIMIT 2 OFFSET 
                                     (SELECT FLOOR((COUNT(*) - 1) / 2)
                                      FROM $table
                                      WHERE $conditions)
                             ) AS middle_values)
                        ";
                        
                        // Add the median query to the select statements
                        $selectStatements[] = DB::raw($medianQuery);
                    }elseif($val->aggregatecolumns_calculation_type=='Sumhourcal'){
                            $column=$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                            if ($val->aggregatecolumns_fieldtype == 25) {
                                $datamergecol = "SUM($val->aggregatecolumns_coloumn_name) AS $column";
                            }else{
                                $datamergecol="SUM(COALESCE(NULLIF($val->aggregatecolumns_coloumn_name, ''), '')) AS $column";
                            }
                            $selectStatements[] = DB::raw($datamergecol);
                    }elseif($val->aggregatecolumns_calculation_type=='picklist_tracking'){
                        $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$val->picklist_tracking_id)->where('field_id','!=',0)->get();
                        if(count($trackingdetails)){
                            $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                            foreach($picklist_data as $picklistval){
                                 $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                $datamergecol = "GROUP_CONCAT({$reportdetails[0]->name_db}.id) AS $column";
                                $selectStatements[] = DB::raw($datamergecol);
                            }
                        } 
                    }else{
                        $selectStatements[] = DB::raw($datamergecol);
                    }
                }
                $results = DB::table($reportdetails[0]->name_db)
                    ->join('rsoft_crmentity as ' . $crmentitytablename, $reportdetails[0]->name_db . '.id', '=', $crmentitytablename . '.crmid')
                    ->leftJoin('rsoft_users as rsoft_user_'.$tablename.'_smownerid', $crmentitytablename . '.smownerid', '=', 'rsoft_user_'.$tablename.'_smownerid.id')
                    ->leftJoin('rsoft_users as rsoft_user_'.$tablename.'_smcreatorid', $crmentitytablename . '.smcreatorid', '=', 'rsoft_user_'.$tablename.'_smcreatorid.id')
                    ->leftJoin('rsoft_users as rsoft_user_'.$tablename.'_modifiedby', $crmentitytablename . '.modifiedby', '=', 'rsoft_user_'.$tablename.'_modifiedby.id');

                
                    $relatedmodule = DB::table('rsoft_fieldmodulerel')
                    ->join('rsoft_modules', 'rsoft_fieldmodulerel.relmodule', '=', 'rsoft_modules.name')
                    ->where('rsoft_fieldmodulerel.module', $reportdetails[0]->name)
                    ->where('relmodule', '!=', $reportdetails[0]->name)
                    ->when($reportdetails[0]->moduletype == 'Inventory', function($query) {
                        $query->where('relmodule', '!=', 'Products');
                    })
                    ->get();
                if (!empty($relatedmodule)) {
                    foreach ($relatedmodule as $relatedtable) {
                        $relcrmentitytablename = 'rsoft_crmentity_' . $relatedtable->name_db;
                        $fieldData = DB::table('rsoft_module_fields')
                            ->where('id', $relatedtable->fieldid)
                            ->pluck('colname');
                        if ($fieldData->isNotEmpty()) {
                            $results->leftJoin($relatedtable->name_db, $reportdetails[0]->name_db . '.' . $fieldData[0], '=', $relatedtable->name_db . '.id')
                            ->leftJoin('rsoft_crmentity as ' . $relcrmentitytablename, $relatedtable->name_db . '.id', '=', $relcrmentitytablename . '.crmid')
                            ->leftJoin('rsoft_users as rsoft_user_'.$relatedtable->name_db.'_smownerid', $relcrmentitytablename . '.smownerid', '=', 'rsoft_user_'.$relatedtable->name_db.'_smownerid.id')
                            ->leftJoin('rsoft_users as rsoft_user_'.$relatedtable->name_db.'_smcreatorid', $relcrmentitytablename . '.smcreatorid', '=', 'rsoft_user_'.$relatedtable->name_db.'_smcreatorid.id')
                            ->leftJoin('rsoft_users as rsoft_user_'.$relatedtable->name_db.'_modifiedby', $relcrmentitytablename . '.modifiedby', '=', 'rsoft_user_'.$relatedtable->name_db.'_modifiedby.id');
                        }
                    }
                }

                if (!empty($imgquery)) {
                    preg_match('/LEFT JOIN (.+) ON (.+)/i', $imgquery, $matches);
                    $joinTable = $matches[1] ?? null;
                    $joinCondition = $matches[2] ?? null;

                    if ($joinTable && $joinCondition) {
                        $results->leftJoin(DB::raw($joinTable), function($join) use ($joinCondition) {
                            $join->on(DB::raw($joinCondition), '>', DB::raw('0'));
                        });
                    }
                }

                if(!empty( $this->preimgquery)){
                    preg_match('/LEFT JOIN (.+) ON (.+)/i', $this->preimgquery, $matches);
                    $joinTable = $matches[1] ?? null;
                    $joinCondition = $matches[2] ?? null;
                    
                    if ($joinTable && $joinCondition) {
                        $results->leftJoin(DB::raw($joinTable), function($join) use ($joinCondition) {
                            $join->on(DB::raw($joinCondition), '>', DB::raw('0'));
                        });
                    }
                }

                
                
                if ($reportdetails[0]->picklist_order == 1 && count($groupbyrows)) {
                    foreach ($groupbyrows as $value) {
                        $groupbyftype=$value->groupbyrows_fieldtype;
                        if(count($groupbyrows) && in_array($groupbyftype,[9, 21, 23,29,30,31])){
                            $tnme = $value->groupbyrows_coloumn_name;
                            $vcolname='picklistvalue';
                            if($groupbyftype==21){
                                $tnme='rsoft_phonenumber_prefix';
                                $vcolname='prefix_value';
                            }else if($groupbyftype==23){
                                $tnme='rsoft_namefield_prefix';
                                $vcolname='prefix_value';
                            }else if ($groupbyftype == 29) {
                                $tnme = 'rsoft_city';
                            } elseif ($groupbyftype == 30) {
                                $tnme = 'rsoft_state';
                            } elseif ($groupbyftype == 31) {
                                $tnme = 'rsoft_country';
                            }
                            $results->leftJoin(
                                $tnme,
                                $value->name_db . '.' . $value->groupbyrows_coloumn_name, 
                                '=', 
                                $tnme . '.'. $vcolname
                            );
                        }
                    }
                }
              
                $results->where($crmentitytablename . '.deleted', '=', 0);

                if (!empty($filterquery)) {
                    $results->whereRaw($filterquery);
                }

                if ($userid != 1) {
                    $results->where($crmentitytablename . '.smownerid', '!=', 1);
                }

                if ($reportdetails[0]->data_handling == 2) {
                    $results->where($crmentitytablename . '.smownerid', '=', $userid);
                }

                if ($reportdetails[0]->data_handling == 3 && !empty($RecordsAccess['sharingrecordusers'])) {
                    $sharingcondition = substr($RecordsAccess['sharingrecordusers'], 4);
                    $results->whereRaw($sharingcondition);
                }

                if (($viewmode == 'preview' || $viewmode == 'export') && !empty($searchQuery)) {
                    $results->whereRaw($searchQuery);
                }
                $results->select($selectStatements);
                $results->groupByRaw($groupByColumns)
                    ->havingRaw('COUNT(*) > 0');

                $orderby = '';
                $misreport = DB::table('mis_report_table')->where('report_id', $this->misCurrentReportId)->where('id', $this->currentReportId)->first();
                $groupSortValue =($this->pagemode === 'MISPreview' && !empty($misreport->mis_group_sort))? ($misreport->mis_group_sort): ($reportdetails[0]->group_sort ?? '');
                if($groupSortValue){
                    $group_sort=json_decode($groupSortValue); 
                    $orderrowClauses=[];
                    $validGroupByRowIds = array_column($groupbyrows, 'groupbyrows_fieldid');
                    foreach( $group_sort as $sortcol){
                        if($sortcol->type=='Row' && in_array($sortcol->field_id, $validGroupByRowIds)){
                            $sortfield = DB::table('rsoft_module_fields')->where('active',1)->where('id',$sortcol->field_id)->get();
                            if ($sortfield->isNotEmpty()) {
                                    $sortftype=$sortfield[0]->field_type;
                              $sortcolname=$sortfield[0]->colname;
                           if (in_array($sortftype, [13,14,15])) {
                                $userTable = 'rsoft_user_' . $tablename . '_' . $sortcolname;
                                $orderrowClauses[] = "CONCAT($userTable.users_firstname, ' ', $userTable.users_lastname) $sortcol->order";
                            } elseif (in_array($sortftype, [16,17])) {
                                $crmentityTable = 'rsoft_crmentity_' . $tablename;
                                $colname = $sortfield->isNotEmpty() && isset($sortfield[0]->colname) ? $sortfield[0]->colname : 'created_time'; // Fallback to 'created_time'
                                $orderrowClauses[] = "$crmentityTable.$colname $sortcol->order";
                            } else {
                                $colname = $sortfield->isNotEmpty() && isset($sortfield[0]->colname) ? $sortfield[0]->colname : 'id'; // Fallback to 'id'
                                $orderrowClauses[] = "$colname $sortcol->order";
                                }
                            }
                        }
                    }
                    if (!empty($orderrowClauses)) {
                        $orderby = implode(', ', $orderrowClauses);
                        $results->orderByRaw($orderby);
                    } else {
                        $results->orderBy($reportdetails[0]->name_db . '.id', 'DESC');
                    }

                }else{
                    if ($reportdetails[0]->picklist_order == 1 && count($groupbyrows)) {
                        $orderClauses = [];
                    
                        foreach ($groupbyrows as $value) {
                            $groupbyftype = $value->groupbyrows_fieldtype;
                            if (in_array($groupbyftype, [9, 21, 23, 29, 30, 31])) {
                                $tnme = $value->groupbyrows_coloumn_name;
                                $ordercolname='seq';
                                if($groupbyftype==21){
                                    $tnme='rsoft_phonenumber_prefix';
                                    $ordercolname='id';
                                }else if($groupbyftype==23){
                                    $tnme='rsoft_namefield_prefix';
                                    $ordercolname='id';
                                }else if ($groupbyftype == 29) {
                                    $tnme = 'rsoft_city';
                                } elseif ($groupbyftype == 30) {
                                    $tnme = 'rsoft_state';
                                } elseif ($groupbyftype == 31) {
                                    $tnme = 'rsoft_country';
                                }
                                $orderClauses[] =$tnme . '.'. $ordercolname.' ASC';
                            } elseif (in_array($groupbyftype, [13, 14, 15])) {
                                $orderClauses[] = $value->groupbyrows_coloumn_name . ' ASC';
                            }
                        }
                        if (!empty($orderClauses)) {
                            $orderby = implode(', ', $orderClauses);
                            $results->orderByRaw($orderby);
                        } else {
                            $results->orderBy($reportdetails[0]->name_db . '.id', 'DESC');
                        }
                    } else {
                        $results->orderBy($reportdetails[0]->name_db . '.id', 'DESC');
                    }
                }
                
                $results = $results->get();

                
                $grandTotalPer = []; 
                $grandTotalRow = []; 
                $groupbycol='';
                $AllUsers = (new User())->GettingAllUsers();
                
               // dd($results);
                //percentage total value get
                foreach ($results as $key => $row) {

                    if(count($groupbycolumns)){
                        if($groupbycolumns[0]->column_type=='picklist_tracking'){
                            $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$groupbycolumns[0]->picklist_tracking_id)->where('field_id','!=',0)->get();
                            if(count($trackingdetails)){
                                $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                foreach($picklist_data as $picklistval){
                                    $groupbycolName =$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                    $groupbycol= empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                    $picklisttracingdata=$this->getPicklistTrackingData($groupbycol, $picklistval);  
                                    $picklisttracingoutput=$picklisttracingdata['finalOutput'];
                                    $picklisttracingcount=$picklisttracingdata['totalCount'];
                                    $aggregateKey =  $picklisttracingoutput . '_' . $column;
                                    $currentLevel[$aggregateKey] = $picklisttracingoutput;
                                    $grandTotalPer[$aggregateKey] = $picklisttracingoutput;
                                    $aggregateKeytotal =  $picklisttracingoutput . '_' . $column.'_total';
                                    $currentLevel[$aggregateKeytotal] = $picklisttracingcount;
                                    $grandTotalPer[$aggregateKeytotal] = $picklisttracingcount;

                                }
                            } 
                        }else{
                            $col_fieldtype=$groupbycolumns[0]->groupbycolumns_fieldtype;
                            if($col_fieldtype==13){
                                $groupbycolName ='modifiedby';
                                $groupbycol= empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                            }elseif($col_fieldtype==14){
                                $groupbycolName ='smcreatorid';
                                $groupbycol= empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                            }elseif($col_fieldtype==15){
                                $groupbycolName ='smownerid';
                                $groupbycol= empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                            }elseif($col_fieldtype==16 || $col_fieldtype==17 || $col_fieldtype==19){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                if($col_fieldtype==16 ){
                                    $groupbycolName='created_time';
                                }elseif($col_fieldtype==17 ){
                                    $groupbycolName='modified_time';
                                }
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value !='Empty' && $value!=''){
                                    $datetime=$dateformat.' '.$timeformat;
                                    $value =(new User())->convertUserTimeZone($value,$datetime,'Y-m-d H:i:s');
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==20){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value = (new User())->convertUserTimeZone(trim($value),$timeformat, 'H:i:s');
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==7){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value  = (new User())->convertUserTimeZone($value,$dateformat,'Y-m-d'); 
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==6){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = $row->$groupbycolName=='' ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty'){
                                    if($value==1){
                                        $value='Yes';
                                    }else{
                                        $value='No';
                                    }
                                }
                            $groupbycol= $value;
                            }elseif($col_fieldtype==25){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value  =$this->getUserFormatValues($col_fieldtype,$value);  
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==11){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value  =$this->getUserFormatValues($col_fieldtype,$value,$value,$groupbycolName);  
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==12 || $col_fieldtype==3){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value  =$this->getUserFormatValues($col_fieldtype,$value);  
                                }
                                $groupbycol= $value;
                            }else{
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $groupbycol= empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                            }
                        }
                    }

                    $grandTotalPer['Total'] = ($grandTotalPer['Total'] ?? 0) + $row->count;
                    foreach ($aggregatecolumns as $val) {
                        if($val->aggregatecolumns_calculation_type=='picklist_tracking'){
                            $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$val->picklist_tracking_id)->where('field_id','!=',0)->get();
                            if(count($trackingdetails)){
                                $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                foreach($picklist_data as $picklistval){
                                    $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                    $columntotal ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value).'_total';

                                    $picklisttracingdata=$this->getPicklistTrackingData($row->$column, $picklistval);
                                    $picklisttracingoutput=$picklisttracingdata['finalOutput'];
                                    $picklisttracingcount=$picklisttracingdata['totalCount'];
                                    if($picklistval->formula=='percentage'){
                                        $grandTotalPer[$column] = ($grandTotalPer[$column] ?? 0) + $row->count;
                                        $grandTotalPer['Total_'.$column] = ($grandTotalPer['Total_'.$column] ?? 0) + $row->count;
                                        $aggregateKey =  $groupbycol . '_' . $column;
                                        $grandTotalPer['Total_'.$aggregateKey] = ($grandTotalPer['Total_'.$aggregateKey] ?? 0) + $row->count;
                                    }else{
                                         $grandTotalPer[$column] = ($grandTotalPer[$column] ?? 0) + floatval($picklisttracingoutput);
                                        $grandTotalPer['Total_'.$column] = ($grandTotalPer['Total_'.$column] ?? 0) + floatval($picklisttracingoutput);
                                        $aggregateKey =  $groupbycol . '_' . $column;
                                        $grandTotalPer['Total_'.$aggregateKey] = ($grandTotalPer['Total_'.$aggregateKey] ?? 0) + floatval($picklisttracingoutput);
                                    }

                                    $grandTotalPer[$columntotal] = ($grandTotalPer[$columntotal] ?? 0) + floatval($picklisttracingcount);
                                    $grandTotalPer['Total_'.$columntotal] = ($grandTotalPer['Total_'.$columntotal] ?? 0) + floatval($picklisttracingcount);
                                    $aggregateKey =  $groupbycol . '_' . $columntotal;
                                    $grandTotalPer['Total_'.$aggregateKey] = ($grandTotalPer['Total_'.$aggregateKey] ?? 0) + floatval($picklisttracingcount);
                                }
                            } 
                        }else{
                            if(in_array($val->aggregatecolumns_fieldtype,[13,14,15,16,17])){
                                $column=$val->aggregatecolumns_calculation_type . '_'.str_replace('.','_',$val->aggregatecolumns_coloumn_name);
                                $agcolName=$val->aggregatecolumns_calculation_type.'_'.$val->aggregatecolumns_coloumn_name;
                            }else{
                                $column=$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                                $agcolName=$val->aggregatecolumns_calculation_type.'_'.$val->aggregatecolumns_coloumn_name;
                            }

                            $aggregateKey =  $groupbycol . '_' . $agcolName;
                            $grandTotalPer['Total_'.$aggregateKey] = ($grandTotalPer['Total_'.$aggregateKey] ?? 0) + floatval($row->$column);
                            $grandTotalPer[$column] = ($grandTotalPer[$column] ?? 0) + floatval($row->$column);
                        }
                        
                        
                    }
                    $groupbycolValue = $groupbycol;
                    $grandTotalPer[$groupbycolValue] = ($grandTotalPer[$groupbycolValue] ?? 0) + $row->count;
                    foreach ($aggregatecolumns as $val) {
                        $column=$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                        $agcolName=$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                        $aggregateKey =  $groupbycol . '_' . $agcolName; 
                        $grandTotalPer['Total_'.$aggregateKey] = ($grandTotalPer['Total_'.$aggregateKey] ?? 0);
                        $grandTotalPer[$column] = ($grandTotalPer[$column] ?? 0);                    
                    }
                    foreach ($GroupbyArray as $defaultKey) {
                        if (!isset($grandTotalPer[$defaultKey])) {
                            $grandTotalPer[$defaultKey] = 0;
                        }
                    }
                    
                }
                //dd($grandTotalPer);
                foreach ($results as $key => $row) {
                    $groupbyValues = [];
                    $TotalRecordCount=$row->count+$TotalRecordCount;
                    foreach ($groupbyrows as $index => $groupbyRow) {
                        if($groupbyRow->groupbyrows_fieldtype==13){
                            $colName ='modifiedby';
                            $value=empty($row->$colName) ? 'Empty' : $row->$colName;
                            if($value !='Empty'){
                                $value = $AllUsers[$value]['users_firstname'] . ' ' . $AllUsers[$value]['users_lastname'];
                            }
                            $groupbyValues[$index] = $value;
                        }elseif($groupbyRow->groupbyrows_fieldtype==14){
                            $colName ='smcreatorid';
                            $value=empty($row->$colName) ? 'Empty' : $row->$colName;
                            if($value!='Empty'){
                                $value = $AllUsers[$value]['users_firstname'] . ' ' . $AllUsers[$value]['users_lastname'];
                            }
                            $groupbyValues[$index] = $value;
                        }elseif($groupbyRow->groupbyrows_fieldtype==15){
                            $colName ='smownerid';
                            $value=empty($row->$colName) ? 'Empty' : $row->$colName;
                            if($value!='Empty'){
                                $value = $AllUsers[$value]['users_firstname'] . ' ' . $AllUsers[$value]['users_lastname'];
                            }
                            $groupbyValues[$index] = $value;
                        }elseif($groupbyRow->groupbyrows_fieldtype==16 || $groupbyRow->groupbyrows_fieldtype==17 || $groupbyRow->groupbyrows_fieldtype==19){
                            $colName = $groupbyRow->groupbyrows_coloumn_name;
                            if($groupbyRow->groupbyrows_fieldtype==16 ){
                                $colName='created_time';
                            }elseif($groupbyRow->groupbyrows_fieldtype==17 ){
                                $colName='modified_time';
                            }
                            $value = empty($row->$colName) ? 'Empty' : $row->$colName;
                            if($value!='Empty' && $value!=''){
                                $datetime=$dateformat.' '.$timeformat;
                                $value =(new User())->convertUserTimeZone($value,$datetime,'Y-m-d H:i:s');
                            }
                            $groupbyValues[$index] = $value;
                        }elseif($groupbyRow->groupbyrows_fieldtype==20){
                            $colName = $groupbyRow->groupbyrows_coloumn_name;
                            $value = empty($row->$colName) ? 'Empty' : $row->$colName;
                            if($value!='Empty' && $value!=''){
                                 $value = (new User())->convertUserTimeZone(trim($value),$timeformat, 'H:i:s');
                            }
                            $groupbyValues[$index] = $value;
                        }elseif($groupbyRow->groupbyrows_fieldtype==7){
                            $colName = $groupbyRow->groupbyrows_coloumn_name;
                            $value = empty($row->$colName) ? 'Empty' : $row->$colName;
                            if($value!='Empty' && $value!=''){
                                $value  = (new User())->convertUserTimeZone($value,$dateformat,'Y-m-d'); 
                            }
                            $groupbyValues[$index] = $value;
                        }elseif($groupbyRow->groupbyrows_fieldtype==6){
                            $colName = $groupbyRow->groupbyrows_coloumn_name;
                            $value = $row->$colName=='' ? 'Empty' : $row->$colName;
                            if($value!='Empty' && $value!=''){
                                if($value==1){
                                    $value='Yes';
                                }else{
                                    $value='No';
                                }
                            }
                            $groupbyValues[$index] = $value;
                        }elseif($groupbyRow->groupbyrows_fieldtype==25){
                            $colName = $groupbyRow->groupbyrows_coloumn_name;
                            $value = empty($row->$colName) ? 'Empty' : $row->$colName;
                            if($value!='Empty' && $value!=''){
                                $value  =$this->getUserFormatValues($groupbyRow->groupbyrows_fieldtype,$value);  
                            }
                            $groupbyValues[$index] = $value;
                        }elseif($groupbyRow->groupbyrows_fieldtype==11){
                            $colName = $groupbyRow->groupbyrows_coloumn_name;
                            $value = empty($row->$colName) ? 'Empty' : $row->$colName;
                            if($value!='Empty' && $value!=''){
                                $value  =$this->getUserFormatValues($groupbyRow->groupbyrows_fieldtype,$value,$value,$colName);  
                            }
                            $groupbyValues[$index] = $value;
                        }elseif($groupbyRow->groupbyrows_fieldtype==12 || $groupbyRow->groupbyrows_fieldtype==3){
                            $colName = $groupbyRow->groupbyrows_coloumn_name;
                            $value = empty($row->$colName) ? 'Empty' : $row->$colName;
                            if($value!='Empty' && $value!=''){
                                $value  =$this->getUserFormatValues($groupbyRow->groupbyrows_fieldtype,$value);  
                            }
                            $groupbyValues[$index] = $value;
                        }else{
                            $colName = $groupbyRow->groupbyrows_coloumn_name;
                            $groupbyValues[$index] = empty($row->$colName) ? 'Empty' : $row->$colName;
                            

                        }
                        
                    }

                    $currentLevel = &$leadstatusArray['body'];
                
                    foreach ($groupbyValues as $value) {
                        $value = $this->SpaceConvert($value);
                        if (!isset($currentLevel[$value])) {
                            $currentLevel[$value] = [];
                        }
                        $currentLevel = &$currentLevel[$value];
                    }
                
                    foreach ($GroupbyArray as $defaultKey) {
                        if (!isset($currentLevel[$defaultKey])) {
                            $defaultKey = $this->SpaceConvert($defaultKey);
                            $currentLevel[$defaultKey] = 0;
                        }
                    }
                    if(count($groupbycolumns)){
                        if($groupbycolumns[0]->column_type=='picklist_tracking'){
                            $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$groupbycolumns[0]->picklist_tracking_id)->where('field_id','!=',0)->get();
                      
                            if(count($trackingdetails)){
                                $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                foreach($picklist_data as $picklistval){
                                    $column =$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                    $columntotal =$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value).'_total';
                                    $groupbycol= empty($row->$column) ? 'Empty' : $row->$column;
                                    $picklisttracingdata=$this->getPicklistTrackingData($groupbycol, $picklistval); 
                                    $picklisttracingoutput=$picklisttracingdata['finalOutput'];
                                    $picklisttracingcount=$picklisttracingdata['totalCount'];  
                                    $currentLevel[$column] = $picklisttracingoutput;
                                    $currentLevel[$columntotal] = $picklisttracingcount;
                                }
                            } 
                        }else{
                            $col_fieldtype=$groupbycolumns[0]->groupbycolumns_fieldtype;
                            if($col_fieldtype==13){
                                $groupbycolName ='modifiedby';
                                $groupbycol= empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                            }elseif($col_fieldtype==14){
                                $groupbycolName ='smcreatorid';
                                $groupbycol= empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                            }elseif($col_fieldtype==15){
                                $groupbycolName ='smownerid';
                                $groupbycol= empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                            }elseif($col_fieldtype==16 || $col_fieldtype==17 || $col_fieldtype==19){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                if($col_fieldtype==16 ){
                                    $groupbycolName='created_time';
                                }elseif($col_fieldtype==17 ){
                                    $groupbycolName='modified_time';
                                }
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value !='Empty' && $value!=''){
                                    $datetime=$dateformat.' '.$timeformat;
                                    $value =(new User())->convertUserTimeZone($value,$datetime,'Y-m-d H:i:s');
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==20){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value = (new User())->convertUserTimeZone(trim($value),$timeformat, 'H:i:s');
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==7){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value  = (new User())->convertUserTimeZone($value,$dateformat,'Y-m-d'); 
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==6){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = $row->$groupbycolName=='' ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty'){
                                    if($value==1){
                                        $value='Yes';
                                    }else{
                                        $value='No';
                                    }
                                }
                            $groupbycol= $value;
                            }elseif($col_fieldtype==25){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value  =$this->getUserFormatValues($col_fieldtype,$value);  
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==11){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value  =$this->getUserFormatValues($col_fieldtype,$value,$value,$groupbycolName);  
                                }
                                $groupbycol= $value;
                            }elseif($col_fieldtype==12 || $col_fieldtype==3){
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $value = empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                                if($value!='Empty' && $value!=''){
                                    $value  =$this->getUserFormatValues($col_fieldtype,$value);  
                                }
                                $groupbycol= $value;
                            }else{
                                $groupbycolName = $groupbycolumns[0]->groupbycolumns_coloumn_name;
                                $groupbycol= empty($row->$groupbycolName) ? 'Empty' : $row->$groupbycolName;
                            }
                        }
                    }
                    //dd($groupbycolName);
                        
                    foreach ($aggregatecolumns as $val) {
                       
                        if(in_array($val->aggregatecolumns_fieldtype,[13,14,15,16,17])){
                            $agcolName=$val->aggregatecolumns_calculation_type . '_'.str_replace('.','_',$val->aggregatecolumns_coloumn_name);
                            $aggregateKey =   $agcolName;
                        }else{
                            $agcolName = $val->aggregatecolumns_calculation_type . '_' . $val->aggregatecolumns_coloumn_name;
                           $aggregateKey = !empty($groupbycol) ? $groupbycol . '_' . $agcolName : $agcolName;
                        }
                        if (!isset($currentLevel[$aggregateKey])) {
                            $currentLevel[$aggregateKey] = [];
                        }
                        $currentLevel[$aggregateKey] = isset($row->$agcolName) ? $row->$agcolName : 0;
                    }
                    
                    $currentLevel['Total'] = ($currentLevel['Total'] ?? 0) + $row->count;
                    foreach ($aggregatecolumns as $val) {
                         if($val->aggregatecolumns_calculation_type=='picklist_tracking'){
                            $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$val->picklist_tracking_id)->where('field_id','!=',0)->get();
                            if(count($trackingdetails)){
                                $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                foreach($picklist_data as $picklistval){
                                    $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                     $columntotal ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value).'_total';

                                    $picklisttracingdata=$this->getPicklistTrackingData($row->$column, $picklistval);
                                    $picklisttracingoutput=$picklisttracingdata['finalOutput'];
                                    $picklisttracingcount=$picklisttracingdata['totalCount'];
                                    if($picklistval->formula=='percentage'){
                                        $currentLevel[$column] = ($currentLevel[$column] ?? 0) + $row->count;
                                        $aggregateKey =  $groupbycol . '_' . $column;
                                        $currentLevel[$aggregateKey]= ($currentLevel[$aggregateKey] ?? 0) + $row->count;
                                    }else{
                                        $currentLevel[$column] = ($currentLevel[$column] ?? 0) + floatval($picklisttracingoutput);
                                        $aggregateKey =  $groupbycol . '_' . $column;
                                        $currentLevel[$aggregateKey]= $picklisttracingoutput;
                                    }

                                    $currentLevel[$columntotal] = ($currentLevel[$columntotal] ?? 0) + floatval($picklisttracingcount);
                                    $aggregateKey =  $groupbycol . '_' . $columntotal;
                                    $currentLevel[$aggregateKey]= $picklisttracingcount;
                                }
                            } 
                        }else{
                            if(in_array($val->aggregatecolumns_fieldtype,[13,14,15,16,17])){
                                $column=$val->aggregatecolumns_calculation_type . '_'.str_replace('.','_',$val->aggregatecolumns_coloumn_name);
                                $agcolName=$val->aggregatecolumns_calculation_type.'_'.$val->aggregatecolumns_coloumn_name;
                            }else{
                                $column=$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                                $agcolName=$val->aggregatecolumns_calculation_type.'_'.$val->aggregatecolumns_coloumn_name;
                            }
                            $aggregateKey =  $groupbycol . '_' . $agcolName;
                            $currentLevel[$column] = ($currentLevel[$column] ?? 0) + floatval($row->$column);
                            if($val->aggregatecolumns_calculation_type=='Column_Percentage'){
                                $currentLevel[$aggregateKey] = ($grandTotalPer['Total_'.$aggregateKey] != 0) ? ($row->$column / $grandTotalPer['Total_'.$aggregateKey] * 100) : 0;
                            }
                           
                        }
                    }
                  
                    $groupbycolValue = $groupbycol;
                    $currentLevel[$groupbycolValue] = ($currentLevel[$groupbycolValue] ?? 0) + $row->count;
                    foreach ($aggregatecolumns as $val) {
                        $column=$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                        $agcolName=$val->aggregatecolumns_calculation_type . '_'.$val->aggregatecolumns_coloumn_name;
                        $aggregateKey =  $groupbycol . '_' . $agcolName;                   
                    }
                }
            
            if ($reportdetails[0]->picklist_order == 1 && count($groupbyrows)) {
                $groupbyftype = $groupbyrows[0]->groupbyrows_fieldtype;
                if (in_array($groupbyftype, [9, 21, 23, 29, 30, 31])) {
                    $tnme = $groupbyrows[0]->groupbyrows_coloumn_name;
                    $vcolname = 'picklistvalue';
                    $ordercolname = 'seq';
                    if ($groupbyftype == 21) {
                        $tnme = 'rsoft_phonenumber_prefix';
                        $vcolname = 'prefix_value';
                        $ordercolname = 'id';
                    } else if ($groupbyftype == 23) {
                        $tnme = 'rsoft_namefield_prefix';
                        $vcolname = 'prefix_value';
                        $ordercolname = 'id';
                    } else if ($groupbyftype == 29) {
                        $tnme = 'rsoft_city';
                    } elseif ($groupbyftype == 30) {
                        $tnme = 'rsoft_state';
                    } elseif ($groupbyftype == 31) {
                        $tnme = 'rsoft_country';
                    }
                    $orderMapping = DB::table($tnme)->pluck($ordercolname, $vcolname)->toArray();
                    uksort($leadstatusArray['body'], function($a, $b) use ($orderMapping) {
                        $aSeq = isset($orderMapping[$a]) ? (int)$orderMapping[$a] : PHP_INT_MAX;
                        $bSeq = isset($orderMapping[$b]) ? (int)$orderMapping[$b] : PHP_INT_MAX;
                        return $aSeq <=> $bSeq;
                    });
                } elseif (in_array($groupbyftype, [13, 14, 15])) {
                    $userIdMapping = [];
                    foreach ($AllUsers as $userId => $userData) {
                        $name = $this->SpaceConvert($userData['users_firstname'] . ' ' . $userData['users_lastname']);
                        $userIdMapping[$name] = $userId;
                    }
                    $userIdMapping['Empty'] = PHP_INT_MAX; 
                    uksort($leadstatusArray['body'], function($a, $b) use ($userIdMapping) {
                        $aId = isset($userIdMapping[$a]) ? (int)$userIdMapping[$a] : PHP_INT_MAX;
                        $bId = isset($userIdMapping[$b]) ? (int)$userIdMapping[$b] : PHP_INT_MAX;
                        return $aId <=> $bId;
                    });
                }
            }
              //dd($leadstatusArray['body']);
             
             // dd($grandTotalPer);

                $leadstatusArray['GrandTotal']['GrandTotal'] = $grandTotalPer;
                $leadstatusArray['row_count'] = count($leadstatusArray['body']);
            }
            $leadstatusArray['TotalRecordCount']=$TotalRecordCount;
            $response['reportresult']=$leadstatusArray;
            $response['reportMode']='GroupReport';
        }
        $response['previewgtotalresult']=$previewgtotalresult;
        $response['reportfields']=$reportfields;
        $response['reportcolumns']=$reportcolumns;
        $response['coloumnfieldtypes']=$coloumnfieldtypes;
        $response['groupbycolumns']=$groupbycolumns;
        $response['groupbyrows']=$groupbyrows;
        $response['aggregatecolumns']=$aggregatecolumns;
        $response['Totalaggregatecolumn']=$Totalaggregatecolumn;
        return  $response;
    }

    public function getChartReportResult($report_id, $reportdetails, $viewmode) {
    try {
        $response = [];
        $reportresult = [];
        $userid = (new user())->getCurrentUserId();
        $searchQuery = $this->searchQuery;
        $roleid = (new user())->getCurrentUserRoleId();
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $roleid)->get()[0]->permissionprofileid;
        $filterquery = $this->getFilterConditions($report_id, $reportdetails);
    
        $chartConfig = DB::table('rsoft_advanced_report_chartconfigure')
            ->where('report_id', $report_id)
            ->select(
                'chart_id',
                'chart_type',
                'target_value',
                'calculation',
                'calculation_colname',
                'x_axis_colname',
                'y_axis_colname',
                'chart_title',
                'sumcalculation_id',
                'y_axis_fontcolor', 
                'y_axis_fontfamily',
                'y_axis_fontsize',
                'y_axis_i',
                'y_axis_u'
            )->first();
    
        if (!$chartConfig) {
            return $response;
        }
    
        $isSpeedometer = $chartConfig->chart_type === 'SpeedometerChart';
    
        if (!$isSpeedometer) {
            $xaxiscolumn = DB::table('rsoft_advanced_report_chartconfigure')
                ->join('rsoft_module_fields', 'rsoft_advanced_report_chartconfigure.x_axis_colname', '=', 'rsoft_module_fields.id')
                ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
                ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
                ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
                ->where('rsoft_profile2field.profileid', $profileid)
                ->when($viewmode != 'SendMail', function($query) {
                    $query->where('rsoft_profile2tab.permission', 1);
                })
                ->where('rsoft_profile2tab.profileid', $profileid)
                ->where('rsoft_advanced_report_chartconfigure.report_id', $report_id)
                ->where('rsoft_module_fields.active', 1)
                ->where('rsoft_modules.status', 0)
                ->select(
                    'rsoft_advanced_report_chartconfigure.chart_id',
                    'rsoft_advanced_report_chartconfigure.*',
                    'rsoft_module_fields.*',
                    'rsoft_modules.label as modulelabel',
                    'rsoft_modules.name as modulename',
                    'rsoft_modules.name_db as tablename',
                    'rsoft_profile2field.visible'
                )->get();
    
            $yaxiscolumn = DB::table('rsoft_advanced_report_chartconfigure')
                ->join('rsoft_module_fields', 'rsoft_advanced_report_chartconfigure.y_axis_colname', '=', 'rsoft_module_fields.id')
                ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
                ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
                ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
                ->where('rsoft_profile2field.profileid', $profileid)
                ->when($viewmode != 'SendMail', function($query) {
                    $query->where('rsoft_profile2tab.permission', 1);
                })
                ->where('rsoft_profile2tab.profileid', $profileid)
                ->where('rsoft_advanced_report_chartconfigure.report_id', $report_id)
                ->where('rsoft_module_fields.active', 1)
                ->where('rsoft_modules.status', 0)
                ->select(
                    'rsoft_advanced_report_chartconfigure.chart_id',
                    'rsoft_advanced_report_chartconfigure.*',
                    'rsoft_module_fields.*',
                    'rsoft_modules.label as modulelabel',
                    'rsoft_modules.name as modulename',
                    'rsoft_modules.name_db as tablename',
                    'rsoft_profile2field.visible'
                )->get();
    
            if ($xaxiscolumn->isEmpty()) {
                return $response;
            }
       if ($yaxiscolumn->isEmpty()) {
            $xaxiscolumn[0]->y_axis_fontcolor = $chartConfig->y_axis_fontcolor ?: '#000000';
            $xaxiscolumn[0]->y_axis_fontfamily = $chartConfig->y_axis_fontfamily ?: 'Helvetica, Arial, sans-serif';
            $xaxiscolumn[0]->y_axis_fontsize = $chartConfig->y_axis_fontsize ?: 14;
            $xaxiscolumn[0]->y_axis_i = $chartConfig->y_axis_i ?: 0;
            $xaxiscolumn[0]->y_axis_u = $chartConfig->y_axis_u ?: 0;
        }
    } else {
        $xaxiscolumn = collect([$chartConfig]);
        $yaxiscolumn = collect([]);
       
        $xaxiscolumn[0]->y_axis_fontcolor = $chartConfig->y_axis_fontcolor ?: '#000000';
        $xaxiscolumn[0]->y_axis_fontfamily = $chartConfig->y_axis_fontfamily ?: 'Helvetica, Arial, sans-serif';
        $xaxiscolumn[0]->y_axis_fontsize = $chartConfig->y_axis_fontsize ?: 14;
        $xaxiscolumn[0]->y_axis_i = $chartConfig->y_axis_i ?: 0;
        $xaxiscolumn[0]->y_axis_u = $chartConfig->y_axis_u ?: 0;
    }
    
      
        $calcLabelInfo = DB::table('rsoft_module_fields')
            ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
            ->where('rsoft_module_fields.id', $chartConfig->calculation_colname)
            ->select(
                'rsoft_module_fields.label as calc_label',
                'rsoft_modules.name as modulename',
                'rsoft_modules.label as modulelabel'
            )->first();

       
        $primaryModule = $reportdetails[0]->name;

        
        $calc_label = $calcLabelInfo ? $calcLabelInfo->calc_label : 'Y-Axis';
        if ($calcLabelInfo && $calcLabelInfo->modulename !== $primaryModule) {
            $calc_label .= " ({$calcLabelInfo->modulelabel})";
        }

       
        $response['calc_label'] = $calc_label;
    
        $tablename = $reportdetails[0]->name_db;
        $response['primary_module'] = $reportdetails[0]->name; 
       
        $RecordsAccess = [];
        if ($reportdetails[0]->data_handling == 3) {
            $RecordsAccess = (new User())->getRecordsAccessQuery($reportdetails[0]->name, $tablename);
        }
    
        $calcColumnData = DB::table('rsoft_module_fields')
            ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
            ->where('rsoft_module_fields.id', $chartConfig->calculation_colname)
            ->select('rsoft_module_fields.colname', 'rsoft_modules.name_db as calc_table', 'rsoft_module_fields.field_type')
            ->first();
    
        $field_type = $calcColumnData ? $calcColumnData->field_type : null;
        $calcColumn = $calcColumnData ? $calcColumnData->colname : null;
        $calcTable = $calcColumnData ? (in_array($field_type, [13, 14, 15]) ? 'rsoft_crmentity_' . $calcColumnData->calc_table : $calcColumnData->calc_table) : $tablename;
        $calcTablename = $calcColumnData ? $calcColumnData->calc_table : null;
        if ($xaxiscolumn[0]->chart_type =='SpeedometerChart'){
            $tablename= $calcTablename;
        }
        $crmentitytablename = 'rsoft_crmentity_' . $tablename;
        $sumColumnData = ($chartConfig->calculation == 'SUM' && $chartConfig->sumcalculation_id) ? DB::table('rsoft_module_fields')
            ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
            ->where('rsoft_module_fields.id', $chartConfig->sumcalculation_id)
            ->select('rsoft_module_fields.colname', 'rsoft_modules.name_db as sum_table')
            ->first() : null;
    
        $sumColumn = $sumColumnData ? $sumColumnData->colname : null;
        $sumTable = $sumColumnData ? $sumColumnData->sum_table : $tablename;
    
        if ($chartConfig->calculation == 'SUM' && !$sumColumnData) {
            $calcMethod = "COUNT(CASE WHEN {$calcTable}.{$calcColumn} IS NOT NULL AND {$calcTable}.{$calcColumn} != '' THEN 1 END) as value";
        } else {
            $calcMethod = ($chartConfig->calculation == 'SUM') ?
                "CAST(SUM(CASE WHEN {$calcTable}.{$calcColumn} IS NOT NULL AND {$calcTable}.{$calcColumn} != '' THEN {$sumTable}.{$sumColumn} ELSE 0 END) AS INTEGER) as value" :
                (($chartConfig->calculation == 'DISTINCT') ?
                    "COUNT(DISTINCT CASE WHEN {$calcTable}.{$calcColumn} IS NOT NULL AND {$calcTable}.{$calcColumn} != '' THEN {$calcTable}.{$calcColumn} END) as value" :
                    "COUNT(CASE WHEN {$calcTable}.{$calcColumn} IS NOT NULL AND {$calcTable}.{$calcColumn} != '' THEN 1 END) as value");
        }
    
        
        $reportresult = DB::table($tablename)
            ->join('rsoft_crmentity as ' . $crmentitytablename, $tablename . '.id', '=', $crmentitytablename . '.crmid')
            ->leftJoin('rsoft_users as rsoft_user_' . $tablename . '_smownerid', $crmentitytablename . '.smownerid', '=', 'rsoft_user_' . $tablename . '_smownerid.id')
            ->leftJoin('rsoft_users as rsoft_user_' . $tablename . '_smcreatorid', $crmentitytablename . '.smcreatorid', '=', 'rsoft_user_' . $tablename . '_smcreatorid.id')
            ->leftJoin('rsoft_users as rsoft_user_' . $tablename . '_modifiedby', $crmentitytablename . '.modifiedby', '=', 'rsoft_user_' . $tablename . '_modifiedby.id');
    
        if (!$isSpeedometer) {
            $xcolname = $xaxiscolumn[0]->colname;
            $xtablename = $xaxiscolumn[0]->tablename;
            $xfieldtype = $xaxiscolumn[0]->field_type;

            $relatedmodule = DB::table('rsoft_fieldmodulerel')
            ->join('rsoft_modules', 'rsoft_fieldmodulerel.relmodule', '=', 'rsoft_modules.name')
            ->where('rsoft_fieldmodulerel.module', $reportdetails[0]->name)
            ->where('relmodule', '!=', $reportdetails[0]->name)
            ->when($reportdetails[0]->moduletype == 'Inventory', function($query) {
                $query->where('relmodule', '!=', 'Products');
            })
            ->get();

        if (!empty($relatedmodule)) {
            foreach ($relatedmodule as $relatedtable) {
                $relcrmentitytablename = 'rsoft_crmentity_' . $relatedtable->name_db;
                $fieldData = DB::table('rsoft_module_fields')
                    ->where('id', $relatedtable->fieldid)
                    ->pluck('colname');
                if ($fieldData->isNotEmpty()) {
                    $reportresult->leftJoin($relatedtable->name_db, $reportdetails[0]->name_db . '.' . $fieldData[0], '=', $relatedtable->name_db . '.id')
                        ->leftJoin('rsoft_crmentity as ' . $relcrmentitytablename, $relatedtable->name_db . '.id', '=', $relcrmentitytablename . '.crmid')
                        ->leftJoin('rsoft_users as rsoft_user_' . $relatedtable->name_db . '_smownerid', $relcrmentitytablename . '.smownerid', '=', 'rsoft_user_' . $relatedtable->name_db . '_smownerid.id')
                        ->leftJoin('rsoft_users as rsoft_user_' . $relatedtable->name_db . '_smcreatorid', $relcrmentitytablename . '.smcreatorid', '=', 'rsoft_user_' . $relatedtable->name_db . '_smcreatorid.id')
                        ->leftJoin('rsoft_users as rsoft_user_' . $relatedtable->name_db . '_modifiedby', $relcrmentitytablename . '.modifiedby', '=', 'rsoft_user_' . $relatedtable->name_db . '_modifiedby.id');
                }
            }
        }
            if ($xaxiscolumn[0]->chart_type !='SpeedometerChart' &&  !in_array($xaxiscolumn[0]->field_type, [13, 14, 15])) {
                $picklistTable = '';
                if ($xaxiscolumn[0]->field_type == 29) {
                    $picklistTable = 'rsoft_city';
                } elseif ($xaxiscolumn[0]->field_type == 30) {
                    $picklistTable = 'rsoft_state';
                } elseif ($xaxiscolumn[0]->field_type == 31) {
                    $picklistTable = 'rsoft_country';
                } else {
                    $cleanColname = preg_replace('/^' . strtolower($xaxiscolumn[0]->modulename) . '_/', '', $xcolname);
                    $picklistTable = strtolower($xaxiscolumn[0]->modulename) . '_' . $cleanColname;
                }
                $reportresult->leftJoin($picklistTable, $xtablename . '.' . $xcolname, '=', $picklistTable . '.picklistvalue');
    
                if ($xaxiscolumn[0]->x_axis_colname != $xaxiscolumn[0]->y_axis_colname) {
                    if ($xaxiscolumn[0]->chart_type == 'StackedVerticalChart' || $xaxiscolumn[0]->chart_type == 'StackedHorizontalChart') {
                        if (!$yaxiscolumn->isEmpty()) {
                            $ytablename = $yaxiscolumn[0]->tablename;
                            $ycolname = $yaxiscolumn[0]->colname;
                            $yfieldtype = $yaxiscolumn[0]->field_type;
                            $yPicklistTable = '';
                            if (!in_array($yaxiscolumn[0]->field_type, [13, 14, 15])) {
                                if ($yaxiscolumn[0]->field_type == 29) {
                                    $yPicklistTable = 'rsoft_city';
                                } elseif ($yaxiscolumn[0]->field_type == 30) {
                                    $yPicklistTable = 'rsoft_state';
                                } elseif ($yaxiscolumn[0]->field_type == 31) {
                                    $yPicklistTable = 'rsoft_country';
                                } else {
                                    $yCleanColname = preg_replace('/^' . strtolower($yaxiscolumn[0]->modulename) . '_/', '', $ycolname);
                                    $yPicklistTable = strtolower($yaxiscolumn[0]->modulename) . '_' . $yCleanColname;
                                }
                                $reportresult->leftJoin($yPicklistTable, $ytablename . '.' . $ycolname, '=', $yPicklistTable . '.picklistvalue');
                            }
                        }
                    }
                }
            }
    
           
        }

        $reportresult->where($crmentitytablename . '.deleted', '=', 0);
        if (!empty($filterquery)) {
            $reportresult->whereRaw($filterquery);
        }
        if ($userid != 1) {
            $reportresult->where($crmentitytablename . '.smownerid', '!=', 1);
        }
        if ($reportdetails[0]->data_handling == 2) {
            $reportresult->where($crmentitytablename . '.smownerid', '=', $userid);
        }
        if ($reportdetails[0]->data_handling == 3 && !empty($RecordsAccess['sharingrecordusers'])) {
            $sharingcondition = substr($RecordsAccess['sharingrecordusers'], 4);
            $reportresult->whereRaw($sharingcondition);
        }
        if (($viewmode == 'preview' || $viewmode == 'export') && !empty($searchQuery)) {
            $reportresult->whereRaw($searchQuery);
        }
    
        $needleValueQuery = clone $reportresult;
        $needle_value = $needleValueQuery->selectRaw($calcMethod)->value('value') ?? 0;
            $calcLabel = (object)[
            'calc_label' => 'Default Label', 
            'calc_modulename' => '',
            'calc_modulelabel' => ''
        ];
        if ($isSpeedometer) {
            $response['data'] = [$needle_value];
            $response['target_value'] = $chartConfig->target_value;
            $response['calc_label'] = $calcLabel ? $calcLabel->calc_label : 'Value';
            $response['calc_modulename'] = $calcLabel ? $calcLabel->calc_modulename : '';
            $response['calc_modulelabel'] = $calcLabel ? $calcLabel->calc_modulelabel : '';
            $response['xaxiscolumn'] = $xaxiscolumn;
            $response['yaxiscolumn'] = $yaxiscolumn;
            $response['linkid'] = $chartConfig->chart_id;
            $response['filtercondition'] = $filterquery ? urlencode($filterquery) : '';
            $response['needle_value'] = $needle_value;
        } else {
            $xFieldId = $xaxiscolumn[0]->x_axis_colname;
            $yFieldId = !$yaxiscolumn->isEmpty() ? $yaxiscolumn[0]->y_axis_colname : null;
            $ycolname = !$yaxiscolumn->isEmpty() && isset($yaxiscolumn[0]->colname) ? $yaxiscolumn[0]->colname : '';
            $filterPart = $filterquery ? '&widgetquery=AND' . urlencode($filterquery) : '';
            $cvid = DB::table('rsoft_filtercustomview')->select('cvid')->where('entity', $xaxiscolumn[0]->modulename)
                ->where('viewname', 'All')->get()->toArray();
            $cvidno = count($cvid) ? $cvid[0]->cvid : '';
           
            $modulename = DB::table('rsoft_modules')
            ->where('rsoft_modules.id', $xaxiscolumn[0]->module_id)
            ->get();
            if($xaxiscolumn[0]->modulename != $modulename[0]->name){
                $cvidno='';
            }
            $baseUrl = url('/') . "/admin?Module={$modulename[0]->name}&view=List&viewname={$cvidno}&alphafiltervalue=&dateformat=d-m-Y&timeformat=12%20hours&viewmode=AdvancedReport&linkid={$xaxiscolumn[0]->chart_id}{$filterPart}&Searchparms=||%||";
    
            $picklistOrder = DB::table('rsoft_advanced_report')
                ->where('report_id', $report_id)
                ->value('picklist_order');
    
                if ($xaxiscolumn[0]->chart_type == 'StackedVerticalChart' || $xaxiscolumn[0]->chart_type == 'StackedHorizontalChart') {
                    if (!$yaxiscolumn->isEmpty()) {
                        $xquerys = in_array($xcolname, ['smownerid', 'smcreatorid', 'modifiedby']) ?
                            "$calcMethod, 
                            CASE WHEN CONCAT_WS(' ', rsoft_user_{$xtablename}_{$xcolname}.users_firstname, rsoft_user_{$xtablename}_{$xcolname}.users_lastname) IS NULL 
                                OR CONCAT_WS(' ', rsoft_user_{$xtablename}_{$xcolname}.users_firstname, rsoft_user_{$xtablename}_{$xcolname}.users_lastname) = '' 
                            THEN {$crmentitytablename}.{$xcolname} 
                            ELSE CONCAT_WS(' ', rsoft_user_{$xtablename}_{$xcolname}.users_firstname, rsoft_user_{$xtablename}_{$xcolname}.users_lastname) 
                            END as x_axis_label, 
                            {$crmentitytablename}.{$xcolname} as x_axis_value" :
                            "$calcMethod, 
                            CASE WHEN {$xtablename}.{$xcolname} IS NULL OR {$xtablename}.{$xcolname} = '' THEN 'Empty' ELSE {$xtablename}.{$xcolname} END as x_axis_label, 
                            {$xtablename}.{$xcolname} as x_axis_value";
                
                        $ytablename = $yaxiscolumn[0]->tablename;
                        $yquerys = $ycolname && in_array($ycolname, ['smownerid', 'smcreatorid', 'modifiedby']) ?
                            "CASE WHEN CONCAT_WS(' ', rsoft_user_{$ytablename}_{$ycolname}.users_firstname, rsoft_user_{$ytablename}_{$ycolname}.users_lastname) IS NULL 
                                OR CONCAT_WS(' ', rsoft_user_{$ytablename}_{$ycolname}.users_firstname, rsoft_user_{$ytablename}_{$ycolname}.users_lastname) = '' 
                            THEN {$crmentitytablename}.{$ycolname} 
                            ELSE CONCAT_WS(' ', rsoft_user_{$ytablename}_{$ycolname}.users_firstname, rsoft_user_{$ytablename}_{$ycolname}.users_lastname) 
                            END as y_axis_label, 
                            {$crmentitytablename}.{$ycolname} as y_axis_value" :
                            ($ycolname ? "CASE WHEN {$ytablename}.{$ycolname} IS NULL OR {$ytablename}.{$ycolname} = '' THEN 'Empty' ELSE {$ytablename}.{$ycolname} END as y_axis_label, 
                            {$ytablename}.{$ycolname} as y_axis_value" : '');
                
                        $finalQuery = ($xFieldId != $yFieldId && $ycolname) ? "$xquerys, $yquerys" : $xquerys;
                
                        $reportresult->select(DB::raw($finalQuery));
                
                        if ($xFieldId != $yFieldId && $ycolname) {
                            $groupByX = in_array($xcolname, ['smownerid', 'smcreatorid', 'modifiedby']) ? "{$crmentitytablename}.{$xcolname}" : "{$xtablename}.{$xcolname}";
                            $groupByY = in_array($ycolname, ['smownerid', 'smcreatorid', 'modifiedby']) ? "{$crmentitytablename}.{$ycolname}" : "{$ytablename}.{$ycolname}";
                            $reportresult->groupBy(DB::raw("$groupByX, $groupByY"));
                        } else {
                            $groupByX = in_array($xcolname, ['smownerid', 'smcreatorid', 'modifiedby']) ? "{$crmentitytablename}.{$xcolname}" : "{$xtablename}.{$xcolname}";
                            $reportresult->groupBy(DB::raw($groupByX));
                        }
                
                        if ($picklistOrder == 1) {
                            if (in_array($xcolname, ['smownerid', 'smcreatorid', 'modifiedby'])) {
                                $reportresult->orderBy('x_axis_value', 'asc');
                            } else {
                                if($xfieldtype==29 || $xfieldtype==30 || $xfieldtype==31 ){
                                    if($xfieldtype==29){
                                        $tname='rsoft_city';
                                    }elseif($xfieldtype==30){
                                        $tname='rsoft_state';
                                    }else{
                                        $tname='rsoft_country';
                                    }
                                    $reportresult->orderBy($tname . '.id', 'asc');
                                }else{
                                    $reportresult->orderBy($xcolname . '.seq', 'asc');
                                }
                               
                                if ($ycolname) {
                                    if($yfieldtype==29 || $yfieldtype==30 || $yfieldtype==31 ){
                                        if($yfieldtype==29){
                                            $tname='rsoft_city';
                                        }elseif($yfieldtype==30){
                                            $tname='rsoft_state';
                                        }else{
                                            $tname='rsoft_country';
                                        }
                                        $reportresult->orderBy($tname . '.id', 'asc');
                                    }else{
                                        $reportresult->orderBy($ycolname . '.seq', 'asc');
                                    }
                                   
                                   
                                }
                            }
                        }
                
                        $reportresult = $reportresult->get();
                        $datasets = [];
                        $labelsArray = [];
                        $linksArray = [];
                        $report_xaxis_labels = [];
                        $report_yaxis_labels = [];
                        $report_xaxis_values = [];
                        $report_yaxis_values = [];
                        $reportval = [];
                        $xaxis_to_yaxis_map = [];
                
                        // Query distinct values for the calculation column
                        $calcValues = DB::table($calcTablename)
                            ->join('rsoft_crmentity as ' . $crmentitytablename, $calcTablename . '.id', '=', $crmentitytablename . '.crmid')
                            ->where($crmentitytablename . '.deleted', '=', 0)
                            ->whereNotNull($calcColumn)
                            ->where($calcColumn, '!=', '')
                            ->distinct()
                            ->pluck($calcColumn)
                            ->toArray();
                        $calcParam = $calcValues ? "||%||{$calcColumn}=," . implode(',', array_map('urlencode', $calcValues)) : '';
                
                        if (count($reportresult) != 0) {
                            $userListView = Auth::user()->users_listviewoption;
                            $viewname = ($userListView === 'Advanced') ? 'AdvancedListView' : 'List';
                            $dateAndTime = ['dateFormat' => Auth::user()->users_dateformat,'timeFormat' => Auth::user()->users_timeformat,];
                            $encodedDateTime = rawurlencode(json_encode($dateAndTime));
                            // Define Advancedurl for AdvancedListView
                            $Advancedurl = url('/') . "/admin?Module={$xaxiscolumn[0]->modulename}&view=AdvancedListView&viewname={$cvidno}reportlinkid={$xaxiscolumn[0]->chart_id}{$filterPart}". '&SelectFilter=' . rawurlencode($cvidno). '&DateandTime=' . $encodedDateTime;
                            $Advancedmoduleid=$xaxiscolumn[0]->module_id;
                            foreach ($reportresult as $key => $val) {
                                if ($val->x_axis_label === 'Empty' || ($xFieldId != $yFieldId && isset($val->y_axis_label) && $val->y_axis_label === 'Empty')) {
                                    continue;
                                }
                
                                if ($val->value > 0) {
                                    $report_xaxis_labels[$val->x_axis_value] = $val->x_axis_label;
                                    $report_xaxis_values[$val->x_axis_label] = $val->x_axis_value;
                
                                    if ($xFieldId == $yFieldId || !$ycolname) {
                                        $report_yaxis_labels[$key] = $val->x_axis_label;
                                        $report_yaxis_values[$val->x_axis_label] = $val->x_axis_value;
                                        $reportval[$val->x_axis_label] = isset($reportval[$val->x_axis_label]) ? $reportval[$val->x_axis_label] : [];
                                        $reportval[$val->x_axis_label][$val->x_axis_label] = $val->value;
                                        $xaxis_to_yaxis_map[$val->x_axis_value] = isset($xaxis_to_yaxis_map[$val->x_axis_value]) ? $xaxis_to_yaxis_map[$val->x_axis_value] : [];
                                        $xaxis_to_yaxis_map[$val->x_axis_value][] = $val->x_axis_value;
                                    } else {
                                        $report_yaxis_labels[$key] = $val->y_axis_label;
                                        $report_yaxis_values[$val->y_axis_label] = $val->y_axis_value;
                                        $reportval[$val->x_axis_label] = isset($reportval[$val->x_axis_label]) ? $reportval[$val->x_axis_label] : [];
                                        $reportval[$val->x_axis_label][$val->y_axis_label] = $val->value;
                                        $xaxis_to_yaxis_map[$val->x_axis_value] = isset($xaxis_to_yaxis_map[$val->x_axis_value]) ? $xaxis_to_yaxis_map[$val->x_axis_value] : [];
                                        $xaxis_to_yaxis_map[$val->x_axis_value][] = $val->y_axis_value;
                                    }
                                }
                            }
                            $reportyaxis_labels = array_unique($report_yaxis_labels);
                            $reportxaxis_labels = array_unique($report_xaxis_labels);
                
                            foreach ($xaxis_to_yaxis_map as $xval => $yvals) {
                                $xaxis_to_yaxis_map[$xval] = array_unique($yvals);
                            }
                
                            $desiredYOrder = [];
                            $sortedYLabels = array_merge(
                                array_intersect($desiredYOrder, array_keys($report_yaxis_values)),
                                array_diff(array_keys($report_yaxis_values), $desiredYOrder)
                            );
                
                            foreach ($sortedYLabels as $key => $vals) {
                                $values = ['label' => $vals, 'data' => [], 'links' => []];
                                $yval = isset($report_yaxis_values[$vals]) ? $report_yaxis_values[$vals] : '';
                                foreach ($reportxaxis_labels as $vals1) {
                                    $xval = isset($report_xaxis_values[$vals1]) ? $report_xaxis_values[$vals1] : '';
                                    $xParam = "{$xcolname}=," . urlencode($xval);
                
                                    // Handle yParam for segment-specific links (block clicks)
                                    $yParam = '';
                                    if ($ycolname && $xFieldId != $yFieldId && $ycolname != $calcColumn) {
                                        $yParam = "{$ycolname}=," . urlencode($yval);
                                    }
                                    $calcParamToUse = '';
                
                                    $values['data'][] = isset($reportval[$vals1][$vals]) ? $reportval[$vals1][$vals] : 0;
                                    // Use Advancedurl for segment links if viewname is AdvancedListView
                                    $segmentBaseUrl = ($viewname === 'AdvancedListView') ? $Advancedurl : $baseUrl;
                                    if ($viewname === 'AdvancedListView') {
                                        $Zcolunm = $calcParamToUse;
                                        $xFieldFilters = [];
                                        $yFieldFilters = [];
                                        $zFieldFilters = [];
 
                                        $xval = (!empty($xParam) && str_contains($xParam, '=,'))
                                            ? $this->cleanValue(urldecode(trim(explode('=,', $xParam)[1] ?? '')))
                                            : '';
 
                                        $yval = (!empty($yParam) && str_contains($yParam, '=,'))
                                            ? $this->cleanValue(urldecode(trim(explode('=,', $yParam)[1] ?? '')))
                                            : '';
 
                                        $colnames = array_filter([$xcolname, $ycolname]);
                                        $moduleId = $xaxiscolumn[0]->module_id;
 
                                        $fieldMetas = DB::table('rsoft_module_fields')
                                            ->select('id', 'field_type', 'colname', 'label')
                                            ->where('module', $moduleId)
                                            ->whereIn('colname', $colnames)
                                            ->get()
                                            ->keyBy('colname');
 
                                        if (!empty($xcolname) && isset($fieldMetas[$xcolname]) && !empty($xval)) {
                                            $meta = $fieldMetas[$xcolname];
 
                                            $conditions = match (true) {
                                                in_array($meta->field_type, [13, 14, 15]) => ['Is', 'is'],
                                                $meta->field_type === 6 => ['Checked', 'checked'],
                                                $meta->field_type === 12 => ['Contains', 'contains'],
                                                default => ['Equals', 'Equals'],
                                            };
 
                                            $xFieldFilters[] = [
                                                'fieldId'         => (string) $meta->id,
                                                'fieldType'       => (string) $meta->field_type,
                                                'fieldColumnName' => $meta->colname,
                                                'fieldLabel'      => $this->cleanValue((string) $meta->label),
                                                'condition'       => $conditions[0],
                                                'conditionValue'  => $conditions[1],
                                                'value'           => $this->cleanValue($xval),
                                            ];
                                        }
 
                                        if (!empty($ycolname) && isset($fieldMetas[$ycolname]) && !empty($yval)) {
                                            $meta = $fieldMetas[$ycolname];
 
                                            $conditions = match (true) {
                                                in_array($meta->field_type, [13, 14, 15]) => ['Is', 'is'],
                                                $meta->field_type === 6 => ['Checked', 'checked'],
                                                $meta->field_type === 12 => ['Contains', 'contains'],
                                                default => ['Equals', 'Equals'],
                                            };
 
                                            $yFieldFilters[] = [
                                                'fieldId'         => (string) $meta->id,
                                                'fieldType'       => (string) $meta->field_type,
                                                'fieldColumnName' => $meta->colname,
                                                'fieldLabel'      => $this->cleanValue((string) $meta->label),
                                                'condition'       => $conditions[0],
                                                'conditionValue'  => $conditions[1],
                                                'value'           => $this->cleanValue($yval),
                                            ];
                                        }
                                        if (!empty($Zcolunm) && str_contains($Zcolunm, '=,')) {
                                            $Zcolunm = preg_replace('/^\|\|%?\|\||%$/', '', $Zcolunm);
                                            [$zColname, $zRawValues] = explode('=,', $Zcolunm, 2);
 
                                            $zDecoded = urldecode($zRawValues);
                                            $zParts = explode(',', $zDecoded);
                                            $zValues = array_map(fn($val) => $this->cleanValue(urldecode($val)), $zParts);
                                            $zValueString = implode(',', array_filter($zValues));
 
                                            $zFieldMeta = DB::table('rsoft_module_fields')
                                                ->select('id', 'field_type', 'colname', 'label')
                                                ->where('module', $moduleId)
                                                ->where('colname', $zColname)
                                                ->first();
 
                                            if ($zFieldMeta && !empty($zValueString)) {
                                                $conditions = match (true) {
                                                    in_array($zFieldMeta->field_type, [13, 14, 15]) => ['Is', 'is'],
                                                    $zFieldMeta->field_type === 6 => ['Checked', 'checked'],
                                                    $zFieldMeta->field_type === 12 => ['Contains', 'contains'],
                                                    default => ['Equals', 'Equals'],
                                                };
 
                                                $zFieldFilters[] = [
                                                    'fieldId'         => (string) $zFieldMeta->id,
                                                    'fieldType'       => (string) $zFieldMeta->field_type,
                                                    'fieldColumnName' => $zFieldMeta->colname,
                                                    'fieldLabel'      => $this->cleanValue((string) $zFieldMeta->label),
                                                    'condition'       => $conditions[0],
                                                    'conditionValue'  => $conditions[1],
                                                    'value'           => $this->cleanValue($zValueString),
                                                ];
                                            }
                                        }
 
                                        $fieldFilters = array_merge($xFieldFilters, $yFieldFilters, $zFieldFilters);
 
                                        $dateAndTime = [
                                            'dateFormat' => Auth::user()->users_dateformat,
                                            'timeFormat' => Auth::user()->users_timeformat,
                                        ];
 
                                        $encodedFilters = rawurlencode(rawurlencode(json_encode($fieldFilters)));
                                        $encodedDateTime = rawurlencode(json_encode($dateAndTime));
 
                                        $values['links'][] = $Advancedurl . '&FieldFilters=' . $encodedFilters . '&DateandTime=' . $encodedDateTime . '&SelectFilter=' . rawurlencode($cvidno);
                                    }
                                    else {
                                        // List View fallback (continue with xParam and yParam)
                                    $cleanXVal = urlencode($xval);
                                    $cleanYVal = ($ycolname && $xFieldId != $yFieldId && $ycolname != $calcColumn) ? urlencode($yval) : '';
                                    
                                    $segmentUrl = $baseUrl . "{$xcolname}=," . $cleanXVal;
                                    if ($cleanYVal) {
                                        $segmentUrl .= "||%||{$ycolname}=," . $cleanYVal;
                                    }
                                    $values['links'][] = $segmentUrl . '#';
                                    }
                
                                    if (!in_array($vals1, $labelsArray)) {
                                        $labelsArray[] = $vals1;
                                        $yParamString = ($xFieldId == $yFieldId) ? $xval : '';
                                        if ($xFieldId != $yFieldId) {
                                            $activeYValues = array_filter(array_map(function($yLabel) use ($report_yaxis_values, $vals1, $reportval) {
                                                return isset($reportval[$vals1][$yLabel]) && $reportval[$vals1][$yLabel] > 0 && isset($report_yaxis_values[$yLabel]) ? $report_yaxis_values[$yLabel] : null;
                                            }, array_keys(isset($reportval[$vals1]) ? $reportval[$vals1] : [])), function($value) {
                                                return $value !== null;
                                            });
                                            $sortedYValues = array_merge(
                                                array_intersect($desiredYOrder, $activeYValues),
                                                array_diff($activeYValues, $desiredYOrder)
                                            );
                                            $yParamString = empty($sortedYValues) ? '' : implode(',', array_map('urlencode', $sortedYValues));
                                        }
                                        // Ensure yAxisParam and calcParam are included for same-field case
                                        $activeYValues = [];
                                        foreach ($reportyaxis_labels as $yLabel) {
                                            if (isset($reportval[$vals1][$yLabel]) && $reportval[$vals1][$yLabel] > 0 && isset($report_yaxis_values[$yLabel])) {
                                                $activeYValues[] = $report_yaxis_values[$yLabel];
                                            }
                                        }
                                        $yAxisParam = $ycolname && !empty($activeYValues) ? "||%||{$ycolname}=," . implode(',', array_map('urlencode', $activeYValues)) : '';
                                        $calcParamToUseForXAxis = '';
                                     // Use Advancedurl for x-axis links if viewname is AdvancedListView
                                        $xAxisBaseUrl = ($viewname === 'AdvancedListView') ? $Advancedurl : $baseUrl;
                                        if ($viewname === 'AdvancedListView') {
                                            $xval = (!empty($xParam) && str_contains($xParam, '=,'))
                                                ? $this->cleanValue(urldecode(trim(explode('=,', $xParam)[1] ?? '')))
                                                : '';

                                            $yval = (!empty($yAxisParam) && str_contains($yAxisParam, '=,'))
                                                ? $this->cleanValue(urldecode(trim(explode('=,', $yAxisParam)[1] ?? '')))
                                                : '';

                                            $colnames = array_filter([$xcolname, $ycolname]);
                                            $moduleId = $xaxiscolumn[0]->module_id;

                                            $fieldMetas = DB::table('rsoft_module_fields')
                                                ->select('id', 'field_type', 'colname', 'label')
                                                ->where('module', $moduleId)
                                                ->whereIn('colname', $colnames)
                                                ->get()
                                                ->keyBy('colname');

                                            $fieldFilters = [];

                                            foreach ([['col' => $xcolname, 'val' => $xval], ['col' => $ycolname, 'val' => $yval]] as $axis) {
                                                ['col' => $col, 'val' => $val] = $axis;

                                                if (!empty($col) && isset($fieldMetas[$col]) && !empty($val)) {
                                                    $meta = $fieldMetas[$col];

                                                    $conditions = match (true) {
                                                        in_array($meta->field_type, [13, 14, 15]) => ['Is', 'is'],
                                                        $meta->field_type === 6 => ['Checked', 'checked'],
                                                        $meta->field_type === 12 => ['Contains', 'contains'],
                                                        default => ['Equals', 'Equals'],
                                                    };

                                                    $fieldFilters[] = [
                                                        'fieldId'         => (string) $meta->id,
                                                        'fieldType'       => (string) $meta->field_type,
                                                        'fieldColumnName' => $meta->colname,
                                                        'fieldLabel'      => $this->cleanValue((string) $meta->label),
                                                        'condition'       => $conditions[0],
                                                        'conditionValue'  => $conditions[1],
                                                        'value'           => $this->cleanValue($val),
                                                    ];
                                                }
                                            }

                                            // Date/time preferences
                                            $dateAndTime = [
                                                'dateFormat' => Auth::user()->users_dateformat,
                                                'timeFormat' => Auth::user()->users_timeformat,
                                            ];

                                            $encodedFilters  = rawurlencode(rawurlencode(json_encode($fieldFilters)));
                                            $encodedDateTime = rawurlencode(json_encode($dateAndTime));

                                            // Final link generation
                                            $linksArray[] = $Advancedurl
                                                . '&FieldFilters=' . $encodedFilters
                                                . '&DateandTime=' . $encodedDateTime
                                                . '&SelectFilter=' . rawurlencode($cvidno);
                                        }
                                        else{
                                            $cleanXVal = urlencode($xval);
                                            $cleanYVals = $activeYValues ? implode(',', array_map('urlencode', $activeYValues)) : '';
                                            
                                            $xAxisUrl = $xAxisBaseUrl . "{$xcolname}=," . $cleanXVal;
                                            if ($cleanYVals && $ycolname) {
                                                $xAxisUrl .= "||%||{$ycolname}=," . $cleanYVals;
                                            }
                                            $linksArray[] = $xAxisUrl . '#';
                                        }
                                       
                                    }
                                }
                                if (array_sum($values['data']) > 0) {
                                    $datasets[] = $values;
                                }
                            }
                            $response['datacount'] = count($datasets);
                            $response['datasets'] = $datasets;
                            $response['labels'] = $labelsArray;
                            $response['links'] = $linksArray;
                            $response['xaxis_links'] = $linksArray;
                            $response['yaxis_links'] = array_map(function($val) use ($baseUrl, $xcolname, $ycolname, $report_xaxis_values, $report_yaxis_values, $xFieldId, $yFieldId, $calcParam, $calcColumn, $Advancedurl, $viewname,$Advancedmoduleid) {
                                if ($xFieldId == $yFieldId || !$ycolname) {
                                    $xval = isset($report_xaxis_values[$val]) ? $report_xaxis_values[$val] : '';
                                    $yAxisParam = ($xFieldId == $yFieldId && $ycolname && $ycolname != $calcColumn) ? "||%||{$ycolname}=," . urlencode($xval) : '';
                                    $calcParamToUse = ($xFieldId == $yFieldId && $ycolname == $calcColumn) ? '' : $calcParam;
                                    $yAxisBaseUrl = ($viewname === 'AdvancedListView') ? $Advancedurl : $baseUrl;
                                    
                                    return $yAxisBaseUrl . "{$xcolname}=," . urlencode($xval) . $yAxisParam . $calcParamToUse . "#";
                                }
                                $yval = isset($report_yaxis_values[$val]) ? $report_yaxis_values[$val] : '';
                                $yAxisParam = ($ycolname && $ycolname != $calcColumn) ? "{$ycolname}=," . urlencode($yval) : ($ycolname == $calcColumn ? "{$ycolname}=," . urlencode($yval) : '');
                                $calcParamToUse = ($ycolname == $calcColumn) ? '' : $calcParam;
                                $yAxisBaseUrl = ($viewname === 'AdvancedListView') ? $Advancedurl : $baseUrl;
                                    if ($viewname === 'AdvancedListView') {
                                        $xFieldFilters = [];
                                        $yFieldFilters = [];
                                        $zFieldFilters = [];

                                        // Clean X (from calcParamToUse)
                                        $Xparam = preg_replace('/^\|\|%?\|\||%$/', '', $calcParamToUse);
                                        $xParts = explode('=,', $Xparam, 2);
                                        $xcolname = $xParts[0] ?? '';  
                                        $xRaw     = $xParts[1] ?? '';   
                                        $xDecoded = urldecode(str_replace('+', ' ', $xRaw));
                                        $xval     = $this->cleanValue($xDecoded);

                                        // Safe explode for Y
                                        $yParts = explode('=,', $yAxisParam, 2);
                                        $ycolname = $yParts[0] ?? '';
                                        $yRaw     = $yParts[1] ?? '';
                                        $yDecoded = urldecode(str_replace('+', ' ', $yRaw));
                                        $yval     = $this->cleanValue($yDecoded);

                                        $colnames = array_filter([$xcolname, $ycolname]);
                                        $moduleId = $Advancedmoduleid;

                                        // Preload metadata
                                        $fieldMetas = DB::table('rsoft_module_fields')
                                            ->select('id', 'field_type', 'colname', 'label')
                                            ->where('module', $moduleId)
                                            ->whereIn('colname', $colnames)
                                            ->get()
                                            ->keyBy('colname');

                                        // X Filter
                                        if (!empty($xcolname) && isset($fieldMetas[$xcolname]) && !empty($xval)) {
                                            $meta = $fieldMetas[$xcolname];
                                            $cond = match (true) {
                                                in_array($meta->field_type, [13, 14, 15]) => ['Is', 'is'],
                                                $meta->field_type === 6 => ['Checked', 'checked'],
                                                $meta->field_type === 12 => ['Contains', 'contains'],
                                                default => ['Equals', 'Equals'],
                                            };

                                            $xFieldFilters[] = [
                                                'fieldId'         => (string) $meta->id,
                                                'fieldType'       => (string) $meta->field_type,
                                                'fieldColumnName' => $meta->colname,
                                                'fieldLabel'      => $this->cleanValue($meta->label),
                                                'condition'       => $cond[0],
                                                'conditionValue'  => $cond[1],
                                                'value'           => $this->cleanValue($xval),
                                            ];
                                        }

                                        // Y Filter
                                        if (!empty($ycolname) && isset($fieldMetas[$ycolname]) && !empty($yval)) {
                                            $meta = $fieldMetas[$ycolname];
                                            $cond = match (true) {
                                                in_array($meta->field_type, [13, 14, 15]) => ['Is', 'is'],
                                                $meta->field_type === 6 => ['Checked', 'checked'],
                                                $meta->field_type === 12 => ['Contains', 'contains'],
                                                default => ['Equals', 'Equals'],
                                            };

                                            $yFieldFilters[] = [
                                                'fieldId'         => (string) $meta->id,
                                                'fieldType'       => (string) $meta->field_type,
                                                'fieldColumnName' => $meta->colname,
                                                'fieldLabel'      => $this->cleanValue($meta->label),
                                                'condition'       => $cond[0],
                                                'conditionValue'  => $cond[1],
                                                'value'           => $this->cleanValue($yval),
                                            ];
                                        }

                                        // Merge filters
                                        $fieldFilters = array_merge($xFieldFilters, $yFieldFilters);

                                        // DateTime info
                                        $dateAndTime = [
                                            'dateFormat' => Auth::user()->users_dateformat,
                                            'timeFormat' => Auth::user()->users_timeformat,
                                        ];

                                        // Final encoding
                                        $encodedFilters = rawurlencode(rawurlencode(json_encode($fieldFilters)));
                                        $encodedDateTime = rawurlencode(json_encode($dateAndTime));

                                        // Final URL
                                        return  $Advancedurl . '&FieldFilters=' . $encodedFilters . '&DateandTime=' . $encodedDateTime ;
                                    }
                                    else{
                                        $cleanYVal = urlencode($yval);
                                        return $yAxisBaseUrl . "{$ycolname}=," . $cleanYVal . "#";
                                    }
                                return $yAxisBaseUrl . $yAxisParam . ($yAxisParam && $calcParamToUse ? '||%||' : '') . $calcParamToUse . "#";
                            }, $sortedYLabels);
                            $response['yaxis_ids'] = array_values($xFieldId == $yFieldId || !$ycolname ? $report_xaxis_values : $report_yaxis_values);
                            $response['xaxis_ids'] = array_values($report_xaxis_values);
                            $response['xaxis_to_yaxis_map'] = $xaxis_to_yaxis_map;
                            $response['calculation_colname'] = $calcColumn;
                            $response['calculation_values'] = $calcValues;
                        }
                    }
                } else {
                $selectQuery = in_array($xcolname, ['smownerid', 'smcreatorid', 'modifiedby']) ?
                    "$calcMethod, 
                    CASE WHEN CONCAT_WS(' ', rsoft_user_{$xtablename}_{$xcolname}.users_firstname, rsoft_user_{$xtablename}_{$xcolname}.users_lastname) IS NULL 
                        OR CONCAT_WS(' ', rsoft_user_{$xtablename}_{$xcolname}.users_firstname, rsoft_user_{$xtablename}_{$xcolname}.users_lastname) = '' 
                    THEN {$crmentitytablename}.{$xcolname} 
                    ELSE CONCAT_WS(' ', rsoft_user_{$xtablename}_{$xcolname}.users_firstname, ' ', rsoft_user_{$xtablename}_{$xcolname}.users_lastname) 
                    END as x_axis_label, 
                    {$crmentitytablename}.{$xcolname} as x_axis_value" :
                    "$calcMethod, 
                    CASE WHEN {$xtablename}.{$xcolname} IS NULL OR {$xtablename}.{$xcolname} = '' THEN 'Empty' ELSE {$xtablename}.{$xcolname} END as x_axis_label, 
                    {$xtablename}.{$xcolname} as x_axis_value";
    
                $reportresult->select(DB::raw($selectQuery));
                $groupByX = in_array($xcolname, ['smownerid', 'smcreatorid', 'modifiedby']) ? "{$crmentitytablename}.{$xcolname}" : "{$xtablename}.{$xcolname}";
                $reportresult->groupBy(DB::raw($groupByX));
    
                if ($xaxiscolumn[0]->chart_type == 'FunnelChart') {
                    $reportresult->orderBy('value', 'desc');
                } elseif ($picklistOrder == 1) {
                    if (in_array($xcolname, ['smownerid', 'smcreatorid', 'modifiedby'])) {
                        $reportresult->orderBy('x_axis_value', 'asc');
                    } else {
                        if($xfieldtype==29 || $xfieldtype==30 || $xfieldtype==31 ){
                            if($xfieldtype==29){
                                $tname='rsoft_city';
                            }elseif($xfieldtype==30){
                                $tname='rsoft_state';
                            }else{
                                $tname='rsoft_country';
                            }
                            $reportresult->orderBy($tname . '.id', 'asc');
                        }else{
                            $reportresult->orderBy($xcolname . '.seq', 'asc');
                        }
                    }
                }
    
                $reportresult = $reportresult->get();
    
                if (count($reportresult)) {
                    $response['labels'] = [];
                    $response['data'] = [];
                    $response['ids'] = [];
                    $response['links'] = [];
                    $xaxis_to_yaxis_map = [];

                    $calcValues = DB::table($calcTablename)
                            ->join('rsoft_crmentity as ' . $crmentitytablename, $calcTablename . '.id', '=', $crmentitytablename . '.crmid')
                            ->where($crmentitytablename . '.deleted', '=', 0)
                            ->whereNotNull($calcColumn)
                            ->where($calcColumn, '!=', '')
                            ->distinct()
                            ->pluck($calcColumn)
                            ->toArray();
                    foreach ($reportresult as $key => $val) {
                        if ($val->x_axis_label === 'Empty' || $val->value == 0) {
                            continue;
                        }
                        $xParam = "{$xcolname}=,{$val->x_axis_value}";
                        $calcParam = ($calcColumn == $xcolname)
                            ? "{$calcColumn}=,{$val->x_axis_value}"
                            : (!empty($calcValues) ? "{$calcColumn}=," . implode(',', $calcValues) : '');
 
                        $response['labels'][] = $val->x_axis_label;
                        $response['data'][] = $val->value;
                        $response['ids'][] = $val->x_axis_value;
 
                        $userListView = Auth::user()->users_listviewoption;
                        $viewname = ($userListView === 'Advanced') ? 'AdvancedListView' : 'List';
 
                        if ($viewname === 'List') {
                            // Simple List View URL
                            $response['links'][] = $baseUrl . $xParam . '||%||' . $calcParam . '#';
                        } else {
                                $moduleId = $xaxiscolumn[0]->module_id;
                                $columns = [$xcolname, $calcColumn];
 
                                $fieldMetas = DB::table('rsoft_module_fields')
                                    ->select('id', 'field_type', 'colname', 'label')
                                    ->where('module', $moduleId)
                                    ->whereIn('colname', $columns)
                                    ->get()
                                    ->keyBy('colname');
 
                                $fieldFilters = [];
 
                                // Normalize non-breaking spaces
                                $normalizedXValue = str_replace("\u{00A0}", ' ', $val->x_axis_value);
 
                                // Add x-axis filter
                                if (isset($fieldMetas[$xcolname])) {
                                    $meta = $fieldMetas[$xcolname];
                                    $condition = match (true) {
                                        in_array($meta->field_type, [13, 14, 15]) => ['Is', 'is'],
                                        $meta->field_type == 6 => ['Checked', 'checked'],
                                        $meta->field_type == 12 => ['Contains', 'contains'],
                                        default => ['Equals', 'Equals'],
                                    };
 
                                    $fieldFilters[] = [
                                        'fieldId' => (string) $meta->id,
                                        'fieldType' => (string) $meta->field_type,
                                        'fieldColumnName' => $meta->colname,
                                        'fieldLabel' => $meta->label,
                                        'condition' => $condition[0],
                                        'conditionValue' => $condition[1],
                                        'value' => $normalizedXValue,
                                    ];
                                }
 
                                // Add calc column filter
                                if (!empty($calcValues) && isset($fieldMetas[$calcColumn])) {
                                    $meta = $fieldMetas[$calcColumn];
                                    $condition = match (true) {
                                        in_array($meta->field_type, [13, 14, 15]) => ['Is', 'is'],
                                        $meta->field_type == 6 => ['Checked', 'checked'],
                                        $meta->field_type == 12 => ['Contains', 'contains'],
                                        default => ['Equals', 'Equals'],
                                    };
 
                                    // Normalize non-breaking spaces in calcValues
                                    $normalizedCalcValues = array_map(function ($v) {
                                        return str_replace("\u{00A0}", ' ', $v);
                                    }, $calcValues);
 
                                    $fieldFilters[] = [
                                        'fieldId' => (string) $meta->id,
                                        'fieldType' => (string) $meta->field_type,
                                        'fieldColumnName' => $meta->colname,
                                        'fieldLabel' => $meta->label,
                                        'condition' => $condition[0],
                                        'conditionValue' => $condition[1],
                                        'value' => implode(',', $normalizedCalcValues),
                                    ];
                                }
 
                                $dateAndTime = [
                                    'dateFormat' => Auth::user()->users_dateformat,
                                    'timeFormat' => Auth::user()->users_timeformat,
                                ];
 
                                $encodedFilters = rawurlencode(rawurlencode(json_encode($fieldFilters)));
                                $encodedDateTime = rawurlencode(json_encode($dateAndTime));
 
                                $advBaseUrl = url('/admin')
                                    . '?Module=' . rawurlencode($xaxiscolumn[0]->modulename)
                                    . '&view=AdvancedListView'
                                    . '&viewname=' . rawurlencode($cvidno)
                                    . '&alphafiltervalue='
                                    . '&viewmode=AdvancedReport'
                                    . $filterPart
                                    . '&FieldFilters=' . $encodedFilters
                                    . '&SelectFilter=' . rawurlencode($cvidno)
                                    . '&DateandTime=' . $encodedDateTime;
 
                                $response['links'][] = $advBaseUrl;
                            }
                        $xaxis_to_yaxis_map[$val->x_axis_value] = [$val->x_axis_value];
                    }
                    $response['xaxis_to_yaxis_map'] = $xaxis_to_yaxis_map;
                }
            }
    
            $response['xaxiscolumn'] = $xaxiscolumn;
            $response['yaxiscolumn'] = $yaxiscolumn;
            $response['linkid'] = $xaxiscolumn[0]->chart_id;
            $response['filtercondition'] = $filterquery ? urlencode($filterquery) : '';
            $response['target_value'] = $xaxiscolumn[0]->target_value;
            $response['needle_value'] = $needle_value;
       
        }
    
        return $response;
        
    } 
        catch (\Exception $e) {
            return [
                'data' => [],
                'labels' => [],
                'datasets' => [],
                'links' => [],
                'xaxiscolumn' => [],
                'yaxiscolumn' => [],
                'calc_label' => 'Error loading chart',
                'message' => 'Unable to load chart data'
            ];
        }
    }
   
   
    function SpaceConvert($key) {
        return preg_replace('/\s+/u', ' ', trim($key));
    }

    function isMultiArray($array) {
        if (!is_array($array)) {
            return 0;
        }
    
        foreach ($array as $element) {
            if (is_array($element)) {
                return 1;
            }
        }
    }

    function TotalDataSumArray($countgroupbyrow,$results) {
        $sums = [];
        if($countgroupbyrow==3){
            foreach ($results as  $statusCounts){
                $result[]=$statusCounts;
            }
            foreach ($result as $dataItem) {
                foreach ($dataItem as $subArray) {
                    foreach ($subArray as $key => $value) {
                        $sums[$key] = ($sums[$key] ?? 0) + (is_numeric($value) ? (float)$value : 0);
                    }
                }
            }
            $result=$sums;
        }elseif($countgroupbyrow==4){
            foreach ($results as  $statusCounts1){
                foreach ($statusCounts1 as $statusCounts){
                    $result[]=$statusCounts;
                }
            }
            foreach ($result as $dataItem) {
                foreach ($dataItem as $subArray) {
                    foreach ($subArray as $key => $value) {
                        $sums[$key] = ($sums[$key] ?? 0) + (is_numeric($value) ? (float)$value : 0);
                    }
                }
            }
            $result=$sums;
        }elseif($countgroupbyrow==5){
            foreach ($results as  $statusCounts1){
                foreach ($statusCounts1 as  $statusCounts2){
                    foreach ($statusCounts2 as  $statusCounts){
                      $result[]=$statusCounts;
                    }
                }
            }
            foreach ($result as $dataItem) {
                foreach ($dataItem as $subArray) {
                    foreach ($subArray as $key => $value) {
                        $sums[$key] = ($sums[$key] ?? 0) + (is_numeric($value) ? (float)$value : 0);
                    }
                }
            }
            $result=$sums;
        }else{
            foreach ($results as $subArray) {
                foreach ($subArray as $key => $value) {
                    $sums[$key] = ($sums[$key] ?? 0) + (float)$value;
                }
            }
            $result=$sums;
           // dd($result);
        }
        return $result;
     }

    function CountisMultiArray($array) {
        if (!is_array($array)) {
            return 1;
        }
    
        foreach ($array as $element) {
            if (is_array($element)) {
                return count($element);
            }
        }
    }
    function countTopLevelArrays($array) {
        $count = 0;
        foreach ($array as $key => $value) {
            if (is_array($value)) {
                $count++;
            }
        }
        return $count;
    }


    public function count2LevelArrays($data)
    {
        $counts = [];
        foreach ($data as $key => $value) {
            if (is_array($value)) {
                $counts[$key] = count($value);
            } else {
                $counts[$key] = 1;
            }
        }
        return $counts;
    }


    function count3LevelArrays($arrays) {
       // dd($arrays);
        $count = [];
        foreach ($arrays as $keys => $values) {
            foreach ($values as $key => $val) {
                foreach ($val as $k => $v) {
                    $count[$keys.'_'.$key] = isset($count[$keys.'_'.$key]) ? $count[$keys.'_'.$key] + 1 : 1; 
                    $count[$keys] = isset($count[$keys]) ? $count[$keys] + 1 : 1; 
                   // $count[$keys.'_'.$k] = isset($count[$keys.'_'.$k]) ? $count[$keys.'_'.$k] + 1 : 1; 
                    $count[$keys.'_'.$key.'_'.$k] = isset($count[$keys.'_'.$key.'_'.$k]) ? $count[$keys.'_'.$key.'_'.$k] + 1 : 1; 
                }
            }
        }
       // dd($count);
        return $count;
    }
    function count4LevelArrays($arrays) {
        $count = [];
        foreach ($arrays as $keys => $values) {
            foreach ($values as $key => $val) {
                foreach ($val as $k => $v) {
                    foreach ($v as $k1 => $v1) {
                        $count[$keys] = isset($count[$keys]) ? $count[$keys] + 1 : 1; 
                        $count[$keys.'_'.$key] = isset($count[$keys.'_'.$key]) ? $count[$keys.'_'.$key] + 1 : 1; 
                       // $count[$keys.'_'.$k] = isset($count[$keys.'_'.$k]) ? $count[$keys.'_'.$k] + 1 : 1; 
                        $count[$keys.'_'.$key.'_'.$k] = isset($count[$keys.'_'.$key.'_'.$k]) ? $count[$keys.'_'.$key.'_'.$k] + 1 : 1;
                    }
                }
            }
        }
        //dd($count);
        return $count;
    }

    function count5LevelArrays($arrays) {
        $count = [];
        foreach ($arrays as $keys => $values) {
            foreach ($values as $key => $val) {
                foreach ($val as $k => $v) {
                    foreach ($v as $k1 => $v1) {
                        foreach ($v1 as $k2 => $v2) {
                            $count[$keys] = isset($count[$keys]) ? $count[$keys] + 1 : 1; 
                            $count[$keys.'_'.$key] = isset($count[$keys.'_'.$key]) ? $count[$keys.'_'.$key] + 1 : 1; 
                          //  $count[$keys.'_'.$k] = isset($count[$keys.'_'.$k]) ? $count[$keys.'_'.$k] + 1 : 1; 
                            $count[$keys.'_'.$key.'_'.$k] = isset($count[$keys.'_'.$key.'_'.$k]) ? $count[$keys.'_'.$key.'_'.$k] + 1 : 1;
                            $count[$keys.'_'.$key.'_'.$k.'_'. $k1] = isset($count[$keys.'_'.$key.'_'.$k.'_'. $k1]) ? $count[$keys.'_'.$key.'_'.$k.'_'. $k1] + 1 : 1;
                        }
                    }
                }
            }
        }
       //dd($count);
        return $count;
    }

    // function count5LevelArrays($arrays) {
    //     dd($arrays);
    //     $count = [];
    //     foreach ($arrays as $keys => $values) {
    //         foreach ($values as $key => $val) {
    //             foreach ($val as $k => $v) {
    //                 foreach ($v as $k1 => $v1) {
    //                     foreach ($v as $k2 => $v2) {
    //                         $count[$keys] = isset($count[$keys]) ? $count[$keys] + 1 : 1; 
    //                         $count[$keys.'_'.$key] = isset($count[$keys.'_'.$key]) ? $count[$keys.'_'.$key] + 1 : 1; 
    //                         $count[$keys.'_'.$k] = isset($count[$keys.'_'.$k]) ? $count[$keys.'_'.$k] + 1 : 1; 
    //                         $count[$keys.'_'.$k1] = isset($count[$keys.'_'.$k1]) ? $count[$keys.'_'.$k1] + 1 : 1;
    //                         $count[$keys.'_'.$key.'_'.$k] = isset($count[$keys.'_'.$key.'_'.$k]) ? $count[$keys.'_'.$key.'_'.$k] + 1 : 1;
    //                       //  $count[$keys.'_'.$k.'_'.$k1] = isset($count[$keys.'_'.$k.'_'.$k1]) ? $count[$keys.'_'.$k.'_'.$k1] + 1 : 1;
    //                         $count[$keys.'_'.$key.'_'.$k.'_'. $k1] = isset($count[$keys.'_'.$key.'_'.$k.'_'. $k1]) ? $count[$keys.'_'.$key.'_'.$k.'_'. $k1] + 1 : 1;

    //                     }
    //                 }
    //             }
    //         }
    //     }
    //     //dd($count);
    //     return $count;
    // }
    
    function scount5LevelArrays($arrays) {
        $count = [];
        foreach ($arrays as $keys => $values) {
            foreach ($values as $k2 => $val) {
                foreach ($val as $key => $vas ) {
                    foreach ($vas as $k => $v1) {
                        foreach ($v1 as $k1 => $va) {
                            $count[$keys] = isset($count[$keys]) ? $count[$keys] + 1 : 1; 
                            $count[$keys.'_'.$k2] = isset($count[$keys.'_'.$k2]) ? $count[$keys.'_'.$k2] + 1 : 1; 
                            $count[$keys.'_'.$key] = isset($count[$keys.'_'.$key]) ? $count[$keys.'_'.$key] + 1 : 1; 
                            $count[$keys.'_'.$k] = isset($count[$keys.'_'.$k]) ? $count[$keys.'_'.$k] + 1 : 1;

                            $count[$keys.'_'.$k2.'_'.$key.'_'.$k] = isset($count[$keys.'_'.$k2.'_'.$key.'_'.$k]) ? $count[$keys.'_'.$k2.'_'.$key.'_'.$k] + 1 : 1;

                            $count[$keys.'_'.$key.'_'.$k] = isset($count[$keys.'_'.$key.'_'.$k]) ? $count[$keys.'_'.$key.'_'.$k] + 1 : 1;
                        } 
                    }
                }
            }
        }
       // dd($count);
        return $count;
    }
    function getLastArrayBeforeKey($array) {
        //dd($array);
        $lastKey = array_key_last($array);
        $lastValue = $array[$lastKey];
        return count($lastValue);
    }

    public function getFilterConditions($report_id,$reportdetails){
        $roleid = (new user())->getCurrentUserRoleId();
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $roleid)->get()[0]->permissionprofileid;
        $Records = DB::table('rsoft_advanced_report_filter')
        ->join('rsoft_module_fields', 'rsoft_advanced_report_filter.fieldid', '=', 'rsoft_module_fields.id')
        ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
        ->join('rsoft_profile2tab', 'rsoft_modules.id', '=', 'rsoft_profile2tab.tabid')
        ->where('permission', 1)
        ->where('profileid',$profileid)
        ->where('report_id', $report_id)
        ->where('rsoft_module_fields.active', 1)
        ->where('rsoft_modules.status', 0)
        ->orderby('filter_id','ASC')
        ->get();
        $query='';
        foreach ($Records as $key => $value) { 
            $count = DB::table('rsoft_fieldmodulerel')->join('rsoft_module_fields', 'rsoft_fieldmodulerel.fieldid', '=', 'rsoft_module_fields.id')->where('rsoft_fieldmodulerel.module',$reportdetails[0]->name)->where('relmodule',$value->name)->where('rsoft_module_fields.active',1)->get();
            if(count($count) || $reportdetails[0]->name==$value->name){
                $fieldData = DB::select("SELECT field_type FROM rsoft_module_fields WHERE colname='".$value->coloumn_name."' AND  active=1");   
                if(count($fieldData)){
                    if( $query =='' && count($fieldData)){
                        $logic = ' ';
                    }else{
                        $logic = $value->logic;
                        if($value->logic=='NOT'){
                            $logic ='<>';
                            $logic ='AND';
                        }
                    }

                    $fieldtype = $value->field_type;

                    $signgeneratorarray = [];
                    $signgeneratorarray['columnname'] = $value->coloumn_name;

                    if ($fieldtype == 13 || $fieldtype == 14 || ($fieldtype == 15 && $value->coloumn_name == 'smownerid') || $fieldtype == 16 || $fieldtype == 17) {
                        $signgeneratorarray['columnname'] = 'rsoft_crmentity_'.trim($value->name_db).'.'.$value->coloumn_name;
                        $signgeneratorarray['fieldname'] = 'rsoft_user_'.trim($value->name_db).'_'.$value->coloumn_name;
                    }

                    $signgeneratorarray['comparator'] = $value->operator;
                    $signgeneratorarray['value'] = $value->value;
                    $signgeneratorarray['fieldtype'] = $fieldtype;
                    $signgeneratorarray['modulename'] = $reportdetails[0]->name;
                    $signgeneratorarray['condition'] = $value->logic;
                    $condition_signwithvalue = (new SignGenerator())->Gettingfilterconditionsign($signgeneratorarray);

                    if ($condition_signwithvalue['return_flag'] == 1 && ! empty($condition_signwithvalue['return_condition'])) {
                        $query.=$logic." (".$condition_signwithvalue['return_condition'].')';
                    } else {
                        $query = '';
                        break;
                    }
                    $query = '('.$query.') ';
                }
            }
        }
        return  $query;
    }

    public function getReportFilters($report_id,$reportdetails){
        $roleid = (new user())->getCurrentUserRoleId();
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $roleid)->get()[0]->permissionprofileid;
        $report_filter = DB::table('rsoft_advanced_report_filter')
        ->join('rsoft_module_fields', 'rsoft_advanced_report_filter.fieldid', '=', 'rsoft_module_fields.id')
        ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
        ->join('rsoft_profile2field', 'rsoft_module_fields.id', '=', 'rsoft_profile2field.fieldid')
        ->where('rsoft_profile2field.profileid', $profileid)
        ->where('report_id', $report_id)
        ->where('rsoft_module_fields.active', 1)
        ->select(
            'rsoft_advanced_report_filter.*',
            'rsoft_module_fields.*',
            'rsoft_modules.label as modulelabel',
             'rsoft_modules.name as modulename',
             'rsoft_profile2field.visible'
        )
        ->groupby('rsoft_advanced_report_filter.filter_id')
        ->orderby('filter_id','ASC')
        ->get();
        $timeformat = 'H:i:s';
        if ((new User())->getCurrentUserTimeFormat() == '12 hours') {
            $timeformat = 'h:i:s A';
        }
   
        $dateformat = (new User())->getCurrentUserDateFormat();
        $dateandtimeformat = $dateformat.' '.$timeformat;
        $report_filters=[];
        foreach($report_filter as $k =>$val){
            $count = DB::table('rsoft_fieldmodulerel')->join('rsoft_module_fields', 'rsoft_fieldmodulerel.fieldid', '=', 'rsoft_module_fields.id')->where('rsoft_fieldmodulerel.module',$reportdetails[0]->name)->where('relmodule',$val->modulename)->where('rsoft_module_fields.active',1)->get();
            if(count($count) || $reportdetails[0]->name==$val->modulename){     
                if(in_array($val->field_type,[3,9,29,30,31,21,23])){
                    $val->value=str_replace('#',',',$val->value);
                }
                else if(in_array($val->field_type,[13,14,15])){
                    if( $val->value !='' &&  $val->operator !='contains' &&  $val->operator !='doesnotcontains'){
                        $userids = explode('#', $val->value);
                        $UsersName = DB::table('rsoft_users')
                        ->select(DB::raw("
                            CASE 
                                WHEN TRIM(CONCAT(COALESCE(users_firstname, ''), ' ', COALESCE(users_lastname, ''))) = '' 
                                THEN CAST(id AS CHAR)
                                ELSE TRIM(CONCAT(COALESCE(users_firstname, ''), ' ', COALESCE(users_lastname, '')))
                            END as full_name
                        "))
                        ->where('rsoft_users.active', 1)
                        ->whereIn('id', $userids)
                        ->pluck('full_name');
                        $val->value = $UsersName->implode(',');
                    }
                }elseif(in_array($val->field_type,[16,17,19]) && $val->value !=''){
                    $Filteremptyconditionarray= (new FilterHelpers())->filteremptyvaluecon();
                    if(array_key_exists($val->operator,$Filteremptyconditionarray)){
                        $val->value =trim($val->value);
                    }elseif($val->operator != 'less_than_hours_before' && $val->operator != 'less_than_hours_later' && $val->operator != 'more_than_hours_before' && $val->operator != 'more_than_hours_later' && $val->operator != 'less_than_days_ago' && $val->operator != 'more_than_days_ago' &&  $val->operator != 'in_less_than' && $val->operator !='in_more_than' && $val->operator != 'daysago' && $val->operator != 'days_later')  {
                        $con_value="";$seperator=',';
                        $explodevalue=explode(',',trim($val->value));
                        
                        foreach($explodevalue as $k=>$v){
                            $conValue = (new User())->convertUserTimeZone($v,$dateandtimeformat,'Y-m-d H:i:s');
                            if($k>0) {
                                $con_value.=" ".$seperator." ".$conValue;
                            }else {
                                $con_value.= $conValue; 
                            }
                        }
                        $val->value= $con_value;
                    }elseif($val->operator == 'less_than_hours_before' || $val->operator == 'less_than_hours_later' || $val->operator == 'more_than_hours_before' || $val->operator == 'more_than_hours_later' || $val->operator == 'less_than_days_ago' || $val->operator == 'more_than_days_ago' ||  $val->operator == 'in_less_than' || $val->operator =='in_more_than' || $val->operator == 'daysago' || $val->operator == 'days_later')  {
                        $val->value =trim($val->value);
                    }else {
                        $val->value = (new User())->convertUserTimeZone(trim($val->value),$dateandtimeformat,'Y-m-d H:i:s');
                    }
                }elseif($val->field_type == 7 && $val->value !=''){
                    $Filteremptyconditionarray= (new FilterHelpers())->filteremptyvaluecon();
                    if(array_key_exists($val->operator,$Filteremptyconditionarray)){
                        $val->value =trim($val->value);
                    }elseif($val->operator != 'less_than_days_ago' && $val->operator!='more_than_days_ago' && $val->operator !='in_less_than' && $val->operator !='in_more_than' && $val->operator !='daysago' && $val->operator !='days_later') {
                        $con_value="";$seperator=',';
                        $explodevalue=explode(',',trim($val->value));
                        foreach($explodevalue as $k=>$v){
                            $datevalue  = (new User())->convertUserTimeZone($v,$dateformat,'Y-m-d'); 
                            if($k>0){
                                $con_value.= $seperator.$datevalue;
                            }else {
                                $con_value.= $datevalue;
                            }	
                        }
                        $val->value=$con_value;
                    }elseif($val->operator == 'less_than_days_ago' || $val->operator == 'more_than_days_ago' ||  $val->operator == 'in_less_than' || $val->operator =='in_more_than' || $val->operator == 'daysago' || $val->operator == 'days_later')  {
                        $val->value = trim($val->value);
                    }else {
                        $val->value = (new User())->convertUserTimeZone(trim($val->value),$dateformat,'Y-m-d');
                    }
                }elseif($val->field_type == 6){
                    $val->value ='No';
                    if($val->operator =='checked'){
                        $val->value ='Yes';
                    }
                }elseif($val->field_type == 20 && $val->value !=''){
                    $val->value = (new User())->convertUserTimeZone(trim($val->value),$timeformat, 'H:i:s');
                }
            
                $report_filters[]= $val;
            }
        }
        return  $report_filters;
    }
    public function DeleteReport($deletereportid,$deletemoduleid,$listviewmode)
    {
       $this->report_id='';
       DB::table('rsoft_advanced_report')->where('report_id', $deletereportid)->delete();
       $rows = DB::table('rsoft_advanced_report')->whereRaw("FIND_IN_SET(?, primarymodule)", [$deletereportid])->get();
        foreach ($rows as $row) {
            $modulesArray = explode(',', $row->primarymodule);
            $newModules = array_diff($modulesArray, [$deletereportid]);
            $newPrimarymodule = count($newModules) > 0 ? implode(',', $newModules) : null;
            DB::table('rsoft_advanced_report')->where('report_id', $row->report_id)->update(['primarymodule' => $newPrimarymodule]);
        }

       DB::table('rsoft_advanced_report_columns')->where('report_id', $deletereportid)->delete();
       DB::table('rsoft_advanced_report_groupbycolumns')->where('report_id', $deletereportid)->delete();
       DB::table('rsoft_advanced_report_groupbyrows')->where('report_id', $deletereportid)->delete();
       DB::table('rsoft_advanced_report_aggregatecolumns')->where('report_id', $deletereportid)->delete();
       DB::table('rsoft_advanced_report_schedule')->where('report_id', $deletereportid)->delete();
       DB::table('rsoft_advanced_report_sharing')->where('report_id', $deletereportid)->delete();
       DB::table('rsoft_advanced_report_filter')->where('report_id', $deletereportid)->delete();
       DB::table('rsoft_advanced_report_tablestyle')->where('report_id', $deletereportid)->delete();
       DB::table('rsoft_advanced_report_formula')->where('report_id', $deletereportid)->delete();
       DB::table('rsoft_advanced_report_chartconfigure')->where('report_id', $deletereportid)->delete();

        $this->page=0;
        $this->perPage=20;
        $this->allreportslist=[];
        $datacount=DB::table('rsoft_advanced_report')->where('primarymodule', $deletemoduleid)->count();
        if($datacount==0){
            $this->loadTableContent('All Reports');

       }else{
            $this->loadTableContent($listviewmode);
       }
        $this->emit('hideModal');
    }

    public function UpdateShareListOrder($sortedIDs)
    {

        $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
        foreach ($sortedIDs as $index => $report_id)
        {
            DB::table('rsoft_advanced_report_sharing')->where('report_id', $report_id)->update(['share_seq' => $index + 1, 'share_modifiedtime' => $datetime, 'share_modifiedby' => Auth::user()->id]);
        }
    }

    public function SharedReportDelete($deletereportid)
    {
    $userId = Auth::id(); 

       DB::table('rsoft_advanced_report_sharing')->where('report_id', $deletereportid)->delete();

       DB::table('rsoft_advanced_report_user_preferences')->where('report_id', $deletereportid)->delete();


       $this->UpdateModifiedInfo($deletereportid);
        $this->emit('hideModal');
    }


public function handleItemDropped($fieldid, $reportid, $mode, $moduleSelect)
{
    try {
        $isSpecialField = function($fieldName) {
            $specialFields = [
                'assignto' => 'smownerid',
                'createdby' => 'smcreatorid',
                'modifiedby' => 'modifiedby',
                'smownerid' => 'smownerid',
                'smcreatorid' => 'smcreatorid',
                'created_time' => 'created_time',
                'modified_time' => 'modified_time'
            ];
            return isset($specialFields[strtolower($fieldName)]) ? $specialFields[strtolower($fieldName)] : false;
        };

        if ($fieldid === 'comments') {
            $tablename = $this->getTableName($mode);
            $count = DB::table($tablename)->where('report_id', $reportid)->count() + 1;
    
            $formData = [
                'report_id' => $reportid,
                'columns_modulename' => 'comments', 
                'columns_moduleid' => 0, 
                'columns_fieldid' => 'comments', 
                'columns_coloumn_name' => 'comments', 
                'columns_coloumn_fieldtype' => 0, 
                'columns_coloumn_label_option' => 0,
                'columns_coloumn_label' => 'Comments', 
                'columns_seq' => $count,
            ];
    
            DB::table($tablename)->insertGetId($formData);
            $this->UpdateModifiedInfo($reportid); 
            return response()->json([
                'success' => true,
                'field_name' => 'Comments',
                'is_picklist' => false
            ]);
        }

        if (str_starts_with($fieldid, 'formula-')) {
            $tablename = $this->getTableName($mode);
            $formulaId = str_replace('formula-', '', $fieldid); 
            $count = DB::table($tablename)->where('report_id', $reportid)->count() + 1;
        
            $formulaLabel = DB::table('rsoft_advanced_report_formula') 
                ->where('formula_id', $formulaId)
                ->value('formula_label');
        
            if (!$formulaLabel) {
                return response()->json(['error' => 'Formula label not found for the provided formula ID'], 400);
            }
        
            $moduleId = DB::table('rsoft_advanced_report_formula') 
                ->where('formula_id', $formulaId) 
                ->value('module_id'); 
        
            if (!$moduleId) {
                return response()->json(['error' => 'Module ID not found for the provided formula ID'], 400);
            }
        
            $formData = [
                'report_id' => $reportid,
                'columns_modulename' => 'formulas',
                'columns_moduleid' => $moduleId, 
                'columns_fieldid' => $formulaId, 
                'columns_coloumn_name' => $formulaLabel, 
                'columns_coloumn_fieldtype' => 0, 
                'columns_coloumn_label_option' => 0,
                'columns_coloumn_label' => $formulaLabel, 
                'columns_isformula' => 1, 
                'columns_seq' => $count,
            ];
        
            DB::table($tablename)->insertGetId($formData);
            $this->UpdateModifiedInfo($reportid);
            return response()->json([
                'success' => true,
                'field_name' => $formulaLabel,
                'is_picklist' => false
            ]);
        }

        if (str_starts_with($fieldid, 'picklist-')) {
            $tablename = $this->getTableName($mode);
            $trackingId = (int) str_replace('picklist-', '', $fieldid);

            $existing = DB::table($tablename)
                ->where('report_id', $reportid)
                ->where('picklist_tracking_id', $trackingId)
                ->first();

            if ($existing) {
                return response()->json([
                    'error' => 'This picklist tracking field already exists in the report',
                    'field_name' => $existing->tracking_name ?? '',
                    'is_picklist' => true
                ], 400);
            }

            $picklistData = DB::table('rsoft_advanced_report_picklisttracking as pt')
                ->join('rsoft_module_fields as mf', 'pt.field_id', '=', 'mf.id')
                ->join('rsoft_modules as m', 'mf.module', '=', 'm.id')
                ->where('pt.tracking_id', $trackingId)
                ->where('pt.report_id', $reportid)
                ->where('pt.module_id', $this->module_id)
                ->select(
                    'pt.report_id',
                    'pt.tracking_id',
                    'pt.tracking_name',
                    'pt.module_id as groupbycolumns_moduleid',
                    'pt.field_id as groupbycolumns_fieldid',
                    'mf.colname as original_colname',
                    'mf.field_type as groupbycolumns_fieldtype',
                    'mf.label as module_field_label',
                    'm.name as groupbycolumns_modulename',
                    'm.name_db as module_name_db',
                    'm.label as module_label'
                )
                ->first();

            if (!$picklistData) {
                return response()->json([
                    'error' => "Picklist tracking data not found for ID: {$trackingId}",
                    'is_picklist' => true
                ], 400);
            }
          
            $colname = $isSpecialField($picklistData->original_colname) ?: $picklistData->original_colname;
            if ($isSpecialField($picklistData->original_colname)) {
                $colname = "rsoft_crmentity_{$picklistData->module_name_db}.{$colname}";
            }

            $count = DB::table($tablename)->where('report_id', $reportid)->count() + 1;

            if ($mode === 'groupbycolumns') {
                $formData = [
                    'report_id' => $reportid,
                    'groupbycolumns_moduleid' => $picklistData->groupbycolumns_moduleid,
                    'groupbycolumns_fieldid' => $picklistData->groupbycolumns_fieldid,
                    'groupbycolumns_coloumn_name' => $colname,
                    'groupbycolumns_fieldtype' => $picklistData->groupbycolumns_fieldtype,
                    'groupbycolumns_coloumn_label_option' => 0,
                    'groupbycolumns_coloumn_label' => $picklistData->module_field_label,
                    'groupbycolumns_seq' => $count,
                    'picklist_tracking_id' => $picklistData->tracking_id,
                    'groupbycolumns_modulename' => $picklistData->groupbycolumns_modulename,
                    'column_type' => 'picklist_tracking',
                ];
                $id = DB::table($tablename)->insertGetId($formData);
            } elseif ($mode === 'groupbyrows') {
                $formData = [
                    'report_id' => $reportid,
                    'groupbyrows_moduleid' => $picklistData->groupbycolumns_moduleid,
                    'groupbyrows_fieldid' => $picklistData->groupbycolumns_fieldid,
                    'groupbyrows_coloumn_name' => $colname,
                    'groupbyrows_fieldtype' => $picklistData->groupbycolumns_fieldtype,
                    'groupbyrows_coloumn_label_option' => 0,
                    'groupbyrows_coloumn_label' => $picklistData->module_field_label,
                    'groupbyrows_seq' => $count,
                    'picklist_tracking_id' => $picklistData->tracking_id,
                    'groupbyrows_modulename' => $picklistData->groupbycolumns_modulename,
                    'column_type' => 'picklist_tracking',
                ];
                $id = DB::table($tablename)->insertGetId($formData);
            } elseif ($mode === 'aggregatecolumns') {
                $formData = [
                    'report_id' => $reportid,
                    'aggregatecolumns_moduleid' => $picklistData->groupbycolumns_moduleid,
                    'aggregatecolumns_fieldid' => $picklistData->groupbycolumns_fieldid,
                    'aggregatecolumns_coloumn_name' => $colname,
                    'aggregatecolumns_fieldtype' => $picklistData->groupbycolumns_fieldtype,
                    'aggregatecolumns_coloumn_label_option' => 0,
                    'aggregatecolumns_coloumn_label' => $picklistData->module_field_label,
                    'aggregatecolumns_seq' => $count,
                    'picklist_tracking_id' => $picklistData->tracking_id,
                    'aggregatecolumns_modulename' => $picklistData->groupbycolumns_modulename,
                    'aggregatecolumns_calculation_type' => 'picklist_tracking',
                    'column_type' => 'picklist_tracking',
                ];
                $id = DB::table($tablename)->insertGetId($formData);
            } else {
                return response()->json([
                    'error' => "Invalid mode for picklist drop: {$mode}",
                    'is_picklist' => true
                ], 400);
            }

            $this->UpdateModifiedInfo($reportid);
            return response()->json([
                'success' => true,
                'field_name' => $picklistData->tracking_name,
                'is_picklist' => true,
                'tracking_id' => $picklistData->tracking_id
            ]);
        }

        if ((int)($fieldid) && $fieldid != '') {
            $tablename = $this->getTableName($mode);
            $count = DB::table($tablename)->where('report_id', $reportid)->count() + 1;
    
            $field = DB::table('rsoft_module_fields')->where('id', $fieldid)->first();
            if ($field) {
                $module = DB::table('rsoft_modules')->where('id', $field->module)->first();
                $colname = $field->colname;
    
                if ($field->crmentityfields == 1) {
                    $colname = 'rsoft_crmentity_' . $module->name_db . '.' . $field->colname;
                }
    
               // In the normal field handling section, modify the duplicate check like this:
                $existing = DB::table($tablename)
                    ->where('report_id', $reportid)
                    ->where(function($query) use ($fieldid, $mode) {
                        if ($mode == 'columns') {
                            $query->where('columns_fieldid', $fieldid);
                        } elseif ($mode == 'groupbycolumns') {
                            $query->where('groupbycolumns_fieldid', $fieldid);
                        } elseif ($mode == 'groupbyrows') {
                            $query->where('groupbyrows_fieldid', $fieldid);
                        } elseif ($mode == 'aggregatecolumns') {
                                            $query->where('aggregatecolumns_fieldid', $fieldid)
                                                ->whereNull('picklist_tracking_id');
                                        }
                                    })
                    ->first();

                if ($existing) {
                    return response()->json([
                        'error' => 'This field already exists in the report',
                        'field_name' => $field->label,
                        'is_picklist' => false
                    ], 400);
                }

                $responseData = [
                    'success' => true,
                    'field_name' => $field->label,
                    'is_picklist' => false,
                    'field_id' => $fieldid
                ];

                if ($mode == 'columns') {
                    $formData = [
                        'report_id' => $reportid,
                        'columns_modulename' => $module->name,
                        'columns_moduleid' => $field->module,
                        'columns_fieldid' => $fieldid,
                        'columns_coloumn_name' => $colname,
                        'columns_coloumn_fieldtype' => $field->field_type,
                        'columns_coloumn_label_option' => 0,
                        'columns_coloumn_label' => $field->label,
                        'columns_seq' => $count,
                    ];
                    DB::table($tablename)->insertGetId($formData);
                } elseif ($mode == 'groupbycolumns') {
                    $formData = [
                        'report_id' => $reportid,
                        'groupbycolumns_modulename' => $module->name,
                        'groupbycolumns_moduleid' => $field->module,
                        'groupbycolumns_fieldid' => $fieldid,
                        'groupbycolumns_coloumn_name' => $colname,
                        'groupbycolumns_fieldtype' => $field->field_type,
                        'groupbycolumns_coloumn_label_option' => 0,
                        'groupbycolumns_coloumn_label' => $field->label,
                        'groupbycolumns_seq' => $count,
                        'column_type' => NULL,
                    ];
                    DB::table($tablename)->insertGetId($formData);
                } elseif ($mode == 'groupbyrows') {
                    $formData = [
                        'report_id' => $reportid,
                        'groupbyrows_modulename' => $module->name,
                        'groupbyrows_moduleid' => $field->module,
                        'groupbyrows_fieldid' => $fieldid,
                        'groupbyrows_coloumn_name' => $colname,
                        'groupbyrows_fieldtype' => $field->field_type,
                        'groupbyrows_coloumn_label_option' => 0,
                        'groupbyrows_coloumn_label' => $field->label,
                        'groupbyrows_seq' => $count,
                        'column_type' => NULL,
                    ];
                    DB::table($tablename)->insertGetId($formData);
                } elseif ($mode == 'aggregatecolumns') {
                    $formData = [
                        'report_id' => $reportid,
                        'aggregatecolumns_modulename' => $module->name,
                        'aggregatecolumns_moduleid' => $field->module,
                        'aggregatecolumns_fieldid' => $fieldid,
                        'aggregatecolumns_coloumn_name' => $colname,
                        'aggregatecolumns_fieldtype' => $field->field_type,
                        'aggregatecolumns_coloumn_label_option' => 0,
                        'aggregatecolumns_coloumn_label' => $field->label,
                        'aggregatecolumns_calculation_type' => '', 
                        'aggregatecolumns_seq' => $count,
                        'column_type' => NULL,
                    ];
                    DB::table($tablename)->insertGetId($formData);
                }               
                $this->UpdateModifiedInfo($reportid); 
                return response()->json($responseData);
            }
        }
    
        $this->moduleSelect = $moduleSelect;
        $this->loadTableContent('EditReport', $this->moduleSelect, $reportid);
        return response()->json([
            'success' => true,
            'field_name' => '',
            'is_picklist' => false
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'error' => $e->getMessage(),
            'success' => false,
            'is_picklist' => false
        ], 500);
    }
}


public function BuilderUpdateOrder($mode,$report_id,$sortedIDs){
        if($mode=='columns'){
            foreach ($sortedIDs as $index => $primaryid) {
                DB::table('rsoft_advanced_report_columns')->where('columns_id', $primaryid)->update(['columns_seq' => $index + 1]);
            }
        }elseif($mode=='groupbycolumns'){
            foreach ($sortedIDs as $index => $primaryid) {
                DB::table('rsoft_advanced_report_groupbycolumns')->where('groupbycolumns_id', $primaryid)->update(['groupbycolumns_seq' => $index + 1]);
            }
        }elseif($mode=='groupbyrows'){
            foreach ($sortedIDs as $index => $primaryid) {
                DB::table('rsoft_advanced_report_groupbyrows')->where('groupbyrows_id', $primaryid)->update(['groupbyrows_seq' => $index + 1]);
            }
        }elseif($mode=='aggregatecolumns'){
            foreach ($sortedIDs as $index => $primaryid) {
                DB::table('rsoft_advanced_report_aggregatecolumns')->where('aggregatecolumns_id', $primaryid)->update(['aggregatecolumns_seq' => $index + 1]);
            }
        }
        $this->UpdateModifiedInfo($report_id);
    }

public function removeReportItem($reportid, $id, $mode, $moduleSelect)
{
    $removedFieldId = null;
    if ($mode == 'columns') {
        DB::table('rsoft_advanced_report_columns')->where('report_id', $reportid)->where('columns_id', $id)->delete();
        $datacount = DB::table('rsoft_advanced_report_columns')->where('report_id', $reportid)->count();
        if ($datacount == 0) {
            DB::table('rsoft_advanced_report')->where('report_id', $reportid)->update(['expand_detail_rows' => 0]);
        }
    } elseif ($mode == 'groupbycolumns') {
        $removedFieldId = DB::table('rsoft_advanced_report_groupbycolumns')
            ->where('report_id', $reportid)
            ->where('groupbycolumns_id', $id)
            ->value('groupbycolumns_fieldid');
        DB::table('rsoft_advanced_report_groupbycolumns')->where('report_id', $reportid)->where('groupbycolumns_id', $id)->delete();

      
        if ($removedFieldId) {
            $report = DB::table('rsoft_advanced_report')->where('report_id', $reportid)->first();
            if ($report->group_sort) {
                $groupSort = json_decode($report->group_sort, true) ?? [];
                $updatedGroupSort = array_filter($groupSort, function ($item) use ($removedFieldId) {
                    return $item['field_id'] != $removedFieldId;
                });
                DB::table('rsoft_advanced_report')
                    ->where('report_id', $reportid)
                    ->update(['group_sort' => json_encode(array_values($updatedGroupSort))]);
                DB::table('mis_report_table')
                    ->where('id', $reportid)
                    ->update(['mis_group_sort' => json_encode(array_values($updatedGroupSort))]);
            }
        }
    } elseif ($mode == 'groupbyrows') {
        $removedFieldId = DB::table('rsoft_advanced_report_groupbyrows')
            ->where('report_id', $reportid)
            ->where('groupbyrows_id', $id)
            ->value('groupbyrows_fieldid');
        DB::table('rsoft_advanced_report_groupbyrows')->where('report_id', $reportid)->where('groupbyrows_id', $id)->delete();
        $datacount = DB::table('rsoft_advanced_report_groupbyrows')->where('report_id', $reportid)->count();
        if ($datacount == 0) {
            DB::table('rsoft_advanced_report_groupbycolumns')->where('report_id', $reportid)->delete();
        }
        if ($datacount == 1) {
            DB::table('rsoft_advanced_report')->where('report_id', $reportid)->update(['expand_sub_total' => 0]);
        }

       
        if ($removedFieldId) {
            $report = DB::table('rsoft_advanced_report')->where('report_id', $reportid)->first();
            if ($report && $report->group_sort) {
                $groupSort = json_decode($report->group_sort, true) ?? [];
                $updatedGroupSort = array_filter($groupSort, function ($item) use ($removedFieldId) {
                    return $item['field_id'] != $removedFieldId;
                });
                DB::table('rsoft_advanced_report')
                    ->where('report_id', $reportid)
                    ->update(['group_sort' => json_encode(array_values($updatedGroupSort))]);
                DB::table('mis_report_table')
                    ->where('id', $reportid)
                    ->update(['mis_group_sort' => json_encode(array_values($updatedGroupSort))]);
            }
        }
    } elseif ($mode == 'aggregatecolumns') {
        DB::table('rsoft_advanced_report_aggregatecolumns')->where('report_id', $reportid)->where('aggregatecolumns_id', $id)->delete();
        $datacount = DB::table('rsoft_advanced_report_aggregatecolumns')->where('report_id', $reportid)->count();
        if ($datacount == 0) {
            DB::table('rsoft_advanced_report')->where('report_id', $reportid)->update(['expand_group_count' => 1]);
        }
    }
    $this->UpdateModifiedInfo($reportid);
    $this->moduleSelect = $moduleSelect;
    $this->loadTableContent('EditReport', $this->moduleSelect, $reportid);
    if ($removedFieldId) {
    
        $report = DB::table('rsoft_advanced_report')->where('report_id', $reportid)->first();
        $misreport = DB::table('mis_report_table')->where('report_id',$this->misCurrentReportId)->where('id', $reportid)->first();
        $updatedSortedFields = $report ? json_decode( $this->pagemode === 'MISPreview'? ($misreport->mis_group_sort): ($report->group_sort),true) : [];
        $this->emit('sortFieldsUpdated', $updatedSortedFields);
        $this->emit('fieldRemovedFromGroupBy', $mode, $removedFieldId);
    }
}
    public function SaveCalculationType($value,$report_id,$aggregatecolumns_id){
        DB::table('rsoft_advanced_report_aggregatecolumns')->where('aggregatecolumns_id', $aggregatecolumns_id)->update(['aggregatecolumns_calculation_type'=>$value]);
        $this->UpdateModifiedInfo($report_id);
    }

    public function SaveCommentsType($value,$report_id,$columns_id){
        DB::table('rsoft_advanced_report_columns')->where('columns_id', $columns_id)->update(['columns_comments'=>$value]);
        $this->UpdateModifiedInfo($report_id);
    }

    public function UpdateModifiedInfo($report_id){
        $datetime = (new User())->getCurrentTimeUTC('Y-m-d H:i:s');
        DB::table('rsoft_advanced_report')->where('report_id', $report_id)->update(['modifiedtime'=> $datetime,'modifiedby'=>Auth::user()->id]);
    }

    public function getTableName($mode)
    {
        if($mode=='columns'){
            $tablename='rsoft_advanced_report_columns';
        }elseif($mode=='groupbycolumns'){
            $tablename='rsoft_advanced_report_groupbycolumns';
        }elseif($mode=='groupbyrows'){
            $tablename='rsoft_advanced_report_groupbyrows';
        }elseif($mode=='aggregatecolumns'){
            $tablename='rsoft_advanced_report_aggregatecolumns';
        }
        return  $tablename;
    }


    function getSchduleListRecord(){
        $userid = Auth::user()->id;
        $roleid = Auth::user()->users_roles;
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $roleid)->get()[0]->permissionprofileid;
        $schduledmodulelist = DB::table('rsoft_advanced_report')
            ->join('rsoft_modules', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_modules.id')
            ->join('rsoft_advanced_report_schedule', 'rsoft_advanced_report.report_id', '=', 'rsoft_advanced_report_schedule.report_id')
            ->join('rsoft_profile2tab', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_profile2tab.tabid')
            ->groupBy('rsoft_advanced_report.report_id')
            ->orderBy('rsoft_advanced_report_schedule.schedule_seq')
            ->when($userid != '1', function($query) use ($userid, $roleid) {
                $query->where(function($query) use ($userid, $roleid) {
                    $query->where('schedule_createdby',$userid);
                });
            })
            ->where('rsoft_modules.status', 0)
            ->where('profileid', $profileid)
            ->where('permission', 1)
            ->get();
        
        $schdulelist = [];
        $reportIds = $schduledmodulelist->pluck('report_id')->all();
        
        $allSchedules = DB::table('rsoft_advanced_report')
            ->join('rsoft_modules', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_modules.id')
            ->join('rsoft_profile2tab', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_profile2tab.tabid')
            ->where('rsoft_modules.status', 0)
            ->where('profileid', $profileid)
            ->where('permission', 1)
            ->where('rsoft_advanced_report.report_moduletype', '!=', 'MISReport')
            ->whereIn('report_id', DB::table('rsoft_advanced_report_schedule')
                ->select('report_id')
                ->distinct()
                 ->when($userid != '1', function($query) use ($userid, $roleid) {
                    $query->where(function($query) use ($userid, $roleid) {
                        $query->where('schedule_createdby',$userid);
                    });
                })
                ->get()
                ->pluck('report_id')
                ->all())
            ->groupBy('rsoft_advanced_report.report_id')
            ->get();
        foreach ($allSchedules as $key => $value) {
            $scheduledata = DB::table('rsoft_advanced_report_schedule')
                ->join('rsoft_modules', 'rsoft_advanced_report_schedule.module_id', '=', 'rsoft_modules.id')
                ->where('report_id', $value->report_id)
                ->when($userid != '1', function($query) use ($userid, $roleid) {
                    $query->where(function($query) use ($userid, $roleid) {
                        $query->where('schedule_createdby',$userid);
                    });
                })
                ->where('rsoft_modules.status', 0)
                ->get();
            
            $schedulestatus = DB::table('rsoft_advanced_report_schedule')
                ->join('rsoft_modules', 'rsoft_advanced_report_schedule.module_id', '=', 'rsoft_modules.id')
                ->where('report_id', $value->report_id)
                ->when($userid != '1', function($query) use ($userid, $roleid) {
                    $query->where(function($query) use ($userid, $roleid) {
                        $query->where('schedule_createdby',$userid);
                    });
                })
                ->where('schedule_status', 1)
                ->where('rsoft_modules.status', 0)
                ->get();
            
            $schdulelist[$key]['report_name'] = $value->report_name;
            $schdulelist[$key]['primarymodule'] = $value->primarymodule;
            $schdulelist[$key]['report_id'] = $value->report_id;
            $schdulelist[$key]['schdule_count'] = count($scheduledata);
            $schdulelist[$key]['schdule_status'] = count($schedulestatus);
            $schdulelist[$key]['schdule_data'] = $scheduledata;
        }
        
        return $schdulelist;
    }

    function getShareListRecord(){
        $userid=Auth::user()->id;
        $roleid = Auth::user()->users_roles;
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $roleid)->get()[0]->permissionprofileid;
        $sharinglist = DB::table('rsoft_advanced_report_sharing')
            ->join('rsoft_advanced_report', 'rsoft_advanced_report_sharing.report_id', '=', 'rsoft_advanced_report.report_id')
            ->whereNotNull('share_report_type')
            ->where('share_createdby', $userid)
            ->select(
            'rsoft_advanced_report_sharing.*',
            'rsoft_advanced_report.report_name',
            'rsoft_advanced_report.smcreatorid',
            'rsoft_advanced_report.modifiedby',
            'rsoft_advanced_report.createdtime',
            'rsoft_advanced_report.modifiedtime'
            )
            ->get();

        $mergedList = DB::table('rsoft_advanced_report')->join('rsoft_modules', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_modules.id')->join('rsoft_advanced_report_sharing', 'rsoft_advanced_report.report_id', '=', 'rsoft_advanced_report_sharing.report_id') ->join('rsoft_profile2tab', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_profile2tab.tabid')->groupBy('rsoft_advanced_report.report_id')->orderBy('rsoft_advanced_report_sharing.share_seq')
         ->when($userid != '1', function($query) use ($userid, $roleid) {
            $query->where(function($query) use ($userid, $roleid) {
                $query->where('share_createdby',$userid);
            });
        })
        ->where('rsoft_modules.status',0)->where('profileid',$profileid)->where('permission',1)->get();

        // $sharemodulelist = $sharinglist->merge($mergedList);
        $sharemodulelist = $sharinglist->merge($mergedList)->unique('report_id')->values();

        $sharelist = [];
        foreach ($sharemodulelist as $key => $value)
        {   
            // $checkuser=1;
            // if($value->share_type=='private'){
            //     if($value->share_width=='users'){
            //         $checkuser=DB::table('rsoft_users')->where('id',$value->share_width_user)->where('active',1)->count();
            //     }
            // }
           // if($checkuser==1){
                $getallreport=DB::table('rsoft_advanced_report_sharing')->join('rsoft_modules','rsoft_advanced_report_sharing.module_id','=','rsoft_modules.id')->where('report_id',$value->report_id)->where('rsoft_modules.status',0)->get();
                $sharemisreport = DB::table('rsoft_advanced_report_sharing')->where('share_report_type', 'MISReports')->where('report_id', $value->report_id)->get();
                $sharedata = $sharemisreport->merge($getallreport);
                $sharelist[$key]['report_name']=$value->report_name;
                $sharelist[$key]['primarymodule'] = isset($value->primarymodule) ? $value->primarymodule : null;
                $sharelist[$key]['report_id'] = $value->report_id;
                $sharelist[$key]['description']=isset($value->description) ? $value->description : null;
                $sharelist[$key]['label']=isset($value->label) ? $value->label : null;
                $sharelist[$key]['createdtime']=$value->createdtime;
                $sharelist[$key]['smcreatorid']=$value->smcreatorid;
                $sharelist[$key]['modifiedtime']=$value->modifiedtime;
                $sharelist[$key]['modifiedby']=$value->modifiedby;
                $sharelist[$key]['report_id']=$value->report_id;
                $sharelist[$key]['module_id']=$value->module_id;
                $sharelist[$key]['share_count']=count( $sharedata);
                $sharelist[$key]['share_data']=$sharedata;
           // }
        }
        return $sharelist;
    }

    function getTablestyle($tablestyle){
        $data=[];
        $tablestyle=$tablestyle[0];
        $hfont_color=$tablestyle->table_header_color;
        $hfont_family=$tablestyle->table_header_font;
        $hfont_size=$tablestyle->table_header_size.'px';
        $hcell_color=$tablestyle->table_header_cell_color;
        $hbtag=$hutag=$hitag='';
        if($tablestyle->table_header_b==1){
            $hbtag='font-weight: bold;';
        }
        if($tablestyle->table_header_u==1){
            $hutag='text-decoration: underline;';
        }
        if($tablestyle->table_header_i==1){
            $hitag='font-style: italic;';
        }
        $data['hstyle']='color:'.$hfont_color.';font-size:'.$hfont_size.';font-family:'. $hfont_family.';background-color:'.$hcell_color.'; position: sticky; top: 0; z-index: 1; height:25px; padding: 10px; box-sizing: border-box;width:15%; width: 200px;'.$hbtag.''.$hutag.''.$hitag.'';
        $data['pdfhstyle']='color:'.$hfont_color.';font-size:'.$hfont_size.';font-family:'. $hfont_family.';background-color:'.$hcell_color.';'.$hbtag.''.$hutag.''.$hitag.'';
     
        $ffont_color=$tablestyle->table_footer_color;
        $ffont_family=$tablestyle->table_footer_font;
        $ffont_size=$tablestyle->table_footer_size.'px';
        $fcell_color=$tablestyle->table_footer_cell_color;
        $fbtag=$futag=$fitag='';
        if($tablestyle->table_footer_b==1){
            $fbtag='font-weight: bold;';
        }
        if($tablestyle->table_footer_u==1){
            $futag='text-decoration: underline;';
        }
        if($tablestyle->table_footer_i==1){
            $fitag='font-style: italic;';
        }
        $data['fstyle']='color:'.$ffont_color.';font-size:'.$ffont_size.';font-family:'. $ffont_family.';background-color:'.$fcell_color.'; position: sticky; top: 0; z-index: 1; height:25px; padding: 10px; box-sizing: border-box;width:15%; width: 200px;'.$fbtag.''.$futag.''.$fitag.'';
        $data['pdffstyle']='color:'.$ffont_color.';font-size:'.$ffont_size.';font-family:'. $ffont_family.';background-color:'.$fcell_color.'; '.$fbtag.''.$futag.''.$fitag.'';

        $bfont_color=$tablestyle->table_label_color;
        $bfont_family=$tablestyle->table_label_font;
        $bfont_size=$tablestyle->table_label_size.'px';
        $bbtag=$butag=$bitag='';
       
        $data['bstyle']='color:'.$bfont_color.';font-size:'.$bfont_size.';font-family:'. $bfont_family.'; position: sticky; top: 0; z-index: 1; height:25px; padding: 10px; box-sizing: border-box;width:15%; width: 200px;'.$bbtag.''.$butag.''.$bitag.'';
        $data['pdfbstyle']='color:'.$bfont_color.';font-size:'.$bfont_size.';font-family:'. $bfont_family.';'.$bbtag.''.$butag.''.$bitag.'';
        $tborder_color=$tablestyle->table_border_color;
        $tborder_design=$tablestyle->table_border_design;


        if($tborder_design=='All Borders'){
           $class='all-borders';
        }else if($tborder_design=='Bottom Borders'){
           $class='bottom-borders';
        }else if($tborder_design=='Inner Borders'){
           $class='inner-borders';
        }else if($tborder_design=='Outer Borders'){
            $class='outer-borders';
        }else if($tborder_design=='Left Borders'){
           $class='left-borders';
        }else if($tborder_design=='Right Borders'){
           $class='right-borders';
        }else{
           $class='no-borders';
        }

        $data['tstyle']=$class;
        $data['oddrowcolor'] = $tablestyle->table_odd_row_color;
        $data['evenrowcolor'] = $tablestyle->table_even_row_color;
        $data['tborder_color']= $tborder_color;
        return  $data;
    }

    function getThemeColor(){
        $themeColor = '#000'; 
    
        switch (Auth::user()->users_theme) {
       
            case 'bg-gradient-x-purple-blue':
                $themeColor = '#9f78ff';
                break;
            case 'bg-gradient-x-purple-red':
                $themeColor = '#a376fc';
                break;
            case 'bg-gradient-x-blue-green':
                $themeColor = '#00cef9';
                break;
            case 'bg-gradient-x-orange-yellow':
                $themeColor = '#fd9c40';
                break;
            case 'bg-gradient-x-blue-cyan':
                $themeColor = '#514b9e';
                break;
            case 'bg-gradient-x-red-pink':
                $themeColor = '#ff5858';
                break;
            case 'bg-primary':
                 $themeColor = '#6967ce';
                break;
                 case 'bg-info':
                 $themeColor = '#28afd0';
                break;
                 case 'bg-danger':
                 $themeColor = '#fa626b';
                break;
                 case 'bg-blue':
                 $themeColor = '#28afd0';
                break;
                 case 'bg-warning':
                 $themeColor = '#fdb901';
                break;
                 case 'bg-success':
                 $themeColor = '#5ed84f';
                break;
        }
        return  $themeColor;
    }



    public function getUserFormatValues($fieldtype,$modulevalues,$Recordid='',$colname=''){
		$result='';
            if ($fieldtype == 3) {
                if(is_array($modulevalues)){
                    $modulevaluess='';
                    $coma='';
                    foreach($modulevalues as $key => $value){
                        if($key !=0){
                            $coma=',';
                        }
                        $modulevaluess .=$coma.''.$modulevalues[$key];
                    }
                    $result=$modulevaluess;
                }else{
                    $multival=explode("|#|",$modulevalues);
                    $result = implode(',',$multival);
                }
            }elseif ($fieldtype == 5) {
                $result =  $modulevalues;
            }elseif ($fieldtype == 6) {
                if ($modulevalues == 1) {
                    $result = 'Yes';
                } elseif ($modulevalues == '') {
                    $result = '';
                }else{
                    $result = 'No';
                }   
            }elseif ($fieldtype == 26) {
                    $result=$modulevalues;	
            }elseif ($fieldtype == 11) {
                $viewcolom='';
                if($modulevalues !=''){
                    $viewcolom = $this->getRelatedModuleViewColom($Recordid,$colname);
                }
                if($viewcolom==''){
                    $viewcolom=$Recordid;
                }
                $result = $viewcolom;
            }elseif ($fieldtype == 12) {
                $colvalue='';			
                if($modulevalues !=''){
                    $imagepath = (new Attachment())->GettingAttachments($modulevalues);
                    foreach($imagepath as $key =>$val){
                        $imgexplode=explode('.',$val['name']);
                        $imgextension=strtolower(end($imgexplode));
                        if($imgextension=='jpg' || $imgextension=='png' || $imgextension=='jpeg'){
                            //$colvalue.='<p><img alt="" src="'.$val['name'].'"/></p>';
                            $imgpath=explode('/',$val['name']);
                            $colvalue.=end($imgpath);
                            if(count($imagepath)-1 >$key){
                                $colvalue.=', ';
                            }
                        }else{
                            $imgpath=explode('/',$val['name']);
                            $colvalue.=end($imgpath);
                            if(count($imagepath)-1 >$key){
                                $colvalue.=', ';
                            }
                        }
                    }
                }
                
                $result = $colvalue;
            }elseif($fieldtype == 25){
                $array['value'] = $modulevalues;
                $result = (new ModuleFieldTypes())->dispalyingCurrencyFormat($array);
            }elseif($fieldtype == 7){
                $dateformat=(new User())->getCurrentUserDateFormat();
                $result = '';
                if($modulevalues !=''){
                    $result = (new User())->convertUserTimeZone($modulevalues,$dateformat,'Y-m-d');
                }
            }elseif($fieldtype == 16 || $fieldtype == 17 || $fieldtype == 19){
                $timeformat ="H:i:s";
                $dateformat=(new User())->getCurrentUserDateFormat();
                $timeformatcheck=(new User())->getCurrentUserTimeFormat();
                if($timeformatcheck=='12 hours') {
                    $timeformat = "h:i:s A";
                }
                $result = '';
                if($modulevalues !=''){
                    $datetimeformat=$dateformat." ".$timeformat;
                    $result = (new User())->convertUserTimeZone($modulevalues,$datetimeformat,'Y-m-d H:i:s');
                }
            }elseif($fieldtype == 20){
                $timeformatcheck=(new User())->getCurrentUserTimeFormat();
                $timeformat =" H:i:s";
                if($timeformatcheck=='12 hours'){
                    $timeformat = "h:i:s A";
                }
                $result = '';
                if($modulevalues !=''){
                    $result = (new User())->convertUserTimeZone($modulevalues,$timeformat,'H:i:s');
                }
            }elseif ($fieldtype == 13 || $fieldtype == 14 || $fieldtype == 15) {
                $Recordusername='';
                if($modulevalues!=''){
                    $UserName = DB::select("SELECT users_firstname,users_lastname FROM rsoft_users  WHERE id='".$modulevalues."'");
                    if(count($UserName)){                
                        $Recordusername=$UserName[0]->users_firstname.' '.$UserName[0]->users_lastname;
                    }
                }
                $result = $Recordusername;
            }elseif ($fieldtype == 24) {
                $result=(string) $modulevalues;
            }elseif ($fieldtype == 9 || $fieldtype == 29 || $fieldtype == 30 || $fieldtype == 31 ) {
                if($modulevalues!=''){
                    $result = str_replace("\xc2\xa0",' ',$modulevalues);
                }
            }else{
                $result = $modulevalues;
            } 
		return $result;
	}

    public function getRelatedModuleViewColom($recordid,$colname)
    {
            $data='';
            $crmdata = DB::Select("SELECT * FROM rsoft_crmentity inner join rsoft_modules on rsoft_crmentity.module_name=rsoft_modules.name  WHERE crmid='".trim($recordid)."' AND deleted=0");
            if(count($crmdata)){
                $RelatedModule = (new QuickCreate())->GettingRelatedValues($crmdata[0]->module_name, $recordid);
                if (!empty($RelatedModule)) {
                    if($RelatedModule['name']!=""){
                        $GetRel_Uitype = DB::table('rsoft_module_fields')->where('colname',  $crmdata[0]->view_col)->get();
                        $timeformat = 'H:i:s';
                        if ($GetRel_Uitype[0]->field_type == 7) {
                            $dateformat = Auth::user()->users_dateformat;
                            if($RelatedModule['name'] !=''){
                                $RelatedModule['name'] = (new User())->convertUserTimeZone($RelatedModule['name'],$dateformat,'Y-m-d');
                            }else{
                                    $RelatedModule['name'] = '';
                            }
                        } elseif ($GetRel_Uitype[0]->field_type == 16 || $GetRel_Uitype[0]->field_type == 17 || $GetRel_Uitype[0]->field_type == 19) {
                            if (Auth::user()->users_timeformat == '12 hours') {
                                $timeformat = 'h:i:s A';
                            }
                            $timeformat = Auth::user()->users_dateformat.' '.$timeformat;
                            $RelatedModule['name'] = (new User())->convertUserTimeZone($RelatedModule['name'],$timeformat,'Y-m-d H:i:s');
                        } elseif ($GetRel_Uitype[0]->field_type == 20) {
                            if (Auth::user()->users_timeformat == '12 hours') {
                                $timeformat = 'h:i:s A';
                            }
                            $RelatedModule['name'] = (new User())->convertUserTimeZone($RelatedModule['name'],$timeformat,'H:i:s');
                        } elseif ($GetRel_Uitype[0]->field_type == 25) {
                            $arr['value'] = $RelatedModule['name'];
                            $RelatedModule['name'] = (new ModuleFieldTypes())->dispalyingCurrencyFormat($arr);
                        }elseif ($GetRel_Uitype[0]->colname == 'users_roles') {
                            $Userrole=DB::table('rsoft_role')->where('roleid',$RelatedModule['name'])->pluck('rolename')->toarray()[0];
                            $RelatedModule['name'] = $Userrole;
                        }elseif ($GetRel_Uitype[0]->colname == 'users_dateformat') {
                            if($RelatedModule['name'] == 'Y-m-d'){
                                $formatValue = 'YY-MM-DD';
                            }else if($RelatedModule['name'] == 'd-m-Y'){
                                $formatValue = 'DD-MM-YY';
                            }else if($RelatedModule['name'] == 'm-d-Y'){
                                $formatValue = 'MM-DD-YY';
                            }
                            $RelatedModule['name'] = $formatValue;
                        }
                    }else{
                        $RelatedModule['name']=$RelatedModule['id'];
                    }
                    $data=$RelatedModule['name'];
                }
            }
        return  $data;
    }

    public function getUSerProfilePermissions($modulename=''){
        $profilepermissions=[];
        $cur_user_role = Auth::user()->users_roles;
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $cur_user_role)->get()[0]->permissionprofileid;;
        if($modulename !=''){
            $module = DB::table('rsoft_modules')->where('name', '=',$modulename)->get(); 
            $stand_permission = DB::table('rsoft_profile2standardpermissions')->select('operation', 'permissions')->where('profileid', '=', $profileid)->where('tabid', '=', $module[0]->id)->get();
            foreach ($stand_permission as $per) {
                if ($per->operation == 4) {
                    $col = 'view';
                } elseif ($per->operation == 2) {
                    $col = 'delete';
                } elseif ($per->operation == 1) {
                    $col = 'create';
                } else {
                    $col = 'edit';
                }
                $profilepermissions[$col] = $per->permissions;     
            }
        }else{
            $stand_permission = DB::table('rsoft_profile2standardpermissions')->select('operation', 'permissions','tabid')->where('profileid', '=', $profileid)->get();
            foreach ($stand_permission as $per) {
                if ($per->operation == 4) {
                    $col = 'view';
                } elseif ($per->operation == 2) {
                    $col = 'delete';
                } elseif ($per->operation == 1) {
                    $col = 'create';
                } else {
                    $col = 'edit';
                }
                $profilepermissions[$per->tabid][$col] = $per->permissions;     
            }
        }
       
		return $profilepermissions;
	}

    public function getDetailReportResult($report_id,$reportdetails,$reportmode,$reporttype=''){

       $reportall=$this->getReportReultRecord($report_id,$reportdetails,$reportmode,$reporttype);
       $reportarray = [];
       $reportarray1 = [];
       $aggrateValues=[];
       
       if($reportmode=='preview'){
            foreach ($reportall['reportresult'] as $key => $value) {
            // $record = [];
                foreach ($reportall['reportfields'] as $key2 => $field) {
                    if(isset($field['columns_coloumn_name'])){
                        if($field['columns_isformula'] ==1){
                           $label=$field['formula_label'].' - (fx)';
                           $fvalue= $this->getFormulaValue($value,$field);
                           $reportarray1[$label][] = $fvalue;
                           $aggrateValues[$label] = ''; 
                        }else{
                            $fieldKey=$field['columns_coloumn_name'];
                            if($fieldKey=='comments'){
                                $data= (new AdvancedReport())->getComments($value->id,$reportall['commentscolumn']);
                                $label='Comments';
                            }else{
                                $label =$field['label']; 
                                $data= (new AdvancedReport())->getUserFormatValues($reportall['coloumnfieldtypes'][$fieldKey],$value->$fieldKey,$value->$fieldKey,$fieldKey);
                                //$record[$label] = $data;
                                $label = $label; 
                                if ($field['module'] != $reportdetails[0]->primarymodule) {
                                    $label = $label.' - ('.$field['modulelabel'].')'; 
                                } 
                            }
                            $reportarray1[$label][] = $data;
                            if($key2==0){
                                $aggrateValues[$label] = 'Grand Total'; 
                            }else{
                                $aggrateValues[$label] = ''; 
                            }
                        }
                    }elseif(isset($field['aggregatecolumns_coloumn_name'])){
                        $clabel=$field['aggregatecolumns_calculation_type'];
                        if($field['aggregatecolumns_calculation_type']=='Column_Percentage'){
                            $clabel ='Column Percentage';
                        }elseif($field['aggregatecolumns_calculation_type']=='Row_Percentage'){
                            $clabel ='Row Percentage';
                        }elseif($field['aggregatecolumns_calculation_type']=='DistinctCount'){
                            $clabel ='Distinct Count';
                        }elseif($field['aggregatecolumns_calculation_type']=='StdDev'){
                            $clabel ='Sample StdDev';
                        }elseif($field['aggregatecolumns_calculation_type']=='Var'){
                            $clabel ='Sample Variance';
                        }elseif($field['aggregatecolumns_calculation_type']=='Sumhourcal'){
                            $clabel ='Sum (HH:MM: SS)';
                        }
                        $label = $clabel . ' of ' . $field['label']; 
                        $label = $label; 
                        if ($field['module'] != $reportdetails[0]->primarymodule) {
                            $label = $label.' - ('.$field['modulelabel'].')'; 
                        } 
                        $fieldKey = $field['aggregatecolumns_coloumn_name'];
                        $cname='aggregate|#|' . $field['aggregatecolumns_calculation_type'] . '|#|'.$field['aggregatecolumns_coloumn_name'];
                        // $record[$label] = $value->$cname;
                        $explodedata=explode('|#|',$cname);
                        $aggKey = $explodedata[1].'_'.$explodedata[2];
                        if($reportall['coloumnfieldtypes'][$aggKey]==11){
                            $data= (new AdvancedReport())->getUserFormatValues($reportall['coloumnfieldtypes'][$aggKey],$value->$cname,$value->$cname,$fieldKey);
                        }else{
                            $data= (new AdvancedReport())->getUserFormatValues($reportall['coloumnfieldtypes'][$aggKey],$value->$cname,$value->id,$fieldKey);
                        }
                        $reportarray1[$label][] = $data;
                    }
                }
            }
            $aggregatearray=$reportall['previewgtotalresult'];
           
       }else{
            foreach ($reportall['reportresult'] as $key => $value) {
                // $record = [];
                foreach ($reportall['reportfields'] as $key2 => $field) {
                        if(isset($field['columns_coloumn_name'])){
                            if($field['columns_isformula'] ==1){
                               $label=$field['formula_label'].' - (fx)';
                               $fvalue= $this->getFormulaValue($value,$field);
                               $reportarray1[$label][] = $fvalue;
                               $aggrateValues[$label] = ''; 
                            }else{
                            
                                $fieldKey=$field['columns_coloumn_name'];
                                if($fieldKey=='comments'){
                                        $data= (new AdvancedReport())->getComments($value->id,$reportall['commentscolumn']);
                                        $label='Comments';
                                }else{
                                    $label =$field['label']; 
                                    $data= (new AdvancedReport())->getUserFormatValues($reportall['coloumnfieldtypes'][$fieldKey],$value->$fieldKey,$value->$fieldKey,$fieldKey);
                                    //$record[$label] = $data;
                                    $label = $label; 
                                    if ($field['module'] != $reportdetails[0]->primarymodule) {
                                        $label = $label.' - ('.$field['modulelabel'].')'; 
                                    } 
                                }
                                $reportarray1[$label][] = $data;
                                if($key2==0){
                                    $aggrateValues[$label] = 'Grand Total'; 
                                }else{
                                    $aggrateValues[$label] = ''; 
                                }
                            }
                        }elseif(isset($field['aggregatecolumns_coloumn_name'])){
                            $clabel=$field['aggregatecolumns_calculation_type'];
                            if($field['aggregatecolumns_calculation_type']=='Column_Percentage'){
                                $clabel ='Column Percentage';
                            }elseif($field['aggregatecolumns_calculation_type']=='Row_Percentage'){
                                $clabel ='Row Percentage';
                            }elseif($field['aggregatecolumns_calculation_type']=='DistinctCount'){
                                $clabel ='Distinct Count';
                            }elseif($field['aggregatecolumns_calculation_type']=='StdDev'){
                                $clabel ='Sample StdDev';
                            }elseif($field['aggregatecolumns_calculation_type']=='Var'){
                                $clabel ='Sample Variance';
                            }elseif($field['aggregatecolumns_calculation_type']=='Sumhourcal'){
                                $clabel ='Sum (HH:MM: SS)';
                            }
                            $label = $clabel . ' of ' . $field['label']; 
                            $label = $label; 
                            if ($field['module'] != $reportdetails[0]->primarymodule) {
                                $label = $label.' - ('.$field['modulelabel'].')'; 
                            } 
                            $fieldKey = $field['aggregatecolumns_coloumn_name'];
                            $cname='aggregate|#|' . $field['aggregatecolumns_calculation_type'] . '|#|'.$field['aggregatecolumns_coloumn_name'];
                            // $record[$label] = $value->$cname;
                            $explodedata=explode('|#|',$cname);
                            $aggKey = $explodedata[1].'_'.$explodedata[2];
                            if($reportall['coloumnfieldtypes'][$aggKey]==11){
                                $data= (new AdvancedReport())->getUserFormatValues($reportall['coloumnfieldtypes'][$aggKey],$value->$cname,$value->$cname,$fieldKey);
                            }else{
                                $data= (new AdvancedReport())->getUserFormatValues($reportall['coloumnfieldtypes'][$aggKey],$value->$cname,$value->id,$fieldKey);
                            }
                            $reportarray1[$label][] = $data;
                        }
                }
            }
            $aggregatearray=$reportall['reportresult'];
        }
    
        foreach($aggregatearray as $key =>$value){
            foreach ($reportall['reportfields'] as $key2 => $field) {
                if(isset($field['aggregatecolumns_coloumn_name'])){
                    $clabel=$field['aggregatecolumns_calculation_type'];
                    if($field['aggregatecolumns_calculation_type']=='Column_Percentage'){
                        $clabel ='Column Percentage';
                    }elseif($field['aggregatecolumns_calculation_type']=='Row_Percentage'){
                        $clabel ='Row Percentage';
                    }elseif($field['aggregatecolumns_calculation_type']=='DistinctCount'){
                        $clabel ='Distinct Count';
                    }elseif($field['aggregatecolumns_calculation_type']=='StdDev'){
                        $clabel ='Sample StdDev';
                    }elseif($field['aggregatecolumns_calculation_type']=='Var'){
                        $clabel ='Sample Variance';
                    }elseif($field['aggregatecolumns_calculation_type']=='Sumhourcal'){
                        $clabel ='Sum (HH:MM: SS)';
                    }
                    $label = $clabel . ' of ' . $field['label']; 
                    $label = $label; 
                    if ($field['module'] != $reportdetails[0]->primarymodule) {
                        $label = $label.' - ('.$field['modulelabel'].')'; 
                    } 
                    $fieldKey = $field['aggregatecolumns_coloumn_name'];
                    $cname='aggregate|#|' . $field['aggregatecolumns_calculation_type'] . '|#|'.$field['aggregatecolumns_coloumn_name'];
                    // $record[$label] = $value->$cname;
                    $explodedata=explode('|#|',$cname);
                    $aggKey = $explodedata[1].'_'.$explodedata[2];
                   
                    if($reportall['coloumnfieldtypes'][$aggKey]!='25'){
                        if($reportall['coloumnfieldtypes'][$aggKey]==11){
                            $data= (new AdvancedReport())->getUserFormatValues($reportall['coloumnfieldtypes'][$aggKey],$value->$cname,$value->$cname,$fieldKey);
                        }else{
                            $data= (new AdvancedReport())->getUserFormatValues($reportall['coloumnfieldtypes'][$aggKey],$value->$cname,$value->id,$fieldKey);
                        }
                    }else{
                        $data=$value->$cname;
                    }
                    
                    if ($explodedata[1] == 'Sum') {
                        if (!isset($aggrateValues[$label])) {
                            $aggrateValues[$label] = 0;
                        }
                        $aggrateValues[$label] += is_numeric($data) ? $data : 0;
                    }
                    if($explodedata[1] =='Sumhourcal'){
                        if (!isset($aggrateValues[$label])) {
                            $aggrateValues[$label] = ['sumhour' => []];
                        }

                        if (is_numeric($data)) {
                            $aggrateValues[$label]['sumhour'][]= $data;
                        }else{
                            $aggrateValues[$label]['sumhour'][]= 0;
                        } 
                    }
                    if ($explodedata[1] == 'Count') {
                        if (!isset($aggrateValues[$label])) {
                            $aggrateValues[$label] = 0;
                        }
                        $aggrateValues[$label] += 1;
                    }
                    // if ($explodedata[1] == 'Min') {
                    //     if (!isset($aggrateValues[$label])) {
                    //         $aggrateValues[$label] = PHP_INT_MAX;
                    //     }
                    //     if (is_numeric($data) && $data < $aggrateValues[$label]) {
                    //         $aggrateValues[$label] = $data; 
                    //     }
                    // }if ($explodedata[1] == 'Max') {
                    //     if (!isset($aggrateValues[$label])) {
                    //         $aggrateValues[$label] = PHP_INT_MIN;
                    //     }
                    //     if (is_numeric($data) && $data > $aggrateValues[$label]) {
                    //         $aggrateValues[$label] = $data; 
                    //     }
                    // }
                    if ($explodedata[1] == 'Min') {
                        if (!isset($aggrateValues[$label])) {
                            $aggrateValues[$label] = PHP_INT_MAX;
                        }
                        if (is_numeric($data) && $data < $aggrateValues[$label]) {
                            $aggrateValues[$label] = $data;
                        }
                        if ($aggrateValues[$label] === PHP_INT_MAX) {
                            $aggrateValues[$label] = 0;
                        }
                    }
                    
                    if ($explodedata[1] == 'Max') {
                        if (!isset($aggrateValues[$label])) {
                            $aggrateValues[$label] = PHP_INT_MIN;
                        }
                        if (is_numeric($data) && $data > $aggrateValues[$label]) {
                            $aggrateValues[$label] = $data;
                        }
                        if ($aggrateValues[$label] === PHP_INT_MIN) {
                            $aggrateValues[$label] = 0;
                        }
                    }
                    
                    if ($explodedata[1] == 'Avg') {
                        if (!isset($aggrateValues[$label])) {
                            $AvgaggrateValues[$label] = ['sum' => 0, 'count' => 0];
                        }

                        if (is_numeric($data)) {
                            $AvgaggrateValues[$label]['sum'] += $data;
                        }
                        $AvgaggrateValues[$label]['count'] += 1;
                        $aggrateValues[$label] = $AvgaggrateValues[$label]['count'] > 0 ? $AvgaggrateValues[$label]['sum'] / $AvgaggrateValues[$label]['count'] : 0;
                    }
                    if ($explodedata[1] == 'StdDev') {
                        if (!isset($aggrateValues[$label])) {
                            $StdDevval[$label] = ['sum' => 0, 'sum_of_squares' => 0, 'count' => 0];
                        }

                        if (is_numeric($data)) {
                            $StdDevval[$label]['sum'] += $data;
                            $StdDevval[$label]['sum_of_squares'] += $data * $data; 
                        }
                        $StdDevval[$label]['count'] += 1;
                        if ($StdDevval[$label]['count'] > 1) {
                            $mean = $StdDevval[$label]['sum'] / $StdDevval[$label]['count'];
                            $variance = ($StdDevval[$label]['sum_of_squares'] - $StdDevval[$label]['count'] * $mean * $mean) / ($StdDevval[$label]['count'] - 1);
                            $aggrateValues[$label] = sqrt($variance);
                        } else {
                            $aggrateValues[$label] = 0;
                        }
                    }
                    if ($explodedata[1] == 'Median') {
                        if (!isset($aggrateValues[$label])) {
                            $aggrateValues[$label] = ['median' => [], 'count' => 0];
                        }

                        if (is_numeric($data)) {
                            $aggrateValues[$label]['median'][]= $data;
                        }else{
                            $aggrateValues[$label]['median'][]= 0;
                        } 
                        $aggrateValues[$label]['count'] += 1;
                    }
                    if ($explodedata[1] == 'Mode') {
                        if (!isset($aggrateValues[$label])) {
                            $aggrateValues[$label] = ['mode' => []];
                        }

                        if (is_numeric($data)) {
                            $aggrateValues[$label]['mode'][]= $data;
                        } 
                    }
                    if ($explodedata[1] == 'Var') {
                        if (!isset($aggrateValues[$label])) {
                            $VARVal[$label] = ['sum' => 0, 'sum_of_squares' => 0, 'count' => 0];
                        }

                        if (is_numeric($data)) {
                            $VARVal[$label]['sum'] += $data;
                            $VARVal[$label]['sum_of_squares'] += $data * $data;
                        }
                        $VARVal[$label]['count'] += 1;
                        if ($VARVal[$label]['count'] > 1) {
                            $mean = $VARVal[$label]['sum'] / $VARVal[$label]['count'];
                            $aggrateValues[$label] = ($VARVal[$label]['sum_of_squares'] - $VARVal[$label]['count'] * $mean * $mean) / ($VARVal[$label]['count'] - 1);
                        } else {
                            $aggrateValues[$label] = 0;
                        }
                    }
                    if ($explodedata[1] == 'Column_Percentage' || $explodedata[1] == 'Row_Percentage') {

                        if (!isset($aggrateValues[$label])) {
                            $aggrateValues[$label] = ['total' => 0, 'percentage' => 0, 'count' => 0];
                        }
                        if($reportall['coloumnfieldtypes'][$aggKey]=='24' || $reportall['coloumnfieldtypes'][$aggKey]=='25'){
                            if (is_numeric($data)) {
                                $aggrateValues[$label]['total'] += $data;
                                $aggrateValues[$label]['count'] += $data; 
                            } 
                            //$aggrateValues[$label]['count'] += 1; 
                        }else{
                            $aggrateValues[$label]['total'] += 1;
                            $aggrateValues[$label]['count'] += 1; 
                        }
                            
                    }
                    if ($explodedata[1] == 'DistinctCount') {
                        if (!isset($aggrateValues[$label])) {
                            $DistinctVal[$label] = [];
                        }

                        if (!in_array($data, $DistinctVal[$label])) {
                            $DistinctVal[$label][] = $data;
                        }
                        $aggrateValues[$label] = count($DistinctVal[$label]);
                    }
                }
            }
        }
        foreach ($aggrateValues as $label => $values) {
            if (is_array($values)) {
                if(isset($values['total'])){
                    $aggrateValues[$label] = $values['total'] != 0 ? ($values['count'] / $values['total']) * 100 : 0; 
                }elseif(isset($values['median'])){
                    $data = $values['median'];
                  
                    sort($data);
                    $count = $values['count'];
                    if ($count % 2 == 1) {
                        $median = $data[($count - 1) / 2];
                    } else {
                        $mid1 = $data[$count / 2 - 1];
                        $mid2 = $data[$count / 2];
                        $median = ($mid1 + $mid2) / 2;
                    }
                    $aggrateValues[$label] =$median;  
                }elseif(isset($values['mode'])){
                    $result=$this->getMostFrequentDuplicate($values['mode']);
                    $aggrateValues[$label] =$result;  
                }elseif(isset($values['sumhour'])){
                    $totalsum=array_sum($values['sumhour']);
                    $aggrateValues[$label] =gmdate("H:i:s",$totalsum);
                }
            }
        }
        //$reportarray[count($reportarray)] =$aggrateValues;
        $response['reportall']=$reportall;
        $response['reportarray']=$reportarray;
        $response['reportarray1']=$reportarray1;
        $response['aggrateValues']=$aggrateValues;
        return $response;
    }


    function getComments($recordid, $commentscolumn) {
        $messageContent = '';
        $tooltipContent = '';
        $dateformat = (new User())->getCurrentUserDateFormat();
        $timeformat = (new User())->getCurrentUserTimeFormat() == '12 hours' ? 'h:i:s A' : 'H:i:s';
        $datetimeformat = $dateformat . ' ' . $timeformat;
    
        if ($commentscolumn[0]->columns_comments == 'lastcomment') {
            $commentcontent = DB::table('rsoft_comments')
                ->join('rsoft_users', 'rsoft_comments.userid', '=', 'rsoft_users.id')
                ->where('relatedto', $recordid)
                ->select('rsoft_comments.commentcontent', 'rsoft_comments.created_time', 'rsoft_users.users_firstname', 'rsoft_users.users_lastname', 'rsoft_comments.userid')
                ->limit(1)
                ->orderby('modcommentid', 'DESC')
                ->get();
    
            if (count($commentcontent)) {
                $messageContent = $commentcontent[0]->commentcontent;
                $commentNumber = 1;
                foreach ($commentcontent as $comment) {
                    $fullName = $comment->users_firstname . ' ' . $comment->users_lastname;
                    if (trim($fullName) == '') {
                        $fullName = $comment->userid;  
                    }
                    $tooltipContent .= $commentNumber . '. ' . $fullName . ', ';
                    $convertedTime = (new User())->convertUserTimeZone($comment->created_time, $datetimeformat, 'Y-m-d H:i:s');
                    $tooltipContent .= $convertedTime . ', ';
                    $tooltipContent .= $comment->commentcontent . ''; 
                    $tooltipContent .= '<br><br>';
                    $commentNumber++;
                }
            }
        } elseif ($commentscolumn[0]->columns_comments == 'last3comments') {
            $commentcontent = DB::table('rsoft_comments')
                ->join('rsoft_users', 'rsoft_comments.userid', '=', 'rsoft_users.id')
                ->where('relatedto', $recordid)
                ->select('rsoft_comments.commentcontent', 'rsoft_comments.created_time', 'rsoft_users.users_firstname', 'rsoft_users.users_lastname', 'rsoft_comments.userid')
                ->limit(3)
                ->orderby('modcommentid', 'DESC')
                ->get();
    
            if (count($commentcontent)) {
                $messageContent = $commentcontent->pluck('commentcontent')->implode(', ');
                $commentNumber = 1;
                foreach ($commentcontent as $comment) {
                    $fullName = $comment->users_firstname . ' ' . $comment->users_lastname;
                    if (trim($fullName) == '') {
                        $fullName = $comment->userid;  
                    }
                    $tooltipContent .= $commentNumber . '. ' . $fullName . ', ';
                    $convertedTime = (new User())->convertUserTimeZone($comment->created_time, $datetimeformat, 'Y-m-d H:i:s');
                    $tooltipContent .= $convertedTime . ', ';
                    $tooltipContent .= $comment->commentcontent . ''; 
                    $tooltipContent .= '<br><br>';
                    $commentNumber++;
                }
            }
        } elseif ($commentscolumn[0]->columns_comments == 'last5comments') {
            $commentcontent = DB::table('rsoft_comments')
                ->join('rsoft_users', 'rsoft_comments.userid', '=', 'rsoft_users.id')
                ->where('relatedto', $recordid)
                ->select('rsoft_comments.commentcontent', 'rsoft_comments.created_time', 'rsoft_users.users_firstname', 'rsoft_users.users_lastname', 'rsoft_comments.userid')
                ->limit(5)
                ->orderby('modcommentid', 'DESC')
                ->get();
    
            if (count($commentcontent)) {
                $messageContent = $commentcontent->pluck('commentcontent')->implode(', ');
                $commentNumber = 1;
                foreach ($commentcontent as $comment) {
                    $fullName = $comment->users_firstname . ' ' . $comment->users_lastname;
                    if (trim($fullName) == '') {
                        $fullName = $comment->userid;  
                    }
                    $tooltipContent .= $commentNumber . '. ' . $fullName . ', ';
                    $convertedTime = (new User())->convertUserTimeZone($comment->created_time, $datetimeformat, 'Y-m-d H:i:s');
                    $tooltipContent .= $convertedTime . ', ';
                    $tooltipContent .= $comment->commentcontent . ''; 
                    $tooltipContent .= '<br><br>';
                    $commentNumber++;
                }
            }
        } else {
            $commentcontent = DB::table('rsoft_comments')
                ->join('rsoft_users', 'rsoft_comments.userid', '=', 'rsoft_users.id')
                ->where('relatedto', $recordid)
                ->select('rsoft_comments.commentcontent', 'rsoft_comments.created_time', 'rsoft_users.users_firstname', 'rsoft_users.users_lastname', 'rsoft_comments.userid')
                ->orderby('modcommentid', 'DESC')
                ->get();
    
            if (count($commentcontent)) {
                $messageContent = $commentcontent->pluck('commentcontent')->implode(', ');
                $commentNumber = 1;
                foreach ($commentcontent as $comment) {
                    $fullName = $comment->users_firstname . ' ' . $comment->users_lastname;
                    if (trim($fullName) == '') {
                        $fullName = $comment->userid;  
                    }
                    $tooltipContent .= $commentNumber . '. ' . $fullName . ', ';
                    $convertedTime = (new User())->convertUserTimeZone($comment->created_time, $datetimeformat, 'Y-m-d H:i:s');
                    $tooltipContent .= $convertedTime . ', ';
                    $tooltipContent .= $comment->commentcontent . ''; 
                    $tooltipContent .= '<br><br>';
                    $commentNumber++;
                }
            }
        }
    
        return $tooltipContent;
    }
     
    
    function getMostFrequentDuplicate($array, $top = 2) {
        $counts = array_count_values($array);
    
        // Filter to keep only values that occur more than once
        $duplicates = array_filter($counts, function($count) {
            return $count > 1;
        });
    
        if (empty($duplicates)) {
            return "No Mode";
        }
    
        arsort($duplicates);
    
        $topFrequent = array_slice(array_keys($duplicates), 0, $top);
    
        return implode(',', $topFrequent);
    }
   public function AdvancedReportDownload($report_id,$reportmode,$reporttype,$accessmode,$fieldid = '',$fieldtype = '', $colname = '', $condition = '', $fieldvalue = '', $previewsorting = '', $previewcolumnname = '')
{
    $multipleFilters = [];
    
    $filterData = request('filter_data');

    if (!empty($filterData)) {
        if (is_string($filterData)) {
            $jsonEnd = strpos($filterData, '}"]');
            if ($jsonEnd !== false) {
                $filterData = substr($filterData, 0, $jsonEnd + 3);
            }
            
            $filterData = urldecode($filterData);
        }
        
        $multipleFilters = json_decode($filterData, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            $cleanedData = preg_replace('/[^\x20-\x7E]/', '', $filterData);
            $jsonStart = strpos($cleanedData, '[{');
            $jsonEnd = strrpos($cleanedData, '}]') + 2;
            
            if ($jsonStart !== false && $jsonEnd !== false) {
                $jsonContent = substr($cleanedData, $jsonStart, $jsonEnd - $jsonStart);
                $multipleFilters = json_decode($jsonContent, true);
            }
        }
    }
    
    if (empty($multipleFilters) && is_string($fieldid) && !empty($fieldid)) {
        $decodedFieldId = json_decode($fieldid, true);
        if (json_last_error() === JSON_ERROR_NONE && is_array($decodedFieldId)) {
            $multipleFilters = $decodedFieldId;
        }
    }

    $reportdetails = DB::table('rsoft_advanced_report')
        ->where('report_id', $report_id)
        ->join('rsoft_modules', 'rsoft_advanced_report.primarymodule', '=', 'rsoft_modules.id')
        ->get();

    if ($accessmode == 'SendMail') {
        if (!empty($multipleFilters)) {
            $module_id = $reportdetails[0]->primarymodule ?? '';
            $this->PreviewFilterSearch('previewexport', $report_id, $module_id, $multipleFilters);
            $reportall = $this->getDetailReportResult($report_id, $reportdetails, 'SendMail');
        } else {
            $reportall = $this->getDetailReportResult($report_id, $reportdetails, 'SendMail', '', $fieldid, $fieldtype, $colname, $condition, $fieldvalue);
        }
        
        if (($reportall['reportall']['reportMode'] ?? '') == 'DetailReport') {
            return $this->DetailedReportDownload($report_id, $reporttype, $accessmode, $reportdetails, $reportall);
        } else {
            return $this->GroupedReportDownload($report_id, $reporttype, $accessmode, $reportdetails, $reportall['reportall']);
        }
    } else {
        $this->previewsorting = $previewsorting;
        $this->previewcolumnname = $previewcolumnname;
        
        $module_id = $reportdetails[0]->primarymodule ?? '';
        
        if (!empty($multipleFilters)) {
            $this->PreviewFilterSearch('previewexport', $report_id, $module_id, $multipleFilters);
        } else {
            $fieldvalue = urldecode($fieldvalue);
            $this->PreviewFilterSearch('previewexport', $report_id, $module_id, $fieldid, $colname, $fieldtype, $condition, $fieldvalue);
        }

        if ($reportmode == 'Detailed Report') {
            if (!empty($multipleFilters)) {
                $reportall = $this->getDetailReportResult($report_id, $reportdetails, 'export', 'DetailReport');
            } else {
                $reportall = $this->getDetailReportResult($report_id, $reportdetails, 'export', 'DetailReport', $fieldid, $fieldtype, $colname, $condition, $fieldvalue);
            }
            
            return $this->DetailedReportDownload($report_id, $reporttype, $accessmode, $reportdetails, $reportall);
        } else {
            if (!empty($multipleFilters)) {
                $reportall = $this->getReportReultRecord($report_id, $reportdetails, 'export', 'GroupReport');
            } else {
                $reportall = $this->getReportReultRecord($report_id, $reportdetails, 'export', 'GroupReport');
            }
            
            return $this->GroupedReportDownload($report_id, $reporttype, $accessmode, $reportdetails, $reportall);
        }
        }
    }
    
    public function DetailedReportDownload($report_id,$reporttype,$accessmode,$reportdetails, $reportall)
    {
        if($reporttype =='PDF' || $reporttype =='HTML'){
           return $this->getDownloadPDFReport($report_id,$reportall['reportall'],$reportdetails,$reportall['reportarray1'],$reportall['aggrateValues'],$reporttype,$accessmode);
        }else{
            $this->getDownloadExcellReport($report_id,$reportall['reportall'],$reportdetails,$reportall['reportarray1'],$reportall['aggrateValues'],$reporttype,$accessmode);
        }
      
    }

    public function GroupedReportDownload($report_id,$reporttype,$accessmode,$reportdetails, $reportall)
    {
        if($reporttype =='PDF' || $reporttype =='HTML'){
           return $this->getGroupDownloadPDFReport($report_id,$reportall,$reportdetails,$accessmode,$reporttype);
        }else{
            $this->GroupDownloadExcellReport($report_id,$reportall,$reportdetails,$reporttype,$accessmode);
        }
      
    }
    // function getColumnLetter($columnIndex)
    // {
    //     $letters = range('A', 'Z');
    //     return $letters[$columnIndex - 1];
    // }
    function getColumnLetter($columnIndex) {
        $columnLetter = '';
        while ($columnIndex > 0) {
            $mod = ($columnIndex - 1) % 26;
            $columnLetter = chr(65 + $mod) . $columnLetter;
            $columnIndex = (int)(($columnIndex - $mod) / 26);
        }
        return $columnLetter;
    }

    function getColumnIndex($columnLetter)
    {
        $columnLetter = strtoupper($columnLetter);
        $index = ord($columnLetter) - ord('A') + 1;
        return $index;
    }

    function getNextColumnLetter($columnLetter)
    {
        $length = strlen($columnLetter);
        $index = 0;
        $result = '';

        for ($i = 0; $i < $length; $i++) {
            $index *= 26;
            $index += ord($columnLetter[$i]) - ord('A') + 1;
        }

        $index++;

        while ($index > 0) {
            $index--;
            $result = chr($index % 26 + ord('A')) . $result;
            $index = floor($index / 26);
        }

        return $result;
    }

    function getpreviewColumnLetter($columnLetter)
    {
        $columnLetter = strtoupper($columnLetter);

        $nextColumnLetter = chr(ord($columnLetter) - 1);
        
        return $nextColumnLetter;
    }
    function getColumnAfterOffset($columnLetter, $offset)
    {
        // Convert column letter (e.g., "AA") to a numeric index
        $columnIndex = 0;
        $length = strlen($columnLetter);
        for ($i = 0; $i < $length; $i++) {
            $columnIndex *= 26;
            $columnIndex += ord($columnLetter[$i]) - 64; // A=1, B=2, ..., Z=26
        }
    
        // Add the offset to the numeric index
        $newColumnIndex = $columnIndex + $offset;
    
        // Convert numeric index back to column letter
        $letters = '';
        while ($newColumnIndex > 0) {
            $newColumnIndex--; // Adjust for 1-based index
            $letters = chr($newColumnIndex % 26 + 65) . $letters;
            $newColumnIndex = intdiv($newColumnIndex, 26);
        }
    
        return $letters;
    }
    
    public function GroupDownloadExcellReport($report_id, $reportall, $reportdetails, $reporttype, $accessmode) {
       
        ob_start();
    
        $reportresult = $reportall['reportresult'];
        $tablestyle = DB::table('rsoft_advanced_report_tablestyle')->where('report_id', $report_id)->get();
        $tablestyle = $this->getTablestyle($tablestyle);
        $AllUsers = (new User())->GettingAllUsers();
        $reportresult['aggregatecolumns'] = $reportresult['aggregatecolumns'] == 0 ? 1 : $reportresult['aggregatecolumns'];
       
        $originalReportName = $reportdetails[0]->report_name;
        $filename = !empty(trim($originalReportName)) ? $originalReportName : 'Report_' . $report_id;
        if ($reporttype == 'CSV') {
            $filename .= '.csv';
            $headerCellStyle = array();
            $bodyCellStyle = array();
            $FooterCellStyle = array();
            $oddRowStyle = array();
            $evenRowStyle = array();
            $tableborder = array();
            $ConditionsInfoColor = array();
        } elseif ($reporttype == 'Excel') {
            $filename .= '.xlsx';
            $tstyle = DB::table('rsoft_advanced_report_tablestyle')->where('report_id', $report_id)->get()[0];
            $tableborder = $this->getTableBorder($tstyle);
            $headerCellStyle = array(
                'font' => array(
                    'bold' => $tstyle->table_header_b,
                    'name' => $tstyle->table_header_font,
                    'size' => $tstyle->table_header_size,
                    'italic' => $tstyle->table_header_i,
                    'underline' => $tstyle->table_header_u ? PHPExcel_Style_Font::UNDERLINE_SINGLE : PHPExcel_Style_Font::UNDERLINE_NONE,
                    'color' => array('rgb' => str_replace('#', '', $tstyle->table_header_color)),
                ),
                'fill' => array(
                    'type' => PHPExcel_Style_Fill::FILL_SOLID,
                    'color' => array('rgb' => str_replace('#', '', $tstyle->table_header_cell_color)),
                ),
            );
    
            $bodyCellStyle = array(
                'font' => array(
                    'name' => $tstyle->table_label_font,
                    'size' => $tstyle->table_label_size,
                    'color' => array('rgb' => str_replace('#', '', $tstyle->table_label_color)),
                ),
            );
    
            $oddRowStyle = array(
                'font' => array(
                    'name' => $tstyle->table_label_font,
                    'size' => $tstyle->table_label_size,
                    'color' => array('rgb' => str_replace('#', '', $tstyle->table_label_color)),
                ),
                'fill' => array(
                    'type' => PHPExcel_Style_Fill::FILL_SOLID,
                    'color' => array('rgb' => str_replace('#', '', $tstyle->table_odd_row_color)),
                ),
            );
    
            $evenRowStyle = array(
                'font' => array(
                    'name' => $tstyle->table_label_font,
                    'size' => $tstyle->table_label_size,
                    'color' => array('rgb' => str_replace('#', '', $tstyle->table_label_color)),
                ),
                'fill' => array(
                    'type' => PHPExcel_Style_Fill::FILL_SOLID,
                    'color' => array('rgb' => str_replace('#', '', $tstyle->table_even_row_color)),
                ),
            );
    
            $FooterCellStyle = array(
                'font' => array(
                    'bold' => $tstyle->table_footer_b,
                    'name' => $tstyle->table_footer_font,
                    'size' => $tstyle->table_footer_size,
                    'italic' => $tstyle->table_footer_i,
                    'underline' => $tstyle->table_footer_u ? PHPExcel_Style_Font::UNDERLINE_SINGLE : PHPExcel_Style_Font::UNDERLINE_NONE,
                    'color' => array('rgb' => str_replace('#', '', $tstyle->table_footer_color)),
                ),
                'fill' => array(
                    'type' => PHPExcel_Style_Fill::FILL_SOLID,
                    'color' => array('rgb' => str_replace('#', '', $tstyle->table_footer_cell_color)),
                ),
            );
    
            $ConditionsInfoColor = array(
                'font' => array(
                    'bold' => true,
                    'size' => '14',
                    'color' => array('rgb' => '000000'),
                ),
            );
        }
    
        $objPHPExcel = new PHPExcel();
        $objPHPExcel->getProperties()->setCreator('Maarten Balliauw')
                    ->setLastModifiedBy('Maarten Balliauw')
                    ->setTitle('Office 2007 XLSX Test Document')
                    ->setSubject('Office 2007 XLSX Test Document')
                    ->setDescription('Test document for Office 2007 XLSX, generated using PHP classes.')
                    ->setKeywords('office 2007 openxml php')
                    ->setCategory('Test result file');
    
        // Apply styles for the header and set data for report columns
        if (isset($reportresult['body']) && count($reportresult['body'])) {
            $row = 1;
            $countall = $reportresult['countgroupbyrow'] + (count($reportresult['groupbycol']) + 1) * $reportresult['aggregatecolumns'];
            $columnLetter = $this->getColumnLetter($countall);
            $objPHPExcel->setActiveSheetIndex(0)
                ->mergeCells('A' . $row . ':' . $columnLetter . $row)
                ->setCellValue('A' . $row, $reportdetails[0]->report_name);
            $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)
                ->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
            if ($reporttype == 'Excel') {
                $headerCellStyleNoBg = $headerCellStyle;
                if (isset($headerCellStyleNoBg['fill'])) {
                    unset($headerCellStyleNoBg['fill']);
                }
                $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($headerCellStyleNoBg);
                $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $this->getColumnLetter(count($reportresult['labelgroupbyrow'])) . $row)->applyFromArray($tableborder);
            }
    
            $ConditionsInfo = $this->getFilterConditionsInfo($report_id);
            if ($ConditionsInfo != '') {
                $row = $row + 1;
                $objPHPExcel->setActiveSheetIndex(0)
                    ->mergeCells('A' . $row . ':' . $columnLetter . $row)
                    ->setCellValue('A' . $row, $ConditionsInfo);
                $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)
                    ->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
                if ($reporttype == 'Excel') {
                    $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($ConditionsInfoColor);
                    $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $this->getColumnLetter(count($reportresult['labelgroupbyrow'])) . $row)->applyFromArray($tableborder);
                }
            }
    
            // Add description field if it exists
            if (!empty($reportdetails[0]->description)) {
                $row = $row + 1;
                $objPHPExcel->setActiveSheetIndex(0)
                    ->mergeCells('A' . $row . ':' . $columnLetter . $row)
                    ->setCellValue('A' . $row, 'Description: ' . $reportdetails[0]->description);
                $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)
                    ->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
                if ($reporttype == 'Excel') {
                    $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($ConditionsInfoColor);
                    $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $this->getColumnLetter(count($reportresult['labelgroupbyrow'])) . $row)->applyFromArray($tableborder);
                }
            }
    
            $row = $row + 1;
            if (count($reportall['groupbycolumns'])) {
                $groupbycolumns = $reportall['groupbycolumns'][0];
                $columnLetter = $this->getColumnLetter($reportresult['countgroupbyrow']);
    
                $objPHPExcel->setActiveSheetIndex(0)
                    ->mergeCells('A' . $row . ':' . $columnLetter . $row)
                    ->setCellValue('A' . $row, $reportresult['labelgroupbycol']);
                $objPHPExcel->getActiveSheet()->getColumnDimension($columnLetter)->setAutoSize(true);
                $columnLetter = $this->getColumnLetter(($reportresult['countgroupbyrow'] + 1));
                foreach ($reportresult['groupbycol'] as $key => $groupbycol) {
                    if (in_array($groupbycolumns->groupbycolumns_fieldtype, [13, 14, 15])) {
                        if ($groupbycol != 'Empty') {
                            $groupbycol = $AllUsers[$groupbycol]['users_firstname'] . ' ' . $AllUsers[$groupbycol]['users_lastname'];
                        }
                    }
                    $Offset = $this->getColumnAfterOffset($columnLetter, ($reportresult['aggregatecolumns'] - 1));
                    $objPHPExcel->setActiveSheetIndex(0)
                        ->mergeCells($columnLetter . $row . ':' . $Offset . $row)
                        ->setCellValue($columnLetter . $row, "$groupbycol");
                    $objPHPExcel->getActiveSheet()->getColumnDimension($columnLetter)->setAutoSize(true);
                    $columnLetter = $this->getNextColumnLetter($Offset);
                }
                
                $Offset = $this->getColumnAfterOffset($columnLetter, ($reportresult['aggregatecolumns'] - 1));
                $objPHPExcel->setActiveSheetIndex(0)
                    ->mergeCells($columnLetter . $row . ':' . $Offset . $row)
                    ->setCellValue($columnLetter . $row, "Grand Total");
                $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($headerCellStyle);
                $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($tableborder);
                $objPHPExcel->getActiveSheet()->getColumnDimension($columnLetter)->setAutoSize(true);
                $row++;
            }
    
            // Table headers
            foreach ($reportresult['labelgroupbyrow'] as $index => $label) {
                $columnLetter = $this->getColumnLetter($index + 1);
                $objPHPExcel->setActiveSheetIndex(0)->setCellValue($columnLetter . $row, "$label");
                $objPHPExcel->getActiveSheet()->getColumnDimension($columnLetter)->setAutoSize(true);
            }
            $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $this->getColumnLetter(count($reportresult['labelgroupbyrow'])) . $row)->applyFromArray($headerCellStyle);
            $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $this->getColumnLetter(count($reportresult['labelgroupbyrow'])) . $row)->applyFromArray($tableborder);
            $row++;
            $bodyStartRow = $row;
            if ($reportdetails[0]->expand_grand_total == 0) {
                $columnIndex = 0;
                $firstColumnLetter = $this->getColumnLetter(1);
                $lastGroupByColumnLetter = $this->getColumnLetter($reportresult['countgroupbyrow']);
                $objPHPExcel->getActiveSheet()
                    ->mergeCells($firstColumnLetter . $row . ':' . $lastGroupByColumnLetter . $row)
                    ->setCellValue($firstColumnLetter . $row, 'Grand Total');
                $objPHPExcel->getActiveSheet()->getStyle($firstColumnLetter . $row . ':' . $lastGroupByColumnLetter . $row)->applyFromArray($FooterCellStyle);
                $objPHPExcel->getActiveSheet()->getStyle($firstColumnLetter . $row . ':' . $lastGroupByColumnLetter . $row)->applyFromArray($tableborder);
                foreach ($reportresult['groupbyaggrecol'] as $defaultKey) {
                    if (isset($reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey])) {
                        foreach ($reportall['aggregatecolumns'] as $k => $v) {
                            if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                                $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                            } else {
                                $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                            }
                        }
                        $columnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                        if (strpos($defaultKey, 'Column_Percentage') !== false) {
                            $denominator = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                            if ($denominator != 0) {
                                $GrandTotal = round((($denominator / $denominator) * 100), 2);
                            } else {
                                $GrandTotal = 0;
                            }
                        } elseif (strpos($defaultKey, 'Row_Percentage') !== false) {
                            $gtotal = $reportresult['GrandTotal']['GrandTotal'][$column];
                            $datavale = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                            if ($datavale != 0) {
                                $GrandTotal = round((($datavale / $gtotal) * 100), 2);
                            } else {
                                $GrandTotal = 0;
                            }
                        } elseif (strpos($defaultKey, 'Sumhourcal') !== false) {
                            $totalSeconds = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                            $hours = floor($totalSeconds / 3600);
                            $minutes = floor(($totalSeconds % 3600) / 60);
                            $seconds = $totalSeconds % 60;
                            $GrandTotal = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                        }elseif (strpos($defaultKey,'picklisttracking_') !== false) {
                            if (strpos($defaultKey,'_sum_') !== false) {
                                $formula='sum';
                            }elseif (strpos($defaultKey,'_avg_time_') !== false) {
                                    $formula='avg_time';
                            }elseif (strpos($defaultKey,'_count_') !== false) {
                                    $formula='count';
                            }elseif (strpos($defaultKey,'_percentage_') !== false) {
                                    $formula='percentage';
                            }
                            $peravg=$reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey.'_total'] ?? 0;
                            if($formula =='percentage'){
                                 $GrandTotal=round($peravg/$reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey]*100, 2);
                            }else{
                                $GrandTotal=round($reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey] ?? 0,2);
                                $GrandTotal=(new AdvancedReport())->getPicklistTrackingResult($GrandTotal, $formula,$peravg);
                            }
                        } else {
                            $GrandTotal = round($reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey] ?? 0, 2);
                        }
                        if (strpos($defaultKey, 'Column_Percentage') !== false || strpos($defaultKey, 'Row_Percentage') !== false) {
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$GrandTotal%");
                        } else {
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$GrandTotal");
                        }
                        $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($FooterCellStyle);
                        $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($tableborder);
                    } else {
                        if ($reportdetails[0]->expand_group_count == 1) {
                            $columnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                            $value = round($reportresult['GrandTotal']['GrandTotal'][$defaultKey] ?? 0, 2);
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$value");
                            $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($FooterCellStyle);
                            $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($tableborder);
                        }
                    }
                }
    
                if ($reportdetails[0]->expand_group_count == 1) {
                    $totalColumnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                    $totalValue = round($reportresult['GrandTotal']['GrandTotal']['Total'], 2);
                    $objPHPExcel->getActiveSheet()->setCellValue($totalColumnLetter . $row, "$totalValue");
                    $objPHPExcel->getActiveSheet()->getStyle($totalColumnLetter . $row)->applyFromArray($FooterCellStyle);
                    $objPHPExcel->getActiveSheet()->getStyle($totalColumnLetter . $row)->applyFromArray($tableborder);
                }
    
                foreach ($reportall['aggregatecolumns'] as $k => $v) {
                    if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                        $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                        if(count($trackingdetails)){
                            $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                            foreach($picklist_data as $picklistval){
                                $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                $finaltotal = round($reportresult['GrandTotal']['GrandTotal'][$column] ?? 0, 2);
                                $peravg=$reportresult['GrandTotal']['GrandTotal'][$column.'_total'] ?? 0;
                                if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                    $finaltotal=(new AdvancedReport())->getPicklistTrackingResult($finaltotal, $picklistval->formula,$peravg);
                                }elseif($picklistval->formula=='percentage'){
                                    $finaltotal = round(( $peravg / $reportresult['GrandTotal']['GrandTotal']['Total']) * 100, 2);
                                }
                                $columnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                                if (in_array($picklistval->formula, ['percentage'])) {
                                    $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$finaltotal%");
                                } else {
                                    $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$finaltotal");
                                }
                                $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($FooterCellStyle);
                                $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($tableborder);
                            }
                        }
                    }else{
                        if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                            $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                        } else {
                            $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                        }
                        if ($v->aggregatecolumns_calculation_type == 'Column_Percentage' || $v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                            $denominator = $reportresult['GrandTotal']['GrandTotal'][$column];
                            if ($denominator != 0) {
                                $finaltotal = round(($denominator / $denominator) * 100, 2);
                            } else {
                                $finaltotal = 0;
                            }
                        } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                            $totalSeconds = $reportresult['GrandTotal']['GrandTotal'][$column];
                            $hours = floor($totalSeconds / 3600);
                            $minutes = floor(($totalSeconds % 3600) / 60);
                            $seconds = $totalSeconds % 60;
                            $finaltotal = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                        } else {
                            $finaltotal = round($reportresult['GrandTotal']['GrandTotal'][$column] ?? 0, 2);
                        }
                        $columnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                        if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$finaltotal%");
                        } else {
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$finaltotal");
                        }
                        $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($FooterCellStyle);
                        $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($tableborder);
                    }
                }
                foreach (range(1, $columnIndex) as $i) {
                    $columnLetter = $this->getColumnLetter($i);
                    $objPHPExcel->getActiveSheet()->getColumnDimension($columnLetter)->setAutoSize(true);
                }
                $row++;
            }
    
            foreach ($reportresult['body'] as $medium => $sources) {
                if (count($reportall['groupbyrows']) == 1) {
                    $column = 'A';
                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$medium");
                    if ($reporttype == 'Excel') {
                        $tableBodyRowIndex = $row - $bodyStartRow + 1;
                        $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
                        $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($styleToApply);
                        $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                    }
    
                    $column++;
                    foreach ($reportresult['groupbycol'] as $status) {
                        if ($reportdetails[0]->expand_group_count == 1) {
                            $data = round($sources[$status] ?? 0, 2);
                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data");
                            if ($reporttype == 'Excel') {
                            $tableBodyRowIndex = $row - $bodyStartRow + 1;
                            $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
                                $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($styleToApply);
                                $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                            }
                            $column++;
                        }
                        foreach ($reportall['aggregatecolumns'] as $k => $v) {
                            if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                                $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                                if(count($trackingdetails)){
                                    $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                    foreach($picklist_data as $picklistval){
                                        $columnKey ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                       $data = $sources[$status . '_' . $columnKey] ?? 0;
                                       $peravg=$sources[$status . '_' . $columnKey.'_total'] ?? 0;
                                        if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                            $data=(new AdvancedReport())->getPicklistTrackingResult($data, $picklistval->formula,$peravg);
                                        }elseif($picklistval->formula=='percentage'){
                                            $data = ($data ?? 0) > 0 
                                            ? round(($peravg / $data) * 100, 2) 
                                            : 0;
                                        }
                                        if (in_array($picklistval->formula, ['percentage'])) {
                                           $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data%");
                                        } else {
                                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data");
                                        }
                                        if ($reporttype == 'Excel') {
                                            $tableBodyRowIndex = $row - $bodyStartRow + 1;
                                            $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
                                            $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($styleToApply);
                                            $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                                        }
                                        $column++;
                                    }
                                }
                            }else{
                                if ($v->aggregatecolumns_calculation_type != 'Column_Percentage' && in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                                    $columnKey = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                                } else {
                                    $columnKey = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                                }
                                if ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                                    if (!empty($sources[$status . '_' . $columnKey]) && $sources[$status . '_' . $columnKey] != 0) {
                                        $data = ($sources[$status . '_' . $columnKey] / $sources[$columnKey]) * 100;
                                    } else {
                                        $data = 0;
                                    }
                                } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                                    $totalSeconds = $sources[$status . '_' . $columnKey] ?? 0;
                                    $hours = floor($totalSeconds / 3600);
                                    $minutes = floor(($totalSeconds % 3600) / 60);
                                    $seconds = $totalSeconds % 60;
                                    $data = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                                } else {
                                    $data = round($sources[$status . '_' . $columnKey] ?? 0, 2);
                                }
                                if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data%");
                                } else {
                                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data");
                                }
                                if ($reporttype == 'Excel') {
                                    $tableBodyRowIndex = $row - $bodyStartRow + 1;
                                    $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
                                    $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($styleToApply);
                                    $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                                }
                                $column++;
                            }
                           
                        }
                    }
                    if ($reportdetails[0]->expand_group_count == 1) {
                        $data = round($sources['Total'] ?? 0, 2);
                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data");
                        if ($reporttype == 'Excel') {
                            $tableBodyRowIndex = $row - $bodyStartRow + 1;
                            $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
                            $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($styleToApply);
                            $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                        }
                        $column++;
                    }
                    foreach ($reportall['aggregatecolumns'] as $k => $v) {
                        if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                            $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                            if(count($trackingdetails)){
                                $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                foreach($picklist_data as $picklistval){
                                    $columnKey ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                    $data = $sources[$columnKey] ?? 0;
                                    $peravg=$sources[$columnKey.'_total'] ?? 0;
                                    if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                        $data=(new AdvancedReport())->getPicklistTrackingResult($data, $picklistval->formula,$peravg);
                                    }elseif($picklistval->formula=='percentage'){
                                        $data = round(($peravg / $sources['Total']) * 100, 2);
                                    }
                                    if (in_array($picklistval->formula, ['percentage'])) {
                                        $objPHPExcel->getActiveSheet()->setCellValue($column . $row, "$data%");
                                    } else {
                                        $objPHPExcel->getActiveSheet()->setCellValue($column . $row, "$data");
                                    }
                                    if ($reporttype == 'Excel') {
                                    $tableBodyRowIndex = $row - $bodyStartRow + 1;
                                    $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
                                        $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($styleToApply);
                                        $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                                    }
                                    $column++;
                                }
                            }
                        }else{
                            if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                                $columnKey = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                            } else {
                                $columnKey = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                            }
                            $data = $sources[$columnKey] ?? 0;
                            if ($v->aggregatecolumns_calculation_type == 'Column_Percentage') {
                                if (!empty($reportresult['GrandTotal']['GrandTotal'][$columnKey]) && $reportresult['GrandTotal']['GrandTotal'][$columnKey] != 0) {
                                    $data = round(($sources[$columnKey] / $reportresult['GrandTotal']['GrandTotal'][$columnKey]) * 100, 2);
                                } else {
                                    $data = 0;
                                }
                            } elseif ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                                if ($data != 0) {
                                    $data = ($data / $data) * 100;
                                } else {
                                    $data = 0;
                                }
                            } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                                $totalSeconds = $sources[$columnKey] ?? 0;
                                $hours = floor($totalSeconds / 3600);
                                $minutes = floor(($totalSeconds % 3600) / 60);
                                $seconds = $totalSeconds % 60;
                                $data = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                            }
                            if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                                $objPHPExcel->getActiveSheet()->setCellValue($column . $row, "$data%");
                            } else {
                                $objPHPExcel->getActiveSheet()->setCellValue($column . $row, "$data");
                            }
                            if ($reporttype == 'Excel') {
                            $tableBodyRowIndex = $row - $bodyStartRow + 1;
                            $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
                                $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($styleToApply);
                                $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                            }
                            $column++;
                        }
                    }
                    $row++;
                } else {
                    $row = $this->getExcellReportContent('A', $objPHPExcel, $row, $reportresult['body'], $sources, 1, $medium, '', $reportresult, $tablestyle, $reportdetails, $reportall, $medium, $bodyCellStyle, $tableborder, 0, $bodyStartRow, $oddRowStyle, $evenRowStyle);

                    if ($reportdetails[0]->expand_sub_total == 1) {
                        $isData = (new AdvancedReport())->TotalDataSumArray($reportresult['countgroupbyrow'], $sources);
                        $firstColumnLetter = $this->getColumnLetter(1);
                        $lastGroupByColumnLetter = $this->getColumnLetter($reportresult['countgroupbyrow']);
                        $column = $lastGroupByColumnLetter;
                        $objPHPExcel->getActiveSheet()
                            ->mergeCells($firstColumnLetter . $row . ':' . $lastGroupByColumnLetter . $row)
                            ->setCellValue($firstColumnLetter . $row, 'Sub Total');
                        $objPHPExcel->getActiveSheet()->getStyle($firstColumnLetter . $row . ':' . $lastGroupByColumnLetter . $row)->applyFromArray($FooterCellStyle);
                        $objPHPExcel->getActiveSheet()->getStyle($firstColumnLetter . $row . ':' . $lastGroupByColumnLetter . $row)->applyFromArray($tableborder);
                        $column++;
                        $lastGroupByColumnLetter = $this->getColumnLetter($reportresult['countgroupbyrow']);
                        foreach ($reportresult['groupbycol'] as $status) {
                            if ($reportdetails[0]->expand_group_count == 1) {
                                $data1 = round($isData[$status] ?? 0, 2);
                                $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data1");
                                $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($FooterCellStyle);
                                $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                                $column++;
                            }
    
                            foreach ($reportall['aggregatecolumns'] as $k => $v) {
                                if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                                    $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                                    if(count($trackingdetails)){
                                        $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                        foreach($picklist_data as $picklistval){
                                            $columnKey ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                            $data2 = round($isData[$status . '_' . $columnKey] ?? 0, 2);
                                            $peravg=$isData[$status.'_'.$columnKey.'_total'] ?? 0;
                                            if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                                $data2=(new AdvancedReport())->getPicklistTrackingResult($data2, $picklistval->formula,$peravg);
                                            }elseif($picklistval->formula=='percentage'){
                                                $data2 = ($data2 ?? 0) > 0 
                                                ? round(( $peravg / $data2) * 100, 2) 
                                                : 0;
                                            }
                                            if (in_array($picklistval->formula, ['percentage'])) {
                                                  $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data2%");
                                            } else {
                                                $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data2");
                                            }
                                            $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($FooterCellStyle);
                                            $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                                            $column++;
                                        }
                                    }
                                }else{
                                    if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                                        $columnKey = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                                    } else {
                                        $columnKey = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                                    }
                                    if ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                                        $denominator = $isData[$status . '_' . $columnKey];
                                        if ($denominator != 0) {
                                            $data2 = round(($denominator / $isData[$columnKey]) * 100, 2);
                                        } else {
                                            $data2 = 0;
                                        }
                                    } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                                        $totalSeconds = $isData[$status . '_' . $columnKey] ?? 0;
                                        $hours = floor($totalSeconds / 3600);
                                        $minutes = floor(($totalSeconds % 3600) / 60);
                                        $seconds = $totalSeconds % 60;
                                        $data2 = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                                    } else {
                                        $data2 = round($isData[$status . '_' . $columnKey] ?? 0, 2);
                                    }
                                    if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data2%");
                                    } else {
                                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data2");
                                    }
                                    $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($FooterCellStyle);
                                    $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                                    $column++;
                                }
                            }
                        }
                        if ($reportdetails[0]->expand_group_count == 1) {
                            $data3 = round($isData['Total'] ?? 0, 2);
                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data3");
                            $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($FooterCellStyle);
                            $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                            $column++;
                        }
    
                        foreach ($reportall['aggregatecolumns'] as $k => $v) {
                            if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                                $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                                if(count($trackingdetails)){
                                     $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                    foreach($picklist_data as $picklistval){
                                        $columkey ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                        $data4 = round($isData[$columkey], 2);
                                        $peravg=$isData[$columkey.'_total'] ?? 0;
                                        if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                            $data4=(new AdvancedReport())->getPicklistTrackingResult($data4, $picklistval->formula,$peravg);
                                        }elseif($picklistval->formula=='percentage'){
                                            $data4 = round(($peravg / $isData['Total']) * 100, 2);
                                        }
                                        if (in_array($picklistval->formula, ['percentage'])) {
                                               $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data4%");
                                        } else {
                                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data4");
                                        }
                                        $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($FooterCellStyle);
                                        $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                                        $column++;
                                    }
                                }
                            }else{
                                if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                                    $columkey = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                                } else {
                                    $columkey = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                                }
                                if ($v->aggregatecolumns_calculation_type == 'Column_Percentage') {
                                    $grandTotal = $reportresult['GrandTotal']['GrandTotal'][$columkey];
                                    if ($grandTotal != 0) {
                                        $data4 = round(($isData[$columkey] / $grandTotal) * 100, 2);
                                    } else {
                                        $data4 = 0;
                                    }
                                } elseif ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                                    $denominator = $reportresult['GrandTotal']['GrandTotal'][$columkey];
                                    if ($denominator != 0) {
                                        $data4 = round(($denominator / $denominator) * 100, 2);
                                    } else {
                                        $data4 = 0;
                                    }
                                } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                                    $totalSeconds = $isData[$columkey] ?? 0;
                                    $hours = floor($totalSeconds / 3600);
                                    $minutes = floor(($totalSeconds % 3600) / 60);
                                    $seconds = $totalSeconds % 60;
                                    $data4 = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                                } else {
                                    $data4 = round($isData[$columkey], 2);
                                }
                                if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data4%");
                                } else {
                                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue($column . $row, "$data4");
                                }
                                $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($FooterCellStyle);
                                $objPHPExcel->getActiveSheet()->getStyle($column . $row)->applyFromArray($tableborder);
                                $column++;
                            }
                        }
                        $row++;
                    }
                }
            }
    
            if ($reportdetails[0]->expand_grand_total == 1) {
                $columnIndex = 0;
                $firstColumnLetter = $this->getColumnLetter(1);
                $lastGroupByColumnLetter = $this->getColumnLetter($reportresult['countgroupbyrow']);
                $objPHPExcel->getActiveSheet()
                    ->mergeCells($firstColumnLetter . $row . ':' . $lastGroupByColumnLetter . $row)
                    ->setCellValue($firstColumnLetter . $row, 'Grand Total');
                $objPHPExcel->getActiveSheet()->getStyle($firstColumnLetter . $row . ':' . $lastGroupByColumnLetter . $row)->applyFromArray($FooterCellStyle);
                $objPHPExcel->getActiveSheet()->getStyle($firstColumnLetter . $row . ':' . $lastGroupByColumnLetter . $row)->applyFromArray($tableborder);
                foreach ($reportresult['groupbyaggrecol'] as $defaultKey) {
                    if (isset($reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey])) {
                        foreach ($reportall['aggregatecolumns'] as $k => $v) {
                            if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                                $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                            } else {
                                $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                            }
                        }
                        $columnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                        if (strpos($defaultKey, 'Column_Percentage') !== false) {
                            $denominator = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                            if ($denominator != 0) {
                                $GrandTotal = round((($denominator / $denominator) * 100), 2);
                            } else {
                                $GrandTotal = 0;
                            }
                        } elseif (strpos($defaultKey, 'Row_Percentage') !== false) {
                            $gtotal = $reportresult['GrandTotal']['GrandTotal'][$column];
                            $datavale = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                            if ($datavale != 0) {
                                $GrandTotal = round((($datavale / $gtotal) * 100), 2);
                            } else {
                                $GrandTotal = 0;
                            }
                        } elseif (strpos($defaultKey, 'Sumhourcal') !== false) {
                            $totalSeconds = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                            $hours = floor($totalSeconds / 3600);
                            $minutes = floor(($totalSeconds % 3600) / 60);
                            $seconds = $totalSeconds % 60;
                            $GrandTotal = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                        }elseif (strpos($defaultKey,'picklisttracking_') !== false) {
                            if (strpos($defaultKey,'_sum_') !== false) {
                                $formula='sum';
                            }elseif (strpos($defaultKey,'_avg_time_') !== false) {
                                    $formula='avg_time';
                            }elseif (strpos($defaultKey,'_count_') !== false) {
                                    $formula='count';
                            }elseif (strpos($defaultKey,'_percentage_') !== false) {
                                    $formula='percentage';
                            }
                            $peravg=$Module->reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey.'_total'] ?? 0;
                             $peravg=$reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey.'_total'] ?? 0;
                            if($formula =='percentage'){
                                 $GrandTotal=round($peravg/$reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey]*100, 2);
                            }else{
                                $GrandTotal=round($reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey] ?? 0,2);
                                $GrandTotal=(new AdvancedReport())->getPicklistTrackingResult($GrandTotal, $formula,$peravg);
                            }
                        } else {
                            $GrandTotal = round($reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey] ?? 0, 2);
                        }
                        if (strpos($defaultKey, 'Column_Percentage') !== false || strpos($defaultKey, 'Row_Percentage') !== false || strpos($defaultKey,'_percentage_')) {
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$GrandTotal%");
                        } else {
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$GrandTotal");
                        }
                        $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($FooterCellStyle);
                        $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($tableborder);
                    } else {
                        if ($reportdetails[0]->expand_group_count == 1) {
                            $columnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                            $value = round($reportresult['GrandTotal']['GrandTotal'][$defaultKey] ?? 0, 2);
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$value");
                            $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($FooterCellStyle);
                            $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($tableborder);
                        }
                    }
                }
    
                if ($reportdetails[0]->expand_group_count == 1) {
                    $totalColumnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                    $totalValue = round($reportresult['GrandTotal']['GrandTotal']['Total'], 2);
                    $objPHPExcel->getActiveSheet()->setCellValue($totalColumnLetter . $row, "$totalValue");
                    $objPHPExcel->getActiveSheet()->getStyle($totalColumnLetter . $row)->applyFromArray($FooterCellStyle);
                    $objPHPExcel->getActiveSheet()->getStyle($totalColumnLetter . $row)->applyFromArray($tableborder);
                }
    
                foreach ($reportall['aggregatecolumns'] as $k => $v) {
                    if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                        $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                        if(count($trackingdetails)){
                             $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                            foreach($picklist_data as $picklistval){
                                $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                $finaltotal = round($reportresult['GrandTotal']['GrandTotal'][$column] ?? 0, 2);
                                $peravg=$reportresult['GrandTotal']['GrandTotal'][$column.'_total'] ?? 0;
                                if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                    $finaltotal=(new AdvancedReport())->getPicklistTrackingResult($finaltotal, $picklistval->formula,$peravg);
                                }elseif($picklistval->formula=='percentage'){
                                    $finaltotal = round(( $peravg / $reportresult['GrandTotal']['GrandTotal']['Total']) * 100, 2);
                                }
                                $columnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                                if (in_array($picklistval->formula, ['percentage'])) {
                                    $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$finaltotal%");
                                } else {
                                    $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$finaltotal");
                                }
                                $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($FooterCellStyle);
                                $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($tableborder);
                            }
                        }
                    }else{
                        $columnLetter = $this->getColumnLetter($reportresult['countgroupbyrow'] + ++$columnIndex);
                        if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                            $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                        } else {
                            $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                        }
                        if ($v->aggregatecolumns_calculation_type == 'Column_Percentage' || $v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                            $denominator = $reportresult['GrandTotal']['GrandTotal'][$column];
                            if ($denominator != 0) {
                                $finaltotal = round(($denominator / $denominator) * 100, 2);
                            } else {
                                $finaltotal = 0;
                            }
                        } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                            $totalSeconds = $reportresult['GrandTotal']['GrandTotal'][$column];
                            $hours = floor($totalSeconds / 3600);
                            $minutes = floor(($totalSeconds % 3600) / 60);
                            $seconds = $totalSeconds % 60;
                            $finaltotal = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                        } else {
                            $finaltotal = round($reportresult['GrandTotal']['GrandTotal'][$column] ?? 0, 2);
                        }
                        if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$finaltotal%");
                        } else {
                            $objPHPExcel->getActiveSheet()->setCellValue($columnLetter . $row, "$finaltotal");
                        }
                        $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($FooterCellStyle);
                        $objPHPExcel->getActiveSheet()->getStyle($columnLetter . $row)->applyFromArray($tableborder);
                    }
                }
                foreach (range(1, $columnIndex) as $i) {
                    $columnLetter = $this->getColumnLetter($i);
                    $objPHPExcel->getActiveSheet()->getColumnDimension($columnLetter)->setAutoSize(true);
                }
            }
    
            // Save the file
            $sheetName = $originalReportName;
            $sheetName = preg_replace('/[\\\\\\/\\?\\*\\[\\]]/', '', $sheetName);
            $sheetName = preg_replace('/\s+/', '', $sheetName);
            $sheetName = trim($sheetName);
            $sheetName = mb_substr($sheetName, 0, 31);
            $objPHPExcel->getActiveSheet()->setTitle($sheetName);
            $objPHPExcel->setActiveSheetIndex(0);
            if ($accessmode == 'SendMail') {
                $dirname = public_path() . '/AdvancedReport';
                if (!file_exists($dirname)) {
                    mkdir($dirname, 0777, true);
                }
                if ($reporttype == 'CSV') {
                    $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'CSV');
                    $objWriter->setDelimiter(',');
                    $objWriter->setEnclosure('"');
                    $objWriter->setLineEnding("\r\n");
                    $objWriter->setUseBOM(true);
                } elseif ($reporttype == 'Excel') {
                    $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');
                }
                $objWriter->save($dirname . '/' . $filename);
            } else {
                if ($reporttype == 'CSV') {
                    header('Content-Type: text/csv; charset=UTF-8');
                    header('Content-Disposition: attachment; filename="' . $filename . '"');
                    header('Cache-Control: max-age=0');
                    header('Expires: 0');
                    header('Pragma: public');
                    $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'CSV');
                    $objWriter->setDelimiter(',');
                    $objWriter->setEnclosure('"');
                    $objWriter->setLineEnding("\r\n");
                    $objWriter->setUseBOM(true);
                } elseif ($reporttype == 'Excel') {
                    header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
                    header('Content-Disposition: attachment; filename="' . $filename . '"');
                    header('Cache-Control: max-age=0');
                    header('Expires: 0');
                    header('Pragma: public');
                    $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');
                }
                $objWriter->save('php://output');
                exit;
            }
        }
    }

function getExcellReportContent($column, $objPHPExcel, $row, $Org, $Data, $currentMedium, $keyValue, $keyValue1, $reportresult, $tablestyle, $reportdetails, $reportall, $medium, $bodyCellStyle, $tableborder, $count, $bodyStartRow, $oddRowStyle = [], $evenRowStyle = [])
{
    $count++;
    $isGroupByColumnsEmpty = empty($reportresult['groupbycol']);// Check if "Group by Columns" is empty
    $countAllValues = [];
    foreach ($Data as $source => $statusCounts) {
        $isMultiArray = (new AdvancedReport())->isMultiArray($statusCounts);
        if (is_array($statusCounts)) {
            if ($reportresult['countgroupbyrow'] == 2) {
                $countAllValues = (new AdvancedReport())->count2LevelArrays($Org) ?? [];
            } elseif ($reportresult['countgroupbyrow'] == 4) {
                $countAllValues = (new AdvancedReport())->count4LevelArrays($Org) ?? [];
            } elseif ($reportresult['countgroupbyrow'] == 5) {
                $countAllValues = (new AdvancedReport())->count5LevelArrays($Org) ?? [];
            } elseif ($reportresult['countgroupbyrow'] > 6) {
                $countAllValues = (new AdvancedReport())->count5LevelArrays($Data) ?? [];
            } else {
                $countAllValues = (new AdvancedReport())->count3LevelArrays($Org) ?? [];
            }
        }
        if ($isMultiArray == 1) {
            $currentSource = true;
            if ($currentMedium) {
                $rowcount = $countAllValues[$keyValue] ?? 1;
                $mergecount = ($rowcount + $row) - 1;
                $objPHPExcel->setActiveSheetIndex(0)->mergeCells("$column$row:$column$mergecount")->setCellValue($column . $row, "$keyValue");
                $tableBodyRowIndex = $row - $bodyStartRow + 1;
                $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
               
                $objPHPExcel->getActiveSheet()->getStyle("$column$row:$column$mergecount")->applyFromArray($styleToApply);
                $objPHPExcel->getActiveSheet()->getStyle("$column$row:$column$mergecount")->applyFromArray($tableborder);
                $currentMedium = false;
                $column = $this->getNextColumnLetter($column);
            }
            $localSession[$count] = $source;
            $rowspanValue = 1;
            if ($count != 2 && isset($countAllValues[$medium . '_' . ($localSession[1] ?? '') . '_' . $keyValue1 . '_' . $source])) {
                $rowspanValue = $countAllValues[$medium . '_' . ($localSession[1] ?? '') . '_' . $keyValue1 . '_' . $source];
            } elseif (isset($countAllValues[$medium . '_' . ($localSession[1] ?? '') . '_' . ($localSession[2] ?? '')])) {
                $rowspanValue = $countAllValues[$medium . '_' . ($localSession[1] ?? '') . '_' . ($localSession[2] ?? '')];
            } elseif (isset($countAllValues[$medium . '_' . ($localSession[1] ?? '') . '_' . ($localSession[2] ?? '') . '_' . ($localSession[3] ?? '')])) {
                $rowspanValue = $countAllValues[$medium . '_' . ($localSession[1] ?? '') . '_' . ($localSession[2] ?? '') . '_' . ($localSession[3] ?? '')];
            } elseif (isset($countAllValues[$medium . '_' . $keyValue1 . '_' . $source])) {
                $rowspanValue = $countAllValues[$medium . '_' . $keyValue1 . '_' . $source];
            } elseif (isset($countAllValues[$medium . '_' . $source])) {
                $rowspanValue = $countAllValues[$medium . '_' . $source];
            } elseif (isset($countAllValues[$source])) {
                $rowspanValue = $countAllValues[$source];
            }
            if ($currentSource) {
                if ($reportresult['countgroupbyrow'] == 4) {
                    if ($count == 1) {
                        $column = $this->getColumnLetter(($reportresult['countgroupbyrow'] - 2));
                    } elseif ($count == 2) {
                        $column = $this->getColumnLetter(($reportresult['countgroupbyrow'] - 1));
                    }
                } elseif ($reportresult['countgroupbyrow'] == 5) {
                    if ($count == 1) {
                        $column = $this->getColumnLetter(($reportresult['countgroupbyrow'] - 3));
                    } elseif ($count == 2) {
                        $column = $this->getColumnLetter(($reportresult['countgroupbyrow'] - 2));
                    } elseif ($count == 3) {
                        $column = $this->getColumnLetter(($reportresult['countgroupbyrow'] - 1));
                    }
                }
                $mergecount = ($rowspanValue + $row) - 1;
                $objPHPExcel->setActiveSheetIndex(0)->mergeCells("$column$row:$column$mergecount")->setCellValue($column . $row, "$source");
                $tableBodyRowIndex = $row - $bodyStartRow + 1;
                $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
               
                $objPHPExcel->getActiveSheet()->getStyle("$column$row:$column$mergecount")->applyFromArray($styleToApply);
                $objPHPExcel->getActiveSheet()->getStyle("$column$row:$column$mergecount")->applyFromArray($tableborder);
                $currentSource = false;
            }
            $row = $this->getExcellReportContent($column, $objPHPExcel, $row, $Org, $statusCounts, $currentMedium, $keyValue, $source, $reportresult, $tablestyle, $reportdetails, $reportall, $medium, $bodyCellStyle, $tableborder, $count, $bodyStartRow, $oddRowStyle, $evenRowStyle);
        } else {
            $currentSource = true;
            $column = $this->getColumnLetter(($reportresult['countgroupbyrow'] - 1));
            $tableBodyRowIndex = $row - $bodyStartRow + 1;
            $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
 
         
            $startColumn = $column;
            $endColumn = $startColumn;
            if (!$isGroupByColumnsEmpty) {
                $endColumn = $this->getNextColumnLetter($endColumn, count($reportresult['groupbycol']));
                foreach ($reportall['aggregatecolumns'] as $v) {
                    $endColumn = $this->getNextColumnLetter($endColumn);
                }
                if ($reportdetails[0]->expand_group_count == 1) {
                    $endColumn = $this->getNextColumnLetter($endColumn);
                }
            }
 
            // Apply style to all cells in the row, including empty ones
            $objPHPExcel->getActiveSheet()->getStyle("$startColumn$row:$endColumn$row")->applyFromArray($styleToApply);
            $objPHPExcel->getActiveSheet()->getStyle("$startColumn$row:$endColumn$row")->applyFromArray($tableborder);
 
            if ($currentMedium) {
                $mergecount = (is_array($countAllValues) && isset($countAllValues[$medium]) ? $countAllValues[$medium] : 1) + $row - 1;
                $objPHPExcel->setActiveSheetIndex(0)->mergeCells("$column$row:$column$mergecount")->setCellValue($column . $row, "$medium");
                $objPHPExcel->getActiveSheet()->getStyle("$column$row:$column$mergecount")->applyFromArray($styleToApply);
                $objPHPExcel->getActiveSheet()->getStyle("$column$row:$column$mergecount")->applyFromArray($tableborder);
                $currentMedium = false;
            }
            $rowcolum = $this->getNextColumnLetter($column);
            if ($currentSource) {
                $objPHPExcel->setActiveSheetIndex(0)->setCellValue($rowcolum . $row, "$source");
                $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($styleToApply);
                $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($tableborder);
                $currentSource = false;
                $rowcolum = $this->getNextColumnLetter($rowcolum);
            }
            foreach ($reportresult['groupbycol'] as $status) {
                if ($reportdetails[0]->expand_group_count == 1) {
                    $data = round($statusCounts[$status] ?? 0, 2);
                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue($rowcolum . $row, "$data");
                    $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($styleToApply);
                    $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($tableborder);
                    $rowcolum = $this->getNextColumnLetter($rowcolum);
                }
                foreach ($reportall['aggregatecolumns'] as $k => $v) {
                    if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                        $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                        if(count($trackingdetails)){
                            $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                            foreach($picklist_data as $picklistval){
                                $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                $data = $statusCounts[$status . '_' . $column] ?? 0;
                                $peravg=$statusCounts[$status.'_'.$column.'_total'] ?? 0;
                                if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                    $data=(new AdvancedReport())->getPicklistTrackingResult($data, $picklistval->formula,$peravg);
                                }elseif($picklistval->formula=='percentage'){
                                    $data = ($data ?? 0) > 0 
                                    ? round(($peravg / $data) * 100, 2) 
                                    : 0;
                                }
                                $objPHPExcel->setActiveSheetIndex(0)->setCellValue($rowcolum . $row, in_array($picklistval->formula, ['percentage']) ? "$data%" : "$data");
                                $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($styleToApply);
                                $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($tableborder);
                                $rowcolum = $this->getNextColumnLetter($rowcolum);
                            }
                        }
                    }else{
                    
                        if ($v->aggregatecolumns_calculation_type != 'Column_Percentage' && in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                            $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                        } else {
                            $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                        }
                        if ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                            $denominator = $statusCounts[$status . '_' . $column] ?? 0;
                            $data = $denominator != 0 ? round(($statusCounts[$status . '_' . $column] / $statusCounts[$column]) * 100, 2) : 0;
                        } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                            $totalSeconds = $statusCounts[$status . '_' . $column] ?? 0;
                            $hours = floor($totalSeconds / 3600);
                            $minutes = floor(($totalSeconds % 3600) / 60);
                            $seconds = $totalSeconds % 60;
                            $data = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                        } else {
                            $data = round($statusCounts[$status . '_' . $column] ?? 0, 2);
                        }
                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue($rowcolum . $row, in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage']) ? "$data%" : "$data");
                        $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($styleToApply);
                        $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($tableborder);
                        $rowcolum = $this->getNextColumnLetter($rowcolum);
                    }
                }
            }
            if ($reportdetails[0]->expand_group_count == 1) {
                $data = round($statusCounts['Total'] ?? 0, 2);
                $objPHPExcel->setActiveSheetIndex(0)->setCellValue($rowcolum . $row, "$data");
                $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($styleToApply);
                $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($tableborder);
                $rowcolum = $this->getNextColumnLetter($rowcolum);
            }
            foreach ($reportall['aggregatecolumns'] as $k => $v) {
                if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                    $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                    if(count($trackingdetails)){
                         $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                        foreach($picklist_data as $picklistval){
                            $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                             $data = $statusCounts[$column] ?? 0;
                             $peravg=$statusCounts[$column.'_total'] ?? 0;
                            if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                $data=(new AdvancedReport())->getPicklistTrackingResult($data, $picklistval->formula,$peravg);
                            }elseif($picklistval->formula=='percentage'){
                                $data = round(($peravg / $statusCounts['Total']) * 100, 2);
                            }
                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue($rowcolum . $row, in_array($picklistval->formula, ['percentage']) ? "$data%" : "$data");
                            $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($styleToApply);
                            $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($tableborder);
                            $rowcolum = $this->getNextColumnLetter($rowcolum);
                        }
                    }
                }else{
                    if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                        $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                    } else {
                        $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                    }
                    $data = round($statusCounts[$column] ?? 0, 2);
                    if ($v->aggregatecolumns_calculation_type == 'Column_Percentage') {
                        $data = (!empty($reportresult['GrandTotal']['GrandTotal'][$column]) && $reportresult['GrandTotal']['GrandTotal'][$column] != 0) ? ($statusCounts[$column] / $reportresult['GrandTotal']['GrandTotal'][$column]) * 100 : 0;
                        $data = round($data, 2);
                    } elseif ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                        $data = ($data != 0) ? ($data / $data) * 100 : 0;
                    } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                        $totalSeconds = $data;
                        $data = sprintf('%02d:%02d', floor($totalSeconds / 3600), floor(($totalSeconds % 3600) / 60));
                    }
                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue($rowcolum . $row, in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage']) ? "$data%" : "$data");

                    $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($styleToApply);
                    $objPHPExcel->getActiveSheet()->getStyle($rowcolum . $row)->applyFromArray($tableborder);
                    $rowcolum = $this->getNextColumnLetter($rowcolum);
                }
            }
            $row++;
        }
    }
    return $row;
}


  
    
public function getGroupDownloadPDFReport($report_id, $reportall, $reportdetails, $accessmode,$reporttype) {
// Increase memory limit for large PDFs
    ini_set('memory_limit', '512M');
    ini_set('pcre.backtrack_limit', '2000000');
    $reportresult = $reportall['reportresult'];
    $tablestyle = DB::table('rsoft_advanced_report_tablestyle')->where('report_id', $report_id)->get();
    $tablestyle = $this->getTablestyle($tablestyle);

    // CSS with footer-row class
    $html = '<style>
        .all-borders td, .all-borders th {
            border: 2px solid ' . $tablestyle['tborder_color'] . ' !important;
        }
        .bottom-borders td, .bottom-borders th {
            border-bottom: none !important;
        }
        .bottom-borders tr:last-child td, .bottom-borders tr:last-child th {
            border-bottom: 2px solid ' . $tablestyle['tborder_color'] . ' !important;
        }
        .inner-borders td, .inner-borders th {
            border: 1px solid transparent !important;
            position: relative;
        }
        .inner-borders td:after, .inner-borders th:after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 2px;
            background: ' . $tablestyle['tborder_color'] . ' !important;
        }
        .inner-borders td:before, .inner-borders th:before {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: ' . $tablestyle['tborder_color'] . ' !important;
            left: 0;
        }
        .inner-borders tr:last-child td:after, .inner-borders tr:last-child th:after {
            border-bottom: none !important;
        }
        .inner-borders td:last-child:before, .inner-borders th:last-child:before {
            border-right: none !important;
        }
        .outer-borders {
            border: 2px solid ' . $tablestyle['tborder_color'] . ' !important;
            border-collapse: collapse !important;
        }
        .outer-borders td, .outer-borders th {
            border: none !important;
        }
        .left-borders td, .left-borders th {
            border-left: none !important;
        }
        .left-borders td:first-child, .left-borders th:first-child {
            border-left: 2px solid ' . $tablestyle['tborder_color'] . ' !important;
        }
        .right-borders td, .right-borders th {
            border-right: none !important;
        }
        .right-borders td:last-child, .right-borders th:last-child {
            border-right: 2px solid ' . $tablestyle['tborder_color'] . ' !important;
        }
        .no-borders td, .no-borders th {
            border: none;
        }
        .bodycss {
            ' . $tablestyle['pdfbstyle'] . ';
        }
        /* Odd and even row styles */
        .' . $tablestyle['tstyle'] . ' tbody tr:nth-child(odd) td {
            background-color: ' . $tablestyle['oddrowcolor'] . ' !important;
        }
        .' . $tablestyle['tstyle'] . ' tbody tr:nth-child(even) td {
            background-color: ' . $tablestyle['evenrowcolor'] . ' !important;
        }
        /* Footer row style */
        .' . $tablestyle['tstyle'] . ' tbody tr.footer-row td {
            ' . $tablestyle['pdffstyle'] . ' !important;
        }
    </style>';

    if (isset($reportresult['body']) && count($reportresult['body'])) {
        $AllUsers = (new User())->GettingAllUsers();
        $html .= '<div style="text-align:center;font-size:18px;font-weight:bold;">' . htmlspecialchars($reportdetails[0]->report_name) . '</div><br/>';
        $ConditionsInfo = $this->getFilterConditionsInfo($report_id);
        if ($ConditionsInfo != '') {
            $html .= '<div style="text-align:center;font-size:14px;font-weight:bold;">' . htmlspecialchars($ConditionsInfo) . '</div><br/>';
        }
        if (!empty($reportdetails[0]->description)) {
            $html .= '<div style="text-align:center;font-size:14px;font-weight:bold;">Description: ' . htmlspecialchars($reportdetails[0]->description) . '</div><br/>';
        }
        $html .= '<table class="table table-bordered ' . $tablestyle['tstyle'] . '" style="width:100%;"><thead>';
        if (count($reportall['groupbycolumns'])) {
            $groupbycolumns = $reportall['groupbycolumns'][0];
            $html .= '<tr><th style="' . $tablestyle['pdfhstyle'] . '" colspan="' . $reportresult['countgroupbyrow'] . '">' . htmlspecialchars($reportresult['labelgroupbycol']) . '</th>';
            foreach ($reportresult['groupbycol'] as $groupbycol) {
                if (in_array($groupbycolumns->groupbycolumns_fieldtype, [13, 14, 15])) {
                    if ($groupbycol != 'Empty') {
                        $groupbycol = $AllUsers[$groupbycol]['users_firstname'] . ' ' . $AllUsers[$groupbycol]['users_lastname'];
                    }
                }
                $html .= '<th style="' . $tablestyle['pdfhstyle'] . '" colspan="' . $reportresult['aggregatecolumns'] . '">' . htmlspecialchars($groupbycol) . '</th>';
            }
            $html .= '<th style="' . $tablestyle['pdfhstyle'] . '" colspan="' . $reportresult['aggregatecolumns'] . '">Grand Total</th>';
            $html .= '</tr>';
        }
        $html .= '<tr>';
        foreach ($reportresult['labelgroupbyrow'] as $groupbyrow) {
            $html .= '<th style="' . $tablestyle['pdfhstyle'] . '">' . htmlspecialchars($groupbyrow) . '</th>';
        }
        $html .= '</tr>';
        $html .= '</thead><tbody>';

        if ($reportdetails[0]->expand_grand_total == 0) {
            // Add footer-row class for Grand Total
            $html .= '<tr class="footer-row" style="' . $tablestyle['pdffstyle'] . '"><td colspan="' . $reportresult['countgroupbyrow'] . '">Grand Total</td>';
            foreach ($reportresult['groupbyaggrecol'] as $defaultKey) {
                if (isset($reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey])) {
                    foreach ($reportall['aggregatecolumns'] as $k => $v) {
                        if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                            $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                        } else {
                            $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                        }
                    }
                    if (strpos($defaultKey, 'Column_Percentage') !== false) {
                        $denominator = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                        $GrandTotal = ($denominator != 0) ? round(($denominator / $denominator) * 100, 2) : 0;
                    } elseif (strpos($defaultKey, 'Row_Percentage') !== false) {
                        $gtotal = $reportresult['GrandTotal']['GrandTotal'][$column];
                        $datavale = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                        $GrandTotal = ($datavale != 0) ? round(($datavale / $gtotal) * 100, 2) : 0;
                    } elseif (strpos($defaultKey, 'Sumhourcal') !== false) {
                        $totalSeconds = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                        $hours = floor($totalSeconds / 3600);
                        $minutes = floor(($totalSeconds % 3600) / 60);
                        $seconds = $totalSeconds % 60;
                        $GrandTotal = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                    }elseif (strpos($defaultKey,'picklisttracking_') !== false) {
                        if (strpos($defaultKey,'_sum_') !== false) {
                            $formula='sum';
                        }elseif (strpos($defaultKey,'_avg_time_') !== false) {
                            $formula='avg_time';
                        }elseif (strpos($defaultKey,'_count_') !== false) {
                            $formula='count';
                        }elseif (strpos($defaultKey,'_percentage_') !== false) {
                            $formula='percentage';
                        }
                        $peravg=$reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey.'_total'] ?? 0;
                        if($formula =='percentage'){
                                $GrandTotal=round($peravg/$reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey]*100, 2);
                        }else{
                            $GrandTotal=round($reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey] ?? 0,2);
                            $GrandTotal=(new AdvancedReport())->getPicklistTrackingResult($GrandTotal, $formula,$peravg);
                        }
                    } else {
                        $GrandTotal = round($reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey] ?? 0, 2);
                    }
                    $html .= '<td class="bodycss">' . htmlspecialchars($GrandTotal);
                    if (strpos($defaultKey, 'Column_Percentage') !== false || strpos($defaultKey, 'Row_Percentage') !== false || strpos($defaultKey, 'percentage') !== false) {
                        $html .= '%';
                    }
                    $html .= '</td>';
                } else {
                    if ($reportdetails[0]->expand_group_count == 1) {
                        $html .= '<td class="bodycss">' . round($reportresult['GrandTotal']['GrandTotal'][$defaultKey] ?? 0, 2) . '</td>';
                    }
                }
            }
            if ($reportdetails[0]->expand_group_count == 1) {
                $html .= '<td class="bodycss">' . round($reportresult['GrandTotal']['GrandTotal']['Total'], 2) . '</td>';
            }
            foreach ($reportall['aggregatecolumns'] as $k => $v) {
                if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                        $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                        if(count($trackingdetails)){
                             $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                            foreach($picklist_data as $picklistval){
                                $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                $finaltotal = round($reportresult['GrandTotal']['GrandTotal'][$column] ?? 0, 2);
                                $peravg=$reportresult['GrandTotal']['GrandTotal'][$column.'_total'] ?? 0;
                                if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                    $finaltotal=(new AdvancedReport())->getPicklistTrackingResult($finaltotal, $picklistval->formula,$peravg);
                                }elseif($picklistval->formula=='percentage'){
                                    $finaltotal = round(( $peravg / $reportresult['GrandTotal']['GrandTotal']['Total']) * 100, 2);
                                }
                                $html .= '<td class="bodycss">' . ($finaltotal ?? 0);
                                if (in_array($picklistval->formula, ['percentage'])) {
                                    $html .= '%';
                                }
                                $html .= '</td>';
                            }
                        }
                }else{
                    if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                        $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                    } else {
                        $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                    }
                    if ($v->aggregatecolumns_calculation_type == 'Column_Percentage' || $v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                        $denominator = round($reportresult['GrandTotal']['GrandTotal'][$column], 2);
                        $finaltotal = ($denominator != 0) ? ($denominator / $denominator) * 100 : 0;
                    } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                        $totalSeconds = $reportresult['GrandTotal']['GrandTotal'][$column];
                        $hours = floor($totalSeconds / 3600);
                        $minutes = floor(($totalSeconds % 3600) / 60);
                        $seconds = $totalSeconds % 60;
                        $finaltotal = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                    } else {
                        $finaltotal = round($reportresult['GrandTotal']['GrandTotal'][$column] ?? 0, 2);
                    }
                    $html .= '<td class="bodycss">' . htmlspecialchars($finaltotal);
                    if (strpos($column, 'Column_Percentage') !== false || strpos($column, 'Row_Percentage') !== false) {
                        $html .= '%';
                    }
                    $html .= '</td>';
                }
            }
            $html .= '</tr>';
        }
        $i=0;
        foreach ($reportresult['body'] as $medium => $sources) {
            $rowColor = ($i % 2 == 0) ? $tablestyle['evenrowcolor'] : $tablestyle['oddrowcolor'];
            $bstyle = 'style="background-color:' . $rowColor . ';' . $tablestyle['pdfbstyle'] . '"';
            if (count($reportall['groupbyrows']) == 1) {
                $html .= '<tr><td '.$bstyle.' rowspan="1">' . htmlspecialchars($medium) . '</td>';
                foreach ($reportresult['groupbycol'] as $status) {
                    if ($reportdetails[0]->expand_group_count == 1) {
                        $html .= '<td '.$bstyle.'>' . round($sources[$status] ?? 0, 2) . '</td>';
                    }
                    foreach ($reportall['aggregatecolumns'] as $k => $v) {
                        if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                            $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                            if(count($trackingdetails)){
                                $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                foreach($picklist_data as $picklistval){
                                    $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                    $datavalue = $sources[$status . '_' . $column] ?? 0;
                                    $peravg=$sources[$status.'_'.$column.'_total'] ?? 0;
                                    if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                        $datavalue=(new AdvancedReport())->getPicklistTrackingResult($datavalue, $picklistval->formula,$peravg);
                                    }elseif($picklistval->formula=='percentage'){
                                        $datavalue = ($datavalue ?? 0) > 0 
                                        ? round(($peravg / $datavalue) * 100, 2) 
                                        : 0;
                                    }
                                    $html .= '<td '.$bstyle.'>' . ($datavalue ?? 0);
                                    if (in_array($picklistval->formula, ['percentage'])) {
                                        $html .= '%';
                                    }
                                    $html .= '</td>';
                                }
                            }
                        }else{
                            if ($v->aggregatecolumns_calculation_type != 'Column_Percentage' && in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                                $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                            } else {
                                $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                            }
                            if ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                                $datavalue = (!empty($sources[$status . '_' . $column]) && $sources[$status . '_' . $column] != 0) ? round(($sources[$status . '_' . $column] / $sources[$column]) * 100, 2) : 0;
                            } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                                $totalSeconds = $sources[$status . '_' . $column] ?? 0;
                                $hours = floor($totalSeconds / 3600);
                                $minutes = floor(($totalSeconds % 3600) / 60);
                                $seconds = $totalSeconds % 60;
                                $datavalue = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                            } else {
                                $datavalue = round($sources[$status . '_' . $column] ?? 0, 2);
                            }
                            $html .= '<td '.$bstyle.'>' . htmlspecialchars($datavalue);
                            if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                                $html .= '%';
                            }
                            $html .= '</td>';
                        }
                    }
                }
                if ($reportdetails[0]->expand_group_count == 1) {
                    $html .= '<td '.$bstyle.'>' . round($sources['Total'] ?? 0, 2) . '</td>';
                }
                foreach ($reportall['aggregatecolumns'] as $k => $v) {
                    if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                        $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                        if(count($trackingdetails)){
                            $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                            foreach($picklist_data as $picklistval){
                                $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                $percentage = $sources[$column] ?? 0;
                                $peravg=$sources[$column.'_total'] ?? 0;
                                if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                    $percentage=(new AdvancedReport())->getPicklistTrackingResult($percentage, $picklistval->formula,$peravg);
                                }elseif($picklistval->formula=='percentage'){
                                    $percentage = round(($peravg / $sources['Total']) * 100, 2);
                                }
                                $html .= '<td '.$bstyle.'>' . ($percentage ?? 0);
                                if (in_array($picklistval->formula, ['percentage'])) {
                                    $html .= '%';
                                }
                                $html .= '</td>';
                            }
                        }
                    }else{
                        if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                            $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                        } else {
                            $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                        }
                        $percentage = $sources[$column] ?? 0;
                        if ($v->aggregatecolumns_calculation_type == 'Column_Percentage') {
                            $percentage = (!empty($reportresult['GrandTotal']['GrandTotal'][$column]) && $reportresult['GrandTotal']['GrandTotal'][$column] != 0) ? round(($sources[$column] / $reportresult['GrandTotal']['GrandTotal'][$column]) * 100, 2) : 0;
                        } elseif ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                            $percentage = ($percentage != 0) ? round(($percentage / $percentage) * 100, 2) : 0;
                        } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                            $totalSeconds = $sources[$column] ?? 0;
                            $hours = floor($totalSeconds / 3600);
                            $minutes = floor(($totalSeconds % 3600) / 60);
                            $seconds = $totalSeconds % 60;
                            $percentage = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                        }
                        $html .= '<td '.$bstyle.'>' . htmlspecialchars($percentage);
                        if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                            $html .= '%';
                        }
                        $html .= '</td>';
                    }
                }
                $html .= '</tr>';
            } else {
                $html .= $this->getReportContent($reportresult['body'], $sources, $currentMedium = 1, $medium, $keyValue1 = '', $reportresult, $tablestyle, $reportdetails, $reportall, $medium, 'start', $count = 0,$bstyle,$i);
                if ($reportdetails[0]->expand_sub_total == 1) {
                    // Add footer-row class for Sub Total
                    $html .= '<tr class="footer-row" style="' . $tablestyle['pdffstyle'] . '"><td colspan="' . $reportresult['countgroupbyrow'] . '">Sub Total</td>';
                    $isData = (new AdvancedReport())->TotalDataSumArray($reportresult['countgroupbyrow'], $sources);
                    foreach ($reportresult['groupbycol'] as $status) {
                        $html .= '<td class="bodycss">' . round($isData[$status] ?? 0, 2) . '</td>';
                        foreach ($reportall['aggregatecolumns'] as $k => $v) {
                            if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                                $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                                if(count($trackingdetails)){
                                    $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                    foreach($picklist_data as $picklistval){
                                        $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                        $datavalue = round($isData[$status . '_' . $column] ?? 0, 2);
                                        $peravg=$isData[$status.'_'.$column.'_total'] ?? 0;
                                        if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                            $datavalue=(new AdvancedReport())->getPicklistTrackingResult($datavalue, $picklistval->formula,$peravg);
                                        }elseif($picklistval->formula=='percentage'){
                                            $datavalue = ($datavalue ?? 0) > 0 
                                            ? round(( $peravg / $datavalue) * 100, 2) 
                                            : 0;
                                        }
                                        $html .= '<td class="bodycss">' . ($datavalue ?? 0);
                                        if (in_array($picklistval->formula, ['percentage'])) {
                                            $html .= '%';
                                        }
                                        $html .= '</td>';
                                    }
                                }
                            }else{
                                $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                                if ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                                    $denominator = $isData[$status . '_' . $column];
                                    $datavalue = ($denominator != 0) ? round(($denominator / $isData[$column]) * 100, 2) : 0;
                                } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                                    $totalSeconds = $isData[$status . '_' . $column] ?? 0;
                                    $hours = floor($totalSeconds / 3600);
                                    $minutes = floor(($totalSeconds % 3600) / 60);
                                    $seconds = $totalSeconds % 60;
                                    $datavalue = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                                } else {
                                    $datavalue = round($isData[$status . '_' . $column] ?? 0, 2);
                                }
                                $html .= '<td class="bodycss">' . htmlspecialchars($datavalue);
                                if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                                    $html .= '%';
                                }
                                $html .= '</td>';
                            }
                        }
                    }
                    $html .= '<td class="bodycss">' . round($isData['Total'], 2) . '</td>';
                    foreach ($reportall['aggregatecolumns'] as $k => $v) {
                        if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                            $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                            if(count($trackingdetails)){
                                $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                                foreach($picklist_data as $picklistval){
                                    $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                    $subtotal = round($isData[$column], 2);
                                    $peravg=$isData[$column.'_total'] ?? 0;
                                    if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                        $subtotal=(new AdvancedReport())->getPicklistTrackingResult($subtotal, $picklistval->formula,$peravg);
                                    }elseif($picklistval->formula=='percentage'){
                                        $subtotal = round(($peravg / $isData['Total']) * 100, 2);
                                    }
                                    $html .= '<td class="bodycss">' . ($subtotal ?? 0);
                                    if (in_array($picklistval->formula, ['percentage'])) {
                                        $html .= '%';
                                    }
                                    $html .= '</td>';
                                }
                            }
                        }else{
                            if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                                $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                            } else {
                                $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                            }
                            if ($v->aggregatecolumns_calculation_type == 'Column_Percentage') {
                                $grandTotal = $reportresult['GrandTotal']['GrandTotal'][$column];
                                $subtotal = ($grandTotal != 0) ? round(($isData[$column] / $grandTotal) * 100, 2) : 0;
                            } elseif ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                                $denominator = $reportresult['GrandTotal']['GrandTotal'][$column];
                                $subtotal = ($denominator != 0) ? round(($denominator / $denominator) * 100, 2) : 0;
                            } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                                $totalSeconds = $isData[$column] ?? 0;
                                $hours = floor($totalSeconds / 3600);
                                $minutes = floor(($totalSeconds % 3600) / 60);
                                $seconds = $totalSeconds % 60;
                                $subtotal = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                            } else {
                                $subtotal = round($isData[$column], 2);
                            }
                            $html .= '<td class="bodycss">' . htmlspecialchars($subtotal);
                            if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                                $html .= '%';
                            }
                            $html .= '</td>';
                        }
                    }
                    $html .= '</tr>';
                }
            }
                $i++;
        }
        if ($reportdetails[0]->expand_grand_total == 1) {
            // Add footer-row class for Grand Total
            $html .= '<tr class="footer-row" style="' . $tablestyle['pdffstyle'] . '"><td colspan="' . $reportresult['countgroupbyrow'] . '">Grand Total</td>';
            foreach ($reportresult['groupbyaggrecol'] as $defaultKey) {
                if (isset($reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey])) {
                    foreach ($reportall['aggregatecolumns'] as $k => $v) {
                        if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                            $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                        } else {
                            $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                        }
                    }
                    if (strpos($defaultKey, 'Column_Percentage') !== false) {
                        $denominator = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                        $GrandTotal = ($denominator != 0) ? round(($denominator / $denominator) * 100, 2) : 0;
                    } elseif (strpos($defaultKey, 'Row_Percentage') !== false) {
                        $gtotal = $reportresult['GrandTotal']['GrandTotal'][$column];
                        $datavale = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                        $GrandTotal = ($datavale != 0) ? round(($datavale / $gtotal) * 100, 2) : 0;
                    } elseif (strpos($defaultKey, 'Sumhourcal') !== false) {
                        $totalSeconds = $reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey];
                        $hours = floor($totalSeconds / 3600);
                        $minutes = floor(($totalSeconds % 3600) / 60);
                        $seconds = $totalSeconds % 60;
                        $GrandTotal = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                    }elseif (strpos($defaultKey,'picklisttracking_') !== false) {
                        if (strpos($defaultKey,'_sum_') !== false) {
                            $formula='sum';
                        }elseif (strpos($defaultKey,'_avg_time_') !== false) {
                                $formula='avg_time';
                        }elseif (strpos($defaultKey,'_count_') !== false) {
                                $formula='count';
                        }elseif (strpos($defaultKey,'_percentage_') !== false) {
                                $formula='percentage';
                        }
                        $peravg=$reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey.'_total'] ?? 0;
                        if($formula =='percentage'){
                                $GrandTotal=round($peravg/$reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey]*100, 2);
                        }else{
                            $GrandTotal=round($reportresult['GrandTotal']['GrandTotal']['Total_'.$defaultKey] ?? 0,2);
                            $GrandTotal=(new AdvancedReport())->getPicklistTrackingResult($GrandTotal, $formula,$peravg);
                        }
                    } else {
                        $GrandTotal = round($reportresult['GrandTotal']['GrandTotal']['Total_' . $defaultKey] ?? 0, 2);
                    }
                    $html .= '<td class="bodycss">' . htmlspecialchars($GrandTotal);
                    if (strpos($defaultKey, 'Column_Percentage') !== false || strpos($defaultKey, 'Row_Percentage') !== false || strpos($defaultKey, 'percentage') !== false) {
                        $html .= '%';
                    }
                    $html .= '</td>';
                } else {
                    if ($reportdetails[0]->expand_group_count == 1) {
                        $html .= '<td class="bodycss">' . round($reportresult['GrandTotal']['GrandTotal'][$defaultKey] ?? 0, 2) . '</td>';
                    }
                }
            }
            if ($reportdetails[0]->expand_group_count == 1) {
                $html .= '<td class="bodycss">' . round($reportresult['GrandTotal']['GrandTotal']['Total'], 2) . '</td>';
            }
            foreach ($reportall['aggregatecolumns'] as $k => $v) {
                if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                        $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                        if(count($trackingdetails)){
                            $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                            foreach($picklist_data as $picklistval){
                                $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                $finaltotal = round($reportresult['GrandTotal']['GrandTotal'][$column] ?? 0, 2);
                                $peravg=$reportresult['GrandTotal']['GrandTotal'][$column.'_total'] ?? 0;
                                if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                    $finaltotal=(new AdvancedReport())->getPicklistTrackingResult($finaltotal, $picklistval->formula,$peravg);
                                }elseif($picklistval->formula=='percentage'){
                                    $finaltotal = round(( $peravg / $reportresult['GrandTotal']['GrandTotal']['Total']) * 100, 2);
                                }
                                $html .= '<td class="bodycss">' . ($finaltotal ?? 0);
                                if (in_array($picklistval->formula, ['percentage'])) {
                                    $html .= '%';
                                }
                                $html .= '</td>';
                            }
                        }
                }else{
                    if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                        $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                    } else {
                        $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                    }
                    if ($v->aggregatecolumns_calculation_type == 'Column_Percentage' || $v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                        $denominator = round($reportresult['GrandTotal']['GrandTotal'][$column], 2);
                        $finaltotal = ($denominator != 0) ? ($denominator / $denominator) * 100 : 0;
                    } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                        $totalSeconds = $reportresult['GrandTotal']['GrandTotal'][$column];
                        $hours = floor($totalSeconds / 3600);
                        $minutes = floor(($totalSeconds % 3600) / 60);
                        $seconds = $totalSeconds % 60;
                        $finaltotal = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                    } else {
                        $finaltotal = round($reportresult['GrandTotal']['GrandTotal'][$column] ?? 0, 2);
                    }
                    $html .= '<td class="bodycss">' . htmlspecialchars($finaltotal);
                    if (strpos($column, 'Column_Percentage') !== false || strpos($column, 'Row_Percentage') !== false) {
                        $html .= '%';
                    }
                    $html .= '</td>';
                }
            }
            $html .= '</tr>';
        }
        $html .= '</tbody></table>';
    }

    // Debug: Save HTML for inspection
    //file_put_contents('debug.html', $html);
    //error_log("HTML generated and saved to debug.html");

    // Standardize filename
    $originalReportName = $reportdetails[0]->report_name;
    $FileName = !empty(trim($originalReportName)) ? $originalReportName : 'Report_' . $report_id;
    $FileName .= '.pdf';

    // Log warning for invalid filename characters
    if (preg_match('/[<>:"\/\\|?*]/u', $FileName)) {
        error_log("Warning: Filename '$FileName' contains characters that may be invalid on some systems.");
    }

    // Initialize mPDF
    $mpdf = new \Mpdf\Mpdf([
        'mode' => 'ta-IN',
        'debug' => true,
        'allow_output_buffering' => true
    ]);
    $html = str_replace('&lt;/tr&gt;&lt;td', '&lt;/tr&gt;&lt;tr&gt;&lt;td', htmlentities($html));

    if($reporttype =='HTML'){

    $border = $tablestyle['tborder_color'];
    $style = $tablestyle['tstyle'];
    $html = html_entity_decode($html);
    switch ($style) {
      case 'all-borders':
    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);
    $html = str_replace('<table', '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;width:100%;"', $html);

    
    $html = preg_replace_callback('/<t[dh]([^>]*)>/i', function ($m) use ($border) {
        $tag = substr(trim($m[0]), 1, 2); 
        $attrs = $m[1];
        $newStyle = 'border:1px solid ' . $border . ';padding:8px;';

        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
         
            if (stripos($style, 'border:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $newStyle;
            }
            $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
        } else {
            $attrs .= ' style="' . $newStyle . '"';
        }

        return "<$tag$attrs>";
    }, $html);

    break;

case 'outer-borders':
    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);


    $html = preg_replace_callback(
        '/<table([^>]*)>/i',
        function ($m) use ($border) {
            $attrs = $m[1];
            $newStyle = 'border-collapse:collapse;border:2px solid ' . $border . ';width:100%;';

            if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
                $style = $s[1];
                if (stripos($style, 'border:') === false) {
                    $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $newStyle;
                }
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
            } else {
                $attrs .= ' style="' . $newStyle . '"';
            }

            return '<table' . $attrs . '>';
        },
        $html
    );


    $html = preg_replace_callback('/<t[dh]([^>]*)>/i', function ($m) {
        $tag = substr(trim($m[0]), 1, 2); 
        $attrs = $m[1];
        $newStyle = 'padding:8px;'; 

        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'padding:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $newStyle;
            }
            $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
        } else {
            $attrs .= ' style="' . $newStyle . '"';
        }

        return "<$tag$attrs>";
    }, $html);

    break;


      case 'inner-borders':

    $html = str_replace('<table', '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;border:none;width:100%;"', $html);
    $rowCount = 0;


    $html = preg_replace_callback(
        '/<tr([^>]*)>(.*?)<\/tr>/si',
        function ($matches) use ($border, &$rowCount) {
            $trAttrs = $matches[1]; 
            $rowContent = $matches[2];

            $rowContent = preg_replace_callback(
                '/<t[dh]([^>]*)>/i',
                function ($m) use ($border, $rowCount) {
                    $tag = substr(trim($m[0]), 1, 2);
                    $attrs = $m[1];

                    if ($rowCount < 2) {
                        $newStyle = 'border-top:none;border-bottom:1px solid ' . $border . ';border-left:1px solid ' . $border . ';border-right:1px solid ' . $border . ';padding:8px;';
                    } else {
                        $newStyle = 'border:1px solid ' . $border . ';padding:8px;';
                    }

                    if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
                        $style = $s[1];
                        if (stripos($style, 'border:') === false) {
                            $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $newStyle;
                        }
                        $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
                    } else {
                        $attrs .= ' style="' . $newStyle . '"';
                    }

                    return "<$tag$attrs>";
                },
                $rowContent
            );

            $rowCount++;
            return '<tr' . $trAttrs . '>' . $rowContent . '</tr>';
        },
        $html
    );
    break;


        case 'bottom-borders':
            $html = html_entity_decode($html);
            $tborder = $tablestyle['tborder_color'];
       
            $html = str_replace(
                '<table',
                '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;"',
                $html
            );
        
$html = preg_replace_callback(
    '/<tr([^>]*)>/i',
    function ($m) {
        $attrs = $m[1];
        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'border:none') === false) {
                $newStyle = $style . (substr(trim($style), -1) === ';' ? '' : ';') . 'border:none;';
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $newStyle . '"', $attrs);
            }
        } else {
            $attrs .= ' style="border:none;"';
        }
        return '<tr' . $attrs . '>';
    },
    $html
);

 
            if (preg_match('/<thead[^>]*>(.*?)<\/thead>/is', $html, $theadMatch)) {
                $theadContent = $theadMatch[1];
                if (preg_match_all('/<tr[^>]*>.*?<\/tr>/is', $theadContent, $headRows)) {
                    $lastHeadRow = end($headRows[0]);
                    $lastStyled = strpos($lastHeadRow, 'style=') !== false
                        ? preg_replace(
                            '/<tr([^>]*)style="([^"]*)"/i',
                            '<tr$1 style="$2;border-bottom:2px solid ' . $tborder . ';"',
                            $lastHeadRow
                        )
                        : preg_replace(
                            '/<tr([^>]*)>/i',
                            '<tr$1 style="border-bottom:2px solid ' . $tborder . ';">',
                            $lastHeadRow
                        );
                    $theadUpdated = str_replace($lastHeadRow, $lastStyled, $theadContent);
                    $html = str_replace($theadMatch[1], $theadUpdated, $html);
                }
            }

    
            if (preg_match('/<tfoot[^>]*>(.*?)<\/tfoot>/is', $html, $tfootMatch)) {
                $tfootContent = $tfootMatch[1];
                if (preg_match_all('/<tr[^>]*>.*?<\/tr>/is', $tfootContent, $footRows)) {
                    $lastFootRow = end($footRows[0]);
                    $lastStyledFoot = strpos($lastFootRow, 'style=') !== false
                        ? preg_replace(
                            '/<tr([^>]*)style="([^"]*)"/i',
                            '<tr$1 style="$2;border-bottom:2px solid ' . $tborder . ';"',
                            $lastFootRow
                        )
                        : preg_replace(
                            '/<tr([^>]*)>/i',
                            '<tr$1 style="border-bottom:2px solid ' . $tborder . ';">',
                            $lastFootRow
                        );
                    $tfootUpdated = str_replace($lastFootRow, $lastStyledFoot, $tfootContent);
                    $html = str_replace($tfootMatch[1], $tfootUpdated, $html);
                }
            }
       
            elseif (preg_match('/<tbody[^>]*>(.*?)<\/tbody>/is', $html, $tbodyMatch)) {
                $tbodyContent = $tbodyMatch[1];
                if (preg_match_all('/<tr[^>]*>.*?<\/tr>/is', $tbodyContent, $bodyRows)) {
                    $lastBodyRow = end($bodyRows[0]);
                    $lastStyledBody = strpos($lastBodyRow, 'style=') !== false
                        ? preg_replace(
                            '/<tr([^>]*)style="([^"]*)"/i',
                            '<tr$1 style="$2;border-bottom:2px solid ' . $tborder . ';"',
                            $lastBodyRow
                        )
                        : preg_replace(
                            '/<tr([^>]*)>/i',
                            '<tr$1 style="border-bottom:2px solid ' . $tborder . ';">',
                            $lastBodyRow
                        );
                    $tbodyUpdated = str_replace($lastBodyRow, $lastStyledBody, $tbodyContent);
                    $html = str_replace($tbodyMatch[1], $tbodyUpdated, $html);
                }
            }
            break;

  case 'left-borders':

    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);

    
    $html = str_replace(
        '<table',
        '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;border-left:2px solid ' . $border . ';width:100%;"',
        $html
    );


    $html = preg_replace_callback('/<(td|th)([^>]*)>/i', function ($m) {
        $tag = $m[1];
        $attrs = $m[2];
        $padding = 'padding:8px;';
        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'padding:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $padding;
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
            }
        } else {
            $attrs .= ' style="' . $padding . '"';
        }

        return "<$tag$attrs>";
    }, $html);

    break;


      case 'right-borders':
    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);
    $html = str_replace(
        '<table',
        '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;border-right:2px solid ' . $border . ';width:100%;"',
        $html
    );
    $html = preg_replace_callback('/<(td|th)([^>]*)>/i', function ($m) {
        $tag = $m[1];
        $attrs = $m[2];
        $padding = 'padding:8px;';
        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'padding:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $padding;
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
            }
        } else {
            $attrs .= ' style="' . $padding . '"';
        }
        return "<$tag$attrs>";
    }, $html);

    break;


       case 'outer-borders':
    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);
    $html = str_replace(
        '<table',
        '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;border:2px solid ' . $border . ';width:100%;"',
        $html
    );

    $html = preg_replace_callback('/<(td|th)([^>]*)>/i', function ($m) {
        $tag = $m[1];
        $attrs = $m[2];
        $padding = 'padding:8px;';
        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'padding:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $padding;
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
            }
        } else {
            $attrs .= ' style="' . $padding . '"';
        }
        return "<$tag$attrs>";
    }, $html);

    break;
    }


    $html = preg_replace(
        '/<tr([^>]*)class="footer-row"[^>]*>/',
        '<tr$1class="footer-row" style="' . $tablestyle['pdffstyle'] . ';">',
        $html
    );

    return $html;
}

    $mpdf->AddPage('L', '', '', '', '', 5, 5, 10, 0, 5, 0);

    // Write HTML in chunks
    $htmlChunks = str_split($html, 50000);
    foreach ($htmlChunks as $chunk) {
        $mpdf->WriteHTML(html_entity_decode($chunk));
    }
    $mpdf->SetTitle('Advanced Report');

    if ($accessmode == 'SendMail') {
        $dirname = public_path() . '/AdvancedReport';
        if (!file_exists($dirname)) {
            mkdir($dirname, 0777, true);
        }
        $filePath = $dirname . '/' . $FileName;
        $mpdf->Output($filePath, 'F');
        error_log("PDF saved to: $filePath");
    } else {
        // Clear output buffers
        while (ob_get_level() > 0) {
            ob_end_clean();
        }

        // Set headers
        header('Content-Type: application/pdf');
        header('Content-Disposition: attachment; filename="' . $FileName . '"');
        header('Cache-Control: no-cache, no-store, must-revalidate');
        header('Pragma: no-cache');
        header('Expires: 0');

        // Output PDF
        $mpdf->Output($FileName, \Mpdf\Output\Destination::DOWNLOAD);
        error_log("PDF download initiated for: $FileName");
        exit;
    }
}
    

    
 
 function getReportContent($Org, $Data, $currentMedium, $keyValue, $keyValue1, $reportresult, $tablestyle, $reportdetails, $reportall, $medium, $mode, $count,$bstyle,$i)
  {
    $html = '';
    static $globalRowCount = 0;
    if ($mode == 'start') {
        $globalRowCount = 0;
    }
    if ($currentMedium == true) {
        $globalRowCount++;
        $html .= '<tr>';
    }
    $count++;
    foreach ($Data as $source => $statusCounts) {
          $rowColor = ($i % 2 == 0) ? $tablestyle['evenrowcolor'] : $tablestyle['oddrowcolor'];
                $bstyle = 'style="background-color:' . $rowColor . ';' . $tablestyle['pdfbstyle'] . '"';
        $rowdata = '';
        $isMultiArray = (new AdvancedReport())->isMultiArray($statusCounts);
        if (is_array($statusCounts)) {
            if ($reportresult['countgroupbyrow'] == 2) {
                $countAllValues = count($Data);
                if ($currentMedium) {
                    $rowdata = '';
                } else {
                    $globalRowCount++;
                    $rowdata = '<tr>';
                }
            } elseif ($reportresult['countgroupbyrow'] == 4) {
                $countAllValues = (new AdvancedReport())->count4LevelArrays($Org);
            } elseif ($reportresult['countgroupbyrow'] == 5) {
                $countAllValues = (new AdvancedReport())->count5LevelArrays($Org);
            } elseif ($reportresult['countgroupbyrow'] > 6) {
                $countAllValues = (new AdvancedReport())->count5LevelArrays($Data);
            } else {
                $countAllValues = $this->count3LevelArrays($Org);
                if ($currentMedium) {
                    $rowdata = '';
                } else {
                    $globalRowCount++;
                    $rowdata = '<tr>';
                }
            }
        }
        if ($isMultiArray == 1) {
            $currentSource = true;
            if ($currentMedium) {
                if ($reportresult['countgroupbyrow'] > 2) {
                    $html .= '<td '.$bstyle.' rowspan="' . ($countAllValues[$keyValue] ?? 1) . '">' . htmlspecialchars($keyValue) . '</td>';
                } else {
                    $html .= '<td '.$bstyle.' rowspan="' . $countAllValues . '">' . htmlspecialchars($keyValue) . '</td>';
                }
                $currentMedium = false;
            }
            $_SESSION[$count] = $source;
            if ($count != 2 && isset($countAllValues[$medium . '_' . ($_SESSION[1] ?? '') . '_' . $keyValue1 . '_' . $source])) {
                $rowspanValue = $countAllValues[$medium . '_' . ($_SESSION[1] ?? '') . '_' . $keyValue1 . '_' . $source];
            } elseif (isset($countAllValues[$medium . '_' . ($_SESSION[1] ?? '') . '_' . ($_SESSION[2] ?? '')])) {
                $rowspanValue = $countAllValues[$medium . '_' . ($_SESSION[1] ?? '') . '_' . ($_SESSION[2] ?? '')];
            } elseif (isset($countAllValues[$medium . '_' . ($_SESSION[1] ?? '') . '_' . ($_SESSION[2] ?? '') . '_' . ($_SESSION[3] ?? '')])) {
                $rowspanValue = $countAllValues[$medium . '_' . ($_SESSION[1] ?? '') . '_' . ($_SESSION[2] ?? '') . '_' . ($_SESSION[3] ?? '')];
            } elseif (isset($countAllValues[$medium . '_' . $keyValue1 . '_' . $source])) {
                $rowspanValue = $countAllValues[$medium . '_' . $keyValue1 . '_' . $source];
            } elseif (isset($countAllValues[$medium . '_' . $source])) {
                $rowspanValue = $countAllValues[$medium . '_' . $source];
            } else {
                $rowspanValue = $countAllValues[$source] ?? 1;
            }
            if ($currentSource) {
                if ($reportresult['countgroupbyrow'] > 2) {
                    $html .= '<td '.$bstyle.' rowspan="' . $rowspanValue . '">' . htmlspecialchars($source) . '</td>';
                } else {
                    $html .= '<td '.$bstyle.' rowspan="' . count($statusCounts) . '">' . htmlspecialchars($source) . '</td>';
                    foreach ($reportall['aggregatecolumns'] as $k => $v) {
                        $html .= '<td '.$bstyle.'>' . round($statusCounts[$source . '_' . $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name] ?? 0, 2) . '</td>';
                    }
                }
                $currentSource = false;
            }
            $html .= $this->getReportContent($Org, $statusCounts, $currentMedium, $keyValue, $source, $reportresult, $tablestyle, $reportdetails, $reportall, $medium, 'loop', $count, $globalRowCount,$i);
        } else { 
            if ($mode == 'start' || $medium != $keyValue) {
                $globalRowCount++;
                $html .= $rowdata;
            }
            $currentSource = true;
            $sourceTotals = array_fill_keys(array_merge(['Total'], $reportresult['groupbycol']), 0);
            if ($currentMedium) {
                $html .= '<td '.$bstyle.' rowspan="' . $countAllValues . '">' . htmlspecialchars($medium) . '</td>';
                $currentMedium = false;
            }
            if ($currentSource) {
                $html .= '<td '.$bstyle.' rowspan="1">' . htmlspecialchars($source) . '</td>';
                $currentSource = false;
            }
            foreach ($reportresult['groupbycol'] as $status) {
                if ($reportdetails[0]->expand_group_count == 1) {
                    $html .= '<td '.$bstyle.'>' . round($statusCounts[$status] ?? 0, 2) . '</td>';
                }
                foreach ($reportall['aggregatecolumns'] as $k => $v) {
                     if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                        $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                        if(count($trackingdetails)){
                            $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                            foreach($picklist_data as $picklistval){
                                $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                                 $datavalue = round(floatval($statusCounts[$status . '_' . $column] ?? 0), 2);
                                $peravg=$statusCounts[$status.'_'.$column.'_total'] ?? 0;
                                if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                    $datavalue=(new AdvancedReport())->getPicklistTrackingResult($datavalue, $picklistval->formula,$peravg);
                                }elseif($picklistval->formula=='percentage'){
                                    $datavalue = ($datavalue ?? 0) > 0 
                                    ? round(($peravg / $datavalue) * 100, 2) 
                                    : 0;
                                }
                                $html .= '<td '.$bstyle.'>' . ($datavalue ?? 0);
                                if (in_array($picklistval->formula, ['percentage'])) {
                                    $html .= '%';
                                }
                                $html .= '</td>';
                            }
                        }
                    }else{
                         if ($v->aggregatecolumns_calculation_type != 'Column_Percentage' && in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                            $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                        } else {
                            $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                        }
                        if ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                            $denominator = $statusCounts[$status . '_' . $column] ?? 0;
                            if ($denominator != 0) {
                                $datavalue = round(floatval(($statusCounts[$status . '_' . $column] / $statusCounts[$column]) * 100), 2);
                            } else {
                                $datavalue = 0;
                            }
                        } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                            $totalSeconds = $statusCounts[$status . '_' . $column] ?? 0;
                            $hours = floor($totalSeconds / 3600);
                            $minutes = floor(($totalSeconds % 3600) / 60);
                            $seconds = $totalSeconds % 60;
                            $datavalue = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                        } else {
                            $datavalue = round(floatval($statusCounts[$status . '_' . $column] ?? 0), 2);
                        }
                        $html .= '<td '.$bstyle.'>' . $datavalue;
                        if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                            $html .= '%';
                        }
                        $html .= '</td '.$bstyle.'>';
                    }
                   
                }
            }
            if ($reportdetails[0]->expand_group_count == 1) {
                $html .= '<td '.$bstyle.'>' . round($statusCounts['Total'] ?? 0, 2) . '</td>';
            }
            foreach ($reportall['aggregatecolumns'] as $k => $v) {
                 if($v->aggregatecolumns_calculation_type=='picklist_tracking'){
                    $trackingdetails = DB::table('rsoft_advanced_report_picklisttracking')->where('tracking_id',$v->picklist_tracking_id)->where('field_id','!=',0)->get();
                    if(count($trackingdetails)){
                        $picklist_data=json_decode($trackingdetails[0]->picklist_data);
                        foreach($picklist_data as $picklistval){
                            $column ='picklisttracking_'.$trackingdetails[0]->colname.'_'.$picklistval->formula.'_'.str_replace(' ', '_', $picklistval->from_value).'_'.str_replace(' ', '_', $picklistval->to_value);
                            $percentage= $statusCounts[$column];
                            $peravg=$statusCounts[$column.'_total'] ?? 0;
                            if($picklistval->formula=='avg_time' || $picklistval->formula=='sum'){
                                $percentage=(new AdvancedReport())->getPicklistTrackingResult($percentage, $picklistval->formula,$peravg);
                            }elseif($picklistval->formula=='percentage'){
                                $percentage = round(($peravg / $statusCounts['Total']) * 100, 2);
                            }
                             $html .= '<td '.$bstyle.'>' . ($percentage ?? 0);
                            if (in_array($picklistval->formula, ['percentage'])) {
                                $html .= '%';
                            }
                            $html .= '</td>';
                        }
                    }
                 }else{
                    if (in_array($v->aggregatecolumns_fieldtype, [13, 14, 15, 16, 17])) {
                        $column = $v->aggregatecolumns_calculation_type . '_' . str_replace('.', '_', $v->aggregatecolumns_coloumn_name);
                    } else {
                        $column = $v->aggregatecolumns_calculation_type . '_' . $v->aggregatecolumns_coloumn_name;
                    }
                    $percentage = $statusCounts[$column] ?? 0;
                    if ($v->aggregatecolumns_calculation_type == 'Column_Percentage') {
                        $denominator = $reportresult['GrandTotal']['GrandTotal'][$column];
                        if ($denominator != 0) {
                            $percentage = round(($statusCounts[$column] / $denominator) * 100, 2);
                        } else {
                            $percentage = 0;
                        }
                    } elseif ($v->aggregatecolumns_calculation_type == 'Row_Percentage') {
                        if ($percentage != 0) {
                            $percentage = round(($percentage / $percentage) * 100, 2);
                        } else {
                            $percentage = 0;
                        }
                    } elseif ($v->aggregatecolumns_calculation_type == 'Sumhourcal') {
                        $totalSeconds = $statusCounts[$column] ?? 0;
                        $hours = floor($totalSeconds / 3600);
                        $minutes = floor(($totalSeconds % 3600) / 60);
                        $seconds = $totalSeconds % 60;
                        $percentage = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                    }
                    $html .= '<td '.$bstyle.'>' . ($percentage ?? 0);
                    if (in_array($v->aggregatecolumns_calculation_type, ['Column_Percentage', 'Row_Percentage'])) {
                        $html .= '%';
                    }
                    $html .= '</td>';
                 }
                
            }
            $html .= '</tr>';
        }
        $i++;
    }
    return $html;
}


    public function getDownloadExcellReport($report_id, $reportall, $reportdetails, $reportarray, $aggrateValues, $reporttype, $accessmode) {
        
        ob_start();
    
        $Colarray1 = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        $Colarraya = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        $Colarrayb = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
        $Colarray2 = [];
    
        foreach ($Colarrayb as $k => $v) {
            foreach ($Colarraya as $k1 => $v1) {
                $Colarray2[] = $v . $v1;
            }
        }
        $Colarray = array_merge($Colarray1, $Colarray2);
    
        // Sanitize filename while allowing safe special characters
        $originalReportName = $reportdetails[0]->report_name;
        $sanitizedFilename = !empty(trim($originalReportName)) ? $originalReportName : 'Report_' . $report_id;
    
        if ($reporttype == 'CSV') {
            $sanitizedFilename .= '.csv';
            $headerCellStyle = [];
            $bodyCellStyle = [];
            $FooterCellStyle = [];
            $oddRowStyle = [];
            $evenRowStyle = [];
            $tableborder = [];
            $ConditionsInfoColor = [];
        } elseif ($reporttype == 'Excel') {
            $sanitizedFilename .= '.xlsx';
            $tstyle = DB::table('rsoft_advanced_report_tablestyle')->where('report_id', $report_id)->first();
            $tableborder = $this->getTableBorder($tstyle);
    
            $headerCellStyle = [
                'font' => [
                    'bold' => $tstyle->table_header_b,
                    'name' => $tstyle->table_header_font,
                    'size' => $tstyle->table_header_size,
                    'italic' => $tstyle->table_header_i,
                    'underline' => $tstyle->table_header_u ? PHPExcel_Style_Font::UNDERLINE_SINGLE : PHPExcel_Style_Font::UNDERLINE_NONE,
                    'color' => ['rgb' => str_replace('#', '', $tstyle->table_header_color)],
                ],
                'fill' => [
                    'type' => PHPExcel_Style_Fill::FILL_SOLID,
                    'color' => ['rgb' => str_replace('#', '', $tstyle->table_header_cell_color)],
                ],
            ];
    
            $bodyCellStyle = [
                'font' => [
                    'name' => $tstyle->table_label_font,
                    'size' => $tstyle->table_label_size,
                    'color' => ['rgb' => str_replace('#', '', $tstyle->table_label_color)],
                ],
            ];
    
            $FooterCellStyle = [
                'font' => [
                    'bold' => $tstyle->table_footer_b,
                    'name' => $tstyle->table_footer_font,
                    'size' => $tstyle->table_footer_size,
                    'italic' => $tstyle->table_footer_i,
                    'underline' => $tstyle->table_footer_u ? PHPExcel_Style_Font::UNDERLINE_SINGLE : PHPExcel_Style_Font::UNDERLINE_NONE,
                    'color' => ['rgb' => str_replace('#', '', $tstyle->table_footer_color)],
                ],
                'fill' => [
                    'type' => PHPExcel_Style_Fill::FILL_SOLID,
                    'color' => ['rgb' => str_replace('#', '', $tstyle->table_footer_cell_color)],
                ],
            ];
    
            $oddRowStyle = [
                'font' => [
                    'name' => $tstyle->table_label_font,
                    'size' => $tstyle->table_label_size,
                    'color' => ['rgb' => str_replace('#', '', $tstyle->table_label_color)],
                    'bold' => false,
                ],
                'fill' => [
                    'type' => PHPExcel_Style_Fill::FILL_SOLID,
                    'color' => ['rgb' => str_replace('#', '', $tstyle->table_odd_row_color)],
                ],
            ];
    
            $evenRowStyle = [
                'font' => [
                    'name' => $tstyle->table_label_font,
                    'size' => $tstyle->table_label_size,
                    'color' => ['rgb' => str_replace('#', '', $tstyle->table_label_color)],
                ],
                'fill' => [
                    'type' => PHPExcel_Style_Fill::FILL_SOLID,
                    'color' => ['rgb' => str_replace('#', '', $tstyle->table_even_row_color)],
                ],
            ];
    
            $ConditionsInfoColor = [
                'font' => [
                    'bold' => true,
                    'size' => '14',
                    'color' => ['rgb' => '000000'],
                ],
            ];
        } elseif ($reporttype == 'PDF') {
            $sanitizedFilename .= '.pdf';
        }
    
        if ($reporttype == 'Excel' || $reporttype == 'CSV') {
            $objPHPExcel = new PHPExcel();
            $objPHPExcel->getProperties()
                ->setCreator('Maarten Balliauw')
                ->setLastModifiedBy('Maarten Balliauw')
                ->setTitle('Office 2007 XLSX Test Document')
                ->setSubject('Office 2007 XLSX Test Document')
                ->setDescription('Test document for Office 2007 XLSX, generated using PHP classes.')
                ->setKeywords('office 2007 openxml php')
                ->setCategory('Test result file');
    
            $row = 1;
            $keys = is_array($reportarray) && !empty($reportarray) ? array_keys($reportarray) : [];
            $columnLetter = !empty($keys) ? $Colarray[count($keys) - 1] : 'A';
    
            // Report title (use original name with special characters)
            $objPHPExcel->setActiveSheetIndex(0)
                ->mergeCells('A' . $row . ':' . $columnLetter . $row)
                ->setCellValue('A' . $row, $originalReportName);
            $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)
                ->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
            // Make the report name bold
            $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)
                ->getFont()->setBold(true);
            if ($reporttype == 'Excel') {
               
                $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($tableborder);
            }
    
            // Filter conditions
            $ConditionsInfo = $this->getFilterConditionsInfo($report_id);
            if ($ConditionsInfo != '') {
                $row++;
                $objPHPExcel->setActiveSheetIndex(0)
                    ->mergeCells('A' . $row . ':' . $columnLetter . $row)
                    ->setCellValue('A' . $row, $ConditionsInfo);
                $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)
                    ->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
                if ($reporttype == 'Excel') {
                    $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($ConditionsInfoColor);
                    $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($tableborder);
                }
            }
    
            // Add description field if it exists
            if (!empty($reportdetails[0]->description)) {
                $row++;
                $objPHPExcel->setActiveSheetIndex(0)
                    ->mergeCells('A' . $row . ':' . $columnLetter . $row)
                    ->setCellValue('A' . $row, 'Description: ' . $reportdetails[0]->description);
                $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)
                    ->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
                if ($reporttype == 'Excel') {
                    $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($ConditionsInfoColor);
                    $objPHPExcel->getActiveSheet()->getStyle('A' . $row . ':' . $columnLetter . $row)->applyFromArray($tableborder);
                }
            }
    
            $row++;
            try {
                if (!empty($reportarray)) {
                    // Write headers
                    $i = 0;
                    foreach ($keys as $key) {
                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue($Colarray[$i] . $row, $key);
                        if ($reporttype == 'Excel') {
                            $objPHPExcel->getActiveSheet()->getStyle($Colarray[$i] . $row)->applyFromArray($headerCellStyle);
                            $objPHPExcel->getActiveSheet()->getStyle($Colarray[$i] . $row)->applyFromArray($tableborder);
                        }
                        $objPHPExcel->getActiveSheet()->getColumnDimension($Colarray[$i])->setAutoSize(true);
                        $i++;
                    }
                    $headerRow = $row;
    
                    // Write data rows
                    $columns = !empty($reportarray[$keys[0]]) ? count($reportarray[$keys[0]]) : 0;
                    for ($j = 0; $j < $columns; $j++) {
                        $row++;
                        $i = 0;
                        foreach ($keys as $key) {
                            $value = isset($reportarray[$key][$j]) ? $reportarray[$key][$j] : '';
                            if ($key == 'Comments') {
                                $value = html_entity_decode($value, ENT_QUOTES | ENT_HTML5, 'UTF-8');
                                $value = str_replace('<br><br>', PHP_EOL, $value);
                            }
                            $value = strval($value);
                            // Log values starting with '=' for debugging
                            if (strpos($value, '=') === 0) {
                                error_log("Found value starting with '=' in reportarray: " . $value);
                            }
                            // Escape values starting with '=' to prevent Excel formula interpretation
                            if ($reporttype == 'Excel' && strpos($value, '=') === 0) {
                                $value = "'" . $value;
                            }
                            // Sanitize for CSV
                            if($reporttype=='CSV'){
                                if(strpos($value,'=')===0){
                                    $value="'".$value;
                                }
                                if(strpos($value,',')!==false||strpos($value,"\n")!==false||strpos($value,"\r")!==false){
                                    $value='"'.$value.'"';
                                }
                           }
                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue($Colarray[$i] . $row, $value);
                            if ($reporttype == 'Excel') {
                                $tableBodyRowIndex = $row - $headerRow;
                                $styleToApply = ($tableBodyRowIndex % 2 == 0) ? $evenRowStyle : $oddRowStyle;
                                $objPHPExcel->getActiveSheet()->getStyle($Colarray[$i] . $row)->applyFromArray($styleToApply);
                                $objPHPExcel->getActiveSheet()->getStyle($Colarray[$i] . $row)->applyFromArray($tableborder);
                            }
                            $i++;
                        }
                    }
    
                    // Write footer (aggregate values)
                    if (!empty($reportall['aggregatecolumns']) && !empty($aggrateValues)) {
                        if (count($aggrateValues) !== count($keys)) {
                            $aggrateValues = array_pad(array_slice($aggrateValues, 0, count($keys)), count($keys), '');
                        }
                        $row++;
                        $i = 0;
                        foreach ($aggrateValues as $index => $value) {
                            $value = strval($value);
                            if (!empty($reportall['aggregatecolumns'][$index])) {
                                $aggType = $reportall['aggregatecolumns'][$index]->aggregatecolumns_calculation_type;
                                if ($aggType == 'Sumhourcal') {
                                    $totalSeconds = floatval($value);
                                    $hours = floor($totalSeconds / 3600);
                                    $minutes = floor(($totalSeconds % 3600) / 60);
                                    $seconds = $totalSeconds % 60;
                                    $value = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                                } elseif (in_array($aggType, ['Column_Percentage', 'Row_Percentage'])) {
                                    $value = round(floatval($value), 2) . '%';
                                } else {
                                    $value = round(floatval($value), 2);
                                }
                            }

                            if (strpos($value, '=') === 0) {
                            }
                            if ($reporttype == 'Excel' && strpos($value, '=') === 0) {
                                $value = "'" . $value;
                            }
                            // Sanitize for CSV
                            if ($reporttype == 'CSV') {
                                $value = str_replace([',', '"', "\n", "\r"], [' ', '', ' ', ''], $value);
                                // Ensure CSV values starting with '=' are quoted
                                if (strpos($value, '=') === 0) {
                                    $value = '"' . $value . '"';
                                }
                            }
                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue($Colarray[$i] . $row, $value);
                            if ($reporttype == 'Excel') {
                                $objPHPExcel->getActiveSheet()->getStyle($Colarray[$i] . $row)->applyFromArray($FooterCellStyle);
                                $objPHPExcel->getActiveSheet()->getStyle($Colarray[$i] . $row)->applyFromArray($tableborder);
                            }
                            $i++;
                        }
                    }
                }
            } catch (Exception $e) {
                error_log("Error in getDownloadExcellReport: " . $e->getMessage());
                error_log("aggrateValues: " . json_encode($aggrateValues));
                // Fallback: write headers only
                $row = !empty($reportdetails[0]->description) ? 4 : 3;
                if ($ConditionsInfo != '') {
                    $row++;
                }
                $i = 0;
                foreach ($keys as $key) {
                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue($Colarray[$i] . $row, $key);
                    if ($reporttype == 'Excel') {
                        $objPHPExcel->getActiveSheet()->getStyle($Colarray[$i] . $row)->applyFromArray($headerCellStyle);
                        $objPHPExcel->getActiveSheet()->getStyle($Colarray[$i] . $row)->applyFromArray($tableborder);
                    }
                    $objPHPExcel->getActiveSheet()->getColumnDimension($Colarray[$i])->setAutoSize(true);
                    $i++;
                }
            }
            $sheetName = $originalReportName;
            $sheetName = preg_replace('/[\\\\\\/\\?\\*\\[\\]]/', '', $sheetName);
            $sheetName = preg_replace('/\s+/', '', $sheetName);
            $sheetName = trim($sheetName);
            $sheetName = mb_substr($sheetName, 0, 31);
            $objPHPExcel->getActiveSheet()->setTitle($sheetName);
            $objPHPExcel->setActiveSheetIndex(0);
        }
    
        if ($reporttype == 'PDF') {
            // Initialize mPDF
            $mpdf = new \Mpdf\Mpdf();
            $html = '';
    
            // Add report name, filter conditions, and description
            $html .= '<div style="text-align:center;font-size:18px;font-weight:bold;">' . htmlspecialchars($originalReportName, ENT_QUOTES, 'UTF-8') . '</div><br/>';
            $ConditionsInfo = $this->getFilterConditionsInfo($report_id);
            if ($ConditionsInfo != '') {
                $html .= '<div style="text-align:center;font-size:14px;font-weight:bold;">' . htmlspecialchars($ConditionsInfo, ENT_QUOTES, 'UTF-8') . '</div><br/>';
            }
            if (!empty($reportdetails[0]->description)) {
                $html .= '<div style="text-align:center;font-size:14px;font-weight:bold;">Description: ' . htmlspecialchars($reportdetails[0]->description, ENT_QUOTES, 'UTF-8') . '</div><br/>';
            }
    
            // Build table
            $html .= '<table class="table table-bordered" style="width:100%;border-collapse:collapse;">';
            $html .= '<thead><tr>';
            $keys = is_array($reportarray) && !empty($reportarray) ? array_keys($reportarray) : [];
            foreach ($keys as $key) {
                $html .= '<th style="border:1px solid black;padding:5px;font-weight:bold;">' . htmlspecialchars($key, ENT_QUOTES, 'UTF-8') . '</th>';
            }
            $html .= '</tr></thead><tbody>';
    
            // Write data rows
            $columns = !empty($reportarray[$keys[0]]) ? count($reportarray[$keys[0]]) : 0;
            for ($j = 0; $j < $columns; $j++) {
                $html .= '<tr>';
                foreach ($keys as $key) {
                    $value = isset($reportarray[$key][$j]) ? $reportarray[$key][$j] : '';
                    if ($key == 'Comments') {
                        $value = html_entity_decode($value, ENT_QUOTES | ENT_HTML5, 'UTF-8');
                        $value = str_replace('<br><br>', "\n", $value);
                    }
                    $value = strval($value);
                    // Log values starting with '=' for debugging
                    if (strpos($value, '=') === 0) {
                        error_log("Found value starting with '=' in reportarray (PDF): " . $value);
                    }
                    $html .= '<td style="border:1px solid black;padding:5px;">' . htmlspecialchars($value, ENT_QUOTES, 'UTF-8') . '</td>';
                }
                $html .= '</tr>';
            }
    
            // Write footer (aggregate values)
            if (!empty($reportall['aggregatecolumns']) && !empty($aggrateValues)) {
                if (count($aggrateValues) !== count($keys)) {
                    error_log("Mismatch: aggrateValues count (" . count($aggrateValues) . ") does not match column count (" . count($keys) . ")");
                    $aggrateValues = array_pad(array_slice($aggrateValues, 0, count($keys)), count($keys), '');
                }
                $html .= '<tr>';
                foreach ($aggrateValues as $index => $value) {
                    $value = strval($value);
                    // Handle special aggregate calculations (e.g., Sumhourcal, percentages)
                    if (!empty($reportall['aggregatecolumns'][$index])) {
                        $aggType = $reportall['aggregatecolumns'][$index]->aggregatecolumns_calculation_type;
                        if ($aggType == 'Sumhourcal') {
                            $totalSeconds = floatval($value);
                            $hours = floor($totalSeconds / 3600);
                            $minutes = floor(($totalSeconds % 3600) / 60);
                            $seconds = $totalSeconds % 60;
                            $value = sprintf("%02d:%02d:%02d", $hours, $minutes, $seconds);
                        } elseif (in_array($aggType, ['Column_Percentage', 'Row_Percentage'])) {
                            $value = round(floatval($value), 2) . '%';
                        } else {
                            $value = round(floatval($value), 2);
                        }
                    }
                    // Log values starting with '=' for debugging
                    if (strpos($value, '=') === 0) {
                        error_log("Found value starting with '=' in aggrateValues (PDF): " . $value);
                    }
                    $html .= '<td style="border:1px solid black;padding:5px;font-weight:bold;">' . htmlspecialchars($value, ENT_QUOTES, 'UTF-8') . '</td>';
                }
                $html .= '</tr>';
            }
    
            $html .= '</tbody></table>';
    
            $mpdf->WriteHTML($html);
        }
    
        if ($accessmode == 'SendMail') {
            $dirname = public_path() . '/AdvancedReport';
            if (!file_exists($dirname)) {
                mkdir($dirname, 0777, true);
            }
    
            if ($reporttype == 'CSV') {
                $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'CSV');
                $objWriter->setDelimiter(',');
                $objWriter->setEnclosure('"');
                $objWriter->setLineEnding("\r\n");
                $objWriter->setUseBOM(true);
                $objWriter->save($dirname . '/' . $sanitizedFilename);
            } elseif ($reporttype == 'Excel') {
                $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');
                $objWriter->save($dirname . '/' . $sanitizedFilename);
            } elseif ($reporttype == 'PDF') {
                $mpdf->Output($dirname . '/' . $sanitizedFilename, 'F');
            }
            return $dirname . '/' . $sanitizedFilename; // Return file path for email attachment
        } else {
            $downloadFilename = $sanitizedFilename;
            // Clear output buffer before sending headers
            ob_end_clean();
    
            if ($reporttype == 'CSV') {
                header('Content-Type: text/csv; charset=UTF-8');
                header('Content-Disposition: attachment; filename="' . $downloadFilename . '"');
                header('Cache-Control: max-age=0');
                header('Expires: 0');
                header('Pragma: public');
                echo "\xEF\xBB\xBF"; // Add UTF-8 BOM for CSV
    
                $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'CSV');
                $objWriter->setDelimiter(',');
                $objWriter->setEnclosure('"');
                $objWriter->setLineEnding("\r\n");
                $objWriter->setUseBOM(true);
                $objWriter->save('php://output');
            } elseif ($reporttype == 'Excel') {
                header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
                header('Content-Disposition: attachment; filename="' . $downloadFilename . '"');
                header('Cache-Control: max-age=0');
                header('Expires: 0');
                header('Pragma: public');
    
                $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');
                $objWriter->save('php://output');
            } elseif ($reporttype == 'PDF') {
                header('Content-Type: application/pdf');
                header('Content-Disposition: attachment; filename="' . $downloadFilename . '"');
                header('Cache-Control: max-age=0');
                header('Expires: 0');
                header('Pragma: public');
    
                $mpdf->Output($downloadFilename, 'D');
            }
            exit;
        }
    }


    public function getTableBorder($tstyle){
        if($tstyle->table_border_design=='Bottom Borders'){
            $CellBorderStyle = array(
                'borders' => array(
                    'bottom' => array(  // Only apply to bottom
                        'style' => PHPExcel_Style_Border::BORDER_THIN,
                        'color' => array('rgb' => str_replace('#', '', $tstyle->table_border_color)), // Set your border color
                    ),
                ),
            );
        }elseif($tstyle->table_border_design=='Inner Borders'){
            $CellBorderStyle = array(
                'borders' => array(
                    'inside' => array(
                        'style' => PHPExcel_Style_Border::BORDER_THIN, // Use BORDER_THIN, or any other style
                        'color' => array('rgb' => str_replace('#', '', $tstyle->table_border_color)), // Use your desired color
                    ),
                ),
            );
        }elseif($tstyle->table_border_design=='Outer Borders'){
            $CellBorderStyle = array(
                'borders' => array(
                    'outline' => array(  // Apply border to all outer sides (top, right, bottom, left)
                        'style' => PHPExcel_Style_Border::BORDER_THIN,
                        'color' => array('rgb' => str_replace('#', '', $tstyle->table_border_color)),
                    ),
                ),
            );
        }elseif($tstyle->table_border_design=='Left Borders'){
            $CellBorderStyle = array(
                'borders' => array(
                    'left' => array(  // Apply border only to the left
                        'style' => PHPExcel_Style_Border::BORDER_THIN,
                        'color' => array('rgb' => str_replace('#', '', $tstyle->table_border_color)),
                    ),
                ),
            );
            
        }elseif($tstyle->table_border_design=='Right Borders'){
            $CellBorderStyle = array(
                'borders' => array(
                    'right' => array(  // Apply border only to the right
                        'style' => PHPExcel_Style_Border::BORDER_THIN,
                        'color' => array('rgb' => str_replace('#', '', $tstyle->table_border_color)),
                    ),
                ),
            );
        }elseif($tstyle->table_border_design=='No Borders'){
            $CellBorderStyle = array(
                'borders' => array(
                    'top' => array(
                        'style' => PHPExcel_Style_Border::BORDER_NONE,
                    ),
                    'bottom' => array(
                        'style' => PHPExcel_Style_Border::BORDER_NONE,
                    ),
                    'left' => array(
                        'style' => PHPExcel_Style_Border::BORDER_NONE,
                    ),
                    'right' => array(
                        'style' => PHPExcel_Style_Border::BORDER_NONE,
                    ),
                ),
            );
        }else{
            $CellBorderStyle = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => PHPExcel_Style_Border::BORDER_THIN,
                        'color' => array('rgb' => str_replace('#','',$tstyle->table_border_color)),
                    ),
                ),
            );
        }
        return  $CellBorderStyle;
    }


    public function getDownloadPDFReport($report_id,$reportall,$reportdetails,$reportarray,$aggrateValues,$reporttype,$accessmode){
        ini_set('pcre.backtrack_limit', '2000000');
        $html='';
        if(count($reportarray)){
        
            $tablestyle=DB::table('rsoft_advanced_report_tablestyle')->where('report_id',$report_id)->get();
            $tablestyle=$this->getTablestyle($tablestyle);
        
            $html.=' <style>
            .all-borders td, .all-borders th {
                    border: 2px solid '.$tablestyle['tborder_color'].' !important;
            }
                
           .bottom-borders td, .bottom-borders th {
                border-bottom: none !important;
            }

            .bottom-borders tr:last-child td, .bottom-borders tr:last-child th {
                border-bottom: 2px solid '.$tablestyle['tborder_color'].' !important;
            }

                
            .inner-borders td, .inner-borders th {
                border: 1px solid transparent !important;
                position: relative;
            }

            .inner-borders td:after, .inner-borders th:after {
               content: "";
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
                height: 2px;
                background: '.$tablestyle['tborder_color'].' !important;
            }

            .inner-borders td:before, .inner-borders th:before {
               content: "";
                position: absolute;
                top: 0;
                bottom: 0;
                width: 2px;
                background: '.$tablestyle['tborder_color'].' !important;
                left: 0;
            }

            .inner-borders tr:last-child td:after, .inner-borders tr:last-child th:after {
                border-bottom: none !important;
            }

            .inner-borders td:last-child:before, .inner-borders th:last-child:before {
                border-right: none !important;
            }

            .outer-borders {
                border: 2px solid '.$tablestyle['tborder_color'].' !important;
                border-collapse: collapse !important;
            }

            .outer-borders td, .outer-borders th {
                border: none !important;
            }
            .left-borders td, .left-borders th {
                border-left: none !important;
            }

            .left-borders td:first-child, .left-borders th:first-child {
                border-left: 2px solid '.$tablestyle['tborder_color'].' !important;
            }

                
                .right-borders td, .right-borders th {
                border-right: none !important;
            }

            .right-borders td:last-child, .right-borders th:last-child {
                border-right: 2px solid '.$tablestyle['tborder_color'].' !important;
            }

                
            .no-borders td, .no-borders th {
                border: none;
            }
        </style>';
            $keys = array_keys($reportarray);
            $columns = count($reportarray[$keys[0]]);
            $html.='<div style="text-align:center;font-size:18px;font-weight:bold;">'.$reportdetails[0]->report_name.'</div><br/>';
            $ConditionsInfo=$this->getFilterConditionsInfo($report_id);
            if($ConditionsInfo !=''){
                $html.='<div style="text-align:center;font-size:14px;font-weight:bold;">'.$ConditionsInfo.'</div><br/>';
            }
            if (!empty($reportdetails[0]->description)) {
                $html .= '<div style="text-align:center;font-size:14px;font-weight:bold;">Description: ' . htmlspecialchars($reportdetails[0]->description) . '</div><br/>';
            }
                $html.='<table class="table table-bordered '.$tablestyle['tstyle'].'" style="line-height: 1.5; width: 100%;">
                <thead>
                    <tr>';
                        foreach($keys as $key){
                                $html.='<th scope="col" style="'.$tablestyle['pdfhstyle'].'">'.$key.'</th>';
                        }
                    $html.='</tr>
                </thead>
                <tbody>';
                   for ($i = 0; $i < $columns; $i++) {
                       
                        $html .= '<tr>';
                        foreach ($reportarray as $key => $values) {
                            $rowColor = ($i % 2 == 0) ? $tablestyle['evenrowcolor'] : $tablestyle['oddrowcolor'];
                            $style = 'style="background-color:' . $rowColor . ';' . $tablestyle['pdfbstyle'] . '"';
                            if ($key == 'Comments') {
                                $html .= '<td ' . $style . '>' . html_entity_decode($values[$i]) . '</td>';
                            } else {
                                $html .= '<td ' . $style . '>' . $values[$i] . '</td>';
                            }
                        }
                        $html .= '</tr>';
                    }
                $html.='</tbody>';
                if(count($reportall['aggregatecolumns'])){
                    $html.='<tfoot><tr>';
                    foreach($aggrateValues as $key => $value){
                        $html.='<th  style="'.$tablestyle['pdffstyle'].'">'.$value.'</th>';
                    }
                    $html.='</tr></tfoot>';
                }
             $html.='</table>';
         
        }              
        if($reporttype =='HTML'){
    $border = $tablestyle['tborder_color'];
    $style = $tablestyle['tstyle'];
    $html = html_entity_decode($html);

    switch ($style) {
      case 'all-borders':
    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);
    $html = str_replace('<table', '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;width:100%;"', $html);

    
    $html = preg_replace_callback('/<t[dh]([^>]*)>/i', function ($m) use ($border) {
        $tag = substr(trim($m[0]), 1, 2); 
        $attrs = $m[1];
        $newStyle = 'border:1px solid ' . $border . ';padding:8px;';

        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
         
            if (stripos($style, 'border:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $newStyle;
            }
            $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
        } else {
            $attrs .= ' style="' . $newStyle . '"';
        }

        return "<$tag$attrs>";
    }, $html);

    break;

case 'outer-borders':
    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);


    $html = preg_replace_callback(
        '/<table([^>]*)>/i',
        function ($m) use ($border) {
            $attrs = $m[1];
            $newStyle = 'border-collapse:collapse;border:2px solid ' . $border . ';width:100%;';

            if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
                $style = $s[1];
                if (stripos($style, 'border:') === false) {
                    $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $newStyle;
                }
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
            } else {
                $attrs .= ' style="' . $newStyle . '"';
            }

            return '<table' . $attrs . '>';
        },
        $html
    );


    $html = preg_replace_callback('/<t[dh]([^>]*)>/i', function ($m) {
        $tag = substr(trim($m[0]), 1, 2); 
        $attrs = $m[1];
        $newStyle = 'padding:8px;'; 

        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'padding:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $newStyle;
            }
            $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
        } else {
            $attrs .= ' style="' . $newStyle . '"';
        }

        return "<$tag$attrs>";
    }, $html);

    break;


      case 'inner-borders':

    $html = str_replace('<table', '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;border:none;width:100%;"', $html);
    $rowCount = 0;


    $html = preg_replace_callback(
        '/<tr([^>]*)>(.*?)<\/tr>/si',
        function ($matches) use ($border, &$rowCount) {
            $trAttrs = $matches[1]; 
            $rowContent = $matches[2];

            $rowContent = preg_replace_callback(
                '/<t[dh]([^>]*)>/i',
                function ($m) use ($border, $rowCount) {
                    $tag = substr(trim($m[0]), 1, 2);
                    $attrs = $m[1];

                    if ($rowCount < 2) {
                        $newStyle = 'border-top:none;border-bottom:1px solid ' . $border . ';border-left:1px solid ' . $border . ';border-right:1px solid ' . $border . ';padding:8px;';
                    } else {
                        $newStyle = 'border:1px solid ' . $border . ';padding:8px;';
                    }

                    if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
                        $style = $s[1];
                        if (stripos($style, 'border:') === false) {
                            $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $newStyle;
                        }
                        $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
                    } else {
                        $attrs .= ' style="' . $newStyle . '"';
                    }

                    return "<$tag$attrs>";
                },
                $rowContent
            );

            $rowCount++;
            return '<tr' . $trAttrs . '>' . $rowContent . '</tr>';
        },
        $html
    );
    break;


        case 'bottom-borders':
            $html = html_entity_decode($html);
            $tborder = $tablestyle['tborder_color'];
       
            $html = str_replace(
                '<table',
                '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;"',
                $html
            );
        
$html = preg_replace_callback(
    '/<tr([^>]*)>/i',
    function ($m) {
        $attrs = $m[1];
        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'border:none') === false) {
                $newStyle = $style . (substr(trim($style), -1) === ';' ? '' : ';') . 'border:none;';
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $newStyle . '"', $attrs);
            }
        } else {
            $attrs .= ' style="border:none;"';
        }
        return '<tr' . $attrs . '>';
    },
    $html
);

 
            if (preg_match('/<thead[^>]*>(.*?)<\/thead>/is', $html, $theadMatch)) {
                $theadContent = $theadMatch[1];
                if (preg_match_all('/<tr[^>]*>.*?<\/tr>/is', $theadContent, $headRows)) {
                    $lastHeadRow = end($headRows[0]);
                    $lastStyled = strpos($lastHeadRow, 'style=') !== false
                        ? preg_replace(
                            '/<tr([^>]*)style="([^"]*)"/i',
                            '<tr$1 style="$2;border-bottom:2px solid ' . $tborder . ';"',
                            $lastHeadRow
                        )
                        : preg_replace(
                            '/<tr([^>]*)>/i',
                            '<tr$1 style="border-bottom:2px solid ' . $tborder . ';">',
                            $lastHeadRow
                        );
                    $theadUpdated = str_replace($lastHeadRow, $lastStyled, $theadContent);
                    $html = str_replace($theadMatch[1], $theadUpdated, $html);
                }
            }

    
            if (preg_match('/<tfoot[^>]*>(.*?)<\/tfoot>/is', $html, $tfootMatch)) {
                $tfootContent = $tfootMatch[1];
                if (preg_match_all('/<tr[^>]*>.*?<\/tr>/is', $tfootContent, $footRows)) {
                    $lastFootRow = end($footRows[0]);
                    $lastStyledFoot = strpos($lastFootRow, 'style=') !== false
                        ? preg_replace(
                            '/<tr([^>]*)style="([^"]*)"/i',
                            '<tr$1 style="$2;border-bottom:2px solid ' . $tborder . ';"',
                            $lastFootRow
                        )
                        : preg_replace(
                            '/<tr([^>]*)>/i',
                            '<tr$1 style="border-bottom:2px solid ' . $tborder . ';">',
                            $lastFootRow
                        );
                    $tfootUpdated = str_replace($lastFootRow, $lastStyledFoot, $tfootContent);
                    $html = str_replace($tfootMatch[1], $tfootUpdated, $html);
                }
            }
       
            elseif (preg_match('/<tbody[^>]*>(.*?)<\/tbody>/is', $html, $tbodyMatch)) {
                $tbodyContent = $tbodyMatch[1];
                if (preg_match_all('/<tr[^>]*>.*?<\/tr>/is', $tbodyContent, $bodyRows)) {
                    $lastBodyRow = end($bodyRows[0]);
                    $lastStyledBody = strpos($lastBodyRow, 'style=') !== false
                        ? preg_replace(
                            '/<tr([^>]*)style="([^"]*)"/i',
                            '<tr$1 style="$2;border-bottom:2px solid ' . $tborder . ';"',
                            $lastBodyRow
                        )
                        : preg_replace(
                            '/<tr([^>]*)>/i',
                            '<tr$1 style="border-bottom:2px solid ' . $tborder . ';">',
                            $lastBodyRow
                        );
                    $tbodyUpdated = str_replace($lastBodyRow, $lastStyledBody, $tbodyContent);
                    $html = str_replace($tbodyMatch[1], $tbodyUpdated, $html);
                }
            }
            break;

  case 'left-borders':

    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);

    
    $html = str_replace(
        '<table',
        '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;border-left:2px solid ' . $border . ';width:100%;"',
        $html
    );


    $html = preg_replace_callback('/<(td|th)([^>]*)>/i', function ($m) {
        $tag = $m[1];
        $attrs = $m[2];
        $padding = 'padding:8px;';
        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'padding:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $padding;
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
            }
        } else {
            $attrs .= ' style="' . $padding . '"';
        }

        return "<$tag$attrs>";
    }, $html);

    break;


      case 'right-borders':
    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);
    $html = str_replace(
        '<table',
        '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;border-right:2px solid ' . $border . ';width:100%;"',
        $html
    );
    $html = preg_replace_callback('/<(td|th)([^>]*)>/i', function ($m) {
        $tag = $m[1];
        $attrs = $m[2];
        $padding = 'padding:8px;';
        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'padding:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $padding;
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
            }
        } else {
            $attrs .= ' style="' . $padding . '"';
        }
        return "<$tag$attrs>";
    }, $html);

    break;


       case 'outer-borders':
    $border = $tablestyle['tborder_color'];
    $html = html_entity_decode($html);
    $html = str_replace(
        '<table',
        '<table cellspacing="0" cellpadding="4" style="border-collapse:collapse;border:2px solid ' . $border . ';width:100%;"',
        $html
    );

    $html = preg_replace_callback('/<(td|th)([^>]*)>/i', function ($m) {
        $tag = $m[1];
        $attrs = $m[2];
        $padding = 'padding:8px;';
        if (preg_match('/\bstyle\s*=\s*"(.*?)"/i', $attrs, $s)) {
            $style = $s[1];
            if (stripos($style, 'padding:') === false) {
                $style .= (substr(trim($style), -1) === ';' ? '' : ';') . $padding;
                $attrs = preg_replace('/\bstyle\s*=\s*"(.*?)"/i', 'style="' . $style . '"', $attrs);
            }
        } else {
            $attrs .= ' style="' . $padding . '"';
        }
        return "<$tag$attrs>";
    }, $html);

    break;
    }


    $html = preg_replace(
        '/<tr([^>]*)class="footer-row"[^>]*>/',
        '<tr$1class="footer-row" style="' . $tablestyle['pdffstyle'] . ';">',
        $html
    );

    return $html;
}
        $FileName=$reportdetails[0]->report_name;
        $mpdf = new \Mpdf\Mpdf(['mode' => 'ta-IN']);
        $mpdf->AddPage('L', // L - landscape, P - portrait
        '', '', '', '',
        5, // margin_left
        5, // margin right
        10, // margin top
        0, // margin bottom
        5, // margin header
        0); // margin footer
        //$mpdf->WriteHTML($html);
        $htmlChunks = str_split($html, 50000);
		foreach ($htmlChunks as $chunk) {
			$mpdf->WriteHTML(html_entity_decode($chunk));
		}
        $mpdf->SetTitle('Advanced Report');
        if($accessmode=='SendMail'){
            $dirname=public_path().'/AdvancedReport';
            if (!file_exists($dirname)) {
                mkdir($dirname, 0777, true);
            }  
            $mpdf->Output($dirname.'/'.$FileName.'.pdf', 'F');  
        }else{
            $mpdf->Output($FileName.'.pdf', 'D');
            exit;
        }
    }

    public function triggerCloseSchedule()
    {
        $this->loadTableContent('Scheduled Reports','','','listtab');
    }


    public function getExecutionTime($request) {

        $currentTime = date('Y-m-d H:i:s');
        $timeformat = (new User())->getCurrentUserTimeFormat() == '12 hours' ? 'h:i:s A' : 'H:i:s';
        $schduletime = (new User())->convertToUtc(trim($request['scheduleTime']), $timeformat, 'H:i:s');
       
        $execution_time = null;
        $dayOfWeek = [
            'Monday' => 'monday',
            'Tuesday' => 'tuesday',
            'Wednesday' => 'wednesday',
            'Thursday' => 'thursday',
            'Friday' => 'friday',
            'Saturday' => 'saturday',
            'Sunday' => 'sunday'
        ];
        if ($request['frequency'] == 'Daily') {
            $executeTime = date('Y-m-d ' . $schduletime);
            if ($currentTime > $executeTime) {
                $execution_time = date('Y-m-d H:i:s', strtotime('+1 day', strtotime($executeTime)));
            } else {
                $execution_time = date('Y-m-d H:i:s', strtotime($executeTime)+5);
            }
        }else if ($request['frequency'] === 'Weekly') {
            $schedule_days = $request['weeklydays'];
            if (array_key_exists($schedule_days, $dayOfWeek)) {
                $dayName = $dayOfWeek[$schedule_days];

                // Get the start of the day with the desired week day
                $executeTime = date('Y-m-d', strtotime("this week $dayName")) . ' ' . trim($schduletime);
                $executeTime = date('Y-m-d H:i:s', strtotime($executeTime)); // Ensures correct format

                if ($currentTime > $executeTime) {
                    $execution_time = date('Y-m-d', strtotime("next $dayName")) . ' ' . trim($schduletime);
                    $execution_time = date('Y-m-d H:i:s', strtotime($execution_time)); // Ensures correct format
                } else {
                    $execution_time = date('Y-m-d H:i:s', strtotime($executeTime) + 5); // Adds 5 seconds
                }
            }
        }elseif ($request['frequency'] === 'Monthly') {
            $monthly_radio = $request['monthlyradio'];
            if ($monthly_radio == 'date_time') {
                $month_date =$request['monthdate'];
                $currentMonth = date('n');
                $currentYear = date('Y');
                $currentTime = time();
                $executeTime = strtotime("$currentYear-$currentMonth-$month_date " . trim($schduletime));
                if ($currentTime > $executeTime) {
                    $nextMonth = ($currentMonth % 12) + 1;
                    $nextYear = ($nextMonth === 1) ? $currentYear + 1 : $currentYear;
                    $month_date = min($month_date, cal_days_in_month(CAL_GREGORIAN, $nextMonth, $nextYear));
                    $execution_time = date("$nextYear-$nextMonth-$month_date " . trim($schduletime));
                } else {
                    $execution_time = date("Y-m-d H:i:s", strtotime("$currentYear-$currentMonth-$month_date " . trim($schduletime)) + 5);
                }
        
            }elseif ($monthly_radio == 'start_day') {
                $month_date = $request['monthdate'];
                if (array_key_exists($month_date, $dayOfWeek)) {
                    $dayName = $dayOfWeek[$month_date];
                    $currentYear = date('Y');
                    $currentMonth = date('n');
                    $firstOccurrence = strtotime("first $dayName of $currentYear-$currentMonth " . trim($schduletime));
                    if ($currentTime > date('Y-m-d H:i:s', $firstOccurrence)) {
                        $nextMonth = ($currentMonth % 12) + 1;
                        $nextYear = ($nextMonth === 1) ? $currentYear + 1 : $currentYear;
                        $firstOccurrence = strtotime("first $dayName of $nextYear-$nextMonth " . trim($schduletime));
                    }
                    $execution_time = date('Y-m-d H:i:s', strtotime(date('Y-m-d', $firstOccurrence) . ' ' . trim($schduletime)) + 5);
                }
            }  else {
                $month_date =$request['monthdate'];
                if (array_key_exists($month_date, $dayOfWeek)) {
                    $dayName = $dayOfWeek[$month_date];
                    $currentYear = date('Y');
                    $currentMonth = date('n');
                    $lastOccurrence = strtotime("last $dayName of $currentYear-$currentMonth") + 5;
                }
                if ($currentTime > date('Y-m-d H:i:s', $lastOccurrence)) {
                    $nextMonth = ($currentMonth % 12) + 1;
                    $nextYear = ($nextMonth === 1) ? $currentYear + 1 : $currentYear;
                    $lastOccurrence = strtotime("last $dayName of $nextYear-$nextMonth");
                }
                $execution_time = date('Y-m-d H:i:s', strtotime(date('Y-m-d', $lastOccurrence) . ' ' . trim($schduletime)));
            
            }
        }
        return $execution_time;
    }

    public function SaveChartconfigure($report_id, $chartconfigure, $module_id)
    {
        $chartconfigure['module_id'] = $module_id; 
        
        if (DB::table('rsoft_advanced_report_chartconfigure')->where('report_id', $report_id)->exists()) {
            DB::table('rsoft_advanced_report_chartconfigure')
              ->where('report_id', $report_id)
              ->update($chartconfigure);
        } else {
            $chartconfigure['report_id'] = $report_id;
            DB::table('rsoft_advanced_report_chartconfigure')->insert($chartconfigure);
        }
    
        $this->UpdateModifiedInfo($report_id);
        $this->emit('hideModal');
       $this->loadTableContent('ChartReport',$module_id,$report_id);

    } 
    
    public function DeleteChartconfigure($report_id)
    {
        DB::table('rsoft_advanced_report_chartconfigure')->where('report_id', $report_id)->delete();
        $this->UpdateModifiedInfo($report_id);
        $this->emit('showMessage', 'Chart configuration deleted successfully!');
    }

    public function AdvancedeportDelete($moduleid)
    {
        $reportdata=DB::table('rsoft_advanced_report')->where('primarymodule',$moduleid)->get();
        foreach($reportdata as $val){
            $deletereportid=$val->report_id;
            DB::table('rsoft_advanced_report')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_columns')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_groupbycolumns')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_groupbyrows')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_aggregatecolumns')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_schedule')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_sharing')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_filter')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_tablestyle')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_formula')->where('report_id', $deletereportid)->delete();
            DB::table('rsoft_advanced_report_chartconfigure')->where('report_id', $deletereportid)->delete();
        }
    }


    public function fetchFormulaDetails($formulaId)
    {
       

       
        $formula = DB::table('rsoft_advanced_report_formula')
            ->where('formula_id', $formulaId)
            ->first();

       
        if ($formula) {
            $this->emit('formulaDetailsFetched', $formula);
        } else {
            $this->emit('formulaDetailsFetched', null);
        }
    }
    
    
    public function SaveFormula($report_id, $module_id, $functionName, $formulaName, $functionid, $formula_id = null)
    {
        if ($formula_id) {
            DB::table('rsoft_advanced_report_formula')
                ->where('formula_id', $formula_id) // Find the formula by formula_id
                ->update([
                    'formula_value' => $functionName, 
                    'formula_label' => $formulaName, 
                    'formula_functionid' => $functionid, 
                    'formula_modifiedtime' => now(), 
                    'formula_modifiedby' => Auth::user()->id, 
                ]);
        } else {
            DB::table('rsoft_advanced_report_formula')->insert([
                'formula_value' => $functionName, 
                'formula_label' => $formulaName, 
                'formula_functionid' => $functionid, 
                'report_id' => $report_id, 
                'module_id' => $module_id, 
                'formula_createdtime' => now(), 
                'formula_createdby' => Auth::user()->id, 
            ]);
        }
    }
    
    public function DeleteFormula($formulaId,$report_id,$module_id)
    {
        DB::table('rsoft_advanced_report_formula')  
                     ->where('formula_id', $formulaId)
                     ->delete();
         $this->loadTableContent('EditReport',$module_id,$report_id);

    }
    function getFormulaValue($value,$field){
     
        $value->recordid=$value->id;
        $value=json_decode(json_encode($value),true);
        $GetformulaFieldvalue = explode('|##|',$this->GetformulaFieldvalue($field['formula_value'],$value));
        $Calculatedvalue = $GetformulaFieldvalue[0];
        $formula = $Calculatedvalue;
       
        $Fieldforumlaname =  DB::table('rsoft_field_formula')->where('function_status',0)->where('defaultfunction',0)->pluck('function_name') ->whereNotIn('functionid', [7,19])->toarray();
        $FormulaCalculation = new FormulaCalculation();
        foreach ($Fieldforumlaname as $val) {
            $pattern = "/\b" . preg_quote($val, '/') . "\b/";
            $formulaval = preg_replace($pattern, '$FormulaCalculation->'.$val, $formula);
            $formula = $formulaval;
        } 
      
        try {
            $Finalval = eval("return ".$formulaval.";");
            if (is_bool($Finalval)) { 
                $Finalval = $Finalval ? 'true' : 'false';
            }
            if(is_nan((float) $Finalval)){
                $Finalval = 'NAN';
            }
        } catch(\Throwable $e){
            $formulaval =str_replace(['$FormulaCalculation->'],'',$formulaval) ;
            if(str_contains($formulaval,'Abs')){
                $formulaval = "";
            }
            $Finalval = "";
        }
        return $Finalval;
    }

    public function GetformulaFieldvalue($newval,$Requestrecord){
        $FormulaCalculation = new FormulaCalculation();
		if(isset($Requestrecord['recordid']) && ($Requestrecord['recordid'] != "" && $Requestrecord['recordid'] != 0)){
			$Crmentityrecords = DB::table('rsoft_crmentity')->select('created_time','modified_time','smcreatorid','smownerid','modifiedby')->where('crmid',$Requestrecord['recordid'])->get()->toarray()[0];
			$Requestrecord = array_merge((array)$Crmentityrecords ,$Requestrecord);
		}else{
			$Requestrecord['created_time']='';
			$Requestrecord['modified_time']='';
			if(array_key_exists('assign_to',$Requestrecord)){
				$Requestrecord['smownerid']=$Requestrecord['assign_to'];
			}
			$Requestrecord['smcreatorid']=(new User())->getCurrentUserId();
		}
		$changedzerovalue = "No";
		$timeformat ="H:i:s";

        if(isset(Auth::user()->users_timeformat) && Auth::user()->users_timeformat=='12 hours') $timeformat = "h:i:s A";

        $dateformat= isset(Auth::user()->users_timeformat) ? Auth::user()->users_dateformat." ".$timeformat : "Y-m-d ".$timeformat;
    
		foreach($Requestrecord as $key=> $value){
            $explodeval=explode('.',$key);
           
			if(str_contains($newval,$key)){
               
				if (count($explodeval) == 2 &&  (str_contains($newval, ".created_time") || str_contains($newval, ".modified_time")) && str_contains($newval, ".")) {
                    if(!empty($value)){
                        $value = (new User())->convertUserTimeZone($value,$dateformat,'Y-m-d H:i:s');
                    } 
				}elseif(count($explodeval)==2 && str_contains($newval,".smcreatorid") || str_contains($newval,".smownerid") || str_contains($newval,".modifiedby") &&
                str_contains($newval, ".")){
					if($Requestrecord[$key]!=''){
						$User = DB::table('rsoft_users')->where('id',$Requestrecord[$key])->get()->toarray();
                        if(count($User)){
                            $value = $User[0]->users_firstname.' '.$User[0]->users_lastname;
                        }
					}
				}
				$Fields = DB::table('rsoft_module_fields')->where('colname',$key)->get()->toarray();
				if(count($Fields)  && $value !=''){
					if($Fields[0]->field_type==7){
                        $value=(new User())->convertUserTimeZone($value,Auth::user()->users_dateformat,'Y-m-d');
					}elseif($Fields[0]->field_type==19){
                        $value=(new User())->convertUserTimeZone($value,$dateformat,'Y-m-d H:i:s');
					}elseif($Fields[0]->field_type==20){
                        $timeformatcheck=(new User())->getCurrentUserTimeFormat();
                        $timeformat =" H:i:s";
                        if($timeformatcheck=='12 hours') $timeformat = "h:i:s A";  
                      
                        $value = (new User())->convertUserTimeZone($value,$timeformat,'H:i:s');
                        
					}elseif($Fields[0]->field_type==11){
						$FieldsRel = DB::table('rsoft_fieldmodulerel')->where('fieldid',$Fields[0]->id)->get()->toarray();
						if(count($FieldsRel)){
							$Module= DB::table('rsoft_modules')->where('name',$FieldsRel[0]->relmodule)->get()->toarray();
							if(count($Module)){
								$RecordVal= DB::table($Module[0]->name_db)->where('id',$value)->get()->toarray();
								$colname=$Module[0]->view_col;
								$value=$RecordVal[0]->$colname;
							}
						}
					}elseif($Fields[0]->field_type==25){
                        //$value =round($value);
                        $arrayparms['value'] = $value;
						$value = $FormulaCalculation->dispalyingCurrencyFormat($arrayparms);
					}
				}
				$values = '$'.$key.'$';
               
				if($value == ""){$value='';$changedzerovalue="Yes";}
				$value = str_replace(array('"', "'"), '', $value);
				$replaceval = "'".$value."'";
				$relpaceval = str_replace($values,$replaceval,$newval);
				$newval = $relpaceval;
			}else{
				$relpaceval = $newval;
			}
		}
		return $relpaceval.'|##|'.$changedzerovalue;
	}

    public function getFilterConditionsInfo($report_id){
        $reportdetails=DB::table('rsoft_advanced_report')->where('report_id',$report_id)->join('rsoft_modules','rsoft_advanced_report.primarymodule','=','rsoft_modules.id')->get();
        $report_filter = $this->getReportFilters($report_id, $reportdetails);
        $filterDetails=''; 
        if(isset($report_filter) && count($report_filter)){
            $filterParts=[];
            foreach($report_filter as $index => $filter){
                $fieldName=$filter->label;
                if($filter->module!=$reportdetails[0]->id)
                    $fieldName.=' - ('.$filter->modulelabel.')';
                $operator=$Module->Allcustomefiltercondforfieldstypes[$filter->field_type][$filter->operator]??$filter->operator;
                $value=$filter->value;
                if ($filter->field_type != 'picklist' && $filter->field_type != 'multipicklist' && strpos($value, ',') !== false && !in_array(strtolower($operator), ['equals', 'not equals', 'is', 'is_not', 'is not', 'contains', 'in'])) {
                    [$startDate, $endDate] = explode(',', $value, 2);
                    $value = "$startDate to $endDate";
                } elseif (in_array($filter->field_type, [3, 9, 29, 30, 31, 21, 23]) && strpos($value, '#') !== false) {
                    $value = str_replace('#', ', ', $value);
                } elseif (in_array($filter->field_type, [13, 14, 15]) && $value && $filter->operator != 'contains' && $filter->operator != 'doesnotcontains') {
                    $value = str_replace('#', ', ', $value);
                } else {
                    $value = str_replace(',', ', ', $value);
                }
                $filterPart="($fieldName ($operator)-$value)";
                if($index > 0){
                    $relationshipLogic = $filter->logic ? strtoupper(trim($filter->logic)) : 'AND';
                    $filterParts[] = in_array($relationshipLogic, ['OR', 'NOT']) ? $relationshipLogic : 'AND';
                }
                $filterParts[] = $filterPart;
            }
            $filterDetails='Filter By: '.implode(' ', $filterParts);
        }
         return $filterDetails;
    }

    public function fetchCurrentReportId()
    {
        try {
            if (!$this->report_id) {
                $this->emit('error', 'No report ID set.');
                return;
            }
            $this->emit('currentReportIdFetched', $this->report_id);
        } catch (\Exception $e) {
            $this->emit('error', 'Failed to fetch report ID: ' . $e->getMessage());
        }
    }

    public function fetchSortedFields($report_id)
    {
        try {
            $report = DB::table('rsoft_advanced_report')
                ->where('report_id', $report_id)
                ->first();
            $misreport = DB::table('mis_report_table')
                ->where('report_id',$this->misCurrentReportId)
                ->where('id', $report_id)
                ->first();

            if (!$report) {
                $this->emit('error', 'Report not found.');
                return;
            }
            $sortedFields = json_decode(($this->pagemode === 'MISPreview'&& !empty($misreport->mis_group_sort))? $misreport->mis_group_sort: $report->group_sort,true);
            $this->emit('sortedFieldsFetched', $sortedFields);
        } catch (\Exception $e) {
            $this->emit('error', 'Failed to fetch sort fields: ' . $e->getMessage());
        }
    }

    public function fetchGroupByArrays($report_id)
    {
        try {
            $groupByRows = $this->fetchGroupByRows($report_id);
            $groupByColumns = $this->fetchGroupByColumns($report_id);
            $this->emit('groupByArraysFetched', [
                'groupByRows' => $groupByRows,
                'groupByColumns' => $groupByColumns,
            ]);
        } catch (\Exception $e) {
            $this->emit('error', 'Failed to fetch group by arrays: ' . $e->getMessage());
        }
    }

    public function updateSortFields($report_id, $sortedFields)
    {
        try {
            $report = DB::table('rsoft_advanced_report')
                ->where('report_id', $report_id)
                ->first();

            if (!$report) {
                $this->emit('error', 'Report not found. Cannot save sort fields.');
                return;
            }
            
            if($this->pagemode  !== 'MISPreview'){
            DB::table('rsoft_advanced_report')
                ->where('report_id', $report_id)
                ->update([
                    'group_sort' => json_encode($sortedFields),
                    'modifiedby' => Auth::user()->id,
                   'modifiedtime' => now()->utc()->format('Y-m-d H:i:s'),
                ]);
            }
            else{
                DB::table('mis_report_table')
                ->where('report_id',$this->misCurrentReportId)
                ->where('id', $report_id)
                ->update([
                    'mis_group_sort' => json_encode($sortedFields),]);
            }
            $this->report_id = $report_id;
            $reportId = ($this->pagemode === 'MISPreview')? $this->misCurrentReportId: $this->report_id;
            $this->loadTableContent($this->sidetabval, $this->module_id, $reportId);
            $this->emit('sortFieldsUpdated', $sortedFields);
            $this->emit('groupByArraysFetched', [
                'groupByRows' => $this->fetchGroupByRows($report_id),
                'groupByColumns' => $this->fetchGroupByColumns($report_id),
            ]);
        } catch (\Exception $e) {
            $this->emit('error', 'Failed to save sort fields: ' . $e->getMessage());
        }
    }

    public function changeRecord($report_id)
    {
        try {
            $this->report_id = $report_id;
            $this->emit('recordChanged', $report_id);
        } catch (\Exception $e) {
            $this->emit('error', 'Failed to change record: ' . $e->getMessage());
        }
    }

   public function fetchGroupByRows($report_id)
{
    try {
        $report = DB::table('rsoft_advanced_report')
            ->where('report_id', $report_id)
            ->first();

        if (!$report) {
            return [];
        }

        $groupSort = json_decode($report->group_sort, true) ?? [];
        $groupByRows = array_filter($groupSort, function ($item) {
            return isset($item['type']) && $item['type'] === 'Row';
        });

        $rows = array_map(function ($item) {
            return [
                'value' => (string) $item['field_id'], // Cast to string
                'label' => $item['label'],
                'field_id' => (string) $item['field_id'], // Cast to string
                'fieldname' => $item['fieldname'],
                'column_id' => $item['column_id'],
                'field_type' => $this->inferFieldType($item['fieldname']),
            ];
        }, array_values($groupByRows));

        return $rows;
    } catch (\Exception $e) {
        $this->emit('error', 'Failed to fetch group by rows: ' . $e->getMessage());
        return [];
    }
}

public function fetchGroupByColumns($report_id)
{
    try {
        $report = DB::table('rsoft_advanced_report')
            ->where('report_id', $report_id)
            ->first();

        if (!$report) {
            return [];
        }

        $groupSort = json_decode($report->group_sort, true) ?? [];
        $groupByColumns = array_filter($groupSort, function ($item) {
            return isset($item['type']) && $item['type'] === 'Column';
        });

        $columns = array_map(function ($item) {
            return [
                'value' => (string) $item['field_id'], // Cast to string
                'label' => $item['label'],
                'field_id' => (string) $item['field_id'], // Cast to string
                'fieldname' => $item['fieldname'],
                'column_id' => $item['column_id'],
                'field_type' => $this->inferFieldType($item['fieldname']),
            ];
        }, array_values($groupByColumns));

        return $columns;
    } catch (\Exception $e) {
        $this->emit('error', 'Failed to fetch group by columns: ' . $e->getMessage());
        return [];
    }
}

   

    public function updateGroupBy($mode, $fieldId)
    {
        try {
            $report = DB::table('rsoft_advanced_report')
                ->where('report_id', $this->report_id)
                ->first();

            if (!$report) {
                $this->emit('error', 'Report not found.');
                return;
            }

            $groupSort = json_decode($report->group_sort, true) ?? [];
            $typeToRemove = $mode === 'groupbyrows' ? 'Row' : 'Column';

    
            $updatedGroupSort = array_filter($groupSort, function ($item) use ($fieldId, $typeToRemove) {
                return !(isset($item['field_id']) && $item['field_id'] == $fieldId && isset($item['type']) && $item['type'] === $typeToRemove);
            });

           
            DB::table('rsoft_advanced_report')
                ->where('report_id', $this->report_id)
                ->update([
                    'group_sort' => json_encode(array_values($updatedGroupSort)),
                    'modifiedby' => Auth::user()->id,
                    'modifiedtime' => (new \App\Models\User())->getCurrentTimeUTC('Y-m-d H:i:s'),
                ]);

            $groupByRows = $this->fetchGroupByRows($this->report_id);
            $groupByColumns = $this->fetchGroupByColumns($this->report_id);
            $this->emit('updateGroupByArrays', [
                'groupByRows' => $groupByRows,
                'groupByColumns' => $groupByColumns,
            ]);
        } catch (\Exception $e) {
            $this->emit('error', 'Failed to update group by: ' . $e->getMessage());
        }
    }
    public function AdvancedMISReportSave($misreportname, $savemode, $misreportids, $reportmode, $report_id = ''){
        if($savemode == 'MISReportEdit') { 
            $existingReport = DB::table('rsoft_advanced_report')->where('report_id', $report_id)->first(); 
            $oldModules = array_filter(explode(',', $existingReport->primarymodule));
            $newModules = array_filter(explode(',', $misreportids));
            $removedModules = array_diff($oldModules, $newModules);
            if (!empty($removedModules)) {
                DB::table('mis_report_table')->where('report_id', $report_id)->whereIn('id', $removedModules)->delete();
            }
                $update = [
               'report_name' => trim($misreportname),
                'report_moduletype'=>$reportmode,
                'primarymodule' => $misreportids,
            ];
        DB::table('rsoft_advanced_report')->where('report_id', $report_id)->update($update);
        $rows = [];
        foreach ($newModules as $moduleId) {
            $rows[] = [
                'report_id' => $report_id,
                'id'        => (int) $moduleId,
            ];
        }
        DB::table('mis_report_table')->insertOrIgnore($rows);

        }elseif($savemode == 'MISReportCreate') {
            $totalReports = DB::table('rsoft_advanced_report')->count() + 1;
            $report_id = DB::table('rsoft_advanced_report')->insertGetId(['report_name' => trim($misreportname),'primarymodule' => $misreportids,'report_moduletype'=>$reportmode,'smcreatorid' => Auth::user()->id,'smownerid' => Auth::user()->id,'report_seq'=>$totalReports]);
            $newModules= array_filter(explode(',', $misreportids));
            foreach ($newModules as $moduleId) {
                DB::table('mis_report_table')->insert([
                    'report_id'=> $report_id,
                    'id' =>(int) $moduleId]);
                }
            }
        }
  
        public function getMISReports($module_id = '')
    {   
        $userid = Auth::user()->id;
        $roleid = Auth::user()->users_roles;
        $page=$this->page;
        $perPage=$this->perPage;
        $searchvalue=$this->searchValue;
        $column_name=$this->column_name;
        $sortmode=$this->sortmode;
        $profileid = DB::table('rsoft_role2profile')->where('roleid', '=', $roleid)->first()->permissionprofileid;
        //Listview data 
        $reports = DB::table('rsoft_advanced_report')
            ->leftJoin('rsoft_advanced_report_sharing', function($join) {
            $join->on('rsoft_advanced_report.report_id', '=', 'rsoft_advanced_report_sharing.report_id')
                ->where('rsoft_advanced_report_sharing.share_report_type', '=', 'MISReports');
            })
            // Add search filter if search value is provided
                ->when(!empty($searchvalue), function($query) use ($searchvalue) {
                $escapedSearchValue = str_replace(['\\', '%', '_'], ['\\\\', '\%', '\_'], $searchvalue);
                return $query->where(function($query) use ($escapedSearchValue) {
                    $query->where('rsoft_advanced_report.report_name', 'like', '%' . $escapedSearchValue . '%')
                    ->orWhere('rsoft_advanced_report.report_name', 'like', '%' . $escapedSearchValue . '%');
                });
            })
            // sharing permissiom for the user base and roles
            ->when($userid != '1', function($query) use ($userid, $roleid) {
                $query->where(function($query) use ($userid, $roleid) {
                    $query->where('rsoft_advanced_report.smcreatorid', $userid)
                    ->orWhere('rsoft_advanced_report_sharing.share_type', 'public')
                    ->orWhereIn('rsoft_advanced_report_sharing.share_width_user', [$userid, $roleid]);
                });
            })
            ->where('rsoft_advanced_report.report_moduletype', 'MISReport')
            ->select('rsoft_advanced_report.*', 'rsoft_advanced_report_sharing.share_permission')
            ->groupBy('rsoft_advanced_report.report_id')
            ->orderBy('rsoft_advanced_report.report_seq', 'ASC')
            ->get();
         $reportarray = [];
            foreach ($reports as $value) {
                // if (empty($value->primarymodule)) {
                //     continue;
                // }
                $ids = array_map('intval', explode(',', $value->primarymodule));
                $names = DB::table('rsoft_advanced_report')->whereIn('report_id', $ids)->pluck('report_name')->toArray();
                $scheduledata = DB::table('rsoft_advanced_report_schedule')->where('report_id', $value->report_id)
                ->when($userid != '1', function($query) use ($userid, $roleid) {
                    $query->where(function($query) use ($userid, $roleid) {
                        $query->where('schedule_createdby',$userid);
                    });
                })
                ->get();
                $schedule_status = DB::table('rsoft_advanced_report_schedule')->where('report_id', $value->report_id)
                  ->when($userid != '1', function($query) use ($userid, $roleid) {
                    $query->where(function($query) use ($userid, $roleid) {
                        $query->where('schedule_createdby',$userid);
                    });
                })
                ->where('schedule_status', 1)->get();
                $reportarray[$value->primarymodule][] = [
                    'report_id' => $value->report_id,
                    'report_name' => $value->report_name,
                    'select_report_name' => implode(', ', $names),
                    'select_report_id' => $value->primarymodule,
                    'schedule_count' => count($scheduledata),
                    'schdule_data'    => $scheduledata,
                    'schedule_status' =>count($schedule_status),
                    'smcreatorid' => $value->smcreatorid,
                    'share_permission' => $value->share_permission
                ];
            }
            return [
                'totalCount' => count($reportarray),
                'allreports' => $reportarray,

            ];
     }

     public function MISDeleteReport($delreportid,$delmode ='',$delSchedule ='')
    {  
        if($delmode !="Misreportschdule"){
            DB::table('rsoft_advanced_report')->where('report_id', $delreportid)->delete();
            DB::table('rsoft_advanced_report_schedule')->where('report_id', $delreportid)->delete();
            DB::table('rsoft_advanced_report_sharing')->where('report_id', $delreportid)->delete();
            DB::table('mis_report_table')->where('report_id', $delreportid)->delete();
        }else{
            DB::table('rsoft_advanced_report_schedule')->where('schedule_id', $delSchedule)->delete();
        }   
    }

    private function cleanValue($value) {
        // Replace non-breaking space and trim
        return trim(preg_replace('/\x{00A0}|\xC2\xA0/u', ' ', $value));
    }

  public function getPicklistFields($module_id)
    {
        if (empty($module_id)) {
            return [];
        }

        try {
            $picklistFields = DB::table('rsoft_module_fields')
                ->where('module', $module_id)
                ->whereIn('field_type', [9, 29, 30, 31, 14, 15, 13]) // <-- Added 13 here
                ->where('active', 1)
                ->select('id as field_id', 'label as field_label', 'colname', 'field_type')
                ->get()
                ->map(function ($field) use ($module_id) {
                    $moduleName = DB::table('rsoft_modules')->where('id', $module_id)->value('name') ?? 'Unknown';
                    return [
                        'field_id' => $field->field_id,
                        'label' => $field->field_label,
                        'colname' => $field->colname,
                        'field_type' => $field->field_type,
                        'module_name' => $moduleName,
                    ];
                });

        
            $customOrder = [
                'Created By',
                'Assigned To',
                'Modified By',
                'Picklist fields',
                'City',
                'State',
                'Country',
            ];

        
            $picklistFields = $picklistFields->sortBy(function ($field) use ($customOrder) {
                $index = array_search($field['label'], $customOrder);
                return $index === false ? 999 : $index;
            })->values()->toArray();

            return $picklistFields;
        } catch (\Exception $e) {
            return [];
        }
    }


 public function getPicklistValues($field_id, $field_type, $colname, $module_name)
{
    $picklistValues = [];
    $crmentityTable = 'rsoft_crmentity';
    
   
    $normalize = function(string $s) {
        $s = str_replace("\xc2\xa0", ' ', $s); 
        $s = preg_replace('/\s+/', ' ', $s); 
        return trim($s);
    };

    $toValueLabelArray = function(array $values) use ($normalize) {
        $out = [];
        foreach ($values as $v) {
            if (is_array($v)) {
                if (isset($v['value'])) {
                    $val = $normalize((string)$v['value']);
                    $lab = $normalize((string)($v['label'] ?? $v['value']));
                    if ($val !== '') $out[] = ['value' => $val, 'label' => $lab];
                } elseif (isset($v->value)) {
                    $val = $normalize((string)$v->value);
                    $lab = $normalize((string)($v->label ?? $v->value));
                    if ($val !== '') $out[] = ['value' => $val, 'label' => $lab];
                }
            } else {
                $val = $normalize((string)$v);
                if ($val !== '') $out[] = ['value' => $val, 'label' => $val];
            }
        }
        return $out;
    };
 
    if (in_array($field_type, [9, 29, 30, 31])) {
        if ($field_type == 9) {
            $moduleTable = DB::table('rsoft_modules')->where('name', $module_name)->value('name_db');
            $cleanCol = preg_replace('/^' . strtolower($module_name) . '_/', '', $colname);
            $picklistMasterTable = strtolower($module_name) . '_' . $cleanCol;
            if (!DB::getSchemaBuilder()->hasTable($picklistMasterTable)) {
                $picklistMasterTable = $cleanCol;
            }
        } else {
            $moduleTable = DB::table('rsoft_modules')->where('name', $module_name)->value('name_db');
            $picklistMasterTable = $field_type == 29 ? 'rsoft_city' : ($field_type == 30 ? 'rsoft_state' : 'rsoft_country');
        }
 
        $recordedValues = [];
        if (!empty($moduleTable) && DB::getSchemaBuilder()->hasTable($moduleTable)) {
            try {
                $recordedValues = DB::table($moduleTable)
                    ->join($crmentityTable, "$moduleTable.id", '=', "$crmentityTable.crmid")
                    ->whereNotNull($colname)
                    ->where($colname, '!=', '')
                    ->where("$crmentityTable.deleted", 0)
                    ->where("$crmentityTable.module_name", $module_name)
                    ->selectRaw("DISTINCT {$moduleTable}.{$colname} as value")
                    ->orderBy($colname)
                    ->pluck('value')
                    ->map(fn($v) => $normalize((string)$v))
                    ->filter(fn($v) => $v !== '')
                    ->unique() 
                    ->values()
                    ->toArray();
            } catch (\Throwable $e) {
                $recordedValues = [];
            }
        }
 
        $masterValues = [];
        if (!empty($picklistMasterTable) && DB::getSchemaBuilder()->hasTable($picklistMasterTable)) {
            try {
                $masterValues = DB::table($picklistMasterTable)
                    ->selectRaw("picklistvalue as value, picklistvalue as label")
                    ->orderBy('picklistvalue')
                    ->get()
                    ->map(fn($r) => [
                        'value' => $normalize((string)$r->value),
                        'label' => $normalize((string)$r->label)
                    ])
                    ->filter(fn($r) => $r['value'] !== '')
                    ->unique('value') 
                    ->values()
                    ->toArray();
            } catch (\Throwable $e) {
                $masterValues = [];
            }
        }
        $masterArr = $toValueLabelArray($masterValues);
        $recordedArr = $toValueLabelArray($recordedValues);

        $final = [];
        foreach ($masterArr as $m) {
            $final[$m['value']] = ['value' => $m['value'], 'label' => $m['label'], 'mapped' => true];
        }
        foreach ($recordedArr as $r) {
            $val = $r['value'];
            if (!array_key_exists($val, $final)) {
                $final[$val] = ['value' => $val, 'label' => $r['label'] ?: $val, 'mapped' => false];
            } else {
                
                if (empty($final[$val]['label']) && !empty($r['label'])) {
                    $final[$val]['label'] = $r['label'];
                }
                $final[$val]['mapped'] = true;
            }
        }

       
        $final = collect($final)->unique('value')->values()->all();

        $picklistValues = array_map(fn($i) => ['value' => $i['value'], 'label' => $i['label']], $final);

    } elseif (in_array($field_type, [13, 14, 15])) {
        if ($colname === 'smcreatorid' || $colname === 'modifiedby' || $colname === 'smownerid' || $field_type == 15) {
            $picklistValues = DB::table('rsoft_users')
                ->where('active', 1)
                ->whereNull('deleted_at')
                ->select('id as value',
                    DB::raw("CASE
                        WHEN TRIM(CONCAT(users_firstname, ' ', users_lastname)) = '' THEN id
                        WHEN users_firstname IS NULL OR users_firstname = '' THEN users_lastname
                        WHEN users_lastname IS NULL OR users_lastname = '' THEN users_firstname
                        ELSE CONCAT(users_firstname, ' ', users_lastname)
                    END as label"))
                ->orderBy('label')
                ->get()
                ->map(fn($r) => ['value' => trim((string)$r->value), 'label' => trim((string)$r->label)]) // Added: trim
                ->toArray();
        } else {
            $fieldRel = DB::table('rsoft_fieldmodulerel')->where('fieldid', $field_id)->first();
            if ($fieldRel && $fieldRel->relmodule) {
                $relModule = DB::table('rsoft_modules')->where('name', $fieldRel->relmodule)->first();
                if ($relModule) {
                    $picklistValues = DB::table($relModule->name_db)
                        ->join($crmentityTable, "$relModule->name_db.id", '=', "$crmentityTable.crmid")
                        ->select('id as value', "$relModule->view_col as label")
                        ->where("$crmentityTable.deleted", 0)
                        ->where("$crmentityTable.module_name", $relModule->name)
                        ->orderBy($relModule->view_col)
                        ->get()
                        ->map(fn($r) => ['value' => trim((string)$r->value), 'label' => trim((string)$r->{$relModule->view_col})]) // Added: trim
                        ->toArray();
                }
            }
        }
    }
    return $picklistValues;
}


public function checkExistingPicklistTracking($trackingData)
{
    try {
        // Validate input
        if (empty($trackingData['picklist'])) {
            throw new \Exception('Picklist column name is required.');
        }
        if (empty($trackingData['entries']) || !is_array($trackingData['entries'])) {
            throw new \Exception('Picklist entries are required and must be an array.');
        }

        $picklist = $trackingData['picklist'];
        $entries = $trackingData['entries'];
        $currentTrackingId = $trackingData['trackingId'] ?? null;


        // Query existing trackings
        $query = DB::table('rsoft_advanced_report_picklisttracking')
            ->where('picklist_columnname', $picklist)
            ->where('module_id', $this->module_id)
            ->where('report_id', $this->report_id);

        if ($currentTrackingId) {
            $query->where('tracking_id', '!=', $currentTrackingId);
        }

        $existingTrackings = $query->get();

        foreach ($existingTrackings as $tracking) {
            $existingEntries = json_decode($tracking->picklist_data, true);
            
            // Handle invalid JSON
            if (json_last_error() !== JSON_ERROR_NONE) {
                continue;
            }

            // Ensure existingEntries is an array
            if (!is_array($existingEntries)) {
                continue;
            }

            foreach ($entries as $newEntry) {
                // Validate new entry
                if (empty($newEntry['fromValue']) || empty($newEntry['toValue']) || empty($newEntry['formula'])) {
                    continue;
                }

                foreach ($existingEntries as $existingEntry) {
                    if ($this->entriesMatch($newEntry, $existingEntry)) {
                        // Return response based on how the method was called
                        if (request()->hasHeader('X-Livewire')) {
                            $this->dispatchBrowserEvent('existingTrackingChecked', [
                                'exists' => true,
                                'trackingName' => $tracking->tracking_name,
                                'trackingId' => $tracking->tracking_id,
                                'message' => "This combination already exists in tracking '{$tracking->tracking_name}'"
                            ]);
                            return;
                        } else {
                            return response()->json([
                                'exists' => true,
                                'trackingName' => $tracking->tracking_name,
                                'trackingId' => $tracking->tracking_id,
                                'message' => "This combination already exists in tracking '{$tracking->tracking_name}'"
                            ]);
                        }
                    }
                }
            }
        }

        // Return response based on how the method was called
        if (request()->hasHeader('X-Livewire')) {
            $this->dispatchBrowserEvent('existingTrackingChecked', ['exists' => false]);
        } else {
            return response()->json(['exists' => false]);
        }
        // NEW: Check if picklist field is already used in other trackings
        $existingTrackings = DB::table('rsoft_advanced_report_picklisttracking')
            ->where('picklist_columnname', $trackingData['picklist'])
            ->where('report_id', $this->report_id)
            ->where('module_id', $this->module_id)
            ->when($trackingData['trackingId'] ?? null, function($query, $trackingId) {
                return $query->where('tracking_id', '!=', $trackingId);
            })
            ->get();

        if ($existingTrackings->isNotEmpty()) {
            return response()->json([
                'picklistFieldUsed' => true, // New flag
                'trackingNames' => $existingTrackings->pluck('tracking_name')->toArray(),
                'message' => "This picklist field is already used in other trackings"
            ]);
        }

    } catch (\Exception $e) {
        
        // Return error response based on how the method was called
        if (request()->hasHeader('X-Livewire')) {
            $this->dispatchBrowserEvent('existingTrackingChecked', [
                'exists' => false,
                'error' => 'Failed to check existing tracking: ' . $e->getMessage()
            ]);
        } else {
            return response()->json([
                'exists' => false,
                'error' => 'Failed to check existing tracking: ' . $e->getMessage()
            ], 500);
        }
    }
}

    protected function entriesMatch($newEntry, $existingEntry)
{
    
    $newFromValue = $newEntry['fromValue'] ?? $newEntry['from_picklist']['value'] ?? null;
    $newToValue = $newEntry['toValue'] ?? $newEntry['to_picklist']['value'] ?? null;
    $newFormula = $newEntry['formula'] ?? null;

    $existingFromValue = $existingEntry['from_value'] ?? $existingEntry['from_picklist']['value'] ?? null;
    $existingToValue = $existingEntry['to_value'] ?? $existingEntry['to_picklist']['value'] ?? null;
    $existingFormula = $existingEntry['formula'] ?? null;

    return $newFromValue === $existingFromValue &&
           $newToValue === $existingToValue &&
           $newFormula === $existingFormula;
}
   
   public function fetchPicklistValues($field_id)
    {
        try {
            $field = DB::table('rsoft_module_fields')
                ->join('rsoft_modules', 'rsoft_module_fields.module', '=', 'rsoft_modules.id')
                ->where('rsoft_module_fields.id', $field_id)
                ->whereIn('rsoft_module_fields.field_type', [9, 29, 30, 31, 13, 14, 15])
                ->select('rsoft_module_fields.field_type', 'rsoft_module_fields.colname', 'rsoft_modules.name as module_name')
                ->first();

            if (!$field) {
                $this->emit('error', 'Field not found or invalid field type.');
                return;
            }

            $values = $this->getPicklistValues($field_id, $field->field_type, $field->colname, $field->module_name);
            $this->picklistValues[$field->colname] = $values;
            $this->emit('picklistValuesFetched', $values);
        } catch (\Exception $e) {
            $this->emit('error', 'Failed to fetch picklist values: ' . $e->getMessage());
        }
    }



    public function savePicklistTracking($trackingData)
{
    try {
       
        if (empty($trackingData['trackingName'])) throw new \Exception('Picklist Tracking Name is required.');
        if (empty($trackingData['picklist'])) throw new \Exception('Picklist is required.');
        if (empty($trackingData['entries']) || !is_array($trackingData['entries'])) throw new \Exception('At least one picklist entry is required.');
        if (empty($this->module_id)) throw new \Exception('Module ID is not set.');
        if (empty($this->report_id)) throw new \Exception('Report ID is not set.');


        $duplicateCheck = $this->checkExistingPicklistTracking([
            'picklist' => $trackingData['picklist'],
            'entries' => $trackingData['entries'],
            'trackingId' => null
        ]);

        if (($duplicateCheck->original['exists'] ?? false) || isset($duplicateCheck->original['error'])) {
            $this->popupIsOpen = true;
            $this->dispatchBrowserEvent('duplicateTrackingFound', $duplicateCheck->original);
            return;
        }

     
        $trackingName = trim($trackingData['trackingName']);
        $picklistColname = $trackingData['picklist'];
        $reportId = $trackingData['reportId'];
        $currentUserId = auth()->id();

        if (DB::table('rsoft_advanced_report_picklisttracking')
            ->where('tracking_name', $trackingName)
            ->where('report_id', $reportId)
            ->exists()) {
            $this->popupIsOpen = true;
            $this->dispatchBrowserEvent('trackingNameExists', [
                'message' => 'The Report Name Already Exists',
                'operation' => 'trackingNameCheck'
            ]);
            return;
        }


        $module = DB::table('rsoft_modules')->where('id', $this->module_id)->first();
        if (!$module) throw new \Exception('Module not found.');

        $field = DB::table('rsoft_module_fields')->where('colname', $picklistColname)->where('module', $this->module_id)->first();
        if (!$field) throw new \Exception("Picklist field with colname $picklistColname not found.");


        $picklistData = array_map(function ($entry, $index) {
            if (empty($entry['fromValue']) || empty($entry['toValue']) || empty($entry['formula'])) {
                throw new \Exception("Invalid data in picklist entry at index $index.");
            }
            return [
                'from_value' => $entry['fromValue'],
                'to_value' => $entry['toValue'],
                'formula' => $entry['formula'],
            ];
        }, $trackingData['entries'], array_keys($trackingData['entries']));

      
        DB::table('rsoft_advanced_report_picklisttracking')->insert([
            'tracking_name' => $trackingName,
            'module_name' => $module->name,
            'module_id' => $this->module_id,
            'field_id' => $field->id,
            'colname' => $picklistColname,
            'fieldtype' => $field->field_type ?? null,
            'picklist_columnname' => $picklistColname,
            'createdby' => $currentUserId,
            'modifiedby' => $currentUserId,
            'picklist_data' => json_encode($picklistData),
            'report_id' => $reportId,
            'created_at' => now(),
            'updated_at' => now(),
        ]);

     
        $this->popupIsOpen = false;
        $this->dispatchBrowserEvent('success', [
            'message' => 'Picklist Tracking saved successfully.',
            'operation' => 'savePicklist'
        ]);
        $this->emit('select2Updated');

        $this->reset(['trackingData', 'popupIsOpen']);

    } catch (\Exception $e) {
        $this->popupIsOpen = true;
        $this->dispatchBrowserEvent('error', ['message' => 'Failed to save: ' . $e->getMessage()]);
    }
}


   public function updatePicklistTracking($trackingData)
{
    try {
        if (empty($trackingData['trackingId'])) throw new \Exception('Tracking ID is required.');
        if (empty($trackingData['trackingName'])) throw new \Exception('Picklist Tracking Name is required.');
        if (empty($trackingData['picklist'])) throw new \Exception('Picklist is required.');
        if (empty($trackingData['entries']) || !is_array($trackingData['entries'])) throw new \Exception('At least one picklist entry is required.');
        if (empty($this->module_id)) throw new \Exception('Module ID is not set.');
        if (empty($this->report_id)) throw new \Exception('Report ID is not set.');

        $trackingId = $trackingData['trackingId'];
        $trackingName = trim($trackingData['trackingName']);
        $picklistColname = $trackingData['picklist'];
        $reportId = $trackingData['reportId'];
        $currentUserId = auth()->id(); // Get current user ID

        if (DB::table('rsoft_advanced_report_picklisttracking')
            ->where('tracking_name', $trackingName)
            ->where('report_id', $reportId)
            ->where('tracking_id', '!=', $trackingId)
            ->exists()) {
            $this->popupIsOpen = true;
            $this->dispatchBrowserEvent('trackingNameExists', [
                'message' => 'The Report Name Already Exists',
                'operation' => 'trackingNameCheck'
            ]);
            return;
        }

        $module = DB::table('rsoft_modules')->where('id', $this->module_id)->first();
        if (!$module) throw new \Exception('Module not found.');

        $field = DB::table('rsoft_module_fields')->where('colname', $picklistColname)->where('module', $this->module_id)->first();
        if (!$field) throw new \Exception("Picklist field with colname $picklistColname not found.");

        // Use the same JSON structure as in savePicklistTracking
        $picklistData = array_map(function ($entry, $index) {
            if (empty($entry['fromValue']) || empty($entry['toValue']) || empty($entry['formula'])) {
                throw new \Exception("Invalid data in picklist entry at index $index.");
            }
            return [
                'from_value' => $entry['fromValue'],
                'to_value' => $entry['toValue'],
                'formula' => $entry['formula'],
            ];
        }, $trackingData['entries'], array_keys($trackingData['entries']));

        $updated = DB::table('rsoft_advanced_report_picklisttracking')
            ->where('tracking_id', $trackingId)
            ->where('report_id', $reportId)
            ->where('module_id', $this->module_id)
            ->update([
                'tracking_name' => $trackingName,
                'module_name' => $module->name,
                'module_id' => $this->module_id,
                'field_id' => $field->id,
                'colname' => $picklistColname,
                'fieldtype' => $field->field_type ?? null,
                'picklist_columnname' => $picklistColname,
                'picklist_data' => json_encode($picklistData),
                'modifiedby' => $currentUserId,
                'updated_at' => now(),
            ]);

        if ($updated) {
            $this->popupIsOpen = false;
            $this->dispatchBrowserEvent('success', [
                'message' => 'Picklist Tracking updated successfully.',
                'operation' => 'updatePicklist'
            ]);
            $this->emit('select2Updated');
        } else {
            throw new \Exception('No changes made or tracking ID not found.');
        }
    } catch (\Exception $e) {
        $this->popupIsOpen = true;
        $this->dispatchBrowserEvent('error', ['message' => 'Failed to update: ' . $e->getMessage()]);
    }
}



   public function deletePicklistTracking($trackingId)
{
    DB::beginTransaction();
    try {
       
        $deleted = DB::table('rsoft_advanced_report_picklisttracking')
            ->where('tracking_id', $trackingId)
            ->where('report_id', $this->report_id)
            ->where('module_id', $this->module_id)
            ->delete();

        if ($deleted) {
         
            DB::table('rsoft_advanced_report_groupbycolumns')
                ->where('report_id', $this->report_id)
                ->where('picklist_tracking_id', $trackingId)
                ->delete();

            DB::table('rsoft_advanced_report_groupbyrows')
                ->where('report_id', $this->report_id)
                ->where('picklist_tracking_id', $trackingId)
                ->delete();

            
            DB::table('rsoft_advanced_report_aggregatecolumns')
                ->where('report_id', $this->report_id)
                ->where('picklist_tracking_id', $trackingId)
                ->delete();

            DB::commit();
            session()->flash('toastr', ['type' => 'info', 'message' => 'Picklist Tracking and all related columns deleted successfully.']);
            $this->emit('picklistTrackingDeleted', $trackingId);
        } else {
            throw new \Exception('Picklist Tracking not found or could not be deleted.');
        }
    } catch (\Exception $e) {
        DB::rollBack();
        session()->flash('toastr', ['type' => 'info', 'message' => 'Failed to delete: ' . $e->getMessage()]);
    }
}




public function fetchPicklistTrackingDetails($trackingId)
{
    try {
        $this->isEditingPopup = true;
        $this->dispatchBrowserEvent('popupStateUpdated', ['popupIsOpen' => true]);
        $this->currentTrackingId = $trackingId;
       
        $tracking = DB::table('rsoft_advanced_report_picklisttracking')
            ->where('tracking_id', $trackingId)
            ->where('report_id', $this->report_id)
            ->where('module_id', $this->module_id)
            ->first();
 
        if (!$tracking) {
            throw new \Exception('Picklist Tracking not found');
        }
 
        $field = DB::table('rsoft_module_fields')
            ->where('id', $tracking->field_id)
            ->select('colname', 'field_type')
            ->first();
 
        $fieldExists = !is_null($field);
        $picklistColname = $fieldExists ? $field->colname : null;
 
        $picklistData = json_decode($tracking->picklist_data, true) ?? [];
 
       // Ensure picklist values are loaded
        if ($fieldExists && !isset($this->picklistValues[$picklistColname])) {
            $this->picklistValues[$picklistColname] = $this->getPicklistValues(
                $tracking->field_id,
                $field->field_type,
                $picklistColname,
                $tracking->module_name
            );
        }
 
        $entries = [];
        foreach ($picklistData as $entry) {
            // Handle both old and new JSON structures
            $fromValue = $entry['from_picklist']['value'] ?? $entry['from_value'] ?? '';
            $toValue = $entry['to_picklist']['value'] ?? $entry['to_value'] ?? '';
           
            $entries[] = [
                'fromValue' => $fromValue,
                'toValue' => $toValue,
                'formula' => $entry['formula'] ?? 'avg_time'
            ];
        }
 
        $this->dispatchBrowserEvent('picklistTrackingDetailsFetched', [
            'trackingId' => $tracking->tracking_id,
            'trackingName' => $tracking->tracking_name,
            'picklist' => $picklistColname,  
            'entries' => $entries,
            'fieldExists'  => $fieldExists        
        ]);
 
    } catch (\Exception $e) {
        $this->dispatchBrowserEvent('error', [
            'message' => 'Failed to fetch details: ' . $e->getMessage()
        ]);
        $this->closePicklistPopup();
    }
}


    public function updatePicklistTrackingOnRename($data)
{
    try {
        $moduleName = $data['moduleName'];
        $oldValue = $data['itemtorename'];
        $newValue = $data['newname'];
        $colname = $data['tablename'];

        // Find the module
        $module = DB::table('rsoft_modules')->where('name', $moduleName)->first();
        if (!$module) {
            throw new \Exception('Module not found: ' . $moduleName);
        }

        // Find all tracking records that use this picklist column
        $trackings = DB::table('rsoft_advanced_report_picklisttracking')
            ->where('module_id', $module->id)
            ->where('picklist_columnname', $colname)
            ->get();

        foreach ($trackings as $tracking) {
            $picklistData = json_decode($tracking->picklist_data, true);
            
            if (json_last_error() !== JSON_ERROR_NONE) {
                continue;
            }

            $updated = false;
            
            // Update both from_value and to_value fields in all entries
            foreach ($picklistData as &$entry) {
                // Handle both old and new data structures
                if (isset($entry['from_value']) && $entry['from_value'] === $oldValue) {
                    $entry['from_value'] = $newValue;
                    $updated = true;
                }
                if (isset($entry['to_value']) && $entry['to_value'] === $oldValue) {
                    $entry['to_value'] = $newValue;
                    $updated = true;
                }
                
                // Handle nested structure if exists
                if (isset($entry['from_picklist']['value']) && $entry['from_picklist']['value'] === $oldValue) {
                    $entry['from_picklist']['value'] = $newValue;
                    $updated = true;
                }
                if (isset($entry['to_picklist']['value']) && $entry['to_picklist']['value'] === $oldValue) {
                    $entry['to_picklist']['value'] = $newValue;
                    $updated = true;
                }
            }

            if ($updated) {
                DB::table('rsoft_advanced_report_picklisttracking')
                    ->where('tracking_id', $tracking->tracking_id)
                    ->update([
                        'picklist_data' => json_encode($picklistData),
                        'updated_at' => now()
                    ]);
            }
        }

        // Refresh frontend picklist values
        $this->emit('picklistValuesUpdated', [
            'colname' => $colname,
            'oldValue' => $oldValue,
            'newValue' => $newValue
        ]);

        return ['success' => true, 'message' => 'Picklist tracking updated successfully'];

    } catch (\Exception $e) {
        return ['success' => false, 'message' => 'Failed to update picklist tracking: ' . $e->getMessage()];
    }
}


   public function fetchPicklistTrackingResults($trackingConfig)
{
    try {
        $results = [];
        $trackingName = $trackingConfig['trackingName'];
        $picklistColname = $trackingConfig['picklist'];
        $module = DB::table('rsoft_modules')->where('name', $this->module)->first();
        if (!$module) throw new \Exception('Module not found.');
 
        $tableName = $module->name_db;
        $crmentityTable = 'rsoft_crmentity';
        $field = DB::table('rsoft_module_fields')->where('colname', $picklistColname)->where('module', $this->module_id)->first();
        if (!$field) throw new \Exception('Picklist field not found.');
 
        $fieldType = $field->field_type;
        $picklistValuesTable = $fieldType == 9 ? $tableName :
                              ($fieldType == 29 ? 'rsoft_city' : ($fieldType == 30 ? 'rsoft_state' : 'rsoft_country'));
        $valueColumn = $fieldType == 9 ? $picklistColname : 'picklistvalue';
 
        foreach ($trackingConfig['entries'] as $entry) {
            $fromValue = $entry['fromValue'];
            $toValue = $entry['toValue'];
            $formula = $entry['formula'];
 
            $validValues = array_column($this->picklistValues[$picklistColname] ?? [], 'value');
            if (!in_array($fromValue, $validValues) || !in_array($toValue, $validValues)) {
                throw new \Exception("Invalid 'From' or 'To' value for picklist $picklistColname.");
            }
 
            $query = DB::table($tableName)
                ->join($crmentityTable, "$tableName.id", '=', "$crmentityTable.crmid")
                ->where("$crmentityTable.deleted", 0)
                ->where("$crmentityTable.module_name", $this->module);
 
            if ($fieldType != 9) {
                $query->leftJoin($picklistValuesTable, "$tableName.$picklistColname", '=', "$picklistValuesTable.$valueColumn");
            }
 
            $historyResults = DB::table('rsoft_field_history')
                ->where('field_name', $picklistColname)
                ->where('old_value', $fromValue)
                ->where('new_value', $toValue)
                ->select('record_id', 'old_value', 'new_value', 'changed_at')
                ->get();
 
            $metric = [];
            if ($formula == 'avg_time') {
                $count = $historyResults->count();
                if ($count > 1) {
                    $times = $historyResults->sortBy('changed_at')->pluck('changed_at')->toArray();
                    $totalTime = 0;
                    for ($i = 1; $i < $count; $i++) {
                        $totalTime += Carbon::parse($times[$i])->diffInSeconds(Carbon::parse($times[$i - 1]));
                    }
                    $avgTimeSeconds = $totalTime / ($count - 1);
                    $metric = ['avg_time_seconds' => $avgTimeSeconds, 'avg_time_formatted' => gmdate('H:i:s', $avgTimeSeconds)];
                } else {
                    $metric = ['avg_time_seconds' => 0, 'avg_time_formatted' => '00:00:00'];
                }
            } elseif ($formula == 'count') {
                $metric['count'] = $historyResults->count();
            } elseif ($formula == 'percentage') {
                $totalRecords = DB::table($tableName)
                    ->join($crmentityTable, "$tableName.id", '=', "$crmentityTable.crmid")
                    ->where("$crmentityTable.deleted", 0)
                    ->where("$crmentityTable.module_name", $this->module)
                    ->count();
                $metric['percentage'] = $totalRecords > 0 ? ($historyResults->count() / $totalRecords) * 100 : 0;
            } elseif ($formula == 'sum') {
                $sum = DB::table($tableName)
                    ->join($crmentityTable, "$tableName.id", '=', "$crmentityTable.crmid")
                    ->join('rsoft_field_history', "$tableName.id", '=', 'rsoft_field_history.record_id')
                    ->where('rsoft_field_history.field_name', $picklistColname)
                    ->where('rsoft_field_history.old_value', $fromValue)
                    ->where('rsoft_field_history.new_value', $toValue)
                    ->where("$crmentityTable.deleted", 0)
                    ->where("$crmentityTable.module_name", $this->module)
                    ->sum("$tableName.amount");
                $metric['sum'] = $sum ?: 0;
            }
 
            $results[] = [
                'tracking_name' => $trackingName,
                'picklist' => $picklistColname,
                'from_value' => $fromValue,
                'to_value' => $toValue,
                'formula' => $formula,
                'metric' => $metric,
            ];
        }
 
        $this->emit('picklistTrackingResultsFetched', $results);
    } catch (\Exception $e) {
        $this->emit('error', 'Failed to fetch picklist tracking results: ' . $e->getMessage());
    }
}


 

    public function closePicklistPopup()
    {
        $this->isEditingPopup = false;
        $this->currentTrackingId = null;
        $this->popupIsOpen = false;
        $this->dispatchBrowserEvent('popupStateUpdated', ['popupIsOpen' => false]);
    }

    public function checkPicklistFieldUsage($data)
{
    $exists = DB::table('rsoft_advanced_report_picklisttracking')
        ->where('picklist_columnname', $data['picklist'])
        ->where('report_id', $data['reportId'])
        ->when($data['trackingId'], function($query, $trackingId) {
            return $query->where('tracking_id', '!=', $trackingId);
        })
        ->exists();

    $this->dispatchBrowserEvent('picklistFieldUsed', [
        'picklistFieldUsed' => $exists,
        'trackingNames' => $exists ? 
            DB::table('rsoft_advanced_report_picklisttracking')
                ->where('picklist_columnname', $data['picklist'])
                ->where('report_id', $data['reportId'])
                ->pluck('tracking_name')
                ->toArray() : [],
    ]);
}


     function getPicklistTrackingData($result, $picklistval){
        $recordsid = explode(',', $result);
        $response=[];
        $finalOutput =0;
        $totalSeconds = 0;
        $totalCount = 0;
        foreach ($recordsid as $rid) {
            $updatesfrom = DB::table('rsoft_updates')
                ->where('postvalue', $picklistval->from_value)
                ->where('recordid', $rid)
                ->orderBy('created_time', 'ASC')
                ->get();
            $updatesrevfrom = DB::table('rsoft_updates')
                ->where('previousvalue', $picklistval->from_value)
                ->where('recordid', $rid)
                ->orderBy('created_time', 'ASC')
                ->get();
               
            if(count($updatesfrom) && count($updatesrevfrom))  {
                $fromTime = strtotime($updatesrevfrom[0]->created_time);
                $toTime = strtotime($updatesfrom[0]->created_time);
                
            
                if ($fromTime <= $toTime) {
                    $updatesfrom=$updatesrevfrom;
                }
            }
            $updatesto = DB::table('rsoft_updates')
                ->where('postvalue', $picklistval->to_value)
                ->where('recordid', $rid)
                ->orderBy('created_time', 'ASC')
                ->get();

            $updatesfromcrm = DB::table('rsoft_updates')
                ->where('previousvalue', $picklistval->from_value)
                ->where('recordid', $rid)
                ->orderBy('created_time', 'ASC')
                ->get();
               
            if (count($updatesfrom) == 0 && count($updatesto) > 0) {
                $crmentity = DB::table('rsoft_crmentity')
                    ->select('smownerid', 'created_time')
                    ->where('crmid', $rid)
                    ->first();

                if ($crmentity) {
                    if ($crmentity->smownerid == $picklistval->from_value) {
                        $updatesfrom = collect([(object)[
                            'created_time' => $crmentity->created_time
                        ]]);
                    }
                }
            }

      
            if (count($updatesfrom) == 0 ||( count($updatesfromcrm) && count($updatesto) && strtotime($updatesfromcrm[0]->created_time) == strtotime($updatesto[0]->created_time))) {
                $checkval = $updatesfrom[0]->postvalue ?? null;
               
                if($checkval != $picklistval->from_value){
                     $updatesfromcrm = DB::table('rsoft_updates')
                    ->where('previousvalue', $picklistval->from_value)
                    ->where('recordid', $rid)
                    ->orderBy('created_time', 'ASC')
                    ->get();
                    if(count($updatesfromcrm)){

                        $refTime = $updatesfromcrm[0]->created_time;

                    
                        $lastToUpdate = DB::table('rsoft_updates')
                            ->where('recordid', $rid)
                            ->where('created_time', '<', $refTime)
                            ->orderBy('created_time', 'DESC')
                            ->first();

                        if($lastToUpdate){
                            $updatesfrom = collect([(object)[
                                'created_time' => $lastToUpdate->created_time
                            ]]);
                        } else {
                            
                            $updatesfrom = DB::table('rsoft_crmentity')
                                ->where('crmid', $rid)
                                ->orderBy('created_time', 'ASC')
                                ->get();
                        }
                    }

                }
            }
            if(count($updatesto)>1){
                 $updatesto=$updatesfromcrm;
            }
           
                
                
            if (count($updatesfrom) && count($updatesto)) {
                $fromTime = strtotime($updatesfrom[0]->created_time);
                $toTime = strtotime($updatesto[0]->created_time);
                
            
                if ($fromTime <= $toTime) {
                    if ($picklistval->formula == 'avg_time' || $picklistval->formula == 'sum') {
                            $start = new DateTime($updatesfrom[0]->created_time);
                            $end = new DateTime($updatesto[0]->created_time);
                            $totalSeconds += abs($end->getTimestamp() - $start->getTimestamp());
                            $totalCount++;
                        } elseif ($picklistval->formula == 'count' || $picklistval->formula == 'percentage') {
                            $totalCount++;
                        }
                    }
                }
            }

        if ($picklistval->formula == 'avg_time') {
            $finalOutput =  ($totalSeconds == 0) ? 0 : $totalSeconds;
        }elseif ($picklistval->formula == 'sum') {
            $finalOutput= ($totalSeconds == 0) ? 0 : $totalSeconds;
        } elseif ($picklistval->formula == 'count') {
            $finalOutput= ($totalCount == 0) ? 0 : $totalCount;
        }elseif ($picklistval->formula == 'percentage') {
            $finalOutput= round(($totalCount/count($recordsid)) * 100,2);
        }
        $response['finalOutput']=$finalOutput;
        $response['totalCount']=$totalCount;
        return $response;
    }

    function getPicklistTrackingResult($totalSeconds, $formula,$Total) {
   
        $totalSeconds = is_numeric($totalSeconds) ? (int)$totalSeconds : 0;
       if ($formula === 'avg_time') {
            if (!empty($Total) && $Total != 0) {
                $totalSeconds =round((int)$totalSeconds / (int)$Total,2); 
            }
        }
        if ($formula == 'avg_time' || $formula == 'sum') {
            $output = '';
            if ($totalSeconds != 0) {
            
                if ($totalSeconds < 60) {
                    $output = "{$totalSeconds} Sec";
                }
            
                elseif ($totalSeconds < 3600) {
                    $minutes = floor($totalSeconds / 60);
                    $seconds = $totalSeconds % 60;
                    $output = "{$minutes} Min {$seconds} Sec";
                }
    
                elseif ($totalSeconds < 86400) {
                    $hours = floor($totalSeconds / 3600);
                    $remaining = $totalSeconds % 3600;
                    $minutes = floor($remaining / 60);
                    $seconds = $remaining % 60;
                    $output = "{$hours} Hrs {$minutes} Min {$seconds} Sec";
                }
                else {
                    $days = floor($totalSeconds / 86400);
                    $remaining = $totalSeconds % 86400;
                    $hours = floor($remaining / 3600);
                    $remaining = $remaining % 3600;
                    $minutes = floor($remaining / 60);
                    $seconds = $remaining % 60;
                    $output = "{$days} Days {$hours} Hrs {$minutes} Min {$seconds} Sec";
                }
            }
            return $output;
        }else if ($formula == 'percentage'){
            if($totalSeconds>=100){
                $totalSeconds=100;
            }
        }
        return $totalSeconds;
    }

        public function clearStoredFilters()
    {
        $this->filterData = []; 
        $this->dispatchBrowserEvent('filters-cleared');
    }

    public function resetAllFilterData()
    {
        $this->filterData = [];
        $this->previewsorting = 'ASC';
        $this->previewcolumnname = '';
    }

    public function loadMISPreview($report_id)
    {
        $this->report_id = $report_id;
        $this->previewperPage =20;
        $this->loadTableContent('MISPreview', '', $report_id);
    }
    public function reloadPreview($report_id)
    {
        $this->currentReportId = $report_id;
        $this->previewsorting = 'ASC';
        $this->previewcolumnname = '';
        $this->previewpage = 0;
        $this->previewreportslist = [];
        $this->previewperPage =20;
        $this->loadTableContent('MISPreview', $this->module_id, $this->misCurrentReportId);
    }
    public function MisScroll($report_id)
    {
        if($this->currentReportId == $report_id){
        $this->previewperPage += 10;
        }
    }

    public function getDefaultTablestyle()
    {
        return [
            'hstyle' => 'color: #000000; font-size: 12px; font-family: Arial, sans-serif; background-color: #f5f5f5; position: sticky; top: 0; z-index: 1; height: 25px; padding: 10px; box-sizing: border-box; width: 15%; width: 200px;',
            'pdfhstyle' => 'color: #000000; font-size: 12px; font-family: Arial, sans-serif; background-color: #f5f5f5;',
            'fstyle' => 'color: #000000; font-size: 12px; font-family: Arial, sans-serif; background-color: #f5f5f5; position: sticky; top: 0; z-index: 1; height: 25px; padding: 10px; box-sizing: border-box; width: 15%; width: 200px;',
            'pdffstyle' => 'color: #000000; font-size: 12px; font-family: Arial, sans-serif; background-color: #f5f5f5;',
            'bstyle' => 'color: #000000; font-size: 12px; font-family: Arial, sans-serif; position: sticky; top: 0; z-index: 1; height: 25px; padding: 10px; box-sizing: border-box; width: 15%; width: 200px;',
            'pdfbstyle' => 'color: #000000; font-size: 12px; font-family: Arial, sans-serif;',
            'tstyle' => 'no-borders',
            'oddrowcolor' => '#ffffff',
            'evenrowcolor' => '#f9f9f9',
            'tborder_color' => '#cccccc'
        ];
    }
    public function misCurrentReportId($report_id,$mode='')
    {   
        $this->oldMisCurrentReportId = $this->misCurrentReportId;
        $this->misCurrentReportId = $report_id;
        $this->tabmode = $mode;
    }
    public function mount()
    {   
        $tabmode = request()->query('tabmode');
        if($tabmode == "MISPreview"){
            $this->tabmode =$tabmode;
        }
        if($this->misCurrentReportId ==null){
                $this->misCurrentReportId = request()->query('record');
            }
        }
    public function misreport() {
            $this->currentReportId ='';
        }
}
